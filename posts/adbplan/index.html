<!doctype html><html lang=en>
<head>
<title>
::
Asky — My note blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="issues #  1490 #  1921 #  1699 #  http://10.20.16.216:9090/ADB/AntDB/-/issues/1490 http://10.20.16.216:9090/ADB/AntDB/-/issues/1921 http://10.20.16.216:9090/ADB/AntDB/-/issues/1699
问题 #  使用到reduce的地方（包括查询）偶现以下错误，再次执行sql就正常；
ERROR: remote node 16389 closed socket CONTEXT: dynamic reduce 复现方法 #  使用修改分布方式的方式去复现问题，过程如下： 创建100张表，然后并发100，不停执行下面的语句，5分钟之内会出现报错：
alter table xxx distribute by replication; alter table xxx distribute by random;  无法直接复现  1779 #  http://10.20.16.216:9090/ADB/AntDB/-/issues/1779
问题 #  执行计划不正确导致dyreduce执行出错
复现方法 #  create table tttb1( c1 int,c2 varchar(100),c3 varchar(100)); create table tttb2(c1 int,sheet_num varchar(100)); create table tttb3(c1 int,order_no varchar(100)); explain select count(distinct c2) from tttb1 where c2 in (select distinct sheet_num from tttb2,tttb3 where sheet_num=order_no and c3=&amp;#39;1&amp;#39;); create table tb1(c1 int,c2 varchar(100),c3 varchar(100)); create table tb2(c1 int,sheet_num varchar(100)); create table tb3(c1 int,order_no varchar(100)); explain select count(distinct c2) from tb1 where c2 in (select distinct sheet_num from tb2,tb3 where sheet_num=order_no and c3=&amp;#39;1&amp;#39;); insert into tb1 select (random()*10000000)::int, (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb2 select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb3 select (random()*10000000)::character varying, (random()*10000000)::int from generate_series(1,100000); create table tb1int(c1 int, c2 int,c3 int); create table tb2int(c1 int, sheet_num int); create table tb3int(c1 int, order_no int); explain select count(distinct c2) from tb1int where c2 in (select distinct sheet_num from tb2int,tb3int where sheet_num=order_no and c3=1); insert into tb1int select (random()*10000000)::int, (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb2int select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb3int select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); 1875 #  http://10.">
<meta name=keywords content="程序员、码农、database、C++">
<meta name=robots content="noodp">
<link rel=canonical href=https://askyx.github.io/posts/adbplan/>
<link rel=stylesheet href=//cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css media=print onload="this.media='all'">
<link rel=stylesheet href=https://askyx.github.io/assets/style.css>
<link rel=stylesheet href=https://askyx.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://askyx.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://askyx.github.io/favicon.ico>
<link rel=apple-touch-icon href=https://askyx.github.io/favicon.ico>
<link rel=bookmark href=https://askyx.github.io/favicon.ico>
<link rel=apple-touch-icon-precomposed sizes=180x180 href=https://askyx.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta name=twitter:title content>
<meta name=twitter:description content="issues #  1490 #  1921 #  1699 #  http://10.20.16.216:9090/ADB/AntDB/-/issues/1490 http://10.20.16.216:9090/ADB/AntDB/-/issues/1921 http://10.20.16.216:9090/ADB/AntDB/-/issues/1699
问题 #  使用到reduce的地方（包括查询）偶现以下错误，再次执行sql就正常；
ERROR: remote node 16389 closed socket CONTEXT: dynamic reduce 复现方法 #  使用修改分布方式的方式去复现问题，过程如下： 创建100张表，然后并发100，不停执行下面的语句，5分钟之内会出现报错：
alter table xxx distribute by replication; alter table xxx distribute by random;  无法直接复现  1779 #  http://10.20.16.216:9090/ADB/AntDB/-/issues/1779
问题 #  执行计划不正确导致dyreduce执行出错
复现方法 #  create table tttb1( c1 int,c2 varchar(100),c3 varchar(100)); create table tttb2(c1 int,sheet_num varchar(100)); create table tttb3(c1 int,order_no varchar(100)); explain select count(distinct c2) from tttb1 where c2 in (select distinct sheet_num from tttb2,tttb3 where sheet_num=order_no and c3='1'); create table tb1(c1 int,c2 varchar(100),c3 varchar(100)); create table tb2(c1 int,sheet_num varchar(100)); create table tb3(c1 int,order_no varchar(100)); explain select count(distinct c2) from tb1 where c2 in (select distinct sheet_num from tb2,tb3 where sheet_num=order_no and c3='1'); insert into tb1 select (random()*10000000)::int, (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb2 select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb3 select (random()*10000000)::character varying, (random()*10000000)::int from generate_series(1,100000); create table tb1int(c1 int, c2 int,c3 int); create table tb2int(c1 int, sheet_num int); create table tb3int(c1 int, order_no int); explain select count(distinct c2) from tb1int where c2 in (select distinct sheet_num from tb2int,tb3int where sheet_num=order_no and c3=1); insert into tb1int select (random()*10000000)::int, (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb2int select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb3int select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); 1875 #  http://10.">
<meta property="og:title" content>
<meta property="og:description" content="issues #  1490 #  1921 #  1699 #  http://10.20.16.216:9090/ADB/AntDB/-/issues/1490 http://10.20.16.216:9090/ADB/AntDB/-/issues/1921 http://10.20.16.216:9090/ADB/AntDB/-/issues/1699
问题 #  使用到reduce的地方（包括查询）偶现以下错误，再次执行sql就正常；
ERROR: remote node 16389 closed socket CONTEXT: dynamic reduce 复现方法 #  使用修改分布方式的方式去复现问题，过程如下： 创建100张表，然后并发100，不停执行下面的语句，5分钟之内会出现报错：
alter table xxx distribute by replication; alter table xxx distribute by random;  无法直接复现  1779 #  http://10.20.16.216:9090/ADB/AntDB/-/issues/1779
问题 #  执行计划不正确导致dyreduce执行出错
复现方法 #  create table tttb1( c1 int,c2 varchar(100),c3 varchar(100)); create table tttb2(c1 int,sheet_num varchar(100)); create table tttb3(c1 int,order_no varchar(100)); explain select count(distinct c2) from tttb1 where c2 in (select distinct sheet_num from tttb2,tttb3 where sheet_num=order_no and c3='1'); create table tb1(c1 int,c2 varchar(100),c3 varchar(100)); create table tb2(c1 int,sheet_num varchar(100)); create table tb3(c1 int,order_no varchar(100)); explain select count(distinct c2) from tb1 where c2 in (select distinct sheet_num from tb2,tb3 where sheet_num=order_no and c3='1'); insert into tb1 select (random()*10000000)::int, (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb2 select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb3 select (random()*10000000)::character varying, (random()*10000000)::int from generate_series(1,100000); create table tb1int(c1 int, c2 int,c3 int); create table tb2int(c1 int, sheet_num int); create table tb3int(c1 int, order_no int); explain select count(distinct c2) from tb1int where c2 in (select distinct sheet_num from tb2int,tb3int where sheet_num=order_no and c3=1); insert into tb1int select (random()*10000000)::int, (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb2int select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); insert into tb3int select (random()*10000000)::int, (random()*10000000)::int from generate_series(1,100000); 1875 #  http://10.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://askyx.github.io/posts/adbplan/"><meta property="article:section" content="posts">
</head>
<body class=light-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://askyx.github.io/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
<li><a href=/search>🔍</a></li>
<li><a href=javascript:; onclick=randomPost() title=随机访问一篇文章><svg t="1660103436159" class="icon search-box-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1184" width="32" height="32"><path d="M421.376 481.28s117.248 24.576 175.104-8.704c0 0-89.6 70.144-89.6 166.4.512-.512-8.192-121.344-85.504-157.696zm17.408 487.936s68.608 6.656 68.608-80.896c0 0 3.072 88.576 65.024 78.336.0.512-50.688 22.016-133.632 2.56zM161.28 238.08s-30.208 65.536 11.264 91.648c0 0-67.072-17.408-81.408 37.376.0.0 8.704-82.944 70.144-129.024zM857.6 227.328s49.152 50.176 1.024 81.408c0 0 58.88-18.432 66.56 36.352.0.0 5.12-69.632-67.584-117.76z" p-id="1185"/><path d="M443.392 970.752c-5.632.0-10.752-1.024-15.36-3.072L157.184 810.496l-1.536-1.024s-1.024-1.024-4.608-2.56c-51.2-29.184-62.976-94.208-65.536-120.832V386.56c0-3.072.512-7.168 1.024-11.264l.512-3.584 1.024-2.56c19.456-50.688 76.8-51.2 103.936-44.032l-1.536 5.632 4.096-6.144L476.16 486.4l18.944 37.888c20.992 36.864 29.184 77.824 32.768 99.84v258.048c-4.608 56.32-36.864 76.288-55.808 82.944-1.024.512-15.36 5.632-28.672 5.632zM181.248 774.656l263.168 152.576c12.288-.512 36.864-6.656 40.448-48.128V628.736c-4.608-31.744-20.992-103.936-72.192-128L322.56 445.44l1.536 3.072L181.76 366.08c-2.048-.512-40.448-9.216-52.736 15.872-.512 2.56-.512 4.608-.512 6.144v294.4c1.536 16.896 9.728 67.072 43.52 86.528 3.584 2.048 6.656 4.096 9.216 5.632z" p-id="1186"/><path d="M837.632 212.992c6.656 4.096 12.8 7.168 18.432 10.752l1.536 1.024 1.536 1.536c5.12 4.096 10.752 9.216 16.384 15.36 6.144 11.776 5.632 33.28 4.608 49.152-1.024 12.288-6.656 30.208-26.624 44.544l-1.024.512-247.808 156.672c-26.624 14.336-62.976 18.432-96.256 18.432-40.96.0-77.824-6.656-89.088-8.704l-3.072-.512-245.248-142.336c-39.424-29.696-28.16-85.504-15.36-113.664l2.56-6.144 263.68-166.912c29.184-14.336 104.448-43.008 173.056-1.024 3.584 2.56 58.368 34.304 119.296 69.632M431.616 460.8c40.448 7.168 114.176 13.824 152.576-6.144L828.928 299.52c7.168-5.632 8.192-10.24 8.704-12.8 1.024-11.264-9.728-26.624-15.36-32.768-55.808-32.256-243.712-141.312-250.368-145.408-49.664-30.72-107.008-9.216-130.048 2.56L192.512 268.8c-4.096 12.288-12.288 42.496 3.584 55.808L431.616 460.8z" p-id="1187"/><path d="M831.488 299.008c4.096-1.024 38.4-11.264 66.048 6.144 7.168 4.608 17.92 11.776 24.064 24.576 1.024 5.632 4.096 10.752 4.608 16.896v2.048l-1.024 323.072c-5.12 35.328-22.528 91.648-77.312 125.44l-5.12 3.584h-1.024L579.584 966.656l-4.608.512c-4.096.512-8.704 1.024-12.8 1.024-15.872.0-30.208-5.12-41.984-14.848-24.576-20.48-32.768-55.808-35.328-73.728l-1.024-252.928h1.536c6.144-96.768 88.576-164.864 96.768-171.008l-.512-.512L829.44 299.52M528.384 867.328c.512 10.24 5.12 41.472 19.968 53.76 3.072 2.56 7.68 5.632 16.384 5.12L829.44 758.272c56.32-38.4 53.76-115.712 53.76-116.224l-.512-32.256 1.024-250.368h-.512c-1.536-12.8-7.168-16.384-8.704-17.408-8.704-5.632-23.552-3.072-28.672-2.048L610.304 488.96c-1.024.512-80.896 65.024-80.896 149.504h-1.536l.512 228.864zM435.2 264.192c0 27.648 31.744 50.176 71.168 50.176s71.168-22.528 71.168-50.176-31.744-50.176-71.168-50.176S435.2 236.544 435.2 264.192z" p-id="1188"/><path d="M663.552 782.848c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-50.176-.512-50.176-31.232s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM760.32 602.624c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-49.664-.512-49.664-31.232s22.528-67.072 49.664-80.384c27.136-13.824 49.664.512 49.664 31.232zM867.84 428.032c0 30.72-22.528 67.072-49.664 80.384C790.528 522.24 768 507.904 768 477.184s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM270.848 538.112c0 30.72-22.016 41.984-48.64 24.576-27.136-16.896-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528zm161.28 285.184c0 30.72-22.016 41.984-48.64 24.576-26.624-17.408-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528z" p-id="1189"/></svg></a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
<li><a href=/search>🔍</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<div class=breadcrumb>
<li>
<a href=https://askyx.github.io/>首页</a>
</li>
<li>
<a href=https://askyx.github.io/posts/>Posts</a>
</li>
<li class=active>
<a href=https://askyx.github.io/posts/adbplan/></a>
</li>
</div>
<h2 class=post-title><a href=https://askyx.github.io/posts/adbplan/></a></h2>
<div class=post-meta>
</div>
<div class=post-content>
<h2 id=issues>
issues
<a href=#issues class=h-anchor aria-hidden=true>#</a>
</h2>
<h3 id=1490>
1490
<a href=#1490 class=h-anchor aria-hidden=true>#</a>
</h3>
<h3 id=1921>
1921
<a href=#1921 class=h-anchor aria-hidden=true>#</a>
</h3>
<h3 id=1699>
1699
<a href=#1699 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/1490
http://10.20.16.216:9090/ADB/AntDB/-/issues/1921
http://10.20.16.216:9090/ADB/AntDB/-/issues/1699</p>
<h4 id=问题>
问题
<a href=#%e9%97%ae%e9%a2%98 class=h-anchor aria-hidden=true>#</a>
</h4>
<p>使用到reduce的地方（包括查询）偶现以下错误，再次执行sql就正常；</p>
<pre tabindex=0><code class=language-log data-lang=log>ERROR:  remote node 16389 closed socket
CONTEXT:  dynamic reduce
</code></pre><h4 id=复现方法>
复现方法
<a href=#%e5%a4%8d%e7%8e%b0%e6%96%b9%e6%b3%95 class=h-anchor aria-hidden=true>#</a>
</h4>
<p>使用修改分布方式的方式去复现问题，过程如下：
创建100张表，然后并发100，不停执行下面的语句，5分钟之内会出现报错：</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> xxx distribute <span style=color:#66d9ef>by</span> replication;
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> xxx distribute <span style=color:#66d9ef>by</span> random;
</code></pre></div><ul>
<li>无法直接复现</li>
</ul>
<h3 id=1779>
1779
<a href=#1779 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/1779</p>
<h4 id=问题-1>
问题
<a href=#%e9%97%ae%e9%a2%98-1 class=h-anchor aria-hidden=true>#</a>
</h4>
<p>执行计划不正确导致dyreduce执行出错</p>
<h4 id=复现方法-1>
复现方法
<a href=#%e5%a4%8d%e7%8e%b0%e6%96%b9%e6%b3%95-1 class=h-anchor aria-hidden=true>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tttb1( c1 int,c2 varchar(<span style=color:#ae81ff>100</span>),c3 varchar(<span style=color:#ae81ff>100</span>));
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tttb2(c1 int,sheet_num varchar(<span style=color:#ae81ff>100</span>));
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tttb3(c1 int,order_no varchar(<span style=color:#ae81ff>100</span>));
<span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>count</span>(<span style=color:#66d9ef>distinct</span> c2) <span style=color:#66d9ef>from</span> tttb1 <span style=color:#66d9ef>where</span> c2 <span style=color:#66d9ef>in</span> (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>distinct</span> sheet_num <span style=color:#66d9ef>from</span> tttb2,tttb3 <span style=color:#66d9ef>where</span> sheet_num<span style=color:#f92672>=</span>order_no <span style=color:#66d9ef>and</span> c3<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;1&#39;</span>);
    


<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tb1(c1 int,c2 varchar(<span style=color:#ae81ff>100</span>),c3 varchar(<span style=color:#ae81ff>100</span>));
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tb2(c1 int,sheet_num varchar(<span style=color:#ae81ff>100</span>));
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tb3(c1 int,order_no varchar(<span style=color:#ae81ff>100</span>));
<span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>count</span>(<span style=color:#66d9ef>distinct</span> c2) <span style=color:#66d9ef>from</span> tb1 <span style=color:#66d9ef>where</span> c2 <span style=color:#66d9ef>in</span> (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>distinct</span> sheet_num <span style=color:#66d9ef>from</span> tb2,tb3 <span style=color:#66d9ef>where</span> sheet_num<span style=color:#f92672>=</span>order_no <span style=color:#66d9ef>and</span> c3<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;1&#39;</span>);

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tb1 <span style=color:#66d9ef>select</span> (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int <span style=color:#66d9ef>from</span>  generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tb2 <span style=color:#66d9ef>select</span> (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int <span style=color:#66d9ef>from</span>  generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tb3 <span style=color:#66d9ef>select</span> (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::character varying, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int <span style=color:#66d9ef>from</span>  generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);


<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tb1int(c1 int, c2 int,c3 int);
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tb2int(c1 int, sheet_num int);
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> tb3int(c1 int, order_no int);
<span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>count</span>(<span style=color:#66d9ef>distinct</span> c2) <span style=color:#66d9ef>from</span> tb1int <span style=color:#66d9ef>where</span> c2 <span style=color:#66d9ef>in</span> (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>distinct</span> sheet_num <span style=color:#66d9ef>from</span> tb2int,tb3int <span style=color:#66d9ef>where</span> sheet_num<span style=color:#f92672>=</span>order_no <span style=color:#66d9ef>and</span> c3<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tb1int <span style=color:#66d9ef>select</span> (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int <span style=color:#66d9ef>from</span>  generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tb2int <span style=color:#66d9ef>select</span> (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int <span style=color:#66d9ef>from</span>  generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tb3int <span style=color:#66d9ef>select</span> (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int, (random()<span style=color:#f92672>*</span><span style=color:#ae81ff>10000000</span>)::int <span style=color:#66d9ef>from</span>  generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);


</code></pre></div><h3 id=1875>
1875
<a href=#1875 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/1875</p>
<h4 id=问题-2>
问题
<a href=#%e9%97%ae%e9%a2%98-2 class=h-anchor aria-hidden=true>#</a>
</h4>
<p>数据重分布错误</p>
<h4 id=复现方法-2>
复现方法
<a href=#%e5%a4%8d%e7%8e%b0%e6%96%b9%e6%b3%95-2 class=h-anchor aria-hidden=true>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> test (id int ,name varchar(<span style=color:#ae81ff>22</span>)) <span style=color:#66d9ef>to</span> node(dn2);
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> test  distribute <span style=color:#66d9ef>by</span> replication ;
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> t1 (id int ,name text) distribute <span style=color:#66d9ef>by</span> replication <span style=color:#66d9ef>to</span> node(dn2);
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> t1 distribute <span style=color:#66d9ef>by</span> hash(id);


<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> test <span style=color:#66d9ef>to</span> node(dn1, dn2);

</code></pre></div><h3 id=1938>
1938
<a href=#1938 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/1938</p>
<p>cluster reduce not support from REPLICATED to none REPLICATED</p>
<h4 id=复现>
复现
<a href=#%e5%a4%8d%e7%8e%b0 class=h-anchor aria-hidden=true>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> test2(c1 int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,c2 text) distribute <span style=color:#66d9ef>by</span> replication;
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test2 <span style=color:#66d9ef>select</span> id ,<span style=color:#e6db74>&#39;abcd&#39;</span><span style=color:#f92672>||</span>id<span style=color:#f92672>||</span><span style=color:#e6db74>&#39;efgh&#39;</span> <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>) id;
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> test2_tmp2 (c1 int <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>null</span> <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>,c2 text,c3 int) distribute <span style=color:#66d9ef>by</span> hash(c1);
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> test2_tmp3 (c1 int,c2 text,c3 int) distribute <span style=color:#66d9ef>by</span> hash(c1);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test2_tmp3 <span style=color:#66d9ef>select</span> c1, <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>c</span>, <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>from</span> test2 <span style=color:#66d9ef>where</span> c1 <span style=color:#66d9ef>between</span> <span style=color:#ae81ff>501</span> <span style=color:#66d9ef>and</span> <span style=color:#ae81ff>1000</span> <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> c1 <span style=color:#66d9ef>HAVING</span> c1<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>520</span> ;
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test2_tmp3 <span style=color:#66d9ef>select</span> c1, c2, c1 <span style=color:#66d9ef>from</span> test2 <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>10</span>  ;



<span style=color:#66d9ef>select</span> c1, <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>c</span>, rank() OVER my_win <span style=color:#66d9ef>as</span> rnk <span style=color:#66d9ef>from</span> test2 <span style=color:#66d9ef>where</span> c1 <span style=color:#66d9ef>between</span> <span style=color:#ae81ff>501</span> <span style=color:#66d9ef>and</span> <span style=color:#ae81ff>1000</span> <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> c1 <span style=color:#66d9ef>HAVING</span> c1<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>520</span> WINDOW my_win <span style=color:#66d9ef>AS</span> (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> c2 <span style=color:#66d9ef>DESC</span>) <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>50</span> <span style=color:#66d9ef>offset</span> <span style=color:#ae81ff>5</span>;

<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test2_tmp2 <span style=color:#66d9ef>select</span> c1, <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>c</span>, rank() OVER my_win <span style=color:#66d9ef>as</span> rnk <span style=color:#66d9ef>from</span> test2 <span style=color:#66d9ef>where</span> c1 <span style=color:#66d9ef>between</span> <span style=color:#ae81ff>501</span> <span style=color:#66d9ef>and</span> <span style=color:#ae81ff>1000</span> <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> c1 <span style=color:#66d9ef>HAVING</span> c1<span style=color:#f92672>&lt;</span><span style=color:#ae81ff>520</span> WINDOW my_win <span style=color:#66d9ef>AS</span> (<span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> c2 <span style=color:#66d9ef>DESC</span>) <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>50</span> <span style=color:#66d9ef>offset</span> <span style=color:#ae81ff>5</span>;

 <span style=color:#66d9ef>Insert</span> <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>public</span>.test2_tmp2  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>50</span>..<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>99</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
   <span style=color:#f92672>-&gt;</span>  Subquery Scan <span style=color:#66d9ef>on</span> <span style=color:#e6db74>&#34;*SELECT*&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>50</span>..<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>99</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>14</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>40</span>)
         <span style=color:#66d9ef>Output</span>: <span style=color:#e6db74>&#34;*SELECT*&#34;</span>.c1, <span style=color:#e6db74>&#34;*SELECT*&#34;</span>.<span style=color:#66d9ef>c</span>, <span style=color:#e6db74>&#34;*SELECT*&#34;</span>.rnk
         <span style=color:#f92672>-&gt;</span>  <span style=color:#66d9ef>Limit</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>50</span>..<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>74</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>14</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>33</span>)
               <span style=color:#66d9ef>Output</span>: test2.c1, (<span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)), (rank() OVER (<span style=color:#f92672>?</span>)), test2.c2
               <span style=color:#f92672>-&gt;</span>  WindowAgg  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>41</span>..<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>74</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>19</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>33</span>)
                     <span style=color:#66d9ef>Output</span>: test2.c1, (<span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)), rank() OVER (<span style=color:#f92672>?</span>), test2.c2
                     <span style=color:#f92672>-&gt;</span>  Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>41</span>..<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>46</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>19</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>25</span>)
                           <span style=color:#66d9ef>Output</span>: test2.c1, test2.c2, (<span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>))
                           Sort <span style=color:#66d9ef>Key</span>: test2.c2 <span style=color:#66d9ef>DESC</span>
                           <span style=color:#f92672>-&gt;</span>  GroupAggregate  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>29</span>..<span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>00</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>19</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>25</span>)
                                 <span style=color:#66d9ef>Output</span>: test2.c1, test2.c2, <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
                                 <span style=color:#66d9ef>Group</span> <span style=color:#66d9ef>Key</span>: test2.c1
                                 <span style=color:#f92672>-&gt;</span>  <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>using</span> test2_pkey <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>public</span>.test2  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>29</span>..<span style=color:#ae81ff>8</span>.<span style=color:#ae81ff>72</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>19</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>17</span>)
                                       <span style=color:#66d9ef>Output</span>: test2.c1, test2.c2
                                       <span style=color:#66d9ef>Index</span> Cond: ((test2.c1 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>501</span>) <span style=color:#66d9ef>AND</span> (test2.c1 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1000</span>) <span style=color:#66d9ef>AND</span> (test2.c1 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>520</span>))


 <span style=color:#66d9ef>Limit</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>30</span>..<span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>32</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>33</span>)
   <span style=color:#66d9ef>Output</span>: c1, (<span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)), (rank() OVER (<span style=color:#f92672>?</span>)), c2
   <span style=color:#f92672>-&gt;</span>  WindowAgg  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>21</span>..<span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>32</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>33</span>)
         <span style=color:#66d9ef>Output</span>: c1, (<span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)), rank() OVER (<span style=color:#f92672>?</span>), c2
         <span style=color:#f92672>-&gt;</span>  Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>21</span>..<span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>23</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>25</span>)
               <span style=color:#66d9ef>Output</span>: c1, c2, (<span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>))
               Sort <span style=color:#66d9ef>Key</span>: test2.c2 <span style=color:#66d9ef>DESC</span>
               <span style=color:#f92672>-&gt;</span>  <span style=color:#66d9ef>Cluster</span> Gather  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>17</span>..<span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>14</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>25</span>)
                     Remote node: <span style=color:#ae81ff>16388</span>
                     <span style=color:#f92672>-&gt;</span>  GroupAggregate  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>17</span>..<span style=color:#ae81ff>45</span>.<span style=color:#ae81ff>34</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>25</span>)
                           <span style=color:#66d9ef>Output</span>: c1, c2, <span style=color:#66d9ef>count</span>(<span style=color:#f92672>*</span>)
                           <span style=color:#66d9ef>Group</span> <span style=color:#66d9ef>Key</span>: test2.c1
                           <span style=color:#f92672>-&gt;</span>  <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>using</span> test2_pkey <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>public</span>.test2  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>17</span>..<span style=color:#ae81ff>45</span>.<span style=color:#ae81ff>25</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>17</span>)
                                 <span style=color:#66d9ef>Output</span>: c1, c2
                                 <span style=color:#66d9ef>Index</span> Cond: ((test2.c1 <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>501</span>) <span style=color:#66d9ef>AND</span> (test2.c1 <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>1000</span>) <span style=color:#66d9ef>AND</span> (test2.c1 <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>520</span>))
                                 Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>,<span style=color:#ae81ff>16388</span>

<span style=color:#f92672>#</span><span style=color:#ae81ff>0</span>  cost_cluster_reduce (path<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec5acd8) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>path<span style=color:#f92672>/</span>costsize.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>6422</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>1</span>  <span style=color:#ae81ff>0</span>x000055d3ed7c2289 <span style=color:#66d9ef>in</span> create_cluster_reduce_path (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec4b1a8, sub_path<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec59a00, rinfo_list<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec5ac88, rel<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec5a648, pathkeys<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x0) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>util<span style=color:#f92672>/</span>pathnode.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>5051</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>2</span>  <span style=color:#ae81ff>0</span>x000055d3ed759dc6 <span style=color:#66d9ef>in</span> create_cluster_window_path (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec4b1a8, window_rel<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec5a648, path<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec59a00, input_target<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec592d8, output_target<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec58c80, wflists<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec56b18, activeWindows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec56c18)
    <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planner.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>5948</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>3</span>  <span style=color:#ae81ff>0</span>x000055d3ed758c56 <span style=color:#66d9ef>in</span> create_window_paths (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec4b1a8, input_rel<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec58110, input_target<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec592d8, output_target<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec58c80, output_target_parallel_safe<span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>, wflists<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec56b18, activeWindows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec56c18)
    <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planner.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>5654</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>4</span>  <span style=color:#ae81ff>0</span>x000055d3ed74ee81 <span style=color:#66d9ef>in</span> grouping_planner (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec4b1a8, inheritance_update<span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>, tuple_fraction<span style=color:#f92672>=</span><span style=color:#ae81ff>55</span>) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planner.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>2732</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>5</span>  <span style=color:#ae81ff>0</span>x000055d3ed74aeca <span style=color:#66d9ef>in</span> subquery_planner (glob<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eeb594c0, parse<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec37be0, parent_root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8, hasRecursion<span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>, tuple_fraction<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planner.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>1320</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>6</span>  <span style=color:#ae81ff>0</span>x000055d3ed6deef6 <span style=color:#66d9ef>in</span> set_subquery_pathlist (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8, rel<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec49ce8, rti<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, rte<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec379d0) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>path<span style=color:#f92672>/</span>allpaths.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>3262</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>7</span>  <span style=color:#ae81ff>0</span>x000055d3ed6d4bf4 <span style=color:#66d9ef>in</span> set_rel_size (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8, rel<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec49ce8, rti<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>, rte<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec379d0) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>path<span style=color:#f92672>/</span>allpaths.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>437</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>8</span>  <span style=color:#ae81ff>0</span>x000055d3ed6d487a <span style=color:#66d9ef>in</span> set_base_rel_sizes (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>path<span style=color:#f92672>/</span>allpaths.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>338</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>9</span>  <span style=color:#ae81ff>0</span>x000055d3ed6d4431 <span style=color:#66d9ef>in</span> make_one_rel (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8, joinlist<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec4a198) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>path<span style=color:#f92672>/</span>allpaths.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>200</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>10</span> <span style=color:#ae81ff>0</span>x000055d3ed7476c2 <span style=color:#66d9ef>in</span> query_planner (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8, qp_callback<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3ed754f96 <span style=color:#f92672>&lt;</span>standard_qp_callback<span style=color:#f92672>&gt;</span>, qp_extra<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x7ffe3b15f700) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planmain.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>292</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>11</span> <span style=color:#ae81ff>0</span>x000055d3ed74df07 <span style=color:#66d9ef>in</span> grouping_planner (root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eec495a8, inheritance_update<span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>, tuple_fraction<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planner.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>2471</span>
<span style=color:#f92672>#</span><span style=color:#ae81ff>12</span> <span style=color:#ae81ff>0</span>x000055d3ed74aeca <span style=color:#66d9ef>in</span> subquery_planner (glob<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eeb594c0, parse<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x55d3eeb593b0, parent_root<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>x0, hasRecursion<span style=color:#f92672>=</span><span style=color:#66d9ef>false</span>, tuple_fraction<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) <span style=color:#66d9ef>at</span> <span style=color:#f92672>/</span>workspaces<span style=color:#f92672>/</span>antdb<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>optimizer<span style=color:#f92672>/</span>plan<span style=color:#f92672>/</span>planner.<span style=color:#66d9ef>c</span>:<span style=color:#ae81ff>1320</span>

</code></pre></div><h4 id=问题-3>
问题
<a href=#%e9%97%ae%e9%a2%98-3 class=h-anchor aria-hidden=true>#</a>
</h4>
<p>执行计划不正确，select 的 top 应该是 reduce，但是在某些情况下，执行计划生成错误， 最简单的例子是 insert .. select .. limit offset, 这是一大类问题，除了 limit offset ， 窗口函数也有问题，</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> test2_tmp3 <span style=color:#66d9ef>select</span> c1, c2, c1 <span style=color:#66d9ef>from</span> test2 <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>10</span>  <span style=color:#66d9ef>offset</span> <span style=color:#ae81ff>20</span>;

</code></pre></div><h3 id=2085>
2085
<a href=#2085 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/2085</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>
<span style=color:#66d9ef>set</span> enable_cluster_plan <span style=color:#66d9ef>to</span> <span style=color:#66d9ef>off</span>; <span style=color:#75715e>-- 不使用reduce逻辑
</span><span style=color:#75715e></span>
<span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> tbl;
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> tbl (sd int)  DISTRIBUTE <span style=color:#66d9ef>BY</span> REPLICATION <span style=color:#66d9ef>to</span> node(dn1, dn2);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tbl <span style=color:#66d9ef>select</span> generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>10</span>);


<span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> tbl;
<span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> <span style=color:#66d9ef>IF</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>EXISTS</span> tbl (sd int)  DISTRIBUTE <span style=color:#66d9ef>BY</span> REPLICATION;
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> tbl <span style=color:#66d9ef>select</span> generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>10</span>);
postgres<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>d<span style=color:#f92672>+</span> tbl
                                    <span style=color:#66d9ef>Table</span> <span style=color:#e6db74>&#34;public.tbl&#34;</span>
 <span style=color:#66d9ef>Column</span> <span style=color:#f92672>|</span>  <span style=color:#66d9ef>Type</span>   <span style=color:#f92672>|</span> <span style=color:#66d9ef>Collation</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Nullable</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Default</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Storage</span> <span style=color:#f92672>|</span> Stats target <span style=color:#f92672>|</span> Description
<span style=color:#75715e>--------+---------+-----------+----------+---------+---------+--------------+-------------
</span><span style=color:#75715e></span> sd     <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span>           <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>         <span style=color:#f92672>|</span> plain   <span style=color:#f92672>|</span>              <span style=color:#f92672>|</span>
Tablespace: <span style=color:#e6db74>&#34;hottbs&#34;</span>
DISTRIBUTE <span style=color:#66d9ef>BY</span> REPLICATION <span style=color:#66d9ef>TO</span> NODE(dn1_1, dn2_1, dn3_1)
<span style=color:#66d9ef>Access</span> <span style=color:#66d9ef>method</span>: heap

postgres<span style=color:#f92672>=#</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> tbl <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#ae81ff>1</span>;
 sd
<span style=color:#75715e>----
</span><span style=color:#75715e></span>  <span style=color:#ae81ff>1</span>
  <span style=color:#ae81ff>2</span>
  <span style=color:#ae81ff>3</span>
  <span style=color:#ae81ff>4</span>
  <span style=color:#ae81ff>5</span>
  <span style=color:#ae81ff>6</span>
  <span style=color:#ae81ff>7</span>
  <span style=color:#ae81ff>8</span>
  <span style=color:#ae81ff>9</span>
 <span style=color:#ae81ff>10</span>
(<span style=color:#ae81ff>10</span> <span style=color:#66d9ef>rows</span>)

<span style=color:#66d9ef>execute</span> direct <span style=color:#66d9ef>on</span> (dn1) <span style=color:#e6db74>&#39;select * from tbl &#39;</span>;
<span style=color:#66d9ef>execute</span> direct <span style=color:#66d9ef>on</span> (dn2) <span style=color:#e6db74>&#39;select * from tbl &#39;</span>;
<span style=color:#66d9ef>execute</span> direct <span style=color:#66d9ef>on</span> (dn3) <span style=color:#e6db74>&#39;select * from tbl &#39;</span>;

<span style=color:#66d9ef>execute</span> direct <span style=color:#66d9ef>on</span> (dn1) <span style=color:#e6db74>&#39;select * from tbl where ((hash_combin_mod(3, hashint4(sd))) = 0)&#39;</span>;
<span style=color:#66d9ef>execute</span> direct <span style=color:#66d9ef>on</span> (dn2) <span style=color:#e6db74>&#39;select * from tbl where ((hash_combin_mod(3, hashint4(sd))) = 1)&#39;</span>;
<span style=color:#66d9ef>execute</span> direct <span style=color:#66d9ef>on</span> (dn3) <span style=color:#e6db74>&#39;select * from tbl where ((hash_combin_mod(3, hashint4(sd))) = 2)&#39;</span>;

<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl distribute <span style=color:#66d9ef>by</span> hash(sd);
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl distribute <span style=color:#66d9ef>by</span> modulo(sd);
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl distribute <span style=color:#66d9ef>by</span> random;
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl distribute <span style=color:#66d9ef>by</span> hash(sd) <span style=color:#66d9ef>TO</span> NODE(dn1, dn2, dn3);
<span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl distribute <span style=color:#66d9ef>by</span> REPLICATION;
postgres<span style=color:#f92672>=#</span> <span style=color:#960050;background-color:#1e0010>\</span>d<span style=color:#f92672>+</span> tbl
                                    <span style=color:#66d9ef>Table</span> <span style=color:#e6db74>&#34;public.tbl&#34;</span>
 <span style=color:#66d9ef>Column</span> <span style=color:#f92672>|</span>  <span style=color:#66d9ef>Type</span>   <span style=color:#f92672>|</span> <span style=color:#66d9ef>Collation</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Nullable</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Default</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>Storage</span> <span style=color:#f92672>|</span> Stats target <span style=color:#f92672>|</span> Description
<span style=color:#75715e>--------+---------+-----------+----------+---------+---------+--------------+-------------
</span><span style=color:#75715e></span> sd     <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span>           <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>         <span style=color:#f92672>|</span> plain   <span style=color:#f92672>|</span>              <span style=color:#f92672>|</span>
Tablespace: <span style=color:#e6db74>&#34;hottbs&#34;</span>
DISTRIBUTE <span style=color:#66d9ef>BY</span> HASH(sd) <span style=color:#66d9ef>TO</span> NODE(dn1_1, dn2_1, dn3_1)
<span style=color:#66d9ef>Access</span> <span style=color:#66d9ef>method</span>: heap

postgres<span style=color:#f92672>=#</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> tbl <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#ae81ff>1</span>;
 sd
<span style=color:#75715e>----
</span><span style=color:#75715e></span>  <span style=color:#ae81ff>3</span>
  <span style=color:#ae81ff>3</span>
  <span style=color:#ae81ff>3</span>
  <span style=color:#ae81ff>5</span>
  <span style=color:#ae81ff>5</span>
  <span style=color:#ae81ff>5</span>
(<span style=color:#ae81ff>6</span> <span style=color:#66d9ef>rows</span>)

<span style=color:#66d9ef>DELETE</span> <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>public</span>.tbl <span style=color:#66d9ef>where</span> ((hash_combin_mod(<span style=color:#ae81ff>3</span>, hashint4(sd))) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)

</code></pre></div><h4 id=问题-4>
问题
<a href=#%e9%97%ae%e9%a2%98-4 class=h-anchor aria-hidden=true>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c>
distrib_delete_hash <span style=color:#960050;background-color:#1e0010>构建语句删除数据，条件拼接错误</span> 

<span style=color:#f92672>---</span> a<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>pgxc<span style=color:#f92672>/</span>locator<span style=color:#f92672>/</span>redistrib.c
<span style=color:#f92672>+++</span> b<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>backend<span style=color:#f92672>/</span>pgxc<span style=color:#f92672>/</span>locator<span style=color:#f92672>/</span>redistrib.c
<span style=color:#960050;background-color:#1e0010>@@</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>805</span>,<span style=color:#ae81ff>6</span> <span style=color:#f92672>+</span><span style=color:#ae81ff>805</span>,<span style=color:#ae81ff>7</span> <span style=color:#960050;background-color:#1e0010>@@</span> distrib_delete_hash(RedistribState <span style=color:#f92672>*</span>distribState, ExecNodes <span style=color:#f92672>*</span>exec_nodes)
 
                <span style=color:#75715e>/* Then launch this single query */</span>
                distrib_execute_query(buf2.data, RelationUsesLocalBuffers(rel), local_exec_nodes);
<span style=color:#f92672>+</span>               nodepos<span style=color:#f92672>++</span>;
 
                FreeExecNodes(<span style=color:#f92672>&amp;</span>local_exec_nodes);
                pfree(buf2.data);

</code></pre></div><h3 id=2103>
2103
<a href=#2103 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/2103</p>
<pre tabindex=0><code>版本：ADB 6.3.14 d22d4cf
pgbench压测一段时间
gc上执行with a as (select sum(abalance) from pgbench_accounts),b as (select sum(delta) from pgbench_history),c as (select sum(bbalance) from pgbench_branches) select * from a,b,c;

报错：
postgres=# with a as (select sum(abalance) from pgbench_accounts),b as (select sum(delta) from pgbench_history),c as (select sum(bbalance) from pgbench_branches) select * from a,b,c;
ERROR:  can not send message to dynamic reduce for plan: MQ detached

cn上执行成功，没有报错。

</code></pre><ul>
<li>无法复现</li>
</ul>
<h3 id=1927>
1927
<a href=#1927 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/1927</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> ff1;
<span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> ff2;
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> ff1 (a bigint,b integer);
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> ff2 (a bigint,b integer);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> ff1 <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>456789</span>, <span style=color:#ae81ff>123456</span>),(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>123456</span>),(<span style=color:#ae81ff>123456</span>, <span style=color:#ae81ff>11</span>), (<span style=color:#ae81ff>4567890123456789</span>, <span style=color:#ae81ff>344545</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> ff2 <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>4567890123456789</span>, <span style=color:#ae81ff>344545</span>),(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>344545</span>),(<span style=color:#ae81ff>123456</span>, <span style=color:#ae81ff>11</span>);

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> ff1, ff2 <span style=color:#66d9ef>where</span> ff1.a <span style=color:#f92672>=</span> ff2.a;

<span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> ff1;
<span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> ff2;
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> ff1 (a integer);
<span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> ff2 (a bigint);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> ff1 <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>456789</span>),(<span style=color:#ae81ff>11</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> ff2 <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>4567890123456789</span>),(<span style=color:#ae81ff>11</span>);

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> ff1, ff2 <span style=color:#66d9ef>where</span> ff1.a <span style=color:#f92672>=</span> ff2.a;

                                                       QUERY PLAN
<span style=color:#75715e>-------------------------------------------------------------------------------------------------------------------------
</span><span style=color:#75715e></span> <span style=color:#66d9ef>Cluster</span> Gather  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>1047</span>.<span style=color:#ae81ff>12</span>..<span style=color:#ae81ff>2272</span>.<span style=color:#ae81ff>56</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>3200</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
   Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>,<span style=color:#ae81ff>16388</span>
   <span style=color:#f92672>-&gt;</span>  Hash <span style=color:#66d9ef>Join</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>47</span>.<span style=color:#ae81ff>12</span>..<span style=color:#ae81ff>312</span>.<span style=color:#ae81ff>56</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1067</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
         <span style=color:#66d9ef>Output</span>: ff1.a, ff2.a
         Hash Cond: (ff2.a <span style=color:#f92672>=</span> ff1.a)
         <span style=color:#f92672>-&gt;</span>  <span style=color:#66d9ef>Cluster</span> Reduce  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>152</span>.<span style=color:#ae81ff>55</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>753</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
               Reduce: (<span style=color:#e6db74>&#39;[0:2]={16386,16387,16388}&#39;</span>::oid[])[COALESCE(hash_combin_mod(<span style=color:#ae81ff>3</span>, hashint4((ff2.a)::integer)), <span style=color:#ae81ff>0</span>)]
               <span style=color:#f92672>-&gt;</span>  Seq Scan <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>public</span>.ff2  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>32</span>.<span style=color:#ae81ff>60</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>753</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
                     <span style=color:#66d9ef>Output</span>: ff2.a
                     Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>,<span style=color:#ae81ff>16388</span>
         <span style=color:#f92672>-&gt;</span>  Hash  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>35</span>.<span style=color:#ae81ff>50</span>..<span style=color:#ae81ff>35</span>.<span style=color:#ae81ff>50</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>850</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
               <span style=color:#66d9ef>Output</span>: ff1.a
               <span style=color:#f92672>-&gt;</span>  Seq Scan <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>public</span>.ff1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>35</span>.<span style=color:#ae81ff>50</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>850</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
                     <span style=color:#66d9ef>Output</span>: ff1.a
                     Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>,<span style=color:#ae81ff>16388</span>

(<span style=color:#e6db74>&#39;[0:2]={16386,16387,16388}&#39;</span>::oid[])[COALESCE(hash_combin_mod(<span style=color:#ae81ff>3</span>, hashint8((ff2.a)::bigint)), <span style=color:#ae81ff>0</span>)]

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> pg_attribute <span style=color:#66d9ef>where</span> attrelid <span style=color:#f92672>=</span> <span style=color:#ae81ff>286766</span> <span style=color:#66d9ef>and</span> attname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a&#39;</span>;

int4<span style=color:#75715e>--&gt;23---&gt;int4_ops---&gt;10020
</span><span style=color:#75715e></span>int8<span style=color:#75715e>--&gt;20---&gt;int8_ops---&gt;10021
</span><span style=color:#75715e></span>

bigint <span style=color:#960050;background-color:#1e0010>的</span> opclass <span style=color:#960050;background-color:#1e0010>是</span> <span style=color:#ae81ff>10020</span> int4_ops <span style=color:#960050;background-color:#1e0010>不正确，</span> <span style=color:#960050;background-color:#1e0010>因该为</span> <span style=color:#ae81ff>10021</span> int8_ops
<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> pg_opclass <span style=color:#66d9ef>where</span> oid <span style=color:#f92672>=</span> <span style=color:#ae81ff>10020</span>;
SetReduceKeyDefaultInfo
CreateExprUsingReduceInfo
ff2.a
<span style=color:#960050;background-color:#1e0010>{</span>
  <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>x5558cb24ea28,
  opclass <span style=color:#f92672>=</span> <span style=color:#ae81ff>10020</span>,
  opfamily <span style=color:#f92672>=</span> <span style=color:#ae81ff>1977</span>
<span style=color:#960050;background-color:#1e0010>}</span>

<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> pg_attribute <span style=color:#66d9ef>where</span> attrelid <span style=color:#f92672>=</span> <span style=color:#ae81ff>286766</span> <span style=color:#66d9ef>and</span> attname <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;a&#39;</span>;

reduce_outer_and_inner_for_join <span style=color:#960050;background-color:#1e0010>中</span>reduce <span style=color:#66d9ef>inner</span> <span style=color:#960050;background-color:#1e0010>或者</span> outter <span style=color:#960050;background-color:#1e0010>的时候，使用的是对应另一边的</span>path的rinfo<span style=color:#960050;background-color:#1e0010>，然后使用函数</span> MakeReduceInfoAs <span style=color:#960050;background-color:#1e0010>进行</span> <span style=color:#66d9ef>copy</span> <span style=color:#960050;background-color:#1e0010>的，他在</span><span style=color:#66d9ef>copy</span> <span style=color:#960050;background-color:#1e0010>的时候只会</span><span style=color:#66d9ef>copy</span> <span style=color:#960050;background-color:#1e0010>除</span> <span style=color:#66d9ef>key</span> <span style=color:#960050;background-color:#1e0010>之外的参数，但是</span> <span style=color:#66d9ef>key</span> <span style=color:#960050;background-color:#1e0010>的</span>  opclass <span style=color:#960050;background-color:#1e0010>和</span> opfamily <span style=color:#960050;background-color:#1e0010>应该是和</span> <span style=color:#66d9ef>key</span> <span style=color:#960050;background-color:#1e0010>绑定的，</span>
<span style=color:#960050;background-color:#1e0010>所以类型不一样的时候</span>
<span style=color:#66d9ef>left</span>  
<span style=color:#960050;background-color:#1e0010>{</span>
  <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> int8<span style=color:#75715e>--&gt;20---&gt;int8_ops---&gt;10021
</span><span style=color:#75715e></span>  opclass <span style=color:#f92672>=</span> <span style=color:#ae81ff>10021</span>,
  opfamily <span style=color:#f92672>=</span> <span style=color:#ae81ff>1977</span>
<span style=color:#960050;background-color:#1e0010>}</span>
<span style=color:#66d9ef>right</span>
<span style=color:#960050;background-color:#1e0010>{</span>
  <span style=color:#66d9ef>key</span> <span style=color:#f92672>=</span> int4<span style=color:#75715e>--&gt;23---&gt;int4_ops---&gt;10020
</span><span style=color:#75715e></span>  opclass <span style=color:#f92672>=</span> <span style=color:#ae81ff>10020</span>,
  opfamily <span style=color:#f92672>=</span> <span style=color:#ae81ff>1977</span>
<span style=color:#960050;background-color:#1e0010>}</span>

<span style=color:#960050;background-color:#1e0010>在</span><span style=color:#66d9ef>copy</span> <span style=color:#960050;background-color:#1e0010>之后会产生错误的</span>keyinfo

create_inner_reduce_info_for_join <span style=color:#66d9ef>before</span>: <span style=color:#ae81ff>0</span>x55a8fe4e4af8: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>1</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>23</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>1</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: (nil): <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#f92672>&lt;&gt;</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
create_inner_reduce_info_for_join <span style=color:#66d9ef>after</span>: <span style=color:#ae81ff>0</span>x55a8fe4e5a28: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#ae81ff>37</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e6c68: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>1</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>23</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>1</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e6dc8: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#ae81ff>37</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e6f28: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>1</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>23</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>1</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e7088: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#ae81ff>37</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10020</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
create_outer_reduce_info_for_join <span style=color:#66d9ef>before</span>: <span style=color:#ae81ff>0</span>x55a8fe4e5078: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: (nil): <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#f92672>&lt;&gt;</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
create_outer_reduce_info_for_join <span style=color:#66d9ef>after</span>: <span style=color:#ae81ff>0</span>x55a8fe4e5a78: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>1</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>23</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>1</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#ae81ff>29</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e7508: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e76f8: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e7968: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>2</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>20</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>2</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>
CopyReduceInfoExtend: <span style=color:#ae81ff>0</span>x55a8fe4e7ac8: <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#66d9ef>key</span>: <span style=color:#960050;background-color:#1e0010>{</span>VAR :varno <span style=color:#ae81ff>1</span> :varattno <span style=color:#ae81ff>1</span> :vartype <span style=color:#ae81ff>23</span> :vartypmod <span style=color:#f92672>-</span><span style=color:#ae81ff>1</span> :varcollid <span style=color:#ae81ff>0</span> :varlevelsup <span style=color:#ae81ff>0</span> :varnosyn <span style=color:#ae81ff>1</span> :varattnosyn <span style=color:#ae81ff>1</span> :<span style=color:#66d9ef>location</span> <span style=color:#ae81ff>29</span><span style=color:#960050;background-color:#1e0010>}</span>, opclass: <span style=color:#ae81ff>10021</span>, opfamily: <span style=color:#ae81ff>1977</span><span style=color:#960050;background-color:#1e0010>}</span>


<span style=color:#960050;background-color:#1e0010>所以在最后</span> CreateExprUsingReduceInfo <span style=color:#960050;background-color:#1e0010>生成表达式的时候，使用了错误的</span>rinfo
fix1<span style=color:#960050;background-color:#1e0010>：</span>
  <span style=color:#960050;background-color:#1e0010>从根本上修改，</span><span style=color:#66d9ef>copy</span> rinfo <span style=color:#960050;background-color:#1e0010>的时候，按照</span> <span style=color:#66d9ef>key</span> <span style=color:#960050;background-color:#1e0010>重新生成</span> opclass <span style=color:#960050;background-color:#1e0010>和</span> opfamily <span style=color:#960050;background-color:#1e0010>，但是后续使用</span> rinfo <span style=color:#960050;background-color:#1e0010>已经将错就错形成一套体系，修改比较大</span>
fix2<span style=color:#960050;background-color:#1e0010>：最终</span><span style=color:#66d9ef>create</span> plan <span style=color:#960050;background-color:#1e0010>的时候</span> fix <span style=color:#960050;background-color:#1e0010>对应类型</span>


</code></pre></div><h4 id=已解决>
已解决
<a href=#%e5%b7%b2%e8%a7%a3%e5%86%b3 class=h-anchor aria-hidden=true>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-patch data-lang=patch><span style=color:#75715e>@@ -2317,6 +2362,26 @@ Expr *CreateExprUsingReduceInfo(ReduceInfo *reduce)
</span><span style=color:#75715e></span>                        for(i=0,nkey=reduce-&gt;nkey;i&lt;nkey;++i)
                        {
                                ReduceKeyInfo *key = &amp;reduce-&gt;keys[i];
<span style=color:#a6e22e>+                               {
</span><span style=color:#a6e22e>+                                       printf(&#34;CreateExprUsingReduceInfo: %p: {key: &#34;, key-&gt;key);
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+                                       char       *s;
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+                                       s = nodeToString((void*)key-&gt;key);
</span><span style=color:#a6e22e>+                                       printf(&#34;%s, &#34;, s);
</span><span style=color:#a6e22e>+                                       pfree(s);
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+                                       printf(&#34;opclass: %d, opfamily: %d}\n&#34;, key-&gt;opclass, key-&gt;opfamily);
</span><span style=color:#a6e22e>+                                       fflush(stdout);
</span><span style=color:#a6e22e>+
</span><span style=color:#a6e22e>+                                       // fix opfamily and opclass
</span><span style=color:#a6e22e>+                                       key-&gt;opclass = ResolveOpClass(NIL,
</span><span style=color:#a6e22e>+                                                                 exprType((Node*)key-&gt;key),
</span><span style=color:#a6e22e>+                                                                       &#34;hash&#34;,
</span><span style=color:#a6e22e>+                                                                 HASH_AM_OID
</span><span style=color:#a6e22e>+                                                                 );
</span><span style=color:#a6e22e>+                                       key-&gt;opfamily = get_opclass_family(key-&gt;opclass);
</span><span style=color:#a6e22e>+                               }
</span><span style=color:#a6e22e></span>                                args = lappend(args, makeHashExprFamily(key-&gt;key, key-&gt;opfamily, get_opclass_input_type(key-&gt;opclass)));
                        }
                        result = (Expr*)makeSimpleFuncExpr(F_HASH_COMBIN_MOD, INT4OID, args);

</code></pre></div><h3 id=1736>
1736
<a href=#1736 class=h-anchor aria-hidden=true>#</a>
</h3>
<p>http://10.20.16.216:9090/ADB/AntDB/-/issues/1736</p>
<table>
<thead>
<tr>
<th>issues</th>
<th></th>
<th>fix</th>
<th>status</th>
<th>\</th>
<th>根本问题</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href=#1490>1490</a></td>
<td></td>
<td></td>
<td>无法复现</td>
<td>scoket close</td>
<td></td>
</tr>
<tr>
<td><a href=#1921>1921</a></td>
<td></td>
<td></td>
<td>无法复现</td>
<td>同上</td>
<td></td>
</tr>
<tr>
<td><a href=#1699>1699</a></td>
<td></td>
<td></td>
<td>无法复现</td>
<td>同上</td>
<td></td>
</tr>
<tr>
<td><a href=#1736>1736</a></td>
<td></td>
<td></td>
<td>无法复现</td>
<td>并行reduce偶发core</td>
<td></td>
</tr>
<tr>
<td><a href=#2103>2103</a></td>
<td></td>
<td></td>
<td>无法复现</td>
<td>gc pgbench 压测<code>can not send message to dynamic reduce for plan: MQ detached</code></td>
<td></td>
</tr>
<tr>
<td><a href=#1779>1779</a></td>
<td>hard</td>
<td>已修复</td>
<td>稳定复现</td>
<td>执行计划错误</td>
<td>子查询存在上层引用，没有处理joinrel的情况</td>
</tr>
<tr>
<td><a href=#1875>1875</a></td>
<td></td>
<td>已定位</td>
<td>稳定复现</td>
<td>数据重分布hang住</td>
<td></td>
</tr>
<tr>
<td><a href=#1938>1938</a></td>
<td>hard</td>
<td>已定位</td>
<td>稳定复现</td>
<td>insert..select..有reduce的时候不支持</td>
<td>执行计划生成错误，在<code>grouping_planner</code>之后的op都可能有问题，修复涉及范围可能太大</td>
</tr>
<tr>
<td><a href=#2085>2085</a></td>
<td>mid</td>
<td>已修复</td>
<td>稳定复现</td>
<td>数据重分布之后数据不正确</td>
<td>使用remote query进行数据重分布的时候，拼接语句序号计算错误，修正序号即可</td>
</tr>
<tr>
<td><a href=#1927>1927</a></td>
<td>easy</td>
<td>已修复</td>
<td>稳定复现</td>
<td>reduce 操作int8 溢出</td>
<td>join 条件左右类型不匹配的时候，构建的表达式错误的向下转型，需要修正</td>
</tr>
</tbody>
</table>
<p>10.21.15.28 AntDB@123!@#</p>
<p>../ADB6_2_FOR_POC/configure &ndash;prefix=/home/maoxp/wen &ndash;disable-cluster &ndash;with-segsize=4 &ndash;with-wal-blocksize=64 &ndash;enable-grammar-oracle &ndash;with-perl &ndash;with-python &ndash;with-pam &ndash;with-ldap &ndash;with-libxml &ndash;with-libxslt &ndash;enable-thread-safety &ndash;disable-debug &ndash;disable-cassert &ndash;enable-depend CFLAGS="-O2 -ggdb3 -fsigned-char -march=armv8-a+crc+lse" &ndash;with-libxml</p>
<p>../ADB6_2_FOR_POC/configure &ndash;prefix=/home/maoxp/app/antdb &ndash;with-segsize=4 &ndash;with-wal-blocksize=64 &ndash;enable-grammar-oracle &ndash;with-perl &ndash;with-python &ndash;with-pam &ndash;with-ldap &ndash;with-libxml &ndash;with-libxslt &ndash;enable-thread-safety &ndash;disable-debug &ndash;disable-cassert &ndash;enable-depend CFLAGS="-O2 -ggdb3 -fsigned-char -march=armv8-a+crc+lse" &ndash;with-libxml</p>
<p>mxp1234@#</p>
<p>sysbench &ndash;db-driver=pgsql &ndash;pgsql-host=172.10.13.28 &ndash;pgsql-port=65032 &ndash;pgsql-user=maoxp &ndash;pgsql-password=mxp1234@# &ndash;pgsql-db=sysbench_db &ndash;time=60 &ndash;report-interval=10 &ndash;events=0 &ndash;percentile=95 &ndash;threads=1 &ndash;table-size=5000000 &ndash;tables=5 /usr/share/sysbench/oltp_insert.lua run</p>
<p>/home/maoxp/wen/bin/initdb -D /home/maoxp/datewen/data
/home/maoxp/wen/bin/createdb maoxp</p>
<p>/home/maoxp/wen/bin/pg_ctl -D /home/maoxp/datewen/data start
/home/maoxp/wen/bin/pg_ctl -D /home/maoxp/datewen/data stop</p>
<p>sysbench &ndash;table_size=50000 &ndash;pgsql-host=172.10.13.28 &ndash;pgsql-port=5432 &ndash;pgsql-user=maoxp &ndash;pgsql-password=mxp1234@# &ndash;pgsql-db=postgres &ndash;db-driver=pgsql &ndash;threads=1 &ndash;tables=5 &ndash;report-interval=5 &ndash;time=120 oltp_insert run</p>
<p>sysbench &ndash;db-driver=pgsql &ndash;pgsql-host=172.10.13.28 &ndash;pgsql-port=65032 &ndash;pgsql-user=maoxp &ndash;pgsql-password=mxp1234@# &ndash;pgsql-db=sysbench_db &ndash;time=2000 &ndash;report-interval=5 &ndash;events=0 &ndash;percentile=95 &ndash;threads=1 &ndash;table-size=5000000 &ndash;tables=5 /usr/share/sysbench/oltp_insert.lua run</p>
<p>DELETE FROM public.sbtest5 sbtest5 WHERE (id = $1);</p>
<p>create table tb2(c1 int,sheet_num varchar(100));
create table tb3(c1 int,order_no varchar(100));
create table tb4( c1 int,c2 varchar(100),c3 int);</p>
<p>explain select count(distinct c2) from tb4 where c2 in (select distinct sheet_num from tb2,tb3 where sheet_num=order_no and c3=1);</p>
<p>create table ttb1( c1 int,c2 varchar(100),c3 varchar(100));
create table ttb2(c1 int,sheet_num varchar(100));
create table ttb3(c1 int,order_no varchar(100));
explain select count(distinct c2) from ttb1 where c2 in (select distinct sheet_num from ttb2,ttb3 where sheet_num=order_no and c3=&lsquo;1&rsquo;);</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://askyx.github.io/posts/cpp/>
<span class=button__icon>←</span>
<span class=button__text>C++ Primer Plus</span>
</a>
</span>
<span class="button next">
<a href=https://askyx.github.io/posts/log/>
<span class=button__text></span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=https://askyx.github.io/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://askyx.github.io/assets/main.js></script>
<script src=https://askyx.github.io/assets/prism.js></script>
</div>
</body>
</html>