<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>executor - mysql_internal</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon.svg">
        <link rel="shortcut icon" href="../../favicon.png">
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        <link rel="stylesheet" href="../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">mysql_internal</h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="executor"><a class="header" href="#executor">executor</a></h1>
<p><a href="https://bbkv6krkep.feishu.cn/docx/YBkudpgiSoUQL1x8W38cKkDInob">2025å¹´å®‰å¯æµ‹è¯„ç ”å‘ä¾§ä»»åŠ¡</a></p>
<p>http://zbox.greatdb.com/zentao/task-view-22442.html</p>
<p><a href="./exec">ç›¸å…³æ–‡æ¡£</a></p>
<h2 id="todo"><a class="header" href="#todo">TODO</a></h2>
<ol>
<li>ç»Ÿä¸€æ¡ˆä¾‹ï¼Œä¿è¯æ¯ä¸ªè¿­ä»£å™¨éƒ½æœ‰ä¸€ä¸ªå¯æ‰§è¡Œå¯è°ƒå¼çš„æ¡ˆä¾‹</li>
<li>è¡¥å……ä¸€äº›è¿­ä»£å™¨çš„å®ç°ç»†èŠ‚</li>
<li>è°ƒæŸ¥åˆ†æè¿­ä»£å™¨çš„ä¼˜åŒ–æ–¹å‘ï¼Œå½“å‰è¿­ä»£å™¨å®ç°å¤æ‚åº¦è¿‡é«˜</li>
</ol>
<h2 id="before-you-read"><a class="header" href="#before-you-read">Before you read</a></h2>
<p>ğŸ˜¹ åªä»‹ç»æ‰§è¡Œå™¨çš„ä¸€äº›ç»†èŠ‚ï¼Œä¸ä¼šä»‹ç»å…·ä½“æ‰§è¡Œè®¡åˆ’æ€ä¹ˆæ¥çš„<br />
ğŸ˜» æ²¡æœ‰ç»†è‡´ä»‹ç»æ¯ä¸ªç®—å­çš„å®ç°ç»†èŠ‚ï¼Œåªæ˜¯ç³»ç»Ÿæ€§çš„åšäº†ä¸€äº›æ€»ç»“ï¼Œåç»­å¯èƒ½ä¼šè¡¥å……ï¼Ÿ</p>
<h2 id="æ¦‚è¿°"><a class="header" href="#æ¦‚è¿°">æ¦‚è¿°</a></h2>
<p>MySQLæ‰§è¡Œå™¨çš„æ¶æ„ä½“ç°äº†ç°ä»£æ•°æ®åº“ç³»ç»Ÿçš„è®¾è®¡ç†å¿µï¼Œé€šè¿‡<strong>è¿­ä»£å™¨æ¨¡å¼</strong><sup class="footnote-reference" id="fr-Iteator-1"><a href="#footnote-Iteator">1</a></sup>å®ç°äº†æ‰§è¡Œæ“ä½œçš„æ ‡å‡†åŒ–å’Œæ¨¡å—åŒ–ã€‚è¿™ç§è®¾è®¡ä¸ä»…æé«˜äº†ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œ
è¿˜ä¸ºæ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½æ‰©å±•æä¾›äº†è‰¯å¥½çš„åŸºç¡€ã€‚æ•´ä¸ªæ‰§è¡Œå™¨ä¸æŸ¥è¯¢ä¼˜åŒ–å™¨ã€å­˜å‚¨å¼•æ“ç´§å¯†é…åˆï¼Œå½¢æˆäº†MySQLæŸ¥è¯¢å¤„ç†çš„å®Œæ•´æµæ°´çº¿ã€‚</p>
<p>è¿­ä»£æ¨¡å‹/ç«å±±æ¨¡å‹ï¼ˆIterator Modelï¼‰ä½œä¸ºä¸šç•Œå¸¸è§çš„æ‰§è¡Œæ¨¡å‹ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯å°†æ¯ä¸€ç§æ“ä½œæŠ½è±¡ä¸ºä¸€ä¸ª Operatorï¼Œ
æ•´ä¸ª SQL æŸ¥è¯¢è¢«æ„å»ºæˆä¸€ä¸ª Operator æ ‘ã€‚æŸ¥è¯¢æ‰§è¡Œæ—¶ï¼Œæ ‘è‡ªé¡¶å‘ä¸‹è°ƒç”¨ next() æ¥å£ï¼Œæ•°æ®åˆ™è‡ªåº•å‘ä¸Šè¢«æ‹‰å–å¤„ç†ï¼Œ
å› æ­¤è¿™ç§å¤„ç†æ–¹å¼ä¹Ÿè¢«ç§°ä¸ºæ‹‰å–æ‰§è¡Œæ¨¡å‹ï¼ˆPull Basedï¼‰ã€‚ç«å±±æ¨¡å‹å› å…¶å…·æœ‰å¾ˆé«˜çµæ´»æ€§é«˜ã€å¯æ‰©å±•æ€§å¥½ã€æ˜“äºå®ç°å’Œä¼˜åŒ–ç­‰ç‰¹æ€§ï¼Œè¢«å¹¿æ³›åº”ç”¨äºæ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–å’Œæ‰§è¡Œä¸­ã€‚</p>
<p><img src="https://youke1.picui.cn/s1/2025/07/18/6879fd883518b.png" alt="Iteator" /></p>
<blockquote>
<p>ä¸€èˆ¬å®ç°æ˜¾å¼æŒ‡å®šç®—å­çš„è¿”å›æ•°æ®ï¼Œä½†æ˜¯ MySQL éšè—è¿™ä¸ªè¿‡ç¨‹ï¼Œæ‰§è¡Œå™¨ä¸­çš„æ•°æ®æµåŠ¨å®é™…æ˜¯ä¾èµ–äºè¡¨æˆ–è€…å…¶ä»–ç®—å­çš„å†…å­˜ç®¡ç†</p>
</blockquote>
<h2 id="handler"><a class="header" href="#handler">handler</a></h2>
<p>å­˜å‚¨å¼•æ“å±‚é‡‡ç”¨å¯åŠ¨æ€åŠ è½½çš„æ’ä»¶å½¢å¼ï¼Œä¸ºæ–¹ä¾¿æ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œå°†å­˜å‚¨å¼•æ“æ¥å£è¿›è¡ŒæŠ½è±¡åŒ–ï¼Œserver å±‚é€šè¿‡ç»Ÿä¸€çš„æ¥å£è®¿é—®å­˜å‚¨å¼•æ“ï¼Œ
è¯¥æŠ½è±¡ç±»å³ä¸º handlerã€‚å„ä¸ªå­˜å‚¨å¼•æ“åªéœ€è¦å®ç° handler ç›¸åº”çš„æ¥å£ï¼Œserver å±‚å³å¯è®¿é—®è¯¥å­˜å‚¨å¼•æ“ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼Œ handlerton æ˜¯MySQLä¸­å­˜å‚¨å¼•æ“ä¸æœåŠ¡å™¨å±‚ä¹‹é—´çš„æ ¸å¿ƒæ¥å£ç»“æ„ä½“ï¼Œå®ƒä½œä¸ºå•ä¾‹æ¨¡å¼å­˜åœ¨ï¼Œä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„å­˜å‚¨å¼•æ“ã€‚ä»–å®šä¹‰äº†å’Œå…·ä½“å¾—è¡¨æ— å…³çš„
å­˜å‚¨å¼•æ“ç›¸å…³çš„æ“ä½œæ¥å£ï¼Œä¾‹å¦‚åˆ›å»º handleï¼Œè¡¨ç©ºé—´ç®¡ç†ç­‰ã€‚</p>
<pre><code class="language-c++">static handlerton *installed_htons[128];

enum legacy_db_type {
  DB_TYPE_UNKNOWN = 0,
  DB_TYPE_DIAB_ISAM = 1,
  DB_TYPE_HASH,
  DB_TYPE_MISAM,
  DB_TYPE_PISAM,
  DB_TYPE_RMS_ISAM,
  DB_TYPE_HEAP,
  DB_TYPE_ISAM,
  DB_TYPE_MRG_ISAM,
  DB_TYPE_MYISAM,
  DB_TYPE_MRG_MYISAM,
  DB_TYPE_BERKELEY_DB,
  DB_TYPE_INNODB,
  DB_TYPE_GEMINI,
  DB_TYPE_NDBCLUSTER,
  DB_TYPE_EXAMPLE_DB,
  DB_TYPE_ARCHIVE_DB,
  DB_TYPE_CSV_DB,
  DB_TYPE_FEDERATED_DB,
  DB_TYPE_BLACKHOLE_DB,
  DB_TYPE_PARTITION_DB,  // No longer used.
  DB_TYPE_BINLOG,
  DB_TYPE_SOLID,
  DB_TYPE_PBXT,
  DB_TYPE_TABLE_FUNCTION,
  DB_TYPE_MEMCACHE [[deprecated]],
  DB_TYPE_FALCON,
  DB_TYPE_MARIA,
  /** Performance schema engine. */
  DB_TYPE_PERFORMANCE_SCHEMA,
  DB_TYPE_TEMPTABLE,
  DB_TYPE_FIRST_DYNAMIC = 42,
  DB_TYPE_DEFAULT = 127  // Must be last
};

</code></pre>
<p>handler æ¥å£å®šä¹‰äº†å­˜å‚¨å¼•æ“çš„åŸºæœ¬æ“ä½œï¼ŒåŒ…æ‹¬è¡¨çš„åˆ›å»ºã€åˆ é™¤ã€æ‰“å¼€ã€å…³é—­ã€æ’å…¥ã€åˆ é™¤ã€æ›´æ–°ã€æŸ¥è¯¢ç­‰ã€‚handler æ¥å£çš„å…·ä½“å®ç°ç”±å„ä¸ªå­˜å‚¨å¼•æ“è‡ªè¡Œå®ç°ï¼Œ
æ²¡æœ‰è¦æ±‚å­˜å‚¨å¼•æ“å¿…é¡»å®ç°å…¨éƒ¨çš„æ¥å£ï¼Œé™¤äº†å°‘éƒ¨åˆ†æ ¸å¿ƒæ“ä½œå®šä¹‰ä¸ºçº¯è™šå‡½æ•°ä¹‹å¤–ï¼Œå…¶ä»–å¤§éƒ¨åˆ†æ¥å£æ˜¾ç„¶æ˜¯å¯é€‰çš„ï¼›å­˜å‚¨å¼•æ“å¯ä»¥æŒ‰ç…§è‡ªå·±çš„ç‰¹ç‚¹æŒ‰éœ€å®ç°ï¼Œ
ä¾‹å¦‚ InnoDB å­˜å‚¨å¼•æ“å®ç°äº†äº‹åŠ¡ç›¸å…³çš„æ¥å£ï¼Œè€Œ MyISAM åˆ™æ²¡æœ‰å®ç°è¿™äº›æ¥å£ï¼Œblackholeæ²¡æœ‰ä½¿ç”¨æ›´æ–°åˆ é™¤ç­‰æ¥å£ã€‚</p>
<p>ä¸€äº›é‡ç‚¹æ¥å£å¦‚ä¸‹:</p>
<div class="table-wrapper"><table><thead><tr><th>function</th><th>desc</th></tr></thead><tbody>
<tr><td>ha_rnd_next</td><td>éšæœºè¯»å–ä¸‹ä¸€è¡Œæ•°æ®ï¼Œä¸€èˆ¬ç”¨äº seqscan</td></tr>
<tr><td>ha_index_init</td><td>åˆå§‹åŒ– index æ‰«æ</td></tr>
<tr><td>ha_index_first</td><td>è¯»å–æŒ‡å®š index çš„ç¬¬ä¸€è¡Œ</td></tr>
<tr><td>ha_index_next</td><td>è¯»å–æŒ‡å®š index çš„ä¸‹ä¸€è¡Œ</td></tr>
<tr><td>ha_index_read_map</td><td>æŒ‡å®šè¯»å–æ»¡è¶³ key çš„è¡Œ</td></tr>
<tr><td>ha_index_next_same</td><td>è¯»å–æŒ‡å®šæ»¡è¶³ key çš„ä¸‹ä¸€è¡Œ</td></tr>
<tr><td>multi_range_read_init</td><td>åˆå§‹åŒ– mrr æ‰«æ</td></tr>
<tr><td>ha_multi_range_read_next</td><td>è¯»å– mrr ä¸‹ä¸€è¡Œ</td></tr>
</tbody></table>
</div>
<h2 id="è¡¨è¾¾å¼"><a class="header" href="#è¡¨è¾¾å¼">è¡¨è¾¾å¼</a></h2>
<!-- è¡¨è¾¾å¼ä»æ˜¯å¦éœ€è¦ä¿å­˜è¿è¡ŒçŠ¶æ€å¯ä»¥åˆ†ä¸ºæ— çŠ¶æ€è¡¨è¾¾å¼å’Œæœ‰çŠ¶æ€è¡¨è¾¾å¼ï¼Œæ— çŠ¶æ€è¡¨è¾¾å¼ä¸€èˆ¬æ˜¯ä¸€äº›ç®€å•è¡¨è¾¾å¼ï¼Œæ•°æ®è¾“å…¥å†è¾“å‡ºä¹‹åç”Ÿå‘½å‘¨æœŸå°±ç»“æŸäº†ï¼Œå’Œä¸‹æ¬¡è¿è¡Œæ— å…³ï¼Œä¾‹å¦‚è¡¨è¾¾å¼è¿ç®—ï¼›æœ‰çŠ¶æ€çš„è¡¨è¾¾å¼éœ€è¦å†ä¸€å®šæ—¶é—´æ®µå†…ä¿å­˜è¿è¡Œä¿¡æ¯ï¼Œä¾‹å¦‚èšåˆè¡¨è¾¾å¼ sumï¼Œéœ€è¦è¿›è¡Œç´¯åŠ æ“ä½œã€‚
ä¹Ÿå¯ä»¥ä»æ˜¯å¦ç¨³å®šæ¥å»åŒºåˆ†ï¼Œ -->
<p>SQL è¯­å¥ä¸­çš„è¡¨è¾¾å¼è¿ç®—ä½¿ç”¨çš„æ˜¯ Item çš„ val_xx æ¥å£ï¼Œåœ¨æ‰§è¡Œä¸­ç›´æ¥è°ƒç”¨å¯¹åº”çš„æ¥å£è·å–å€¼ï¼Œä¾‹å¦‚
filter é¢„æœŸå¾—åˆ°çš„ç»“æœæ˜¯ boolï¼Œç›´æ¥è°ƒç”¨ <code>m_condition-&gt;val_int()</code> è·å¾—æ¡ä»¶çš„å€¼ã€‚</p>
<ol>
<li>
<p>æ¡ä»¶è¿ç®—</p>
<ul>
<li>å¦‚æœæ˜¯å¸¸é‡ï¼Œç›´æ¥ Item æœ¬èº«å°±ä¿å­˜æœ‰å…·ä½“çš„å€¼ï¼Œç›´æ¥è°ƒç”¨ val_xx æ¥å£è·å–å€¼</li>
<li>å¦‚æœæ˜¯ Fieldï¼Œéœ€è¦ç¡®ä¿ Field çš„æ•°æ®å·²ç»è¢«å¡«å……ï¼Œå³å…³è”çš„è¡¨å·²ç»è¯»å–å¯¹åº”çš„å€¼</li>
</ul>
</li>
<li>
<p>å­æŸ¥è¯¢</p>
<ul>
<li>
<p>å­æŸ¥è¯¢éœ€è¦åŒºåˆ†ç›¸å…³å­æŸ¥è¯¢å’Œéç›¸å…³å­æŸ¥è¯¢ï¼Œ</p>
<ul>
<li>å¯¹äºéç›¸å…³å­æŸ¥è¯¢ï¼ŒMySQL å…è®¸éç›¸å…³å­æŸ¥è¯¢åœ¨ä¼˜åŒ–é˜¶æ®µç›´æ¥ç‰©åŒ–ï¼Œæ­¤æ—¶æ‰§è¡Œè®¡åˆ’æ˜¾ç¤º <code>Rows fetched before execution</code></li>
<li>å¯¹äºç›¸å…³å­æŸ¥è¯¢ï¼Œåœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ Item_subselect è¡¨ç¤ºï¼Œè¡¨è¾¾å¼è®¡ç®—çš„æ—¶å€™æœ€ç»ˆè°ƒç”¨ <code>Item_subselect::exec</code> è·å–å­æŸ¥è¯¢çš„å€¼</li>
</ul>
<pre><code class="language-c++">// éç›¸å…³å­æŸ¥è¯¢ä½¿ç”¨ optimize_derived ç›´æ¥ç‰©åŒ–å­æŸ¥è¯¢
#0  TableScanIterator::Read (this=0x718bc4a89920) at sql/iterators/basic_row_iterators.cc:286
#1  0x000063674e8ae103 in FilterIterator::Read (this=0x718bc4a89970) at sql/iterators/composite_iterators.cc:93
#2  0x000063674e8aeb93 in AggregateIterator::Read (this=0x718bc4a89998) at sql/iterators/composite_iterators.cc:333
#3  0x000063674e4c95fe in Query_expression::ExecuteIteratorQuery (this=0x718bc4e1fc58, thd=0x718bc4d871a0) at sql/sql_union.cc:1832
#4  0x000063674e4c9a05 in Query_expression::execute (this=0x718bc4e1fc58, thd=0x718bc4d871a0) at sql/sql_union.cc:1888
#5  0x000063674e27bc29 in Table_ref::materialize_derived (this=0x718bc4e27cd0, thd=0x718bc4d871a0) at sql/sql_derived.cc:1843
#6  0x000063674e27b63c in Table_ref::optimize_derived (this=0x718bc4e27cd0, thd=0x718bc4d871a0) at sql/sql_derived.cc:1728
#7  0x000063674e306f54 in JOIN::optimize (this=0x718bc4a875d8, finalize_access_paths=true) at sql/sql_optimizer.cc:441
#8  0x000063674e3eef91 in Query_block::optimize (this=0x718bc4da0698, thd=0x718bc4d871a0, finalize_access_paths=true) at sql/sql_select.cc:2147
#9  0x000063674e4c60e9 in Query_expression::optimize (this=0x718bc4da05a0, thd=0x718bc4d871a0, materialize_destination=0x0, create_iterators=true, finalize_access_paths=true)
    at sql/sql_union.cc:1030
#10 0x000063674e3ec6be in Sql_cmd_dml::execute_inner (this=0x718bc4e29b70, thd=0x718bc4d871a0) at sql/sql_select.cc:1125


// ç›¸å…³å­æŸ¥è¯¢åœ¨è¡¨è¾¾å¼è¿ç®—çš„æ—¶å€™ï¼Œè°ƒç”¨å­æŸ¥è¯¢è·å¾—ç»“æœ
#0  RefIterator&lt;false&gt;::Read (this=0x718bc4a895b8) at sql/iterators/ref_row_iterators.cc:359
#1  0x000063674e8aeb93 in AggregateIterator::Read (this=0x718bc4a89600) at sql/iterators/composite_iterators.cc:333
#2  0x000063674e8ae103 in FilterIterator::Read (this=0x718bc4a89920) at sql/iterators/composite_iterators.cc:93
#3  0x000063674e8ae72e in LimitOffsetIterator::Read (this=0x718bc4a89948) at sql/iterators/composite_iterators.cc:246
#4  0x000063674e4c95fe in Query_expression::ExecuteIteratorQuery (this=0x718bc4e20878, thd=0x718bc4d871a0) at sql/sql_union.cc:1832
#5  0x000063674e4c9a05 in Query_expression::execute (this=0x718bc4e20878, thd=0x718bc4d871a0) at sql/sql_union.cc:1888
#6  0x000063674de5e6cc in Item_subselect::exec (this=0x718bc4e1f000, thd=0x718bc4d871a0) at sql/item_subselect.cc:786
#7  0x000063674de5ed1f in Item_in_subselect::exec (this=0x718bc4e1f000, thd=0x718bc4d871a0) at sql/item_subselect.cc:892
#8  0x000063674de62b22 in Item_in_subselect::val_bool_naked (this=0x718bc4e1f000) at sql/item_subselect.cc:1863
#9  0x000063674dceef68 in Item_in_optimizer::val_int (this=0x718bc4e2a128) at sql/item_cmpfunc.cc:2634
#10 0x000063674e8ae135 in FilterIterator::Read (this=0x718bc4a891b0) at sql/iterators/composite_iterators.cc:96
#11 0x000063674e4c95fe in Query_expression::ExecuteIteratorQuery (this=0x718bc4da05a0, thd=0x718bc4d871a0) at sql/sql_union.cc:1832
#12 0x000063674e4c9a05 in Query_expression::execute (this=0x718bc4da05a0, thd=0x718bc4d871a0) at sql/sql_union.cc:1888
#13 0x000063674e3ec800 in Sql_cmd_dml::execute_inner (this=0x718bc4e29a28, thd=0x718bc4d871a0) at sql/sql_select.cc:1152
#14 0x000063674e3eb831 in Sql_cmd_dml::execute (this=0x718bc4e29a28, thd=0x718bc4d871a0) at sql/sql_select.cc:823
#15 0x000063674e34d5bb in mysql_execute_command (thd=0x718bc4d871a0, first_level=true) at sql/sql_parse.cc:5271
</code></pre>
</li>
</ul>
</li>
</ol>
<h2 id="ä¸´æ—¶æ•°æ®"><a class="header" href="#ä¸´æ—¶æ•°æ®">ä¸´æ—¶æ•°æ®</a></h2>
<p>åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæœ‰çš„è¿­ä»£å™¨ä¸æ˜¯ç«‹åˆ»å°±èƒ½è¾“å‡ºæ•°æ®ï¼Œéœ€è¦å¯¹æ•°æ®è¿›è¡Œä¸€å®šå¤„ç†ä¹‹åï¼Œæ‰èƒ½è¿›è¡Œè¾“å‡ºï¼Œæ­¤æ—¶å¯èƒ½æœ‰ä¸€äº›ä¸´æ—¶æ•°æ®åœ¨ï¼Œéœ€è¦è¿›è¡Œä¿å­˜ï¼Œ
å½“å‰MySQL ä¸­ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯ä½¿ç”¨ä¸´æ—¶è¡¨ï¼Œè€Œæ˜¯è‡ªå·±ä½¿ç”¨ buffer è¿›è¡Œç®¡ç†ã€‚</p>
<ol>
<li>
<p>ä½¿ç”¨ä¸´æ—¶è¡¨ä¿å­˜æ•°æ®<br />
ä½¿ç”¨ä¸´æ—¶è¡¨çš„è¿­ä»£å™¨æœ‰ä¸ªç‰¹ç‚¹æ˜¯åœ¨åˆå§‹åŒ–çš„æ—¶å€™ç›´æ¥è¯»å–ä¸‹å±‚è¿­ä»£å™¨ï¼Œå¡«å……ä¸´æ—¶è¡¨ï¼Œè€Œåœ¨ read çš„æ—¶å€™ç›´æ¥ä»ä¸´æ—¶è¡¨è¯»å–æ•°æ®</p>
<blockquote>
<p>TODO: å­æŸ¥è¯¢å­˜åœ¨ä¸Šå±‚å¼•ç”¨ï¼Ÿ</p>
</blockquote>
<ul>
<li><code>MaterializeIterator</code></li>
<li><code>StreamingIterator</code></li>
<li><code>MaterializedTableFunctionIterator</code></li>
<li><code>WeedoutIterator</code></li>
<li><code>TemptableAggregateIterator</code></li>
<li><code>MaterializeInformationSchemaTableIterator</code></li>
<li><code>WindowIterator</code></li>
</ul>
</li>
<li>
<p>ä½¿ç”¨ buffer
è‡ªå·±ä½¿ç”¨ buffer ç®¡ç†ï¼Œå½“å‰æœ‰ä¸‹é¢å‡ ä¸ªè¿­ä»£å™¨æœ‰ç±»ä¼¼çš„æœºåˆ¶</p>
<blockquote>
<p>PS: å½“å‰æ²¡æœ‰ç»Ÿä¸€çš„å®ç°ï¼Œéƒ½æ˜¯ä¸“äººä¸“ç”¨</p>
</blockquote>
<ul>
<li><code>SortingIterator</code></li>
<li><code>HashIterator</code></li>
<li><code>BKAIterator</code></li>
</ul>
</li>
</ol>
<blockquote>
<p>ä½¿ç”¨ä¸´æ—¶è¡¨ä¿å­˜ä¸´æ—¶æ•°æ®çš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œä½†æ˜¯ç¼ºç‚¹æ˜¯è¿è¡Œä¸­è¿˜éœ€è¦è¿›è¡Œè¡¨çš„ç®¡ç†ï¼Œè€¦åˆåº¦å¤ªé«˜</p>
</blockquote>
<h2 id="æ‰§è¡Œè®¡åˆ’"><a class="header" href="#æ‰§è¡Œè®¡åˆ’">æ‰§è¡Œè®¡åˆ’</a></h2>
<h2 id="æ•°æ®æµåŠ¨é—®é¢˜"><a class="header" href="#æ•°æ®æµåŠ¨é—®é¢˜">æ•°æ®æµåŠ¨é—®é¢˜</a></h2>
<h3 id="é‡æ–°è®¤è¯†-table"><a class="header" href="#é‡æ–°è®¤è¯†-table">é‡æ–°è®¤è¯† TABLE</a></h3>
<p>struct TABLE æ˜¯ MySQL ä¸­æœ€æ ¸å¿ƒçš„æ•°æ®ç»“æ„ä¹‹ä¸€ï¼Œå®ƒè¡¨ç¤ºåœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé—´å†…å­˜ä¸­çš„ä¸€ä¸ªè¡¨å®ä¾‹ã€‚è¯¥ç»“æ„ä½“å®šä¹‰åœ¨ sql/table.h æ–‡ä»¶ä¸­ï¼Œ</p>
<p>TABLE ä¼šä¿å­˜ Field å­—æ®µï¼Œå¯¹åº”è¡¨çš„åˆ—</p>
<ul>
<li>Field æŒ‰ç…§å…·ä½“çš„ç±»å‹å¯¹åº”ä¸åŒçš„å­ç±»å®ç°ï¼Œé™¤äº†ä¿å­˜æ­£å¸¸çš„ç±»å‹ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜ä¿å­˜ä¸€ä¸ªå¯¹åº”å€¼çš„æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ TABLE::record å­—æ®µ</li>
<li>TABLE::record æ˜¯ char* ç±»å‹ï¼Œè¡¨ç¤ºçš„æ˜¯è¡¨åœ¨æŸä¸€åˆ»çš„å…·ä½“çš„æŒæœ‰çš„å€¼ï¼Œå…·ä½“å‚è€ƒ open_table_from_share</li>
<li>TABLE ä¸ä»…ä»…åªæ˜¯é€»è¾‘ä¸Šçš„è¡¨ï¼Œè¿˜æ˜¯å…·ä½“çš„å†…å­˜ä¸­çš„å®ä½“è¡¨ï¼ŒæŒæœ‰æ•°æ®é‚£ç§ï¼Œåœ¨è¿è¡Œé˜¶æ®µï¼Œå¯ä»¥ä» table ä¸­è·å–æ•°æ®</li>
</ul>
<h3 id="field"><a class="header" href="#field">Field</a></h3>
<p>Field å’Œ Item_field å­˜åœ¨ä¸€å®šçš„å·®å¼‚ï¼Œä»–ä»¬çš„å…³ç³»æ˜¯</p>
<ul>
<li>Field æ˜¯ TABLE ç»“æ„ä½“ä¸­ç”¨äºç®¡ç†åˆ—ä»¥åŠåˆ—æ•°æ®ï¼ŒåŒ…å«å…·ä½“æ•°æ®å’Œæ•°æ®ç±»å‹</li>
<li>è€Œ Item_field ç”¨äºç®¡ç† Fieldï¼Œç”¨äºå‚ä¸è¡¨è¾¾å¼è¿ç®—</li>
</ul>
<h3 id="query_result"><a class="header" href="#query_result">Query_result</a></h3>
<p>å¤„ç†è¿­ä»£å™¨çš„è¾“å‡ºçš„æ•°æ®ï¼Œæœ‰ä¸åŒçš„å­ç±»å®ç°ï¼Œç”¨äºå¤„ç†è¿­ä»£å™¨çš„è¾“å‡ºï¼Œæˆ–è€…ä¸€äº›ä¸­é—´æ•°æ®ï¼Œä¸€èˆ¬ä¼ é€’æ•°æ®åˆ°å®¢æˆ·ç«¯ä½¿ç”¨çš„æ˜¯ Query_result_send</p>
<p>å½“å‰çš„ç»§æ‰¿å…³ç³»</p>
<pre><code class="language-shell">Query_result_send		                    // å‘é€æ•°æ®åˆ°å®¢æˆ·ç«¯
    Query_result_explain		            // å…·ä½“çš„Query_resultçš„åŒ…è£…ç±»ï¼Œç”¨äºå®ç°explain
        Query_result_explain_into_var		// ç”¨äºæŠŠexplainçš„ç»“æœè¾“å‡ºåˆ°æŒ‡å®šå˜é‡
    Query_fetch_protocol_binary		        // ä½¿ç”¨äºŒè¿›åˆ¶åè®®å‘é€æ¸¸æ ‡è¡Œçš„ç»“æœ
Query_result_do		                        // DO stmt ä½¿ç”¨
Query_result_interceptor		            // è¿è¡Œä¸­æ•°æ®è½¬å‘ï¼Œç”±äºä¸éœ€è¦å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥ä¸éœ€è¦è®¾ç½®å…ƒæ•°æ®ä¿¡æ¯
    Query_result_null		                // ä¸è¾“å‡ºæ•°æ®ï¼Œç”¨äºexplain analyze
    Query_result_to_file		            // è¾“å‡ºç»“æœåˆ°æ–‡ä»¶
        Query_result_export		            // è¾“å‡ºç»“æœåˆ°æ–‡ä»¶ï¼Œåªè¾“å‡ºæ•°æ®
        Query_result_dump		            // è¾“å‡ºç»“æœåˆ°æ–‡ä»¶ï¼Œä»¥è¯­å¥çš„å½¢å¼
    Query_dumpvar		                    // å¯¼å‡ºå˜é‡
    Query_result_subquery		            // å¤„ç†å­æŸ¥è¯¢çš„åŸºç±»
        Query_result_scalar_subquery		// æ ‡é‡å’Œè¡Œå­æŸ¥è¯¢çš„æŸ¥è¯¢ç»“æœ
        Query_result_max_min_subquery		// ç”¨äºç‹¬ç«‹çš„ ALL/ANY æŸ¥è¯¢
        Query_result_exists_subquery		// å¤„ç† exists è¯­å¥ï¼Œåªåˆ¤æ–­æ˜¯å¦æœ‰ç»“æœ
    Query_fetch_into_spvars		            // ç”¨äºå¤„ç†spä¸­çš„æ¸¸æ ‡çš„å€¼
    Query_result_delete		                // ç”¨äºå¤„ç†deleteè¯­å¥ï¼Œæ˜¯ä¸€ä¸ªç©ºæ“ä½œ
    Query_result_insert		                // ç”¨äºå¤„ç† insert into select è¯­å¥ä¸­ï¼Œ æŸ¥è¯¢è¯­å¥çš„ç»“æœï¼Œè½¬å‘åˆ°ç›®æ ‡è¡¨ä¸­
        Query_result_create		            // ç±»ä¼¼ Query_result_insertï¼Œä½†æ˜¯æ˜¯create as select è¯­å¥
    Query_result_union		                // ç”¨äº union è¯­å¥
        Query_result_materialize		    // ç”¨äºå¤„ç†æ¸¸æ ‡ï¼Œä¿å­˜æ¸¸æ ‡çš„æ•°æ®
        Query_result_union_direct		    // å·²åºŸå¼ƒ
    Query_result_update		                // ç”¨äºæ›´æ–°è¯­å¥
</code></pre>
<p>å½“æ‰§è¡Œ <code>select * from t1</code> çš„æ—¶å€™ï¼Œè°ƒç”¨å †æ ˆå¦‚ä¸‹</p>
<pre><code class="language-c++">#0  Protocol_text::store_long (this=0x705581119a30, from=5, zerofill=0) at sql/protocol_classic.cc:3402
#1  0x00005c1a439ecdc2 in Field_long::send_to_protocol (this=0x7055817fc8f0, protocol=0x705581119a30) at sql/field.cc:4427
#2  0x00005c1a43b6113c in Protocol_classic::store_field (this=0x705581119a30, field=0x7055817fc8f0) at sql/protocol_classic.cc:1283
#3  0x00005c1a42e82acb in Item_field::send (this=0x705581826648, protocol=0x705581119a30) at sql/item.cc:9823
#4  0x00005c1a433dfec0 in THD::send_result_set_row (this=0x7055800084f0, row_items=mem_root_deque&lt;Item *&gt; with 2 = {...}) at sql/sql_class.cc:3364
#5  0x00005c1a432b5dc1 in Query_result_send::send_data (this=0x705581826620, thd=0x7055800084f0, items=mem_root_deque&lt;Item *&gt; with 2 = {...})
    at sql/query_result.cc:109
#6  0x00005c1a4368a70d in Query_expression::ExecuteIteratorQuery (this=0x7055818234a0, thd=0x7055800084f0) at sql/sql_union.cc:1847
#7  0x00005c1a4368aa05 in Query_expression::execute (this=0x7055818234a0, thd=0x7055800084f0) at sql/sql_union.cc:1888
</code></pre>
<p>å…¶ä¸­æœ‰å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<ol>
<li>Item æœ‰å®šä¹‰ send å‡½æ•°ï¼Œç”¨äºå°†æ•°æ®å‘é€åˆ°åè®®å±‚</li>
<li>Field æœ‰å®šä¹‰ send_to_protocol å‡½æ•°ï¼Œç”¨äºå°†æ•°æ®å‘é€åˆ°åè®®å±‚</li>
<li>Field ä¸­æœ‰æŒ‡å‘ TABLE::record çš„æŒ‡é’ˆï¼Œç”¨äºä¿å­˜å…·ä½“çš„æ•°æ®ï¼Œæ‰€ä»¥æœ€ç»ˆçš„æ•°æ®æ˜¯æ¥è‡ª TABLE</li>
</ol>
<h2 id="iteator"><a class="header" href="#iteator">Iteator</a></h2>
<p>å½“å‰(MySQL8.4.4) ä¸­å…±æœ‰ 55 ç§è¿­ä»£å™¨</p>
<ul>
<li>RowIterator
å®šä¹‰è¿­ä»£å™¨çš„æ¥å£</li>
<li>TableRowIterator
æŒæœ‰ä¸€ä¸ªè¡¨ï¼Œè¿­ä»£å™¨ç”¨äºè®¿é—®è¡¨ä¸­çš„æ•°æ®ï¼Œå¦ä¸€å±‚æ„æ€æ˜¯å½“å‰è¿­ä»£å™¨å’Œä¸Šä¸€å±‚è¿­ä»£å™¨çš„æ•°æ®ä¸æ˜¯ç”¨ä¸€ä¸ªè¡¨ï¼Œå¦‚æœéœ€è¦ä¼ é€’æ•°æ®åˆ°ä¸‹å±‚ï¼Œéœ€è¦è¿›è¡Œæ‹·è´ï¼Œä¾‹å¦‚ StreamingIterator</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>class</th><th>extend from</th><th>desc</th></tr></thead><tbody>
<tr><td><a href="#tablescaniterator">TableScanIterator</a></td><td>RowIterator</td><td>é¡ºåºæ‰«æï¼Œè°ƒç”¨å­˜å‚¨å¼•æ“æ¥å£ ha_rnd_next è·å–ä¸€è¡Œè®°å½•</td></tr>
<tr><td><a href="#indexscaniterator">IndexScanIterator</a></td><td>RowIterator</td><td>å…¨é‡ç´¢å¼•æ‰«æï¼Œæ ¹æ®æ‰«æé¡ºåºï¼Œåˆ†åˆ«è°ƒç”¨ha_index_nextæˆ–è€…ha_index_prevæ¥è·å–ä¸€è¡Œè®°å½•</td></tr>
<tr><td>RefIterator</td><td>TableRowIterator</td><td>index ç‚¹æŸ¥ï¼Œæ”¯æŒ col = xxx å½¢å¼çš„æŸ¥è¯¢ï¼Œå¯èƒ½æœ‰å¤šè¡Œæ»¡è¶³æ¡ä»¶</td></tr>
<tr><td>RefOrNullIterator</td><td>TableRowIterator</td><td>ç±»ä¼¼ RefIteratorï¼Œä½†æ˜¯é™¤äº†è¿”å›åŒ¹é…çš„ç»“æœä¹‹å¤–ï¼Œè¿˜æ˜¯è¿”å›ç­‰äºnullå¾—ç»“æœ</td></tr>
<tr><td>EQRefIterator</td><td>TableRowIterator</td><td>ç±»ä¼¼ RefIteratorï¼Œä½†æ˜¯ç¡®å®šç­‰å€¼æŸ¥è¯¢è‡³å¤šåªæœ‰ä¸€è¡Œèƒ½æ»¡è¶³æ¡ä»¶ï¼Œä¾‹å¦‚ä¸»é”®æˆ–è€…unique,ä¼šç¼“å­˜ä¸Šæ¬¡çš„æŸ¥è¯¢çš„å€¼ï¼Œå‡å°‘å’Œå­˜å‚¨å¼•æ“çš„äº¤äº’æ¬¡æ•°</td></tr>
<tr><td>PushedJoinRefIterator</td><td>TableRowIterator</td><td>desc</td></tr>
<tr><td>IndexDistanceScanIterator</td><td>RowIterator</td><td>ç”¨äºæ”¯æŒç©ºé—´ç±»å‹çš„ full index scan</td></tr>
<tr><td><a href="#groupindexskipscaniterator">GroupIndexSkipScanIterator</a></td><td>TableRowIterator</td><td>å¯¹äº gourp min/max çš„ç‰¹æ®Šä¼˜åŒ–ï¼Œç›´æ¥å®šä½ index çš„æŸä¸€è¡Œè€Œä¸è¿›è¡Œæ‰«ææ“ä½œ</td></tr>
<tr><td><a href="#indexskipscaniterator">IndexSkipScanIterator</a></td><td>TableRowIterator</td><td>index çš„è·³è·ƒå¼æ‰«æï¼Œå‡å°‘æ‰«æçš„æ— æ•ˆè¡Œæ•°</td></tr>
<tr><td><a href="#indexrangescaniterator">IndexRangeScanIterator</a></td><td>RowIDCapableRowIterator</td><td>å¯¹å•ä¸ªé”®è¿›è¡ŒèŒƒå›´ç´¢å¼•æ‰«æ</td></tr>
<tr><td><a href="#reverseindexrangescaniterator">ReverseIndexRangeScanIterator</a></td><td>TableRowIterator</td><td>å’Œ IndexRangeScanIterator ç±»ä¼¼ï¼Œä½†æ˜¯æ‰«ææ–¹å‘æ˜¯åå‘çš„</td></tr>
<tr><td>ConstIterator</td><td>TableRowIterator</td><td>å¯ä»¥æ ¹æ®ä¸»é”®æˆ–è€…uniqueindexç¡®å®šå”¯ä¸€ä¸€è¡Œçš„æŸ¥è¯¢</td></tr>
<tr><td><a href="#dynamicrangeiterator">DynamicRangeIterator</a></td><td>TableRowIterator</td><td>å­˜åœ¨å¤šä¸ªå¯ç”¨ indexï¼Œä½†æ˜¯æ— æ³•ç¡®å®šå…·ä½“é€‰æ‹©é‚£ä¸ª indexï¼Œåœ¨æ‰§è¡Œçš„æ—¶å€™åŠ¨æ€é€‰æ‹©</td></tr>
<tr><td>FullTextSearchIterator</td><td>TableRowIterator</td><td>ç”¨äºæŸ¥è¯¢å…¨æ–‡ç´¢å¼•</td></tr>
<tr><td>GeometryIndexRangeScanIterator</td><td>IndexRangeScanIterator</td><td>ç±»ä¼¼IndexRangeScanIteratorï¼Œ ç”¨äºæ”¯æŒç©ºé—´ç±»å‹çš„ç´¢å¼•æ‰«æ</td></tr>
<tr><td><a href="#sort">SortingIterator</a></td><td>RowIterator</td><td>ä»ä¸€ä¸ªå·²æ’åºçš„è¿­ä»£å™¨è¾“å‡ºæ•°æ®ï¼Œæ’åºæ“ä½œåœ¨ init çš„æ—¶å€™ï¼Œåä¸‹é¢å‡ ä¸ªè¿­ä»£å™¨å®Œæˆ</td></tr>
<tr><td><a href="#sort">SortBufferIterator</a></td><td>RowIterator</td><td>ä»ç¼“å†²åŒºè¯»å–å·²ç»æ’å¥½åºçš„ç»“æœé›†ï¼Œä¸»è¦ç»™ SortingIterator è°ƒç”¨</td></tr>
<tr><td><a href="#sort">SortBufferIndirectIterator</a></td><td>RowIterator</td><td>ä»ç¼“å†²åŒºè¯»å–è¡ŒIDç„¶åä»è¡¨ä¸­è¯»å–å¯¹åº”çš„è¡Œï¼Œç”±SortingIteratorå’ŒæŸäº›å½¢å¼çš„uniqueæ“ä½œä½¿ç”¨</td></tr>
<tr><td><a href="#sort">SortFileIterator</a></td><td>RowIterator</td><td>å’Œ SortBufferIterator ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨ç£ç›˜è¿›è¡Œmerge sort</td></tr>
<tr><td><a href="#sort">SortFileIndirectIterator</a></td><td>RowIterator</td><td>å’Œ SortFileIterator ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯ rowid æ’åºï¼Œåç»­ä¼šè¿›è¡Œå›è¡¨æ“ä½œ</td></tr>
<tr><td><a href="#fakesinglerowiterator">FakeSingleRowIterator</a></td><td>RowIterator</td><td>è¿”å›å•è¡Œï¼Œç„¶åç»“æŸã€‚ ä»…åœ¨æŸäº›ä½¿ç”¨constè¡¨æƒ…å†µä¸‹æ‰ä½¿ç”¨</td></tr>
<tr><td><a href="#unqualifiedcountiterator">UnqualifiedCountIterator</a></td><td>RowIterator</td><td>ç®€å• count(*) è¯­å¥ä¼˜åŒ–ï¼Œä½¿ç”¨ innodb å¹¶è¡ŒåŠ é€ŸæŸ¥è¯¢</td></tr>
<tr><td><a href="#zerorowsiterator">ZeroRowsIterator</a></td><td>RowIterator</td><td>ä¼˜åŒ–å™¨ç¡®å®šå½“å‰ç®—å­æ— è¾“å‡ºï¼Œåˆ™ç›´æ¥ç”Ÿæˆè¯¥ç®—å­ï¼Œä¾‹å¦‚æ¡ä»¶ä¸ºå‡</td></tr>
<tr><td>ZeroRowsAggregatedIterator</td><td>RowIterator</td><td>å’Œ ZeroRowsIterator ç±»ä¼¼ï¼Œä½†æ˜¯ç”¨äºèšåˆæ“ä½œï¼Œæ™®é€šè¯­å¥æ— è¾“å‡ºï¼Œä½†æ˜¯èšåˆæ“ä½œæŒ‰è¯­ä¹‰è¾“å‡ºnullæˆ–è€…0</td></tr>
<tr><td>TableValueConstructorIterator</td><td>RowIterator</td><td>è¯»å– values row_list</td></tr>
<tr><td><a href="#nestedloopiterator">NestedLoopIterator</a></td><td>RowIterator</td><td>ä½¿ç”¨ nestloop çš„æ–¹å¼æ‰§è¡Œjoinæ“ä½œ</td></tr>
<tr><td><a href="#bkaiterator">BKAIterator</a></td><td>RowIterator</td><td>batch key access ç®—æ³•ï¼Œnestloopjoinçš„ç‰¹æ®Šå®ç°</td></tr>
<tr><td><a href="#multirangerowiterator">MultiRangeRowIterator</a></td><td>RowIterator</td><td>bka ä¸“ç”¨è¿­ä»£å™¨ï¼Œè¯»å– inner tableï¼ŒæŠŠéšæœº IO è½¬æ¢ä¸ºé¡ºåº IO</td></tr>
<tr><td><a href="#removeduplicatesiterator">RemoveDuplicatesIterator</a></td><td>RowIterator</td><td>å¿«é€Ÿæ¶ˆé™¤é‡å¤è¡Œï¼Œè¦æ±‚ä¸‹å±‚è¿­ä»£å™¨çš„è¾“å…¥æ˜¯åˆ†ç»„çš„</td></tr>
<tr><td><a href="#removeduplicatesonindexiterator">RemoveDuplicatesOnIndexIterator</a></td><td>RowIterator</td><td>ç±»ä¼¼ RemoveDuplicatesIteratorï¼Œä½†æ˜¯è¦æ±‚ä¸‹å±‚è¿­ä»£å™¨çš„è¾“å…¥æ˜¯æœ‰åºçš„</td></tr>
<tr><td><a href="#nestedloopsemijoinwithduplicateremovaliterator">NestedLoopSemiJoinWithDuplicateRemovalIterator</a></td><td>RowIterator</td><td>å®ƒåœ¨è¯­ä¹‰ä¸Šç­‰åŒäºä¸€ä¸ª semijoin NestedLoopIterator+RemoveDuplicatesOnIndexIterator</td></tr>
<tr><td><a href="#weedoutiterator">WeedoutIterator</a></td><td>RowIterator</td><td>ç”¨äºæ¶ˆé™¤semijoinè½¬ä¸º inner join ä¹‹åçš„é‡å¤è¡Œ</td></tr>
<tr><td><a href="#hashjoiniterator">HashJoinIterator</a></td><td>RowIterator</td><td>hash join è¿­ä»£å™¨</td></tr>
<tr><td>FilterIterator</td><td>RowIterator</td><td>æœ€ç®€å•çš„è¿­ä»£å™¨ï¼Œç”¨äºæ‰§è¡Œè¿‡æ»¤æ“ä½œ</td></tr>
<tr><td>LimitOffsetIterator</td><td>RowIterator</td><td>ä»offsetå¼€å§‹è¯»å–è¡Œï¼Œç›´åˆ°æ»¡è¶³limité™åˆ¶ï¼Œç”¨æ¥å®ç°LIMIT/OFFSET</td></tr>
<tr><td><a href="#aggregateiterator">AggregateIterator</a></td><td>RowIterator</td><td>å®ç°èšé›†å‡½æ•°å¹¶ä¸”å¦‚æœéœ€è¦çš„è¯è¿›è¡Œåˆ†ç»„æ“ä½œ</td></tr>
<tr><td><a href="#temptableaggregateiterator">TemptableAggregateIterator</a></td><td>TableRowIterator</td><td>ä½¿ç”¨ä¸´æ—¶è¡¨è¿›è¡Œèšåˆæ“ä½œï¼Œå…è®¸æœªæ’åºçš„è¾“å…¥</td></tr>
<tr><td><a href="#materializeiterator">MaterializeIterator</a></td><td>TableRowIterator</td><td>ä»å¦ä¸€ä¸ªè¿­ä»£å™¨è¯»å–ç»“æœï¼Œå¹¶æ”¾å…¥ä¸´æ—¶è¡¨ï¼Œç„¶åè¯»å–ä¸´æ—¶è¡¨è®°å½•</td></tr>
<tr><td><a href="#cacheinvalidatoriterator">CacheInvalidatorIterator</a></td><td>RowIterator</td><td>è®°å½•ä¸€ä¸ªæ ‡è®°ï¼Œé€šçŸ¥åç»­ä½¿ç”¨ä¾èµ–æ­¤è¡¨å¾—ä¸´æ—¶è¡¨å¤±æ•ˆï¼Œåªç”¨åœ¨ lateral</td></tr>
<tr><td>MaterializeInformationSchemaTableIterator</td><td>RowIterator</td><td>INFORMATION_SCHEMA ä¸­çš„è¡¨æ˜¯åŠ¨æ€å¡«å……çš„ï¼Œä½¿ç”¨æ­¤è¿­ä»£å™¨å¡«å……æ•°æ®</td></tr>
<tr><td><a href="#appenditerator">AppendIterator</a></td><td>RowIterator</td><td>æŒ‰ç…§childè¿­ä»£å™¨çš„é¡ºåºä¾æ¬¡è°ƒç”¨ï¼Œå½“å‰ union all ä¸“ç”¨</td></tr>
<tr><td><a href="#streamingiterator">StreamingIterator</a></td><td>TableRowIterator</td><td>ç±»ä¼¼ MaterializeIteratorï¼Œä½†æ˜¯å¹¶ä¸è¿›è¡Œç‰©åŒ–æ“ä½œï¼Œåªæ˜¯ç®€å•çš„æŠŠæ•°æ®ä»ä¸‹å±‚è¿­ä»£å™¨å¤åˆ¶åˆ°ä¸Šå±‚</td></tr>
<tr><td><a href="#deleterowsiterator">DeleteRowsIterator</a></td><td>RowIterator</td><td>ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç”¨äºåˆ é™¤å…¶å­è¿­ä»£å™¨è¿”å›çš„æ‰€æœ‰è¡Œ</td></tr>
<tr><td>AlternativeIterator</td><td>RowIterator</td><td>in å­æŸ¥è¯¢ä¸“ç”¨ï¼Œç”¨æ¥åŒºåˆ†å­æŸ¥è¯¢ä¸­çš„ NULL å’Œ falseï¼Œå±äºç‰¹æ®Šä¼˜åŒ–</td></tr>
<tr><td>TimingIterator</td><td>RowIterator</td><td>ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç”¨äºå®ç° explain analyze</td></tr>
<tr><td>UpdateRowsIterator</td><td>RowIterator</td><td>ä¸€ä¸ªè¿­ä»£å™¨ï¼Œç”¨äºå¯¹å…¶å­è¿­ä»£å™¨è¿”å›çš„è¡Œæ‰§è¡Œæ›´æ–°</td></tr>
<tr><td>WindowIterator</td><td>RowIterator</td><td>ç”¨äºæ‰§è¡Œçª—å£å‡½æ•°</td></tr>
<tr><td>BufferingWindowIterator</td><td>RowIterator</td><td>ç±»ä¼¼ WindowIteratorï¼Œä½†æ˜¯éœ€è¦ä½¿ç”¨ buffer</td></tr>
<tr><td>FollowTailIterator</td><td>RowIterator</td><td>ç”¨æ¥å®ç°CTE WITH RECURSIVE</td></tr>
<tr><td>MaterializedTableFunctionIterator</td><td>TableRowIterator</td><td>ç”¨æ¥å®ç° TVFï¼Œå½“å‰åªæ”¯æŒ json_tableï¼Œå½“å‰é€šè¿‡ç‰©åŒ–function resultå®ç°çš„</td></tr>
<tr><td>IndexMergeIterator</td><td>TableRowIterator</td><td>è”åˆæŸ¥è¯¢å¤šä¸ª index</td></tr>
<tr><td>RowIDUnionIterator</td><td>TableRowIterator</td><td>è”åˆæŸ¥è¯¢å¤šä¸ª indexï¼Œå¹¶ä¸”è¿”å› union ä¹‹åçš„ rowid çš„ç»“æœé›†</td></tr>
<tr><td>RowIDIntersectionIterator</td><td>RowIDCapableRowIterator</td><td>è”åˆæŸ¥è¯¢å¤šä¸ª indexï¼Œå¹¶ä¸”è¿”å› intersection ä¹‹åçš„ rowid çš„ç»“æœé›†</td></tr>
<tr><td>FakeIntegerIterator</td><td>TableRowIterator</td><td>æµ‹è¯•ä½¿ç”¨</td></tr>
<tr><td>FakeStringIterator</td><td>TableRowIterator</td><td>æµ‹è¯•ä½¿ç”¨</td></tr>
</tbody></table>
</div>
<hr />
<h3 id="tablescaniterator"><a class="header" href="#tablescaniterator">TableScanIterator</a></h3>
<ul>
<li>
<p>TableScanIterator æ˜¯æœ€åŸºç¡€çš„è¡¨è®¿é—®æ–¹æ³•ï¼Œé€šè¿‡ rnd_initã€ha_rnd_next å’Œ rnd_end å­˜å‚¨å¼•æ“æ¥å£è¿›è¡Œæ“ä½œï¼Œä¸ä½¿ç”¨ä»»ä½•ç´¢å¼•ã€‚
é™¤äº†æ­£å¸¸è®¿é—®åŸºè¡¨ä¹‹å¤–ï¼Œä»–è¿˜ä¼šç”¨äºè®¿é—®æ‰§è¡Œä¸­ä¸´æ—¶è¡¨çš„æ•°æ®ã€‚ä¾‹å¦‚èšåˆæ“ä½œï¼Œset æ“ä½œç­‰ã€‚</p>
</li>
<li>
<p>å¯¹äº except å’Œ insersect çš„ distinct æœ‰ç‰¹æ®Šæ“ä½œï¼Œä½¿ç”¨ä¸€ä¸ª counter å¤„ç†é‡å¤è¡Œ</p>
</li>
<li>
<p>ç”± AccessPath::TABLE_SCAN åˆ›å»ºï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ˜¯ <code>Table scan on xx</code></p>
</li>
</ul>
<blockquote>
<p>æœ€åŸºç¡€çš„æ“ä½œï¼Œä½†æ˜¯è¿™é‡Œæœ‰éƒ¨åˆ† set çš„æ“ä½œé€»è¾‘ï¼Œè¿èƒŒäº†å•ä¸€åŠŸèƒ½åŸåˆ™</p>
</blockquote>
<pre><code class="language-c++">    while ((tmp = table()-&gt;file-&gt;ha_rnd_next(m_record))) {
      /*
       ha_rnd_next can return RECORD_DELETED for MyISAM when one thread is
       reading and another deleting without locks.
       */
      if (tmp == HA_ERR_RECORD_DELETED &amp;&amp; !thd()-&gt;killed) continue;
      return HandleError(tmp);
    }
    if (m_examined_rows != nullptr) {
      ++*m_examined_rows;
    }
</code></pre>
<p>å…·ä½“çš„ä¾‹å­</p>
<pre><code class="language-sql">explain format=tree select * from t1;
| -&gt; Table scan on t1  (cost=16.2 rows=160)

explain format=tree  select * from t3 intersect select * from t2;
| -&gt; Table scan on &lt;intersect temporary&gt;  (cost=2.36..3.62 rows=2)
    -&gt; Intersect materialize with deduplication  (cost=1.1..1.1 rows=2)
        -&gt; Table scan on t3  (cost=0.45 rows=2)
        -&gt; Table scan on t2  (cost=0.45 rows=2)

explain format = tree select avg(a) from t2 group by b;
| -&gt; Table scan on &lt;temporary&gt;
    -&gt; Aggregate using temporary table
        -&gt; Table scan on t2  (cost=0.45 rows=2)
</code></pre>
<h3 id="indexscaniterator"><a class="header" href="#indexscaniterator">IndexScanIterator</a></h3>
<ul>
<li>
<p>IndexScanIterator æ˜¯ MySQL æŸ¥è¯¢æ‰§è¡Œå¼•æ“ä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºæ²¿ç€ç´¢å¼•æ‰§è¡Œå®Œæ•´çš„ç´¢å¼•æ‰«ææ“ä½œã€‚ä½¿ç”¨ä¸€ä¸ª bool æ¨¡æ¿æ§åˆ¶ scan çš„é¡ºåº</p>
</li>
<li>
<p>ä» AccessPath::INDEX_SCAN åˆ›å»ºï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ˜¯ <code>[Covering] Index scan using xx on xx</code></p>
</li>
<li>
<p>ä»–çš„æ ¸å¿ƒç›®çš„æ˜¯ä¸ºäº†æ›¿æ¢ full table scanï¼Œä¾‹å¦‚ index only scanï¼Œ</p>
</li>
</ul>
<blockquote>
<p>TODO: è°ƒç ”å›è¡¨çš„ç»†èŠ‚<br />
TODO: è°ƒç ”æ•°æ®åœ¨ç®—å­ä¹‹é—´æ€ä¹ˆæµåŠ¨<br />
TODO: filter index å’Œ index(filter) çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ</p>
</blockquote>
<pre><code class="language-sql">
explain format=tree SELECT  1 FROM t1 ;
| -&gt; Covering index scan on t1 using i1_t1  (cost=16.2 rows=160)


explain format=tree SELECT  c3,c1 FROM t1 ;
| -&gt; Covering index scan on t1 using i1_t1  (cost=16.2 rows=160)

explain format=tree SELECT c1, MIN(c4) FROM t1 GROUP BY c1;
| -&gt; Group aggregate: min(t1.c4)  (cost=32.2 rows=2)
    -&gt; Index scan on t1 using i1_t1  (cost=16.2 rows=160)


explain format=tree SELECT c1, MIN(c4) FROM t1 where c1 &lt; 10 group by c1;
| -&gt; Group aggregate: min(t1.c4)  (cost=32.2 rows=2)
    -&gt; Filter: (t1.c1 &lt; 10)  (cost=16.2 rows=160)
        -&gt; Index scan on t1 using i1_t1  (cost=16.2 rows=160)

</code></pre>
<h3 id="groupindexskipscaniterator"><a class="header" href="#groupindexskipscaniterator">GroupIndexSkipScanIterator</a></h3>
<p><a href="https://mp.weixin.qq.com/s/-V8jP75P4nMi8jFR_Y5oSQ">text</a></p>
<ul>
<li>
<p>é’ˆå¯¹äºmin/max å’Œ distinct çš„ç‰¹æ®Šä¼˜åŒ–ï¼Œåˆ©ç”¨çš„æ˜¯ index è‡ªèº«è‡ªå¸¦ sorted group çš„ç‰¹æ€§ï¼Œç›´æ¥å®šä½åˆ°å…·ä½“çš„min max å€¼ï¼Œæ— éœ€è¿›è¡Œé¢å¤–å¾—èšåˆæ“ä½œ</p>
</li>
<li>
<p>ä» <code>AccessPath::GROUP_INDEX_SKIP_SCAN</code> æ„å»ºè€Œæ¥</p>
<ul>
<li>å¯¹äº mix/max çš„ä¼˜åŒ–ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ˜¯ <code>skip scan for grouping</code></li>
<li>å¯¹äº distinct çš„ä¼˜åŒ–ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ˜¯ <code>skip scan for deduplication</code></li>
</ul>
</li>
</ul>
<pre><code class="language-sql">
explain format=tree SELECT c1, Max(c2) FROM t1 GROUP BY c1;
| -&gt; Covering index skip scan for grouping on t1 using i1_t1  (cost=1 rows=3)

explain format=tree SELECT distinct c1,c2 from t1;
| -&gt; Covering index skip scan for deduplication on t1 using i1_t1  (cost=2.75 rows=10)

</code></pre>
<h3 id="indexskipscaniterator"><a class="header" href="#indexskipscaniterator">IndexSkipScanIterator</a></h3>
<p><a href="https://blog.csdn.net/GreatSQL2021/article/details/146198439"></a></p>
<ul>
<li>
<p>é’ˆå¯¹æŸ¥è¯¢æ¡ä»¶ä¸æ»¡è¶³ index çš„å‰å¯¼åˆ—ï¼Œä½†æ˜¯æ»¡è¶³éƒ¨åˆ†åç»­åˆ—çš„è¯­å¥ï¼Œè™½ç„¶ index å‰å¯¼åˆ—ä¸æ»¡è¶³æ¡ä»¶ï¼Œä½†æ˜¯ index ä¸­å…¶ä»–åˆ—åœ¨ç´¢å¼•ä¸­æ˜¯æœ‰é¡ºåºçš„ï¼Œå¯ä»¥é€šè¿‡è·³è·ƒå¼æ‰«ææ¥å‡å°‘æ‰«æçš„æ— æ•ˆè¡Œæ•°ã€‚</p>
</li>
<li>
<p>ä¸æ˜¯ä»»ä½•åœºæ™¯éƒ½é€‚ç”¨ï¼Œéœ€è¦å‰å¯¼åˆ—ä½ NDVï¼Œå¦åˆ™å¯èƒ½å®é™…æƒ…å†µä¸æ˜¯å¤ªå¥½</p>
</li>
<li>
<p>ä» <code>AccessPath::INDEX_SKIP_SCAN</code> æ„å»ºè€Œæ¥ï¼Œ æ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ˜¯ <code>index skip scan</code></p>
</li>
</ul>
<pre><code class="language-sql">EXPLAIN format=tree SELECT c1, c2 FROM t1 WHERE c2  &lt; 1;
| -&gt; Filter: (t1.c2 &lt; 1)  (cost=0.301..15.9 rows=53)
    -&gt; Covering index skip scan on t1 using i1_t1 over NULL &lt; c2 &lt; 1  (cost=0.301..15.9 rows=53)
</code></pre>
<h3 id="indexrangescaniterator"><a class="header" href="#indexrangescaniterator">IndexRangeScanIterator</a></h3>
<ul>
<li>
<p>é™å®šå•ä½ç´¢å¼•çš„èŒƒå›´æŸ¥è¯¢ï¼Œå•ä¸ªé”®è¿›è¡ŒèŒƒå›´ç´¢å¼•æ‰«æã€‚</p>
</li>
<li>
<p>ä» <code>AccessPath::INDEX_RANGE_SCAN</code> æ„å»ºè€Œæ¥ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ˜¯ <code>index range scan</code></p>
</li>
</ul>
<pre><code class="language-sql">EXPLAIN format=tree SELECT c1, c2 FROM t1 WHERE c1 &gt; 1 and c1 &lt; 10 order by c1 asc;
| -&gt; Filter: ((t1.c1 &gt; 1) and (t1.c1 &lt; 10))  (cost=16.3 rows=80)
    -&gt; Covering index range scan on t1 using i1_t1 over (1 &lt; c1 &lt; 10)  (cost=16.3 rows=80)
</code></pre>
<h3 id="reverseindexrangescaniterator"><a class="header" href="#reverseindexrangescaniterator">ReverseIndexRangeScanIterator</a></h3>
<ul>
<li>å’Œ IndexRangeScanIterator ç±»ä¼¼ï¼Œä½†æ˜¯æ˜¯åå‘æ‰«æï¼Œè™½ç„¶åŠŸèƒ½ç±»ä¼¼ï¼Œä½†æ˜¯æ²¡æœ‰ä½¿ç”¨åŒä¸€ä¸ªç±»å®ç°</li>
</ul>
<blockquote>
<p>TODO: è°ƒæŸ¥è¿™ä¸¤ä¸ª è¿­ä»£å™¨çš„åŒºåˆ«</p>
</blockquote>
<pre><code class="language-sql">EXPLAIN format=tree SELECT c1, c2 FROM t1 WHERE c1 &gt; 1 and c1 &lt; 10 order by c1 desc;
| -&gt; Filter: ((t1.c1 &gt; 1) and (t1.c1 &lt; 10))  (cost=16.3 rows=80)
    -&gt; Covering index range scan on t1 using i1_t1 over (1 &lt; c1 &lt; 10) (reverse)  (cost=16.3 rows=80)
</code></pre>
<h3 id="dynamicrangeiterator"><a class="header" href="#dynamicrangeiterator">DynamicRangeIterator</a></h3>
<ul>
<li>è¡¨ä¸Šå­˜åœ¨å¤šä¸ªå¯ç”¨indexï¼Œä½†æ˜¯æ— æ³•ç¡®å®šå…·ä½“é€‰æ‹©é‚£ä¸ªçš„æ—¶å€™ï¼ŒæŠŠé€‰æ‹©å»¶è¿Ÿåˆ°å…·ä½“æ‰§è¡Œçš„æ—¶å€™</li>
<li>æ‰§è¡Œçš„æ—¶å€™ï¼Œåœ¨ Init ä¸­ï¼Œæ¯æ¬¡æ ¹æ®å…·ä½“çš„å€¼åˆ¤æ–­é€‰æ‹©é‚£ä¸ª indexï¼Œæˆ–è€…æ‰§è¡Œ full scanï¼Œæ¢è¨€ä¹‹ï¼Œä»–å®é™…æ‰§è¡Œçš„scanæ–¹å¼æ˜¯åŠ¨æ€é€‰æ‹©çš„</li>
<li>æ¯æ¬¡ init ï¼Œè¡¨ç¤ºè¿™ä¸ªè¿­ä»£å™¨åªèƒ½å‡ºç°åœ¨é™å®šçš„åœ°æ–¹ï¼Œä¾‹å¦‚ nestloop join çš„ outerï¼Œæˆ–è€… subquery</li>
</ul>
<pre><code class="language-sql">create table t5(a int, b int, c int, d int, key(a),key(b),key(c));
create table t6(a int, b int, c int, d int);
insert into t5 values(1,2,3,4);

explain format=tree  select * from t6 join t5 on true where t5.a = t6.a or t5.b = t6.b or t5.c = t6.c;
| -&gt; Nested loop inner join  (cost=1.3 rows=2.59)
    -&gt; Table scan on t6  (cost=0.35 rows=1)
    -&gt; Filter: ((t5.a = t6.a) or (t5.b = t6.b) or (t5.c = t6.c))  (cost=0.509 rows=2.59)
        -&gt; Index range scan on t5 (re-planned for each iteration)  (cost=0.509 rows=7)
</code></pre>
<h3 id="sort"><a class="header" href="#sort">sort</a></h3>
<p><a href="https://blog.csdn.net/zxz1580977728/article/details/109394496">text</a></p>
<ul>
<li>
<p>SortBufferIterator</p>
<ul>
<li>å¤–éƒ¨ä¸å¯è§çš„è¿­ä»£å™¨ï¼Œå†…éƒ¨ä½¿ç”¨ï¼Œä¸»è¦æ˜¯ä½¿ç”¨ è¿­ä»£å™¨çš„æ–¹å¼è¯»å–ä¸€ä¸ªå·²æ’åºçš„ Filesort_info å¯¹è±¡ï¼Œæ’åºæ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­</li>
<li>ç”± SortingIterator æ„å»ºï¼Œä½¿ç”¨ä¸€ä¸ªç‰¹åŒ–æ¨¡æ¿å­—æ®µè¡¨ç¤ºæ˜¯å¦å¯¹æ•°æ®è¿›è¡Œå‹ç¼©</li>
</ul>
</li>
<li>
<p>SortBufferIndirectIterator</p>
<ul>
<li>å’Œ SortBufferIterator ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯ rowid è¿›è¡Œæ’åºï¼Œä¹‹åå†ä½¿ç”¨ id å›è¡¨è·å¾—å…·ä½“æ•°æ®</li>
</ul>
</li>
<li>
<p>SortFileIterator</p>
<ul>
<li>ç£ç›˜æ’åºï¼Œä½¿ç”¨ merge sort ç®—æ³•ï¼Œå°†æ•°æ®å†™å…¥ç£ç›˜ï¼Œç„¶åå†ä»ç£ç›˜è¯»å–æ•°æ®è¿›è¡Œæ’åº</li>
</ul>
</li>
<li>
<p>SortFileIndirectIterator</p>
<ul>
<li>å’Œ SortFileIterator ç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯ rowid æ’åºï¼Œä¹‹åå†ä½¿ç”¨ id å›è¡¨è·å¾—å…·ä½“æ•°æ®</li>
</ul>
</li>
</ul>
<blockquote>
<p>TODO: è°ƒæŸ¥ sort çš„å…·ä½“å®ç°ï¼Œä»¥åŠæ’åºæ–¹å¼çš„å…·ä½“é€‰æ‹©æ–¹æ³•</p>
</blockquote>
<h3 id="fakesinglerowiterator"><a class="header" href="#fakesinglerowiterator">FakeSingleRowIterator</a></h3>
<h3 id="unqualifiedcountiterator"><a class="header" href="#unqualifiedcountiterator">UnqualifiedCountIterator</a></h3>
<p><a href="https://www.cnblogs.com/huaweiyun/p/18322194">text</a></p>
<ul>
<li>
<p>innodb ä½¿ç”¨å¹¶è¡Œå®ç°ä¸€ä¸ª count æ“ä½œï¼Œä½†æ˜¯ç”±äºå…·ä½“å®ç°å®åœ¨ innodb å†…éƒ¨ï¼Œæ‰€ä»¥é’ˆå¯¹è¿™ç§åœºæ™¯è¿›è¡Œç‰¹æ®Šä¼˜åŒ–</p>
</li>
<li>
<p>æ‰€ä»¥ä½¿ç”¨åœºæ™¯éå¸¸è‹›åˆ»ï¼Œå‡ ä¹åªæ”¯æŒç®€å• count(*) è¯­å¥ï¼Œå¹¶ä¸”åªèƒ½ç”¨äº innodb è¡¨</p>
</li>
<li>
<p>è¿™æ˜¯MySQLå¹¶è¡ŒæŸ¥è¯¢çš„èµ·ç‚¹(ä¹Ÿæ˜¯ç»ˆç‚¹)</p>
</li>
</ul>
<pre><code class="language-sql">explain format=tree select count(*) from t1;
| -&gt; Count rows in t1
</code></pre>
<h3 id="zerorowsiterator"><a class="header" href="#zerorowsiterator">ZeroRowsIterator</a></h3>
<ul>
<li>
<p>ä¼˜åŒ–é˜¶æ®µå¯ä»¥ç¡®å®šç®—å­æ²¡æœ‰è¾“å‡ºï¼Œåˆ™ä½¿ç”¨è¿™ä¸ªç®—å­ï¼Œè¡¨ç¤ºè¿­ä»£å™¨æ— è¾“å‡ºï¼Œæ— è¾“å…¥</p>
</li>
<li>
<p>å¦‚æœæ˜¯èšåˆæ“ä½œï¼Œ åˆ™éœ€è¦è¾“å‡ºnullæˆ–è€…0ï¼Œä½¿ç”¨ ZeroRowsAggregatedIterator å¤„ç†</p>
</li>
</ul>
<pre><code>explain format=tree select count(*) from t1 where 1+1 = 3;
| -&gt; Zero input rows (Impossible WHERE), aggregated into one output row  (cost=0..0 rows=1)
</code></pre>
<h3 id="nestedloopiterator"><a class="header" href="#nestedloopiterator">NestedLoopIterator</a></h3>
<ul>
<li>åŸºç¡€çš„ nestloop å®ç°</li>
</ul>
<blockquote>
<p>TODO: è°ƒæŸ¥æ•°æ®æ˜¯æ€ä¹ˆæµè½¬çš„</p>
</blockquote>
<pre><code class="language-sql">explain format=tree select  * from t1 join t2 on t1.c1 = t2.a;
| -&gt; Nested loop inner join  (cost=17.9 rows=160)
    -&gt; Filter: (t2.a is not null)  (cost=0.45 rows=2)
        -&gt; Table scan on t2  (cost=0.45 rows=2)
    -&gt; Index lookup on t1 using i1_t1 (c1=t2.a)  (cost=4.75 rows=80)
</code></pre>
<h3 id="bkaiterator"><a class="header" href="#bkaiterator">BKAIterator</a></h3>
<ul>
<li>
<p>ä½¿ç”¨ BKA åŠ é€Ÿ nestloop joinï¼Œå¤§è‡´åŸç†æ˜¯ join çš„é©±åŠ¨è¡¨è¯»å–ä¸€æ‰¹æ•°æ®ä¹‹åï¼Œè¢«é©±åŠ¨è¡¨ä½¿ç”¨ mrr åŠŸèƒ½ä»indexè¯»å–æ»¡è¶³æ¡ä»¶çš„æ•°æ®ï¼Œä¹‹åè·å¾—è¡¨çš„rowidï¼Œæ’åº rowid ä¹‹åæŠŠ éšæœº io å˜æˆé¡ºåº io</p>
</li>
<li>
<p>é€»è¾‘å’Œ hash join ç±»ä¼¼ï¼Œåªæ˜¯ bak å’Œä¸»è¦æå‡ç‚¹æ˜¯æŠŠå›è¡¨çš„éšæœº io è½¬æ¢ä¸ºé¡ºåº ioï¼Œ å‡å°‘äº†éšæœº io çš„å¼€é”€</p>
<ul>
<li>å‰ææ¡ä»¶å°±æ˜¯å­˜åœ¨ IO æ“ä½œï¼Œå¦‚æœå°è¡¨æˆ–è€…è¡¨éƒ¨åˆ† page æœ‰ç¼“å­˜ï¼Œåˆ™æ²¡æœ‰ IO æ“ä½œ</li>
</ul>
</li>
<li>
<p>ä¸Šä½æ›¿ä»£æ˜¯ hash join</p>
</li>
<li>
<p>ä» <code>AccessPath::BKA_JOIN</code> æ„å»ºè€Œæ¥ï¼Œ æ‰§è¡Œè®¡åˆ’æ˜¾å¼ <code>Batched key access </code>.</p>
</li>
</ul>
<pre><code class="language-sql">explain format=tree select /*+ bka(t1)*/ * from t1 join t2 on t1.c1 = t2.a;
| -&gt; Batched key access inner join
    -&gt; Batch input rows
        -&gt; Filter: (t2.a is not null)  (cost=0.45 rows=2)
            -&gt; Table scan on t2  (cost=0.45 rows=2)
    -&gt; Multi-range index lookup on t1 using i1_t1 (c1=t2.a)  (cost=4.75 rows=80)
</code></pre>
<h3 id="multirangerowiterator"><a class="header" href="#multirangerowiterator">MultiRangeRowIterator</a></h3>
<ul>
<li>å’Œ BKAIterator ç»‘å®šçš„è¿­ä»£å™¨ï¼Œæ¥å—ä¸€ä¸ª outer ä¼ é€’çš„ bufferï¼Œç„¶åä» index è¯»å–æ•°æ®ï¼Œè·å¾—å¯¹åº”çš„ rowid ä¹‹åï¼ŒæŒ‰ç…§ pk æ’åºï¼ŒæŠŠå›è¡¨çš„éšæœº IO è½¬æ¢ä¸º é¡ºåº IO</li>
</ul>
<h3 id="removeduplicatesiterator"><a class="header" href="#removeduplicatesiterator">RemoveDuplicatesIterator</a></h3>
<ul>
<li>
<p>RemoveDuplicatesIterator é€šè¿‡ç»´æŠ¤ç¼“å­˜çš„åˆ†ç»„å­—æ®µå€¼æ¥æ£€æµ‹é‡å¤è¡Œã€‚å½“è¯»å–æ–°è¡Œæ—¶ï¼Œå®ƒä¼šå°†å½“å‰è¡Œçš„åˆ†ç»„å­—æ®µå€¼ä¸ä¹‹å‰ç¼“å­˜çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœå€¼ç›¸åŒï¼Œåˆ™è®¤ä¸ºæ˜¯é‡å¤è¡Œå¹¶è·³è¿‡ï¼›å¦‚æœä¸åŒï¼Œåˆ™æ›´æ–°ç¼“å­˜å¹¶è¿”å›è¯¥è¡Œã€‚</p>
</li>
<li>
<p>è¦æ±‚è¾“å…¥æ˜¯å·²æ’åºæˆ–è€…groupçš„</p>
</li>
<li>
<p>ç”± <code>AccessPath::REMOVE_DUPLICATES</code> æ„å»ºè€Œæ¥ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼ <code>Remove duplicates from input grouped on</code></p>
</li>
</ul>
<h3 id="removeduplicatesonindexiterator"><a class="header" href="#removeduplicatesonindexiterator">RemoveDuplicatesOnIndexIterator</a></h3>
<ul>
<li>
<p>ç±»ä¼¼ RemoveDuplicatesIterator ï¼Œä½†æ˜¯é™å®šå­èŠ‚ç‚¹æ˜¯ indexï¼Œå®ç°ä¸ŠåŸç†ç±»ä¼¼ï¼Œä½†æ˜¯è¾“å…¥ä¸åŒï¼Œè¿™é‡Œè¦æ±‚çš„æ˜¯index çš„keyï¼Œæ¯æ¬¡è¯»å–çš„æ—¶å€™é€šè¿‡å’Œä¸Šæ¬¡çš„å€¼è¿›è¡Œæ¯”è¾ƒæ¥åˆ¤æ–­æ˜¯å¦é‡å¤</p>
</li>
<li>
<p>ç”± <code>AccessPath::REMOVE_DUPLICATES_ON_INDEX</code> æ„å»ºè€Œæ¥ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼ <code>Remove duplicates from input on sorted</code></p>
</li>
</ul>
<pre><code class="language-sql">DROP TABLE t1;
DROP TABLE t2;
set optimizer_switch='firstmatch=off,materialization=off,duplicateweedout=off,loosescan=on';
CREATE TABLE t1 ( i INTEGER, PRIMARY KEY (i) );
CREATE TABLE t2 ( i INTEGER, INDEX i1 (i) );
INSERT INTO t1 VALUES (2), (3), (4), (5);
INSERT INTO t2 VALUES (1), (2), (3), (4);
ANALYZE TABLE t1, t2;

EXPLAIN format=tree SELECT * FROM t1 WHERE t1.i IN (SELECT t2.i FROM t2);
| -&gt; Nested loop inner join  (cost=2.05 rows=4)
    -&gt; Remove duplicates from input sorted on i1  (cost=0.651 rows=4)
        -&gt; Filter: (t2.i is not null)  (cost=0.651 rows=4)
            -&gt; Covering index scan on t2 using i1  (cost=0.651 rows=4)
    -&gt; Single-row covering index lookup on t1 using PRIMARY (i=t2.i)  (cost=1.1 rows=1)

</code></pre>
<h3 id="nestedloopsemijoinwithduplicateremovaliterator"><a class="header" href="#nestedloopsemijoinwithduplicateremovaliterator">NestedLoopSemiJoinWithDuplicateRemovalIterator</a></h3>
<ul>
<li>
<p>JOIN_SEMI çš„è¯­ä¹‰æ˜¯è¿”å›æ»¡è¶³æ¡ä»¶çš„ outer ä¾§æ•°æ®ï¼Œå³ä½¿ inner æœ‰å¤šæ¡æ•°æ®æ»¡è¶³æ¡ä»¶</p>
</li>
<li>
<p>åœ¨è¯­ä¹‰ä¸Šç­‰ä»·äºä¸€ä¸ª semijoin NestedLoopIterator ç´§æ¥ç€ä¸€ä¸ª RemoveDuplicatesOnIndexIterator çš„ç»„åˆï¼Œä¸»è¦ç”¨äºå¤„ç†åŒ…å«å¤šä¸ªè¡¨çš„åŠè¿æ¥æŸ¥è¯¢</p>
</li>
<li>
<p>ä¸»è¦è§£å†³äº†ä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–é—®é¢˜ï¼šåœ¨ä¼ ç»Ÿçš„æŸ¥è¯¢æ‰§è¡Œæ ‘ä¸­ï¼Œå»é‡æ“ä½œéœ€è¦æ”¾åœ¨åŠè¿æ¥ä¹‹ä¸Šï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå¤–è¡¨è¡Œä¸ä¸€å®šåŒ¹é…å†…è¡¨çš„ä»»ä½•è¡Œã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹å¼æ˜¯ä½æ•ˆçš„ï¼Œå› ä¸ºä¸€æ—¦æ‰¾åˆ°åŒ¹é…çš„å¤–è¡¨/å†…è¡¨è¡Œå¯¹ï¼Œåº”è¯¥åœæ­¢æ‰«æå†…è¡¨ï¼Œç›´åˆ°æœ‰æ–°çš„å¤–è¡¨è¡Œã€‚</p>
</li>
<li>
<p>ä½¿ç”¨è¿™ä¸ªè¿­ä»£å™¨ï¼Œå¯ä»¥æ¶ˆé™¤ semi joinï¼Œè½¬æ¢ä¸º inner joinï¼Œä¾‹å¦‚ä¸‹é¢ä¾‹å­ä¸­ï¼Œt1 join (t3, t4) åŸæœ¬é€»è¾‘ä¸Šåº”è¯¥æ˜¯ semi joinï¼Œä½†æ˜¯å†…éƒ¨ä½¿ç”¨ NestedLoopSemiJoinWithDuplicateRemovalIterator ä¹‹åï¼Œæ²¡æœ‰é‡å¤è¡Œï¼Œæ‰€ä»¥æ— éœ€ä½¿ç”¨ semi join</p>
</li>
</ul>
<pre><code class="language-sql">EXPLAIN FORMAT=TREE SELECT * FROM t1 JOIN t2 ON t1.a = t2.b WHERE t2.b IN ( SELECT t3.b FROM t3 JOIN t4 ON t3.pk = t4.pk );
| -&gt; Inner hash join (t2.b = t1.a)  (cost=2 rows=2)
    -&gt; Table scan on t2  (cost=0.175 rows=3)
    -&gt; Hash
        -&gt; Nested loop inner join  (cost=1.15 rows=2)
            -&gt; Table scan on t1  (cost=0.45 rows=2)
            -&gt; Nested loop semijoin with duplicate removal on b_key  (cost=1 rows=1)
                -&gt; Index lookup on t3 using b_key (b=t1.a)  (cost=0.3 rows=1)
                -&gt; Filter: (t4.pk = t3.pk)  (cost=0.3 rows=1)
                    -&gt; Table scan on t4  (cost=0.3 rows=2)
</code></pre>
<h3 id="weedoutiterator"><a class="header" href="#weedoutiterator">WeedoutIterator</a></h3>
<ul>
<li>
<p>ä¸»è¦ä½œç”¨æ˜¯é¿å… semijoin ä½¿ç”¨ç‰©åŒ–æ“ä½œï¼Œè¿™é‡Œä¹Ÿéœ€è¦ç‰©åŒ–ï¼Œä½†æ˜¯åªæ˜¯ä¸ºäº†æ¶ˆé™¤é‡å¤è¡Œï¼Œæ‰€ä»¥åªéœ€è¦è®°å½• rowid å³å¯ï¼Œæ— éœ€ä¿å­˜å®Œæ•´æ•°æ®</p>
</li>
<li>
<p>NestedLoopSemiJoinWithDuplicateRemovalIterator æ— æ³•ä½¿ç”¨å¾—æƒ…å†µä¸‹ï¼Œæ‰ä½¿ç”¨è¿™ä¸ªæ“ä½œ</p>
</li>
<li>
<p>å¯ä»¥æŠŠ semi join è½¬æ¢ä¸º inner joinï¼Œä»è€Œå…è®¸æ›´å¤šçš„ join ç»„åˆæ–¹å¼ï¼Œ</p>
</li>
</ul>
<pre><code class="language-sql">explain format=tree SELECT 1 FROM t1 WHERE d IN (SELECT a FROM t1);
| -&gt; Remove duplicate t1 rows using temporary table (weedout)  (cost=1.1 rows=2)
    -&gt; Inner hash join (cast(t1.d as double) = cast(t1.a as double))  (cost=1.1 rows=2)
        -&gt; Covering index scan on t1 using PRIMARY  (cost=0.35 rows=2)
        -&gt; Hash
            -&gt; Table scan on t1  (cost=0.45 rows=2)

</code></pre>
<h3 id="hashjoiniterator"><a class="header" href="#hashjoiniterator">HashJoinIterator</a></h3>
<ul>
<li>
<p>HashJoinIterator ç”¨äºå®ç°å“ˆå¸Œè¿æ¥ç®—æ³•ã€‚ è¯¥ç±»ç»§æ‰¿è‡ª RowIteratorï¼Œæ˜¯ MySQL æŸ¥è¯¢æ‰§è¡Œå¼•æ“ä¸­ç”¨äºè¿æ¥ä¸¤ä¸ªè¾“å…¥æ•°æ®æºçš„è¿­ä»£å™¨ã€‚</p>
</li>
<li>
<p>HashJoinIterator ä½¿ç”¨çš„æ˜¯ hybrid hash join</p>
<ul>
<li>å½“hashè¡¨å¯ä»¥æ”¾åœ¨å†…å­˜ä¸­æ—¶ï¼Œæ‰€æœ‰æ“ä½œéƒ½åœ¨å†…å­˜ä¸­æ‰§è¡Œï¼Œinner ä¸ºå°è¡¨ï¼Œç”¨äºæ„å»º hashtableï¼Œæ„å»ºå®Œæˆä¹‹åï¼Œæ¯æ¬¡è¯»å–ä¸€è¡Œinnerç”¨äºåŒ¹é… outer</li>
<li>å½“å‰å†…å­˜ä¸å¤Ÿæ—¶ï¼Œåˆ™æ„å»ºhashtableæ—¶ä½¿ç”¨äºŒæ¬¡åˆ†åŒºæ“ä½œï¼Œå†…å­˜ä¸­ä¿å­˜ä¸€ä¸ªåˆ†åŒºï¼Œå…¶ä»–çš„åˆ†åŒºä¿å­˜åœ¨ç£ç›˜ä¸Šï¼Œå½“æ„å»ºå®Œæˆä¹‹åï¼ŒæŒ‰ç…§æ­£å¸¸çš„hashjoinæ‰§è¡Œï¼Œå†…å­˜ä¸­çš„åˆ†åŒºæ¶ˆè€—å®Œæˆä¹‹åï¼Œä»ç£ç›˜åŠ è½½æ–°çš„åˆ†åŒº</li>
</ul>
</li>
<li>
<p>HashJoinIterator::Read æ˜¯ä¸€ä¸ªçŠ¶æ€æœºï¼Œæ‰§è¡Œçš„æ˜¯joinçš„æ“ä½œï¼Œhashtable çš„ build æ“ä½œåœ¨ HashJoinIterator::Init æ—¶å€™å·²ç»å¤„ç†å®Œæˆ</p>
<ul>
<li>build ä¹‹å‰ä¼šå…ˆè¯»ä¸€ä¸‹outer childï¼Œç¡®ä¿outeræœ‰æ•°æ®ï¼Œè€Œä¸æ˜¯ build å®Œä¹‹åå‘ç°outeræ˜¯ç©ºè¡¨</li>
</ul>
</li>
</ul>
<blockquote>
<p>åœ¨ init é˜¶æ®µå°±æ„å»º hashtableï¼Œå¦‚æœ inner æµ‹æœ‰å¤–å±‚çš„ä¾èµ–å‘¢ï¼Œä¾‹å¦‚ nestloop join æˆ–è€…å­æŸ¥è¯¢ï¼Œè¿˜æ˜¯è¯´æ‰§è¡Œè®¡åˆ’é™å®šä¸ä¼šæœ‰è¿™ç§æ‰§è¡Œè®¡åˆ’<br />
buildä¹‹å‰éœ€è¦è¯»ä¸€ä¸‹outeræœ¬è´¨ä¸Šæ˜¯å¯¹ç»Ÿè®¡ä¿¡æ¯çš„ä¸ä¿¡ä»»ï¼Œæ— æ³•åœ¨ä¼˜åŒ–é˜¶æ®µç¡®è®¤è¡¨æ˜¯å¦ä¸ºç©ºï¼ŒMySQLçš„ç»Ÿè®¡ä¿¡æ¯åº”ç”¨æƒ…å†µæ˜¯ä»€ä¹ˆæ ·çš„ï¼Œæ˜¯æ€ä¹ˆé‡‡æ ·çš„ï¼Œä½¿ç”¨æœ‰æ²¡æœ‰å…¶ä»–æ‰‹æ®µç¡®è®¤è¡¨çš„çŠ¶æ€<br />
MySQLæ²¡æœ‰æ‰§è¡Œè®¡åˆ’ç¼“å­˜ï¼Œæ‰€ä»¥è¯­å¥çš„æ‰§è¡Œè®¡åˆ’æ‰€ç”¨çš„ä¿¡æ¯æ˜¯å½“å‰å®æ—¶çš„ï¼Œæ²¡æœ‰è¿‡æœŸçš„è¯´æ³•ï¼Œæ‰€æœ‰ä¼˜åŒ–é˜¶æ®µåº”è¯¥å¯ä»¥ç›´æ¥ç¡®å®šçš„</p>
</blockquote>
<pre><code class="language-sql">explain format=tree SELECT 1 FROM t1 WHERE d IN (SELECT a FROM t1);
| -&gt; Remove duplicate t1 rows using temporary table (weedout)  (cost=1.1 rows=2)
    -&gt; Inner hash join (cast(t1.d as double) = cast(t1.a as double))  (cost=1.1 rows=2)
        -&gt; Covering index scan on t1 using PRIMARY  (cost=0.35 rows=2)
        -&gt; Hash
            -&gt; Table scan on t1  (cost=0.45 rows=2)
</code></pre>
<h3 id="aggregateiterator"><a class="header" href="#aggregateiterator">AggregateIterator</a></h3>
<ul>
<li>
<p>åˆ†ç»„èšåˆï¼Œè¦æ±‚è¾“å…¥å¿…é¡»æœ‰åºï¼Œä¸€èˆ¬æ˜¯ indexï¼Œå¦åˆ™éœ€è¦ä½¿ç”¨ sort è¿›è¡Œæ’åºï¼Œç„¶åå†èšåˆ</p>
</li>
<li>
<p>AggregateIterator æ˜¯æµå¼ç®—å­ï¼Œä¸ä¼šå­˜å‚¨æ•°æ®ä¹‹åå†è¿›è¡Œèšåˆï¼Œéœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨æ˜¯ <code>TEMPTABLE_AGGREGATE</code>ï¼Œä¸æ˜¯è¿™ä¸ªè¿­ä»£å™¨</p>
</li>
<li>
<p>æŒ‰ç…§å®é™…çš„åŠŸèƒ½ï¼Œæ‰§è¡Œè®¡åˆ’æ˜¾å¼çš„æ—¶å€™ï¼Œä¸€èˆ¬æœ‰ä¸‹é¢é›†ä¸­æƒ…å†µ</p>
<ol>
<li>æ™®é€šé›†åˆæ“ä½œï¼Œæ²¡æœ‰ group by çš„æƒ…å†µï¼Œç›´æ¥æ˜¾å¼ <code>Aggregate:</code></li>
<li>æœ‰èšåˆæ“ä½œï¼Œä½†æ˜¯æ²¡æœ‰èšé›†å‡½æ•°ï¼Œæ˜¾ç¤º <code>Group (no aggregates)</code></li>
<li>group with rollup|cube ï¼Œæ˜¾ç¤º <code>Group aggregate with [rollup|cube]:</code></li>
<li>å…¶ä»–æƒ…å†µæ˜¾ç¤º <code>Group aggregate</code></li>
</ol>
</li>
</ul>
<pre><code class="language-sql">EXPLAIN FORMAT=TREE SELECT a, sum(b) FROM t1  GROUP BY a;
| -&gt; Group aggregate: sum(t1.b)  (cost=1604 rows=8000)
    -&gt; Index scan on t1 using PRIMARY  (cost=804 rows=8000)
</code></pre>
<h3 id="temptableaggregateiterator"><a class="header" href="#temptableaggregateiterator">TemptableAggregateIterator</a></h3>
<ul>
<li>ä½¿ç”¨ä¸´æ—¶è¡¨è¿›è¡Œèšåˆæ“ä½œï¼Œå…è®¸æœªæ’åºçš„è¾“å…¥</li>
</ul>
<pre><code class="language-sql">EXPLAIN FORMAT=TREE SELECT d,a,c,sum(e) FROM t1 GROUP BY d,a,c;
| -&gt; Table scan on &lt;temporary&gt;
    -&gt; Aggregate using temporary table
        -&gt; Table scan on t1  (cost=0.75 rows=5)
</code></pre>
<h3 id="materializeiterator"><a class="header" href="#materializeiterator">MaterializeIterator</a></h3>
<ul>
<li>
<p>ç‰©åŒ–æ“ä½œï¼Œä½¿ç”¨ä¸´æ—¶è¡¨ä¿å­˜æ•°æ®ï¼Œä¸€èˆ¬ç”¨äºä¸€äº›éœ€è¦é‡å¤ä½¿ç”¨æ•°æ®æˆ–è€…ä¸´æ—¶ä¿å­˜æ•°æ®çš„åœºæ™¯ï¼Œä¾‹å¦‚å­æŸ¥è¯¢ï¼Œèšåˆæ“ä½œç­‰</p>
</li>
<li>
<p>æ­¤å¤–ï¼Œå’Œä¸åŒçš„ç®—å­é…åˆä½¿ç”¨çš„æ—¶å€™ï¼Œå…·ä½“ç»†èŠ‚ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ï¼Œè¯¦æƒ…å¯ä»¥å‚è€ƒ ExplainMaterializeAccessPath</p>
</li>
<li>
<p>ç‰©åŒ–æ“ä½œåœ¨ MaterializeIterator::Init çš„æ—¶å€™å·²ç»å¼€å§‹äº†ï¼Œè€Œä¸æ˜¯åœ¨å…·ä½“çš„æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰§è¡Œçš„æ—¶å€™å·²ç»å¼€å§‹ä»ä¸´æ—¶è¡¨ä¸­è¯»æ•°æ®äº†</p>
</li>
<li>
<p>æœ‰çš„è¯­å¥å¯èƒ½ä¼šå­˜åœ¨éƒ¨åˆ† tree æ•´ä½“é‡æ–°æ‰§è¡Œçš„æƒ…å†µï¼Œä¾‹å¦‚å­æŸ¥è¯¢éœ€è¦æ ¹æ®å¤–éƒ¨æä¾›å¾—å‚æ•°é‡æ–°æ‰§è¡Œå­æŸ¥è¯¢ï¼Œnestloop éœ€è¦ä½¿ç”¨ outer å¾—æ•°æ®é‡æ–°æ‰§è¡Œinner childï¼Œæ­¤æ—¶å¦‚æœå­˜åœ¨ç‰©åŒ–æ“ä½œï¼Œåˆ™éœ€è¦é‡æ–°å¡«å……æ•°æ®</p>
</li>
</ul>
<pre><code class="language-sql">explain format=tree select * from t1 union select * from t2;
| -&gt; Table scan on &lt;union temporary&gt;  (cost=2.59..4.91 rows=9)
    -&gt; Union materialize with deduplication  (cost=2.3..2.3 rows=9)
        -&gt; Table scan on t1  (cost=0.85 rows=6)
        -&gt; Table scan on t2  (cost=0.55 rows=3)

explain format=tree select * from t1, lateral (select * from (select * from (select t1.a from t2) as dt limit 1) dt2) dt3;
-&gt; Nested loop inner join  (cost=8.62 rows=2)
    -&gt; Invalidate materialized tables (row from t1)  (cost=0.45 rows=2)
        -&gt; Table scan on t1  (cost=0.45 rows=2)
    -&gt; Table scan on dt3  (cost=7.14..7.14 rows=1)
        -&gt; Materialize (invalidate on row from t1)  (cost=4.62..4.62 rows=1)
            -&gt; Table scan on dt2  (cost=4.53..4.53 rows=1)
                -&gt; Materialize  (cost=2.01..2.01 rows=1)
                    -&gt; Limit: 1 row(s)  (cost=1.91..1.91 rows=1)
                        -&gt; Table scan on dt  (cost=1.91..3.18 rows=2)
                            -&gt; Materialize  (cost=0.65..0.65 rows=2)
                                -&gt; Table scan on t2  (cost=0.45 rows=2)

</code></pre>
<h3 id="cacheinvalidatoriterator"><a class="header" href="#cacheinvalidatoriterator">CacheInvalidatorIterator</a></h3>
<ul>
<li>CacheInvalidatorIterator çš„å·¥ä½œåŸç†åŸºäºç”Ÿæˆè®¡æ•°å™¨æœºåˆ¶ã€‚æ¯å½“è¿­ä»£å™¨æ‰§è¡Œä»»ä½•å¯èƒ½å½±å“ç¼“å­˜æœ‰æ•ˆæ€§çš„æ“ä½œæ—¶ï¼ˆå¦‚åˆå§‹åŒ–ã€è¯»å–è¡Œã€è®¾ç½®ç©ºè¡Œæ ‡å¿—ï¼‰ï¼Œéƒ½ä¼šé€’å¢å†…éƒ¨çš„ç”Ÿæˆè®¡æ•°å™¨ã€‚è¿™ç§è®¾è®¡ä½¿å¾—ä¾èµ–è¯¥è¿­ä»£å™¨çš„ä¸Šå±‚ç»„ä»¶ï¼ˆç‰¹åˆ«æ˜¯MaterializeIteratorï¼‰èƒ½å¤Ÿé€šè¿‡æ£€æŸ¥ç”Ÿæˆè®¡æ•°å™¨çš„å˜åŒ–æ¥ç¡®å®šæ˜¯å¦éœ€è¦é‡æ–°ç‰©åŒ–æ•°æ®ã€‚è¿™ç§æœºåˆ¶é€šå¸¸ç”¨äºLATERALè¡¨çš„åœºæ™¯ï¼Œå³è¿æ¥ä¸€ä¸ªä¾èµ–äºè¿æ¥ä¸­è¾ƒæ—©å†…å®¹çš„æ´¾ç”Ÿè¡¨ã€‚</li>
</ul>
<pre><code class="language-sql">explain format=tree select t1.*, dt.c from t t1, lateral (select count(*) as c from t t2 left join t t3 on t3.a&gt;t2.a-t1.a) as dt;
| -&gt; Nested loop inner join  (cost=7 rows=2)
    -&gt; Invalidate materialized tables (row from t1)  (cost=0.45 rows=2)
        -&gt; Table scan on t1  (cost=0.45 rows=2)
    -&gt; Table scan on dt  (cost=3.89..3.89 rows=1)
        -&gt; Materialize (invalidate on row from t1)  (cost=1.38..1.38 rows=1)
            -&gt; Aggregate: count(0)  (cost=1.28 rows=1)
                -&gt; Left hash join (no condition), extra conditions: (t3.a &gt; (t2.a - t1.a))  (cost=0.875 rows=4)
                    -&gt; Table scan on t2  (cost=0.45 rows=2)
                    -&gt; Hash
                        -&gt; Table scan on t3  (cost=0.225 rows=2)
</code></pre>
<h3 id="appenditerator"><a class="header" href="#appenditerator">AppendIterator</a></h3>
<ul>
<li>
<p>union all ä¸“ç”¨ï¼Œä¾æ¬¡æ‰§è¡Œchild ï¼Œç„¶åè¾“å‡º</p>
</li>
<li>
<p>union ä½¿ç”¨çš„æ˜¯ MaterializeIteratorï¼Œç‰©åŒ–ä¹‹åå»é‡</p>
</li>
</ul>
<pre><code class="language-sql">explain format=tree select * from t2 union all select * from t3 union all select * from t4;
| -&gt; Append  (cost=1.45 rows=7)
    -&gt; Stream results  (cost=0.55 rows=3)
        -&gt; Table scan on t2  (cost=0.55 rows=3)
    -&gt; Stream results  (cost=0.45 rows=2)
        -&gt; Table scan on t3  (cost=0.45 rows=2)
    -&gt; Stream results  (cost=0.45 rows=2)
        -&gt; Table scan on t4  (cost=0.45 rows=2)
</code></pre>
<h3 id="streamingiterator"><a class="header" href="#streamingiterator">StreamingIterator</a></h3>
<ul>
<li>
<p>StreamingIterator ä¸»è¦ç”¨äºä¼˜åŒ–å™¨é€šå¸¸ä¼šè®¾ç½®ç‰©åŒ–æ“ä½œä½†å®é™…ä¸éœ€è¦çš„åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯å½“ä½ ä¸éœ€è¦å¤šæ¬¡è¯»å–å†™å…¥çš„è¡Œï¼Œä¹Ÿä¸éœ€è¦é€šè¿‡ç´¢å¼•è®¿é—®ï¼ˆåªéœ€è¦å•æ¬¡è¡¨æ‰«æï¼‰çš„æƒ…å†µã€‚å®ƒè¿˜è´Ÿè´£åœ¨ä¸´æ—¶è¡¨ä¸Šè®¾ç½®NULLè¡Œæ ‡å¿—</p>
</li>
<li>
<p>ä»–åªæ˜¯èµ·åˆ°ä¸€ä¸ªæ•°æ®ä¸­è½¬çš„ä½œç”¨ï¼Œå› ä¸ºæœ€ç»ˆè¾“å‡ºçš„æ—¶å€™ï¼ŒQuery_result å¤„ç†çš„ field åªèƒ½æ˜¯æ¥è‡ªäºåŒä¸€å¼ è¡¨çš„ï¼Œè¯¦æƒ…å‚è€ƒ<a href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E5%8A%A8%E9%97%AE%E9%A2%98">è¿­ä»£å™¨ä¸­çš„æ•°æ®æµåŠ¨</a></p>
</li>
</ul>
<h3 id="deleterowsiterator"><a class="header" href="#deleterowsiterator">DeleteRowsIterator</a></h3>
<ul>
<li>ä¸ç¡®å®šæœ‰ä½•åŒºåˆ«</li>
</ul>
<blockquote>
<p>TODO: è°ƒæŸ¥å…·ä½“ç»†èŠ‚</p>
</blockquote>
<pre><code class="language-sql">EXPLAIN FORMAT=tree delete t1.* from t1;
| -&gt; Delete from t1 (immediate)  (cost=0.65 rows=4)
    -&gt; Table scan on t1  (cost=0.65 rows=4)

EXPLAIN FORMAT=tree delete  from t1;
| -&gt; &lt;not executable by iterator executor&gt;
</code></pre>
<h2 id="the-end"><a class="header" href="#the-end">The end</a></h2>
<p>å¯¹äºSQLè€Œè¨€ï¼Œé€»è¾‘ç®—å­æ˜¯ç¡®å®šçš„ï¼Œä¸€æ¡è¯­å¥åŸºæœ¬å¯ä»¥å”¯ä¸€å¯¹åº”æ£µé€»è¾‘æ ‘ï¼›ä½†æ˜¯å…·ä½“åˆ°æ‰§è¡Œé˜¶æ®µï¼Œä¸€ä¸ªé€»è¾‘ç®—å­å¯èƒ½å¯¹åº”å¤šç§ç‰©ç†å®ç°ï¼Œ
ä¾‹å¦‚å¯¹äº table æ¥è¯´ï¼Œé™¤äº†æœ€åŸºç¡€çš„ seqscan ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ index åŠ é€ŸæŸ¥è¯¢ã€‚å¯¹äº join æ¥è¯´ï¼Œä¸»æµçš„ç‰©ç†ç®—å­æœ‰ nestloop joinï¼Œ
merge joinï¼Œhash join ç­‰</p>
<p>MySQL å½“å‰å…±æœ‰ 55 ä¸­è¿­ä»£å™¨ï¼Œä½†æ˜¯éƒ¨åˆ†è¿­ä»£å™¨æ˜¯ç›¸äº’ç»‘å®šçš„ï¼Œæ— æ³•ç‹¬ç«‹ä½¿ç”¨ï¼Œä¾‹å¦‚ CacheInvalidatorIterator å¿…é¡»ä¾èµ–äº MaterializeIteratorï¼Œè¿˜æœ‰çš„æ˜¯ä¸ºäº†
å®ç°æŸäº›ç‰¹å®šçš„ä¼˜åŒ–ï¼Œä¾‹å¦‚ Count(*)ï¼Œæœ‰ä¸“ç”¨çš„ UnqualifiedCountIteratorï¼›å¦å¤–å°±æ˜¯åŠŸèƒ½ä¸Šè¾ƒä¸ºåˆ†æ•£ï¼Œè¿­ä»£å™¨åŠŸèƒ½å®ç°ä¸å•ä¸€ï¼Œæœ‰çš„è¿­ä»£å™¨å®ç°ä¸­è¿˜å…³è”ä¸€äº›å…¶ä»–è¿­ä»£å™¨çš„å®ç°</p>
<p>æ€»ä¹‹ä¸ç†Ÿæ‚‰çš„äººæ— æ³•å°±æ‰§è¡Œè®¡åˆ’å…·ä½“çœ‹å‡ºè¯­å¥çš„å®é™…æ‰§è¡Œæƒ…å†µã€‚æ€»ç»“ä¸‹æ¥å­˜åœ¨å‡ ä¸ªé—®é¢˜</p>
<ol>
<li>åŠŸèƒ½è®¾è®¡è¿‡äºåˆ†æ•£ï¼Œæ²¡æœ‰ç»Ÿä¸€çš„æ ‡å‡†ï¼Œå¯¼è‡´ç†è§£å›°éš¾</li>
<li>è¿­ä»£å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»å¤æ‚ï¼Œæœ‰çš„è¿­ä»£å™¨éœ€è¦ä¾èµ–å…¶ä»–è¿­ä»£å™¨ï¼Œæ— æ³•ç‹¬ç«‹å­˜åœ¨</li>
<li>å­˜åœ¨ä¸€äº›ç‰¹æ®Šä¼˜åŒ–ï¼Œå¯¼è‡´éƒ¨åˆ†è¿­ä»£å™¨æ²¡æœ‰é€šç”¨æ€§ï¼Œåªèƒ½é™å®šåœ¨éƒ¨åˆ†åœºæ™¯ä¸‹ä½¿ç”¨</li>
<li>è¡¨è¾¾å¼è¿ç®—æ¶æ„å¤æ‚ï¼Œä¸”è¿ç®—ä¸­æ— å…³æ“ä½œå¤ªå¤šï¼Œå¯¼è‡´è¡¨è¾¾å¼è¿ç®—æœ‰è¾ƒå¤§çš„æ€§èƒ½é—®é¢˜ï¼Œæ— æ³•ç”¨äº AP åœºæ™¯
<ul>
<li>MySQL çš„è¡¨è¾¾å¼å®ç°è¢«<a href="https://zhuanlan.zhihu.com/p/376227899">å…¬å¼€æ‰¹æ–—</a>ï¼ŒTPCH Q1 æ˜¯å…¸å‹çš„APåœºæ™¯ï¼Œè¡¨è¾¾å¼çš„å®é™…è®¡ç®—å æ¯”ä¸è¶³10%</li>
<li>MySQL TPCH Q1 åœ¨æ€»çš„TPCHè¯­å¥ä¸­å æ¯”ä¸º 13.77%ï¼Œè€Œ pg çš„å æ¯”åªæœ‰ 2.16%ï¼Œè¿™è¯´æ˜ MySQL çš„è¡¨è¾¾å¼å®ç°è¿˜æœ‰ä¼˜åŒ–ç©ºé—´
<ul>
<li>ç›¸æ¯”ä¹‹ä¸‹ï¼Œpg çš„å­æŸ¥è¯¢è¿˜éœ€è¦è¿›è¡Œä¼˜åŒ–ï¼Œ</li>
</ul>
</li>
</ul>
</li>
</ol>
<p><img src="https://youke1.picui.cn/s1/2025/07/18/6879fd88356bb.png" alt="alt text" /></p>
<pre><code>
https://github.com/digoal/blog/blob/307dbe4a3fb2a9f800a09a5402f9782bff1172f1/202405/20240525_01.md

https://bbkv6krkep.feishu.cn/wiki/ClpKwq4nMiqU91kfWUbccvCXn9b

    MySQL 8032 sf=100      pg 14.2 sf = 20
Q1  1082.89    |    20  |	162.633          Time: 60317.546 ms (01:00.318)  
Q2  161.951    |    13 |	894.933          Time: 88929.610 ms (01:28.930)  
Q3  334.043    |    17|	43.552          Time: 32596.940 ms (00:32.597)  
Q4  101.223    |    16 |	14.084          Time: 48620.736 ms (00:48.621)  
Q5  198.459    |    10 |	46.459          Time: 55727.432 ms (00:55.727)  
Q6  200.663    |    2 |	28.383          Time: 207391.359 ms (03:27.391)  
Q7  169.708    |    21  |	86.762          Time: 27132.845 ms (00:27.133)  
Q8  460.922    |    11  |	68.929          Time: 117553.008 ms (01:57.553)  
Q9  1044.799   |    37  |	72.851          Time: 829795.748 ms (13:49.796)  
Q10 708.707    |    15  |	158.35          Time: 45392.179 ms (00:45.392)  
Q11 41.389     |    12 |	21.465          Time: 32471.915 ms (00:32.472)  
Q12 276.111    |    20 |	42.711          Time: 25439.356 ms (00:25.439)  
Q13 507.158    |    17 |	56.275          Time: 22745.637 ms (00:22.746)  
Q14 240.353    |    5 |	115.228          Time: 153935.888 ms (02:33.936)  
Q15 702.478    |    4 |	45.295          Time: 124949.464 ms (02:04.949)  
Q16 41.016     |    21 |	42.947          Time: 12197.386 ms (00:12.197)  
Q17 31.761     |    15 |	10.935          Time: 14841.749 ms (00:14.842)  
Q18 271.464    |    19  |	375.221          Time: 42511.465 ms (00:42.511)  
Q19 24.347     |    11 |	10.685          Time: 38056.589 ms (00:38.057)  
Q20 147.665    |    17  |	11.367          Time: 505946.346 ms (08:25.946)  
Q21 1093.338   |    35  |	44.189          Time: 302506.388 ms (05:02.506)  
Q22 19.613     |    11  |	15.214          Time: 1880.400 ms (00:01.880)  
    7860.058                                 2790939.986
</code></pre>
<hr>
<ol class="footnote-definition"><li id="footnote-Iteator">
<p><a href="https://paperhub.s3.amazonaws.com/dace52a42c07f7f8348b08dc2b186061.pdf">Volcano-An Extensible and Parallel Query Evaluation System</a> <a href="#fr-Iteator-1">â†©</a></p>
</li>
</ol>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../internal/optimizer/cost.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../internal/subquery/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../internal/optimizer/cost.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../internal/subquery/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr.min.js"></script>
        <script src="../../mark.min.js"></script>
        <script src="../../searcher.js"></script>

        <script src="../../clipboard.min.js"></script>
        <script src="../../highlight.js"></script>
        <script src="../../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
