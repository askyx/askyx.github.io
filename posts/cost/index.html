<!doctype html><html lang=en><head><title>æ‰§è¡Œè®¡åˆ’ä»£ä»·è®¡ç®—è§„åˆ™æ¢³ç† ::
Asky â€” My note blog
</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="è¡¨å’Œå„ä¸ªindexçš„ç‰©ç†ç»“æ„åŠæ•°æ®æ“ä½œ ç»Ÿè®¡ä¿¡æ¯ cost è®¡ç®— demo é€‰æ‹©ç‡çš„è®¡ç®— åŸºè¡¨cost index cost pageinspect
PostgreSQLç´¢å¼•ç³»åˆ—æ–‡ç« é“¾æ¥æ±‡æ€»
ç»Ÿè®¡ä¿¡æ¯ä¸é€‰æ‹©ç‡ä¸ä»£ä»·è®¡ç®— # å½“å‰ç»Ÿè®¡ä¿¡æ¯ä¼šæ”¶é›†ä¸‹é¢æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è§†å›¾ pg_stats æŸ¥çœ‹ï¼Œåœ¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯çš„æ—¶å€™ï¼Œä½¿ç”¨ç›¸å…³ä¿¡æ¯è®¡ç®—é€‰æ‹©ç‡
* Histogramï¼šç›´æ–¹å›¾ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„ç”¨æ¥æè¿°æ•°æ®çš„åˆ†å¸ƒï¼Œå½“å‰pgä¸­è®¡ç®—çš„æ˜¯ç­‰é«˜ç›´æ–¹å›¾ï¼Œåœ¨æ¯ä¸€ä¸ªèŒƒå›´å†…ï¼Œæ•°æ®æ•°é‡å‡ç­‰ * Most common values: å‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¸€ç»„å€¼ã€‚å°†å®ƒä»¬è¸¢å‡ºç›´æ–¹å›¾å¯ä»¥å‡å°‘æç«¯å€¼é€ æˆçš„ä¼°ç®—è¯¯å·®ã€‚ * Distinct Number: å³è¿™ä¸€åˆ—ä¸€å…±æœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ PostgreSQL å¹¶æ²¡æœ‰ä¸ºç›´æ–¹å›¾çš„ æ¯ä¸ª bucket ç»´æŠ¤ä¸€ä¸ª bucket æœ¬èº«çš„ä¸åŒçš„å€¼ã€‚ * NULL values: æœ‰å¤šå°‘è¡Œçš„å€¼ä¸º NULLã€‚å› ä¸º NULL æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„å€¼ï¼Œæ‰€ä»¥ä¹Ÿä¼šå°† NULL å•ç‹¬æ‹¿å‡ºæ¥è¿›è¡Œç»´æŠ¤ * Average value width in bytes: åˆ—å¹³å‡é•¿åº¦ï¼Œè®°å½•è¿™ä¸ªå€¼å¯ä»¥ç”¨æ¥å¯¹ SQL ä½¿ç”¨çš„å†…å­˜å¤§å°è¿›è¡Œä¼°ç®—ï¼Œä»¥åŠ å¯¹ IO å¼€é”€è¿›è¡Œæ›´ç»†è‡´çš„ä¼°ç®—ã€‚ * Correlation: ç´¢å¼•å’Œä¸»é”®ï¼ˆæˆ–è€…è¯´ row idï¼‰ä¹‹é—´çš„é¡ºåºç›¸å…³ç¨‹åº¦ã€‚æ­£ç›¸å…³ä¸º1ï¼Œè´Ÿç›¸å…³ä¸º-1ï¼Œå®é™…ä¸Šæ˜¯ç»Ÿè®¡çš„åæ–¹å·® é€‰æ‹©ç‡ # é€‰æ‹©ç‡ç”¨äºè®¡ç®—çº¦æŸæ¡ä»¶è¿‡æ»¤ä¹‹åå¤§çš„æ•°æ®é‡å¤§å°ï¼Œä¸»è¦ç”¨äºä»£ä»·è®¡ç®—ä¸­ä¼°ç®—æ‰§è¡Œä»£ä»·ï¼Œé€‰æ‹©ç‡çš„è®¡ç®—ä¸»è¦ä¼šä½¿ç”¨åˆ°ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯å’ŒMCV
å¯¹äºç­‰å€¼çº¦æŸï¼Œåªä¼šä½¿ç”¨ MCV è¿›è¡Œè®¡ç®—ï¼ŒMCVæ˜¯ç»Ÿè®¡çš„é«˜é¢‘å€¼ é¦–å…ˆéœ€è¦åˆ¤æ–­åˆ— isuniqueï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ­¤æ—¶æ˜¯æ²¡æœ‰mcv ï¼Œç›´æ¥ä½¿ç”¨å…¬å¼ selec = 1.0 / rel-&amp;gt;tuples è®¡ç®—é€‰æ‹©ç‡ å¦åˆ™å¦‚æœæ¡ä»¶ä¸­å¸¸æ•°åˆšå¥½æ˜¯ MCV ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰ MCV å¯¹åº”çš„æ¦‚ç‡å³å¯ å¦åˆ™ä»–å‡è®¾æ•°æ®æ˜¯å‡åŒ€åˆ†å¸ƒï¼Œå…ˆå»é™¤ MCV å’Œ nullfac çš„æ¦‚ç‡ä¹‹åï¼Œç„¶åå†é™¤ä»¥ otherdistinctï¼Œè®¡ç®—å…¬å¼ä¸º selec = (1.0 - sumcommon - nullfrac) / otherdistinct å¦‚ä¸‹ä¾‹å­ï¼Œ100 ä¸æ˜¯ MCVï¼Œå¯¹åº”ä¸Šé¢ç¬¬ä¸‰æ¡è§„åˆ™
esoye=# explain select * from t1 where a = 100; QUERY PLAN ------------------------------------------------------------------- Bitmap Heap Scan on t1 (cost=5."><meta name=keywords content="ç¨‹åºå‘˜ã€ç å†œã€databaseã€C++"><meta name=robots content="noodp"><link rel=canonical href=https://askyx.github.io/posts/cost/><link rel=stylesheet href=//cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css media=print onload='this.media="all"'><link rel=stylesheet href=https://askyx.github.io/assets/style.css><link rel=stylesheet href=https://askyx.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://askyx.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://askyx.github.io/favicon.ico><link rel=apple-touch-icon href=https://askyx.github.io/favicon.ico><link rel=bookmark href=https://askyx.github.io/favicon.ico><link rel=apple-touch-icon-precomposed sizes=180x180 href=https://askyx.github.io/favicon.ico><meta name=twitter:card content="summary"><meta name=twitter:title content="æ‰§è¡Œè®¡åˆ’ä»£ä»·è®¡ç®—è§„åˆ™æ¢³ç†"><meta name=twitter:description content="pgä¸­å„ä¸ªç®—å­çš„ä»£ä»·è®¡ç®—"><meta property="og:title" content="æ‰§è¡Œè®¡åˆ’ä»£ä»·è®¡ç®—è§„åˆ™æ¢³ç†"><meta property="og:description" content="pgä¸­å„ä¸ªç®—å­çš„ä»£ä»·è®¡ç®—"><meta property="og:type" content="article"><meta property="og:url" content="https://askyx.github.io/posts/cost/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-17T09:38:28+08:00"><meta property="article:modified_time" content="2023-02-17T09:38:28+08:00"></head><body class=light-theme><div class=container><header class=header><span class=header__inner><a href=https://askyx.github.io/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a><span class=header__right><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/books/duckdb_internal>DuckDB</a></li><li><a href=/search>ğŸ”</a></li><li><a href=javascript:; onclick=randomPost() title=éšæœºè®¿é—®ä¸€ç¯‡æ–‡ç« ><svg t="1660103436159" class="icon search-box-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1184" width="32" height="32"><path d="M421.376 481.28s117.248 24.576 175.104-8.704c0 0-89.6 70.144-89.6 166.4.512-.512-8.192-121.344-85.504-157.696zm17.408 487.936s68.608 6.656 68.608-80.896c0 0 3.072 88.576 65.024 78.336.0.512-50.688 22.016-133.632 2.56zM161.28 238.08s-30.208 65.536 11.264 91.648c0 0-67.072-17.408-81.408 37.376.0.0 8.704-82.944 70.144-129.024zM857.6 227.328s49.152 50.176 1.024 81.408c0 0 58.88-18.432 66.56 36.352.0.0 5.12-69.632-67.584-117.76z" p-id="1185"/><path d="M443.392 970.752c-5.632.0-10.752-1.024-15.36-3.072L157.184 810.496l-1.536-1.024s-1.024-1.024-4.608-2.56c-51.2-29.184-62.976-94.208-65.536-120.832V386.56c0-3.072.512-7.168 1.024-11.264l.512-3.584 1.024-2.56c19.456-50.688 76.8-51.2 103.936-44.032l-1.536 5.632 4.096-6.144L476.16 486.4l18.944 37.888c20.992 36.864 29.184 77.824 32.768 99.84v258.048c-4.608 56.32-36.864 76.288-55.808 82.944-1.024.512-15.36 5.632-28.672 5.632zM181.248 774.656l263.168 152.576c12.288-.512 36.864-6.656 40.448-48.128V628.736c-4.608-31.744-20.992-103.936-72.192-128L322.56 445.44l1.536 3.072L181.76 366.08c-2.048-.512-40.448-9.216-52.736 15.872-.512 2.56-.512 4.608-.512 6.144v294.4c1.536 16.896 9.728 67.072 43.52 86.528 3.584 2.048 6.656 4.096 9.216 5.632z" p-id="1186"/><path d="M837.632 212.992c6.656 4.096 12.8 7.168 18.432 10.752l1.536 1.024 1.536 1.536c5.12 4.096 10.752 9.216 16.384 15.36 6.144 11.776 5.632 33.28 4.608 49.152-1.024 12.288-6.656 30.208-26.624 44.544l-1.024.512-247.808 156.672c-26.624 14.336-62.976 18.432-96.256 18.432-40.96.0-77.824-6.656-89.088-8.704l-3.072-.512-245.248-142.336c-39.424-29.696-28.16-85.504-15.36-113.664l2.56-6.144 263.68-166.912c29.184-14.336 104.448-43.008 173.056-1.024 3.584 2.56 58.368 34.304 119.296 69.632M431.616 460.8c40.448 7.168 114.176 13.824 152.576-6.144L828.928 299.52c7.168-5.632 8.192-10.24 8.704-12.8 1.024-11.264-9.728-26.624-15.36-32.768-55.808-32.256-243.712-141.312-250.368-145.408-49.664-30.72-107.008-9.216-130.048 2.56L192.512 268.8c-4.096 12.288-12.288 42.496 3.584 55.808L431.616 460.8z" p-id="1187"/><path d="M831.488 299.008c4.096-1.024 38.4-11.264 66.048 6.144 7.168 4.608 17.92 11.776 24.064 24.576 1.024 5.632 4.096 10.752 4.608 16.896v2.048l-1.024 323.072c-5.12 35.328-22.528 91.648-77.312 125.44l-5.12 3.584h-1.024L579.584 966.656l-4.608.512c-4.096.512-8.704 1.024-12.8 1.024-15.872.0-30.208-5.12-41.984-14.848-24.576-20.48-32.768-55.808-35.328-73.728l-1.024-252.928h1.536c6.144-96.768 88.576-164.864 96.768-171.008l-.512-.512L829.44 299.52M528.384 867.328c.512 10.24 5.12 41.472 19.968 53.76 3.072 2.56 7.68 5.632 16.384 5.12L829.44 758.272c56.32-38.4 53.76-115.712 53.76-116.224l-.512-32.256 1.024-250.368h-.512c-1.536-12.8-7.168-16.384-8.704-17.408-8.704-5.632-23.552-3.072-28.672-2.048L610.304 488.96c-1.024.512-80.896 65.024-80.896 149.504h-1.536l.512 228.864zM435.2 264.192c0 27.648 31.744 50.176 71.168 50.176s71.168-22.528 71.168-50.176-31.744-50.176-71.168-50.176S435.2 236.544 435.2 264.192z" p-id="1188"/><path d="M663.552 782.848c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-50.176-.512-50.176-31.232s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM760.32 602.624c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-49.664-.512-49.664-31.232s22.528-67.072 49.664-80.384c27.136-13.824 49.664.512 49.664 31.232zM867.84 428.032c0 30.72-22.528 67.072-49.664 80.384C790.528 522.24 768 507.904 768 477.184s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM270.848 538.112c0 30.72-22.016 41.984-48.64 24.576-27.136-16.896-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528zm161.28 285.184c0 30.72-22.016 41.984-48.64 24.576-26.624-17.408-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528z" p-id="1189"/></svg></a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/about>About</a></li><li><a href=/archive>Archive</a></li><li><a href=/books/duckdb_internal>DuckDB</a></li><li><a href=/search>ğŸ”</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><div class=breadcrumb><li><a href=https://askyx.github.io/>é¦–é¡µ</a></li><li><a href=https://askyx.github.io/posts/>Posts</a></li><li class=active><a href=https://askyx.github.io/posts/cost/>æ‰§è¡Œè®¡åˆ’ä»£ä»·è®¡ç®—è§„åˆ™æ¢³ç†</a></li></div><h2 class=post-title><a href=https://askyx.github.io/posts/cost/>æ‰§è¡Œè®¡åˆ’ä»£ä»·è®¡ç®—è§„åˆ™æ¢³ç†</a></h2><div class=post-meta><span class=post-date>2023-02-17</span></div><div class=post-content><ol><li>è¡¨å’Œå„ä¸ªindexçš„ç‰©ç†ç»“æ„åŠæ•°æ®æ“ä½œ</li><li>ç»Ÿè®¡ä¿¡æ¯</li><li>cost è®¡ç®—</li><li>demo</li><li>é€‰æ‹©ç‡çš„è®¡ç®—</li><li>åŸºè¡¨cost</li><li>index cost</li></ol><p><a href=http://postgres.cn/docs/14/pageinspect.html>pageinspect</a></p><p><a href=https://www.mengqingzhong.com/2020/10/01/postgresql-index-linnks/>PostgreSQLç´¢å¼•ç³»åˆ—æ–‡ç« é“¾æ¥æ±‡æ€»</a></p><h2 id=ç»Ÿè®¡ä¿¡æ¯ä¸é€‰æ‹©ç‡ä¸ä»£ä»·è®¡ç®—>ç»Ÿè®¡ä¿¡æ¯ä¸é€‰æ‹©ç‡ä¸ä»£ä»·è®¡ç®—
<a href=#%e7%bb%9f%e8%ae%a1%e4%bf%a1%e6%81%af%e4%b8%8e%e9%80%89%e6%8b%a9%e7%8e%87%e4%b8%8e%e4%bb%a3%e4%bb%b7%e8%ae%a1%e7%ae%97 class=h-anchor aria-hidden=true>#</a></h2><p>å½“å‰ç»Ÿè®¡ä¿¡æ¯ä¼šæ”¶é›†ä¸‹é¢æ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨è§†å›¾ <code>pg_stats</code> æŸ¥çœ‹ï¼Œåœ¨ä½¿ç”¨ç»Ÿè®¡ä¿¡æ¯çš„æ—¶å€™ï¼Œä½¿ç”¨ç›¸å…³ä¿¡æ¯è®¡ç®—é€‰æ‹©ç‡</p><pre><code>* Histogramï¼šç›´æ–¹å›¾ï¼Œè¿™ä¸ªæ•°æ®ç»“æ„ç”¨æ¥æè¿°æ•°æ®çš„åˆ†å¸ƒï¼Œå½“å‰pgä¸­è®¡ç®—çš„æ˜¯ç­‰é«˜ç›´æ–¹å›¾ï¼Œåœ¨æ¯ä¸€ä¸ªèŒƒå›´å†…ï¼Œæ•°æ®æ•°é‡å‡ç­‰
* Most common values: å‡ºç°æ¬¡æ•°æœ€å¤šçš„ä¸€ç»„å€¼ã€‚å°†å®ƒä»¬è¸¢å‡ºç›´æ–¹å›¾å¯ä»¥å‡å°‘æç«¯å€¼é€ æˆçš„ä¼°ç®—è¯¯å·®ã€‚
* Distinct Number: å³è¿™ä¸€åˆ—ä¸€å…±æœ‰å¤šå°‘ä¸ªä¸åŒçš„å€¼ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ PostgreSQL å¹¶æ²¡æœ‰ä¸ºç›´æ–¹å›¾çš„
  æ¯ä¸ª bucket ç»´æŠ¤ä¸€ä¸ª bucket æœ¬èº«çš„ä¸åŒçš„å€¼ã€‚
* NULL values: æœ‰å¤šå°‘è¡Œçš„å€¼ä¸º NULLã€‚å› ä¸º NULL æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„å€¼ï¼Œæ‰€ä»¥ä¹Ÿä¼šå°† NULL å•ç‹¬æ‹¿å‡ºæ¥è¿›è¡Œç»´æŠ¤
* Average value width in bytes: åˆ—å¹³å‡é•¿åº¦ï¼Œè®°å½•è¿™ä¸ªå€¼å¯ä»¥ç”¨æ¥å¯¹ SQL ä½¿ç”¨çš„å†…å­˜å¤§å°è¿›è¡Œä¼°ç®—ï¼Œä»¥åŠ
  å¯¹ IO å¼€é”€è¿›è¡Œæ›´ç»†è‡´çš„ä¼°ç®—ã€‚
* Correlation: ç´¢å¼•å’Œä¸»é”®ï¼ˆæˆ–è€…è¯´ row idï¼‰ä¹‹é—´çš„é¡ºåºç›¸å…³ç¨‹åº¦ã€‚æ­£ç›¸å…³ä¸º1ï¼Œè´Ÿç›¸å…³ä¸º-1ï¼Œå®é™…ä¸Šæ˜¯ç»Ÿè®¡çš„åæ–¹å·®
</code></pre><h3 id=é€‰æ‹©ç‡>é€‰æ‹©ç‡
<a href=#%e9%80%89%e6%8b%a9%e7%8e%87 class=h-anchor aria-hidden=true>#</a></h3><p>é€‰æ‹©ç‡ç”¨äºè®¡ç®—çº¦æŸæ¡ä»¶è¿‡æ»¤ä¹‹åå¤§çš„æ•°æ®é‡å¤§å°ï¼Œä¸»è¦ç”¨äºä»£ä»·è®¡ç®—ä¸­ä¼°ç®—æ‰§è¡Œä»£ä»·ï¼Œé€‰æ‹©ç‡çš„è®¡ç®—ä¸»è¦ä¼šä½¿ç”¨åˆ°ç›´æ–¹å›¾ç»Ÿè®¡ä¿¡æ¯å’ŒMCV</p><ul><li>å¯¹äºç­‰å€¼çº¦æŸï¼Œåªä¼šä½¿ç”¨ MCV è¿›è¡Œè®¡ç®—ï¼ŒMCVæ˜¯ç»Ÿè®¡çš„é«˜é¢‘å€¼<ul><li>é¦–å…ˆéœ€è¦åˆ¤æ–­åˆ— isuniqueï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ­¤æ—¶æ˜¯æ²¡æœ‰mcv ï¼Œç›´æ¥ä½¿ç”¨å…¬å¼ <code>selec = 1.0 / rel->tuples </code>è®¡ç®—é€‰æ‹©ç‡</li><li>å¦åˆ™å¦‚æœæ¡ä»¶ä¸­å¸¸æ•°åˆšå¥½æ˜¯ MCV ï¼Œåˆ™ç›´æ¥è¿”å›å½“å‰ MCV å¯¹åº”çš„æ¦‚ç‡å³å¯</li><li>å¦åˆ™ä»–å‡è®¾æ•°æ®æ˜¯å‡åŒ€åˆ†å¸ƒï¼Œå…ˆå»é™¤ MCV å’Œ nullfac çš„æ¦‚ç‡ä¹‹åï¼Œç„¶åå†é™¤ä»¥ otherdistinctï¼Œè®¡ç®—å…¬å¼ä¸º <code>selec = (1.0 - sumcommon - nullfrac) / otherdistinct</code></li></ul></li></ul><p>å¦‚ä¸‹ä¾‹å­ï¼Œ100 ä¸æ˜¯ MCVï¼Œå¯¹åº”ä¸Šé¢ç¬¬ä¸‰æ¡è§„åˆ™</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> a <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>                            QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>-------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Bitmap Heap Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span>.<span style=color:#ae81ff>19</span>..<span style=color:#ae81ff>362</span>.<span style=color:#ae81ff>44</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>99</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>Recheck</span> Cond: (a <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>   <span style=color:#f92672>-&gt;</span>  Bitmap <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>on</span> idx  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>5</span>.<span style=color:#ae81ff>17</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>99</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Index</span> Cond: (a <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>4</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>n_distinct             <span style=color:#f92672>|</span> <span style=color:#ae81ff>10037</span>
</span></span><span style=display:flex><span>most_common_vals       <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>6531</span>,<span style=color:#ae81ff>9646</span>,<span style=color:#ae81ff>4220</span>,<span style=color:#ae81ff>5958</span>,<span style=color:#ae81ff>710</span>,<span style=color:#ae81ff>933</span>,<span style=color:#ae81ff>1058</span>,<span style=color:#ae81ff>1082</span>,<span style=color:#ae81ff>3047</span>,<span style=color:#ae81ff>5060</span>,<span style=color:#ae81ff>6971</span>,<span style=color:#ae81ff>7584</span>,<span style=color:#ae81ff>8043</span>,<span style=color:#ae81ff>9110</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>most_common_freqs      <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0004</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0004</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00036666667</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00036666667</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,
</span></span><span style=display:flex><span>                          <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,
</span></span><span style=display:flex><span>                          <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00033333333</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>æ­¤æ—¶åœ¨å‡½æ•°</span> eqsel_internal <span style=color:#960050;background-color:#1e0010>è°ƒç”¨çš„å‡½æ•°</span> var_eq_const <span style=color:#960050;background-color:#1e0010>ä¸­ï¼Œå¤§è‡´çš„è®¡ç®—è¿‡ç¨‹ä¸º</span>
</span></span><span style=display:flex><span>selec <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>0</span> <span style=color:#f92672>-</span> sumcommon <span style=color:#f92672>-</span> nullfrac) <span style=color:#f92672>/</span> otherdistinct 
</span></span><span style=display:flex><span>      <span style=color:#f92672>=</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0048666666261851788</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>99513333337381482</span>) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>10037</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>14</span>) 
</span></span><span style=display:flex><span>      <span style=color:#f92672>=</span> <span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>9284977888238531</span>e<span style=color:#f92672>-</span><span style=color:#ae81ff>05</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>9284977888238531</span>e<span style=color:#f92672>-</span><span style=color:#ae81ff>05</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000000</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>99</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>å¯¹äºä¸ç­‰äºï¼Œä¹Ÿæ˜¯åŒæ ·çš„è®¡ç®—é€»è¾‘</span>
</span></span></code></pre></div><ul><li>å¯¹äº &ldquo;&lt;&rdquo;, &ldquo;&lt;=&rdquo;, &ldquo;>&rdquo;, &ldquo;>="ï¼Œåˆ†ä¸ºä¸‹é¢ä¸‰ç§æƒ…å†µ<ol><li>å¦‚æœæ•°æ®æ˜¯å”¯ä¸€çº¦æŸçš„ï¼Œåˆ™æ­¤æ—¶ç»Ÿè®¡ä¿¡æ¯æ²¡æœ‰ MCVï¼Œæ­¤æ—¶ç›´æ¥ä½¿ç”¨ ç›´æ–¹å›¾è®¡ç®—å æ¯”</li><li>å¦åˆ™è®¡ç®—æ—¶ä¼šä½¿ç”¨ç›´æ–¹å›¾å’Œå’Œ MCV ä¸€èµ·è®¡ç®—<ol><li>MCV è®¡ç®—é€‰æ‹©ç‡çš„æ–¹æ³•ä¸ºï¼Œå‡å¦‚æ­¤æ—¶æ˜¯ <code>a &lt; 1000</code>ï¼Œåˆ™ MCV ä¸­æ‰€æœ‰å°äº 1000 çš„å€¼çš„æ¦‚ç‡ç›¸åŠ </li><li>ç›´æ–¹å›¾ä¼šè®¡ç®—å½“å‰å¸¸æ•°åœ¨æ‰€åœ¨æ¡¶ä¸­å¾—åŒºé—´æ¯”ä¾‹ï¼Œç„¶ååŠ ä¸Šå‰é¢æ¡¶å¾—æ•°é‡å†é™¤ä»¥æ‰€æœ‰æ¡¶çš„æ•°é‡ï¼Œè®¡ç®—å…¬å¼ä¸º <code>((i - 1) + ((val - low) / (high - low))) / (sslot.nvalues - 1)</code></li><li>ä½¿ç”¨å…¬å¼ <code>selec = selec * hist_selec + mcv_selec</code> è®¡ç®—æœ€ç»ˆçš„é€‰æ‹©ç‡ï¼Œselec çš„åˆå§‹å€¼ä¸º <code>1.0 - sumcommon - nullfrac</code>ï¼Œè¿™é‡Œæ˜¯å› ä¸ºéœ€è¦å»é™¤ MCV ä¸­é‡å¤è®¡ç®—çš„éƒ¨åˆ†ï¼Œç„¶åä¹˜ä¸Šç›´æ–¹å›¾è®¡ç®—çš„ç»“æœå†åŠ ä¸ŠMCVè®¡ç®—çš„é€‰æ‹©ç‡å³å¯</li></ol></li></ol></li></ul><p>å¦‚ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ’å…¥å¤§é‡1å’Œ2</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>;
</span></span><span style=display:flex><span>                                QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Bitmap Heap Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>6588</span>.<span style=color:#ae81ff>95</span>..<span style=color:#ae81ff>18294</span>.<span style=color:#ae81ff>42</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>372197</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>Recheck</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>   <span style=color:#f92672>-&gt;</span>  Bitmap <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>on</span> idx  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>6495</span>.<span style=color:#ae81ff>90</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>372197</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Index</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>4</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>n_distinct             <span style=color:#f92672>|</span> <span style=color:#ae81ff>9674</span>
</span></span><span style=display:flex><span>most_common_vals       <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>16</span>,<span style=color:#ae81ff>821</span>,<span style=color:#ae81ff>4871</span>,<span style=color:#ae81ff>4903</span>,<span style=color:#ae81ff>5141</span>,<span style=color:#ae81ff>8049</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>most_common_freqs      <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>2432</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>022566667</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>histogram_bounds       <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>95</span>,<span style=color:#ae81ff>197</span>,<span style=color:#ae81ff>291</span>,<span style=color:#ae81ff>400</span>,<span style=color:#ae81ff>504</span>,<span style=color:#ae81ff>593</span>,<span style=color:#ae81ff>700</span>,<span style=color:#ae81ff>794</span>,<span style=color:#ae81ff>901</span>,<span style=color:#ae81ff>1001</span>,<span style=color:#ae81ff>1098</span>,<span style=color:#ae81ff>1192</span>,<span style=color:#ae81ff>1305</span>,<span style=color:#ae81ff>1410</span>.....<span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>åœ¨</span> scalarineqsel <span style=color:#960050;background-color:#1e0010>ä¸­ï¼Œä½¿ç”¨å‡½æ•°</span> mcv_selectivity <span style=color:#960050;background-color:#1e0010>å’Œ</span> ineq_histogram_selectivity <span style=color:#960050;background-color:#1e0010>åˆ†åˆ«è®¡ç®—é€‰æ‹©ç‡ï¼Œç„¶åå†æ±‡æ€»</span>
</span></span><span style=display:flex><span>mcv_selec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>26606667094165459</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>2432</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>022566667</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>
</span></span><span style=display:flex><span>sumcommon <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>26756667101290077</span>
</span></span><span style=display:flex><span>binfrac <span style=color:#f92672>=</span> (val <span style=color:#f92672>-</span> low) <span style=color:#f92672>/</span> (high <span style=color:#f92672>-</span> low) <span style=color:#f92672>=</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>95</span>  <span style=color:#f92672>/</span> <span style=color:#ae81ff>197</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>95</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>049019607843137254</span>
</span></span><span style=display:flex><span>histfrac <span style=color:#f92672>=</span> ((double) (i <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>+</span> binfrac ) <span style=color:#f92672>/</span> (double) (sslot.nvalues <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>04901</span> <span style=color:#f92672>/</span> <span style=color:#ae81ff>100</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>01049</span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>æœ€ç»ˆä½¿ç”¨å…¬å¼</span>
</span></span><span style=display:flex><span>selec <span style=color:#f92672>=</span> selec <span style=color:#f92672>*</span> hist_selec <span style=color:#f92672>+</span> mcv_selec <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>27367426598623362</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1360000</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>273</span> <span style=color:#f92672>=</span>  <span style=color:#ae81ff>372197</span>.<span style=color:#ae81ff>00174127775</span>
</span></span></code></pre></div><ul><li>å¯¹äºå¤šä¸ªçº¦æŸæ¡ä»¶ï¼ŒPGå‡è®¾æ¡ä»¶ç‹¬ç«‹ï¼Œä¼šä½¿ç”¨ç®€å•çš„æ¦‚ç‡å¯¹å•ä¸ªçº¦æŸæ¡ä»¶è¿›è¡Œæ±‡æ€»</li></ul><pre tabindex=0><code>P(A+B) = P(A) + P(B) - P(AB) 
P(AB) = P(A) Ã— P(B) 
</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>c</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9800</span>;
</span></span><span style=display:flex><span>                         QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Seq Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>27453</span>.<span style=color:#ae81ff>00</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>387263</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>   Filter: ((a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>) <span style=color:#66d9ef>OR</span> (<span style=color:#66d9ef>c</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9800</span>))
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>2</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>å‡è®¾</span> <span style=color:#66d9ef>or</span> <span style=color:#960050;background-color:#1e0010>å·¦å³ä¸¤ç«¯çº¦æŸæ¡ä»¶ä¸æƒ³å…³ï¼Œåˆ™ä¼šä½¿ç”¨æ¦‚ç‡åŠ æ³•å…¬å¼è¿›è¡Œè®¡ç®—ï¼Œåœ¨å‡½æ•°</span> clauselist_selectivity_or <span style=color:#960050;background-color:#1e0010>ä¸­ï¼Œ</span>
</span></span><span style=display:flex><span>p(a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>273</span>
</span></span><span style=display:flex><span>p(<span style=color:#66d9ef>c</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9800</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>015</span>
</span></span><span style=display:flex><span>p(a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>or</span> <span style=color:#66d9ef>c</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>9800</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>273</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0152</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>015</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>273</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>28475185873552034</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1360000</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>28475185873552034</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>387262</span>.<span style=color:#ae81ff>52788030764</span>
</span></span></code></pre></div><p>ä¸Šé¢åªæ˜¯ç®€å•çš„ä¾‹å­ï¼Œå…¶ä»–ä¸€äº›è¡¨è¾¾å¼è¿™é‡Œä¸èƒ½ç®€å•çš„ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼è®¡ç®—ï¼Œpgæä¾›ä¸åŒçš„è®¡ç®—å‡½æ•°ï¼Œå¤§è‡´æœ‰ä¸‹é¢å‡ ç§ï¼Œå…¶ä»–çš„å¤åˆæ¡ä»¶ï¼Œåˆ™æ˜¯ä¼šé€’å½’æˆ–è€…å¾ªç¯è°ƒç”¨è¿™äº›å‡½æ•°å•ç‹¬è®¡ç®—ï¼Œå¤§è‡´çš„è°ƒç”¨å…³ç³»å¦‚å›¾</p><p><img src=/posts/postgres/images/cost.svg alt=xx></p><pre><code>  src/backend/utils/adt/selfuncs.c:
     217:  *     eqsel             - Selectivity of &quot;=&quot; for any data types.
     548:  *     neqsel            - Selectivity of &quot;!=&quot; for any data types.
     561:  *     scalarineqsel     - Selectivity of &quot;&lt;&quot;, &quot;&lt;=&quot;, &quot;&gt;&quot;, &quot;&gt;=&quot; for scalars.
    1466:  *     scalarltsel       - Selectivity of &quot;&lt;&quot; for scalars.
    1475:  *     scalarlesel       - Selectivity of &quot;&lt;=&quot; for scalars.
    1484:  *     scalargtsel       - Selectivity of &quot;&gt;&quot; for scalars.
    1493:  *     scalargesel       - Selectivity of &quot;&gt;=&quot; for scalars.
    1502:  *     boolvarsel        - Selectivity of Boolean variable.
    1535:  *     booltestsel       - Selectivity of BooleanTest Node.
    1693:  *     nulltestsel       - Selectivity of NullTest Node.
    1811:  *     scalararraysel    - Selectivity of ScalarArrayOpExpr Node.
    2162:  *     rowcomparesel     - Selectivity of RowCompareExpr Node.
</code></pre><p>é€‰æ‹©ç‡çš„ä¸»è¦å…¥å£æ˜¯clauselist_selectivityï¼Œåœ¨æœ€ç»ˆæ„å»ºpathé˜¶æ®µï¼Œå¯¹äºåŸºè¡¨ï¼Œä¼šæå‰åœ¨å‡½æ•° set_baserel_size_estimates ä¸­è®¡ç®— reloptinfo çš„ rowsï¼Œäººã€è€Œå¯¹äºä¸€äº›pathï¼Œä¼šåœ¨å…¶çš„costé˜¶æ®µä½¿ç”¨ç›¸å…³çš„çº¦æŸæ¡ä»¶è®¡ç®—é€‰æ‹©ç‡ï¼Œç”¨äºä¼°ç®—å…¶æ“ä½œè¡Œæ•°</p><h2 id=cost-è®¡ç®—>cost è®¡ç®—
<a href=#cost-%e8%ae%a1%e7%ae%97 class=h-anchor aria-hidden=true>#</a></h2><h3 id=æ€»ç»“>æ€»ç»“
<a href=#%e6%80%bb%e7%bb%93 class=h-anchor aria-hidden=true>#</a></h3><ol><li>å¯åŠ¨ä»£ä»·<br>ç®—å­åœ¨è¾“å‡ºç¬¬ä¸€è¡Œå¯ç”¨tupleéœ€è¦çš„ä»£ä»·<ul><li>å¯¹äºéé˜»å¡ç®—å­ï¼Œä»£ä»·é€šç”¨çš„è®¡ç®—è§„åˆ™ä¸ºçº¦æŸæ¡ä»¶çš„å¯åŠ¨ä»£ä»· åŠ ä¸Š targetlistçš„å¯åŠ¨ä»£ä»·ï¼Œå…·ä½“çš„è¡¨è¾¾å¼çš„ä»£ä»·è®¡ç®—ä½¿ç”¨å‡½æ•° cost_qual_eval_node è®¡ç®—ï¼Œå…·ä½“ä¸»è¦è®¡ç®— startup cost å’Œ per_tuple cost</li><li>å¯¹äºé˜»å¡ç®—å­ï¼Œä¾‹å¦‚joinï¼Œsortç­‰ï¼Œåˆ™ä¼šå†åŠ ä¸Šä¸€äº›å‡†å¤‡å·¥ä½œéœ€è¦çš„ä»£ä»·ï¼Œä¾‹å¦‚å¦‚æœhash joinçš„ hashtable çš„æ„é€ ä»£ä»·ï¼Œæˆ–è€…æ˜¯ sort ç®—å­çš„æ’åºä»£ä»·</li></ul></li><li>æ€»ä»£ä»·ä¸ºæ‰€æœ‰æ•°æ®è¾“å‡ºå¼€å§‹åˆ°ç»“æŸçš„ä»£ä»·ï¼Œéœ€è¦è®¡ç®—å½“å‰ç®—å­æ“ä½œtupleçš„æ€»ä»£ä»·å’Œä»ä¸‹å±‚èŠ‚ç‚¹è·å–æ•°æ®çš„ä»£ä»·<ul><li>æ­¤æ—¶éœ€è¦ä½¿ç”¨é€‰æ‹©ç‡ä¼°ç®—ç®—å­æ“ä½œçš„tupleï¼Œåœ¨reloptinfo ä¸­ï¼Œbaserel->tuples ä»£è¡¨å¾—æ˜¯ç»Ÿè®¡ä¿¡æ¯æ”¶é›†å¾—è¡¨å¾—è¡Œæ•°ï¼Œbaserel->rows æ˜¯ä½¿ç”¨é€‰æ‹©ç‡è®¡ç®—çš„è¡Œæ•°</li></ul></li><li>cost ä»£ä»·è®¡ç®—ç®€å•å…¬å¼æ€»ç»“ä¸º<ul><li><code>startup_cost = qpqual_cost.startup + pathtarget->cost.startup + other</code></li><li><code>total_cost = startup_cost + cpu_run_cost + disk_run_cost + other</code></li><li>other å¯¹äºå…·ä½“çš„ç®—å­æœ‰ä¸åŒçš„å®ç°</li></ul></li></ol><p>total_cost = startup_cost + cpu_run_cost + disk_run_cost + other
cpu_run_cost = cpu_per_tuple * inputrows + target_cost_per_tuple * outputrows
disk_run_cost = spc_page_cost * pages</p><h4 id=ç®€å•çš„seqscan>ç®€å•çš„seqscan
<a href=#%e7%ae%80%e5%8d%95%e7%9a%84seqscan class=h-anchor aria-hidden=true>#</a></h4><p>seq scan æ¯”è¾ƒç®€å•ï¼Œåœ¨å‰æœŸå·¥ä½œå®Œæˆä¹‹åï¼Œç›´æ¥æ„é€  path ä¸”ä¼°ç®—å…¶ä»£ä»·</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> <span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span> ;
</span></span><span style=display:flex><span>                        QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>----------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Seq Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>24053</span>.<span style=color:#ae81ff>00</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>9770</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>   Filter: (<span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>2</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> relpages <span style=color:#f92672>|</span> reltuples
</span></span><span style=display:flex><span><span style=color:#75715e>----------+-----------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#ae81ff>7053</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>36</span>e<span style=color:#f92672>+</span><span style=color:#ae81ff>06</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>1</span>. <span style=color:#960050;background-color:#1e0010>ä½¿ç”¨å‡½æ•°</span> cost_qual_eval_node <span style=color:#960050;background-color:#1e0010>è®¡ç®—è¡¨è¾¾å¼çš„å¯åŠ¨ä»£ä»·å’Œæ“ä½œæ¯ä¸€è¡Œæ•°æ®çš„ä»£ä»·</span>
</span></span><span style=display:flex><span>    cost<span style=color:#f92672>-&gt;</span>per_tuple <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0025</span>
</span></span><span style=display:flex><span>    cost<span style=color:#f92672>-&gt;</span>startup <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>2</span>. targetlist <span style=color:#960050;background-color:#1e0010>åªæ˜¯ç®€å•çš„è¾“å‡ºï¼Œæ‰€ä»¥ä¸¤ä¸ªå€¼éƒ½ä¸º</span> <span style=color:#ae81ff>0</span> 
</span></span><span style=display:flex><span><span style=color:#ae81ff>3</span>. <span style=color:#960050;background-color:#1e0010>ä¸åŒçš„ç£ç›˜ä»‹è´¨æœ‰ä¸åŒçš„</span>IOä»£ä»·<span style=color:#960050;background-color:#1e0010>ï¼Œä½¿ç”¨å‡½æ•°</span> get_tablespace_page_costs <span style=color:#960050;background-color:#1e0010>è·å¾—</span> <span style=color:#960050;background-color:#1e0010>ç£ç›˜</span> io <span style=color:#960050;background-color:#1e0010>çš„</span> page <span style=color:#960050;background-color:#1e0010>ä»£ä»·</span> spc_seq_page_cost <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>4</span>. startup_cost <span style=color:#f92672>=</span> qpqual_cost.startup <span style=color:#f92672>+</span> path<span style=color:#f92672>-&gt;</span>pathtarget<span style=color:#f92672>-&gt;</span>cost.startup <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>5</span>. disk_run_cost <span style=color:#f92672>=</span> spc_seq_page_cost <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>pages <span style=color:#f92672>=</span> <span style=color:#ae81ff>7053</span>
</span></span><span style=display:flex><span>   cpu_run_cost <span style=color:#f92672>=</span> (cpu_tuple_cost <span style=color:#f92672>+</span> qpqual_cost.per_tuple)  <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0125</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>36</span>e<span style=color:#f92672>+</span><span style=color:#ae81ff>06</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>17000</span>
</span></span><span style=display:flex><span>   cpu_run_cost <span style=color:#f92672>+=</span> path<span style=color:#f92672>-&gt;</span>pathtarget<span style=color:#f92672>-&gt;</span>cost.per_tuple <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span><span style=color:#66d9ef>rows</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>17000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>7</span>. total_cost <span style=color:#f92672>=</span> startup_cost <span style=color:#f92672>+</span> cpu_run_cost <span style=color:#f92672>+</span> disk_run_cost <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>17000</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>7053</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>24053</span>
</span></span></code></pre></div><h4 id=å¤æ‚target-list>å¤æ‚target list
<a href=#%e5%a4%8d%e6%9d%82target-list class=h-anchor aria-hidden=true>#</a></h4><p>éµå¾ªå‰é¢æ€»ç»“çš„å…¬å¼ï¼Œè¿™é‡Œtargetlist ä¸­æœ‰ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œæ‰€ä»¥ä»£ä»·ä¸ä¸º 0</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span>, (<span style=color:#66d9ef>select</span> <span style=color:#66d9ef>sum</span>(a) <span style=color:#66d9ef>from</span> t2) <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5566</span>;
</span></span><span style=display:flex><span>                                QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Bitmap Heap Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>6713</span>.<span style=color:#ae81ff>76</span>..<span style=color:#ae81ff>19349</span>.<span style=color:#ae81ff>72</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>151344</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>20</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>Recheck</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>   Filter: (<span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5566</span>)
</span></span><span style=display:flex><span>   InitPlan <span style=color:#ae81ff>1</span> (<span style=color:#66d9ef>returns</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>     <span style=color:#f92672>-&gt;</span>  <span style=color:#66d9ef>Aggregate</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>180</span>.<span style=color:#ae81ff>01</span>..<span style=color:#ae81ff>180</span>.<span style=color:#ae81ff>02</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>           <span style=color:#f92672>-&gt;</span>  Seq Scan <span style=color:#66d9ef>on</span> t2  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>155</span>.<span style=color:#ae81ff>01</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10001</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>   <span style=color:#f92672>-&gt;</span>  Bitmap <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>on</span> idx  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>6495</span>.<span style=color:#ae81ff>90</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>372197</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Index</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>8</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5566</span>;
</span></span><span style=display:flex><span>                                QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Bitmap Heap Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>6533</span>.<span style=color:#ae81ff>74</span>..<span style=color:#ae81ff>19169</span>.<span style=color:#ae81ff>70</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>151344</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>Recheck</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>   Filter: (<span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5566</span>)
</span></span><span style=display:flex><span>   <span style=color:#f92672>-&gt;</span>  Bitmap <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>on</span> idx  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>6495</span>.<span style=color:#ae81ff>90</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>372197</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Index</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>5</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>sum</span>(a) <span style=color:#66d9ef>from</span> t2;
</span></span><span style=display:flex><span>                          QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#66d9ef>Aggregate</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>180</span>.<span style=color:#ae81ff>01</span>..<span style=color:#ae81ff>180</span>.<span style=color:#ae81ff>02</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
</span></span><span style=display:flex><span>   <span style=color:#f92672>-&gt;</span>  Seq Scan <span style=color:#66d9ef>on</span> t2  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>155</span>.<span style=color:#ae81ff>01</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>10001</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>2</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>6713</span>.<span style=color:#ae81ff>76</span>  <span style=color:#f92672>=</span> <span style=color:#ae81ff>6533</span>.<span style=color:#ae81ff>74</span>  <span style=color:#f92672>+</span> <span style=color:#ae81ff>180</span>.<span style=color:#ae81ff>01</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>19349</span>.<span style=color:#ae81ff>72</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>19169</span>.<span style=color:#ae81ff>70</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>180</span>.<span style=color:#ae81ff>02</span>
</span></span></code></pre></div><h4 id=ä½¿ç”¨-index-scan>ä½¿ç”¨ index scan
<a href=#%e4%bd%bf%e7%94%a8-index-scan class=h-anchor aria-hidden=true>#</a></h4><p>é¦–å…ˆpg å¯¹index è®¾è®¡äº†ä¸€å±‚æŠ½è±¡AMæ¥å£ï¼Œä¸‹é¢å®ç°æœ‰å¤šç§ index å¼•æ“ï¼Œå¸¸è§„çš„æ¯”å¦‚ btree indexï¼Œhash index ç­‰ï¼Œä¸å¸¸è§çš„æ¯”å¦‚ gin indexï¼Œbrin index ç­‰ï¼Œç”šè‡³è¿˜å­˜åœ¨æ¡ä»¶ç´¢å¼•ï¼Œæ¥å£ä¸­é™¤äº†å¸¸è§„çš„ index æ§åˆ¶æœºè®¿é—®æ–¹æ³•å¤–ï¼Œè¿˜éœ€è¦ index å®ç°å…¶ cost çš„è®¡ç®—æ–¹æ³•ï¼Œå½“å‰æ”¯æŒçš„ index cost è®¡ç®—å‡½æ•°å¦‚ä¸‹</p><pre><code>amroutine-&gt;amcostestimate = blcostestimate;
amroutine-&gt;amcostestimate = brincostestimate;
amroutine-&gt;amcostestimate = gincostestimate;
amroutine-&gt;amcostestimate = gistcostestimate;
amroutine-&gt;amcostestimate = hashcostestimate;
amroutine-&gt;amcostestimate = btcostestimate;
amroutine-&gt;amcostestimate = spgcostestimate;
</code></pre><p>ä¸»è¦ç›®çš„æ˜¯è®¡ç®—ä¸‹é¢å‡ ä¸ªå…³é”®å‚æ•°ï¼Œç”¨äºåç»­å¾— cost è®¡ç®—</p><pre><code>indexStartupCost 
indexTotalCost   
indexSelectivity 
indexCorrelation 
index_pages      
</code></pre><p>ä¸‹é¢æ˜¯å‡ ä¸ªç®€å•çš„ä¾‹å­ï¼Œè¯´æ˜ä¸‹ index çš„ cost çš„è®¡ç®—è¿‡ç¨‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>esoye<span style=color:#f92672>=#</span> <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>where</span> a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span> <span style=color:#66d9ef>and</span> <span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5566</span>;
</span></span><span style=display:flex><span>                                QUERY PLAN
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> Bitmap Heap Scan <span style=color:#66d9ef>on</span> t1  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>6533</span>.<span style=color:#ae81ff>74</span>..<span style=color:#ae81ff>19169</span>.<span style=color:#ae81ff>70</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>151344</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>12</span>)
</span></span><span style=display:flex><span>   <span style=color:#66d9ef>Recheck</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>   Filter: (<span style=color:#66d9ef>c</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5566</span>)
</span></span><span style=display:flex><span>   <span style=color:#f92672>-&gt;</span>  Bitmap <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>on</span> idx  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>6495</span>.<span style=color:#ae81ff>90</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>372197</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>         <span style=color:#66d9ef>Index</span> Cond: (a <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>100</span>)
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>5</span> <span style=color:#66d9ef>rows</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> relpages <span style=color:#f92672>|</span> reltuples
</span></span><span style=display:flex><span><span style=color:#75715e>----------+-----------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>     <span style=color:#ae81ff>3382</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>1</span>.<span style=color:#ae81ff>36</span>e<span style=color:#f92672>+</span><span style=color:#ae81ff>06</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>n_distinct             <span style=color:#f92672>|</span> <span style=color:#ae81ff>9674</span>
</span></span><span style=display:flex><span>most_common_vals       <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>16</span>,<span style=color:#ae81ff>821</span>,<span style=color:#ae81ff>4871</span>,<span style=color:#ae81ff>4903</span>,<span style=color:#ae81ff>5141</span>,<span style=color:#ae81ff>8049</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>most_common_freqs      <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>2432</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>022566667</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span>,<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>0003</span><span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>histogram_bounds       <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span><span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>95</span>,<span style=color:#ae81ff>197</span>,<span style=color:#ae81ff>291</span>,<span style=color:#ae81ff>400</span>,<span style=color:#ae81ff>504</span>,<span style=color:#ae81ff>593</span>,<span style=color:#ae81ff>700</span>,<span style=color:#ae81ff>794</span>,<span style=color:#ae81ff>901</span>,<span style=color:#ae81ff>1001</span>,<span style=color:#ae81ff>1098</span>,<span style=color:#ae81ff>1192</span>......<span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>correlation            <span style=color:#f92672>|</span> <span style=color:#f92672>-</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>5632166</span>
</span></span></code></pre></div><p>è¿½è¸ªadd_pathæŸ¥çœ‹å…¶è·¯å¾„çš„ç”Ÿæˆè¿‡ç¨‹çš„æ—¥å¿—å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹å‡ºä»–ç”Ÿæˆäº†ä¸‰ç§ä¸åŒçš„pathï¼Œç„¶åé€šè¿‡ä»£ä»·æ¯”è¾ƒé€‰å‡ºæœ€ä¼˜çš„ path</p><pre tabindex=0><code>accept_new
        SeqScan(t1) rows=151344 cost=0.00..27453.00
reject_new
        IdxScan(t1) rows=151344 cost=0.43..31024.65
remove_old
        SeqScan(t1) rows=151344 cost=0.00..27453.00
accept_new
        BitmapHeapScan(t1) rows=151344 cost=6533.74..19169.70
</code></pre><p>å¯¹äº <code>IdxScan(t1) rows=151344 cost=0.43..31024.65</code></p><ul><li>é¦–å…ˆå¯¹äº path.rowsï¼Œ ä½¿ç”¨çš„æ˜¯baserel ä¼°è®¡çº¦æŸæ¡ä»¶ä¹‹åè®¡ç®—çš„ç»“æœï¼Œè¿™é‡Œä¸º 151344</li><li>amcostestimate æ˜¯ index å®ç°çš„ cost çš„è®¡ç®—å‡½æ•°ï¼Œè¿™é‡Œæ˜¯ btree index ï¼Œ ä½¿ç”¨çš„æ˜¯ btcostestimate<ul><li>indexSelectivity æ˜¯ index çš„é€‰æ‹©ç‡ï¼Œè¿™é‡Œ index çš„æ‰§è¡Œæ¡ä»¶ä¸º <code>a &lt; 100</code>ï¼Œ å‰é¢çš„ä¾‹å­ä¸­å·²ç»è¯´æ˜æ­¤è¡¨è¾¾å¼çš„é€‰æ‹©ç‡çš„è®¡ç®—è¿‡ç¨‹ï¼Œç»“æœä¸º 0.27367426598623362</li><li>indexCorrelation ä¸ºç»Ÿè®¡ä¿¡æ¯ä¸­å…³è”åº¦ï¼Œè¿™é‡Œç›´æ¥æŸ¥è¡¨ä¸º -0.5632166</li><li>index_pages éœ€è¦ä½¿ç”¨å…¬å¼ <code>numIndexPages = ceil((index->tuples * indexSelectivity) * index->pages / index->tuples)</code>è®¡ç®—ï¼Œè¡¨ç¤ºçš„æ˜¯ index åœ¨å½“å‰æ¡ä»¶ä¸‹éœ€è¦è¯»å–çš„ page æ•°é‡ï¼Œ
å¸¦å…¥æ•°æ®è®¡ç®—å¾— <code>index_pages = (1360000 * 0.27367) * 3382 / 1360000 = 926</code></li><li>indexStartupCost å¯ä»¥ç²—ç•¥å¾—ä½¿ç”¨å…¬å¼ <code>indexStartupCost = {ceil( log2(N) ) + ( H+1 ) * 50} * cpu_operator_cost</code>è®¡ç®—ï¼Œä½†æ˜¯å®é™…ä¸Šä»–çš„æ¯ä¸€æ­¥éƒ½æ˜¯åˆ†å¼€å•ç‹¬è®¡ç®—å¾—ï¼Œå› ä¸ºå…¶ä¸­å‚æ‚ç€ä¸€äº›ç‰¹æ®Šåˆ¤æ–­ï¼Œ
ä½†æ˜¯ç›®å‰è¿™ä¸ªä¾‹å­å¹¶æ²¡æœ‰æ¶‰åŠåˆ°è¿™äº›ç‰¹æ®Šå¤„ç†<ul><li><code>log2(N) * cpu_operator_cost</code> ä»£è¡¨æ˜¯å¶å­èŠ‚ç‚¹çš„ä»£ä»·</li><li><code>( H+1 ) * 50 * cpu_operator_cost</code> ä»£è¡¨çš„æ˜¯å¤„ç†å†…éƒ¨èŠ‚ç‚¹çš„ä»£ä»·ï¼Œè¿™é‡Œçš„50æ˜¯ç›´æ¥ä»£ç å†™æ­»çš„</li><li>å¸¦å…¥å‚æ•°è®¡ç®—å¾— <code>indexStartupCost = 0.42749999999999999</code></li></ul></li><li>indexTotalCost éœ€è¦è®¡ç®—å¾—ä»£ä»·å’Œå‰é¢ seqscan ç±»ä¼¼ï¼Œéœ€è¦è®¡ç®— io cost åŠ ä¸Š CPU costï¼Œ index ä½¿ç”¨çš„æ˜¯éšæœºè¯»å†™ï¼Œ è¿™é‡Œå¤§è‡´é€šç”¨å…¬å¼
ä¸º <code>indexTotalCost = indexStartupCost + numIndexPages * spc_random_page_cost + numIndexTuples * (cpu_index_tuple_cost + qual_op_cost)</code>ï¼Œå¸¦å…¥å‚æ•°è®¡ç®—å¾— <code>indexTotalCost = 6495.4775</code><pre tabindex=0><code>  indexStartupCost = 0.4274
  indexTotalCost   = 6495.904
  indexSelectivity = 0.27367
  indexCorrelation = -0.5632166
  index_pages      = 926
</code></pre></li></ul></li><li>ä¹‹åå›åˆ° cost_index ä¸­ï¼Œå¯¹ cost è¿›è¡Œæœ€ç»ˆçš„è®¡ç®—ï¼Œè®¡ç®—çš„æ–¹å¼å’Œå¸¸è§„ cost è®¡ç®—æ–¹å¼å‡ ä¹ä¸€è‡´<ul><li><code>startup_cost = indexStartupCost + qpqual_cost.startup + path->path.pathtarget->cost.startup = 0.4274</code></li><li>total_cost éœ€è¦è®¡ç®— index å›è¡¨æ—¶å€™çš„ä»£ä»·ï¼ŒåŒ…æ‹¬ IO COST å’Œ CPU cost<ul><li>è¿™é‡Œéœ€è¦ä½¿ç”¨ index å’Œ table çš„å…³è”åº¦è®¡ç®— table_IO_costï¼Œå¤§è‡´å…¬å¼ä¸º <code>table_IO_cost = max_IO_cost + indexCorrelation^2 * (min_IO_cost âˆ’ max_IO_cost)</code><ul><li>è¿™é‡Œä½¿ç”¨åæ–¹å·®è®¡ç®—ä»£ä»·ï¼Œmax_IO_cost ä»£è¡¨çš„æ˜¯æœ€å·®çš„æ—¶å€™å…¨è¡¨æ‰«æçš„ä»£ä»·ï¼Œmin_IO_cost ä»£è¡¨çš„æœ€ä¼˜çš„æ—¶å€™ï¼Œè¡¨æ‰«æçš„ä»£ä»·</li><li>å¸¦å…¥å‚æ•° è®¡ç®—å¾— table_IO_cost = 19876.277613</li></ul></li><li>è¿˜éœ€è¦è®¡ç®— cpu cost çš„ä»£ä»·ï¼Œå’Œä¹‹å‰é€šç”¨çš„è®¡ç®—å…¬å¼ä¸€æ ·ï¼Œå¯¹è¡¨æ¥è¯´ï¼Œéœ€è¦ä½¿ç”¨ filter è¿‡æ»¤çš„è¡Œæ•°æ˜¯ index æŸ¥è¯¢çš„è¡Œæ•°ï¼Œæ˜¯ 372197ï¼Œ æœ€ç»ˆè¾“å‡ºçš„è¡Œæ•°æ˜¯åŠ ä¸Šå…¶ä»– æ¡ä»¶ä¹‹åè¿‡æ»¤çš„è¡Œæ•°æ˜¯ 151344ï¼Œå¸¦å…¥å‚æ•°è®¡ç®—
å¾— cpu_run_cost = 4652.4625</li><li>indexTotalCost + table_IO_cost + cpu_run_cost + startup_cost = 6495.904 + 19876.277613 + 4652.4625 + 0.4274 = 31025.071513</li></ul></li><li>æœ€ç»ˆè®¡ç®—ç»“æœä¸º<pre tabindex=0><code>  startup_cost = 0.4274
  total_cost = 31025.071513
</code></pre></li></ul></li></ul><p>å¯¹äº <code>BitmapHeapScan(t1) =151344 cost=6533.74..19169.70</code></p><ul><li>bitmap index éœ€è¦ä½¿ç”¨ä¹‹å‰çš„ç”Ÿæˆçš„ index pathï¼Œå¯¹äºä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯ç”¨çš„index path åªæœ‰ <code>a &lt; 100</code>è¿™ä¸ªï¼Œä»–åœ¨
å‡½æ•° <code>cost_bitmap_heap_scan</code> ä¸­çš„ bitmapqual æ˜¯ <code>IdxScan(t1) rows=151344 cost=0.43..31024.65</code></li><li>å¯¹äº indexTotalCost ï¼Œä»–ä¼šä»ä¸‹å±‚ä½¿ç”¨å‡½æ•° cost_bitmap_tree_node è®¡ç®— costï¼Œè¿™é‡Œ path æ˜¯ IndexPath ä½¿ç”¨
å…¬å¼ <code>cost = ((IndexPath *) path)->indextotalcost + 0.1 * cpu_operator_cost * path->rows</code> è®¡ç®—ï¼Œå¸¦å…¥å‚æ•°å¾— <code>cost = 6495.9049 + 0.1 * 0.0025 * 151344 = 6533.741</code></li><li>å¯¹äº total_costï¼Œä½¿ç”¨å¸¸è§„å…¬å¼è®¡ç®—ï¼Œ <code>total_cost = startup_cost + pages_fetched * cost_per_page + pathtarget->cost.per_tuple * path->rows + cpu_per_tuple * tuples_fetched</code>ï¼Œtuples_fetched
æ˜¯èŠ‚ç‚¹ä¼ å…¥å¾—è¡Œæ•°ï¼Œpath->rowsæ˜¯è¾“å‡ºè¡Œæ•°ï¼Œåˆ†åˆ«ä¸º 372197 å’Œ 151344 ï¼Œ <code>total_cost = 6533.741 + 7053 + 0 * 151344 + 0.015 * 372197 = 19169.696</code></li></ul><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span>btree
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>startup_cost  <span style=color:#f92672>=</span> indexStartupCost <span style=color:#f92672>+</span> qpqual_cost.startup <span style=color:#f92672>+</span> path<span style=color:#f92672>-&gt;</span>path.pathtarget<span style=color:#f92672>-&gt;</span>cost.startup
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span> indexStartupCost <span style=color:#f92672>=</span> {ceil( log2(index<span style=color:#f92672>-&gt;</span>tuples) ) <span style=color:#f92672>+</span> ( H<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> ) <span style=color:#f92672>*</span> <span style=color:#ae81ff>50</span>} <span style=color:#f92672>*</span> cpu_operator_cost
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span> H <span style=color:#f92672>=</span> select level from bt_metap(<span style=color:#960050;background-color:#1e0010>&#39;</span>idx_cm_base_customer_1<span style=color:#960050;background-color:#1e0010>&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>total_cost    <span style=color:#f92672>=</span> startup_cost <span style=color:#f92672>+</span> run_cost;
</span></span><span style=display:flex><span>  <span style=color:#f92672>*</span> run_cost <span style=color:#f92672>=</span> cpu_run_cost <span style=color:#f92672>+</span> max_IO_cost <span style=color:#f92672>+</span> csquared <span style=color:#f92672>*</span> (min_IO_cost <span style=color:#f92672>-</span> max_IO_cost) <span style=color:#f92672>+</span> indexTotalCost <span style=color:#f92672>-</span> indexStartupCost
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> indexTotalCost <span style=color:#f92672>=</span> indexStartupCost
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> csquared <span style=color:#f92672>=</span> indexCorrelation <span style=color:#f92672>*</span> indexCorrelation
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span> indexCorrelation <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> min_IO_cost <span style=color:#f92672>=</span> (pages_fetched <span style=color:#f92672>*</span> spc_random_page_cost) <span style=color:#f92672>/</span> loop_count
</span></span><span style=display:flex><span>                     <span style=color:#66d9ef>if</span> (pages_fetched <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>                        min_IO_cost <span style=color:#f92672>=</span> spc_random_page_cost;
</span></span><span style=display:flex><span>                        <span style=color:#66d9ef>if</span> (pages_fetched <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>                          min_IO_cost <span style=color:#f92672>+=</span> (pages_fetched <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> spc_seq_page_cost;
</span></span><span style=display:flex><span>                      <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>                        min_IO_cost <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> max_IO_cost <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (loop_count <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>        (pages_fetched <span style=color:#f92672>*</span> spc_random_page_cost) <span style=color:#f92672>/</span> loop_count
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>else</span>
</span></span><span style=display:flex><span>        pages_fetched <span style=color:#f92672>*</span> spc_random_page_cost
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span> pages_fetched <span style=color:#f92672>=</span> index_pages_fetched(tuples_fetched <span style=color:#f92672>*</span> loop_count, baserel<span style=color:#f92672>-&gt;</span>pages, (<span style=color:#66d9ef>double</span>) index<span style=color:#f92672>-&gt;</span>pages)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (indexonly)
</span></span><span style=display:flex><span>          pages_fetched <span style=color:#f92672>=</span> ceil(pages_fetched <span style=color:#f92672>*</span> (<span style=color:#ae81ff>1.0</span> <span style=color:#f92672>-</span> baserel<span style=color:#f92672>-&gt;</span>allvisfrac));
</span></span><span style=display:flex><span>          baserel<span style=color:#f92672>-&gt;</span>allvisfrac <span style=color:#f92672>=</span> select relallvisible from pg_class where relname <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>idx_cm_base_customer_1<span style=color:#960050;background-color:#1e0010>&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span> tuples_fetched <span style=color:#f92672>=</span> indexSelectivity <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span> indexSelectivity <span style=color:#f92672>=</span> 
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> cpu_run_cost <span style=color:#f92672>=</span> cpu_per_tuple <span style=color:#f92672>*</span> tuples_fetched <span style=color:#f92672>+</span> path<span style=color:#f92672>-&gt;</span>path.pathtarget<span style=color:#f92672>-&gt;</span>cost.per_tuple <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span>path.rows
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span> tuples_fetched <span style=color:#f92672>=</span> indexSelectivity <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cost_bitmap_or_node
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> path in bitmapquals
</span></span><span style=display:flex><span>    startup_cost <span style=color:#f92672>=</span> total_cost
</span></span><span style=display:flex><span>    totalCost <span style=color:#f92672>+=</span> subCost
</span></span><span style=display:flex><span>      subCost 
</span></span><span style=display:flex><span>        IndexPath       <span style=color:#ae81ff>0.1</span> <span style=color:#f92672>*</span> cpu_operator_cost <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span>rows
</span></span><span style=display:flex><span>        BitmapAndPath   path<span style=color:#f92672>-&gt;</span>total_cost
</span></span><span style=display:flex><span>        BitmapOrPath    path<span style=color:#f92672>-&gt;</span>total_cost
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (l <span style=color:#f92672>!=</span> list_head(path<span style=color:#f92672>-&gt;</span>bitmapquals) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>IsA(subpath, IndexPath))
</span></span><span style=display:flex><span>        totalCost <span style=color:#f92672>+=</span> <span style=color:#ae81ff>100.0</span> <span style=color:#f92672>*</span> cpu_operator_cost;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cost_bitmap_and_node
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> path in bitmapquals
</span></span><span style=display:flex><span>    startup_cost <span style=color:#f92672>=</span> total_cost
</span></span><span style=display:flex><span>    totalCost <span style=color:#f92672>+=</span> subCost
</span></span><span style=display:flex><span>      subCost 
</span></span><span style=display:flex><span>        IndexPath       <span style=color:#ae81ff>0.1</span> <span style=color:#f92672>*</span> cpu_operator_cost <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span>rows
</span></span><span style=display:flex><span>        BitmapAndPath   path<span style=color:#f92672>-&gt;</span>total_cost
</span></span><span style=display:flex><span>        BitmapOrPath    path<span style=color:#f92672>-&gt;</span>total_cost
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (l <span style=color:#f92672>!=</span> list_head(path<span style=color:#f92672>-&gt;</span>bitmapquals) <span style=color:#f92672>&amp;&amp;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>!</span>IsA(subpath, IndexPath))
</span></span><span style=display:flex><span>        totalCost <span style=color:#f92672>+=</span> <span style=color:#ae81ff>100.0</span> <span style=color:#f92672>*</span> cpu_operator_cost;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cost_bitmap_heap_scan
</span></span><span style=display:flex><span>  startup_cost <span style=color:#f92672>=</span> path<span style=color:#f92672>-&gt;</span>pathtarget<span style=color:#f92672>-&gt;</span>cost.startup <span style=color:#f92672>+</span> qpqual_cost.startup <span style=color:#f92672>+</span> indexTotalCost
</span></span><span style=display:flex><span>  total_cost <span style=color:#f92672>=</span> startup_cost <span style=color:#f92672>+</span> run_cost
</span></span><span style=display:flex><span>    run_cost <span style=color:#f92672>=</span> cpu_run_cost <span style=color:#f92672>+</span> path<span style=color:#f92672>-&gt;</span>pathtarget<span style=color:#f92672>-&gt;</span>cost.per_tuple <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span>rows <span style=color:#f92672>+</span> pages_fetched <span style=color:#f92672>*</span> cost_per_page
</span></span><span style=display:flex><span>      cpu_run_cost <span style=color:#f92672>=</span> cpu_per_tuple <span style=color:#f92672>*</span> tuples_fetched 
</span></span><span style=display:flex><span>        tuples_fetched <span style=color:#f92672>=</span> indexSelectivity <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples <span style=color:#f92672>+</span> 
</span></span></code></pre></div><p>58.81 = 28.55 +
+ 28.55
+ qpqual_cost.startup
+ path->pathtarget->cost.startup</p><p>6113.85 = pages_fetched * cost_per_page
+ (cpu_per_tuple * tuples_fetched) / parallel_divisor
+ 0 * 5405</p><p>25.43 - 0.57 + (44 - 1) * inner_rescan_start_cost + 6113.85 - 58.81 + (44 - 1) * inner_rescan_run_cost + cpu_per_tuple * 3440 * 44</p><p>25.43 + 6113.85 * 44 + 0.01 * 44 * 3440
95106.65 = 6113.85
+ 25.43 * 3440
+ 0.01 * 44 * 3440</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span>seq scan
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span>startup_cost  <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>total_cost    <span style=color:#f92672>=</span> <span style=color:#ae81ff>0.0125</span> <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples <span style=color:#f92672>+</span> baserel<span style=color:#f92672>-&gt;</span>pages
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>btree
</span></span><span style=display:flex><span>btcostestimate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>create extension pageinspect;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>select level from <span style=color:#a6e22e>bt_metap</span>(<span style=color:#960050;background-color:#1e0010>&#39;</span>idx_cm_base_customer_1<span style=color:#960050;background-color:#1e0010>&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// log2(index-&gt;tuples) æŒ‡çš„æ˜¯å¶å­äºŒåˆ†æŸ¥æ‰¾çš„costï¼ŒH + 1 æŒ‡çš„æ˜¯æ ‘çš„é«˜åº¦ï¼Œ50 æ˜¯ä»£ç å†™æ­»çš„å®šå€¼ 0.0025 = cpu_operator_cost
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>startup_cost    <span style=color:#f92672>=</span> {ceil( log2(index<span style=color:#f92672>-&gt;</span>tuples) ) <span style=color:#f92672>+</span> ( H <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span> ) <span style=color:#f92672>*</span> <span style=color:#ae81ff>50</span>} <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.0025</span>   
</span></span><span style=display:flex><span><span style=color:#75715e>// max_IO_cost + csquared * (min_IO_cost - max_IO_cost) æ˜¯disk costï¼Œ è¿™é‡Œä½¿ç”¨ç›¸å…³åº¦è®¡ç®—ï¼Œåé¢æ˜¯ cpu cost, 0.01 æ˜¯ cpu_per_tuple
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>indexSelectivity <span style=color:#f92672>=</span> genericcostestimate(xxx)
</span></span><span style=display:flex><span>indexTotalCost  <span style=color:#f92672>=</span> startup_cost <span style=color:#f92672>+</span> ceil(indexSelectivity <span style=color:#f92672>*</span> index<span style=color:#f92672>-&gt;</span>pages) <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> (indexSelectivity <span style=color:#f92672>*</span> index<span style=color:#f92672>-&gt;</span>tuples) <span style=color:#f92672>*</span> <span style=color:#ae81ff>0.0075</span>
</span></span><span style=display:flex><span>max_IO_cost     <span style=color:#f92672>=</span> PF <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>min_IO_cost     <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> (ceil(indexSelectivity <span style=color:#f92672>*</span> (<span style=color:#66d9ef>double</span>) baserel<span style=color:#f92672>-&gt;</span>pages) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>csquared        <span style=color:#f92672>=</span> indexCorrelation <span style=color:#f92672>*</span> indexCorrelation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>total_cost      <span style=color:#f92672>=</span> indexTotalCost <span style=color:#f92672>+</span> max_IO_cost <span style=color:#f92672>+</span> csquared <span style=color:#f92672>*</span> (min_IO_cost <span style=color:#f92672>-</span> max_IO_cost) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.01</span> <span style=color:#f92672>*</span> ceil(indexSelectivity <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples) 
</span></span><span style=display:flex><span><span style=color:#75715e>// Btree çš„ indexSelectivity å°±æ˜¯å…¶ cond è®¡ç®—çš„ç»“æœ
</span></span></span><span style=display:flex><span><span style=color:#75715e>// PF = page fetch, æŒ‡çš„æ˜¯è¯­å¥æœ€å·®çš„æƒ…å†µä¸‹éœ€è¦æœ€å¤§è¯»å–çš„pageï¼Œ4ä¸ºrandom io cost
</span></span></span><span style=display:flex><span><span style=color:#75715e>// æœ€ä¼˜æ—¶è¯»å–çš„page costï¼Œè¿™ä¸¤ä¸ªè¡¨è¾¾å¼åˆ†åˆ«å¯¹åº”å…³è”åº¦æœ€ä¼˜å’Œæœ€å·®æ—¶çš„ä»£ä»·
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  PF <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>    min(<span style=color:#ae81ff>2</span>TNs<span style=color:#f92672>/</span>(<span style=color:#ae81ff>2</span>T<span style=color:#f92672>+</span>Ns), T)              when T <span style=color:#f92672>&lt;=</span> b
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>2</span>TNs<span style=color:#f92672>/</span>(<span style=color:#ae81ff>2</span>T<span style=color:#f92672>+</span>Ns)                      when T <span style=color:#f92672>&gt;</span> b and Ns <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>2</span>Tb<span style=color:#f92672>/</span>(<span style=color:#ae81ff>2</span>T<span style=color:#f92672>-</span>b)
</span></span><span style=display:flex><span>    b <span style=color:#f92672>+</span> (Ns <span style=color:#f92672>-</span> <span style=color:#ae81ff>2</span>Tb<span style=color:#f92672>/</span>(<span style=color:#ae81ff>2</span>T<span style=color:#f92672>-</span>b))<span style=color:#f92672>*</span>(T<span style=color:#f92672>-</span>b)<span style=color:#f92672>/</span>T     when T <span style=color:#f92672>&gt;</span> b and Ns <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span>Tb<span style=color:#f92672>/</span>(<span style=color:#ae81ff>2</span>T<span style=color:#f92672>-</span>b)
</span></span><span style=display:flex><span> where
</span></span><span style=display:flex><span>    T <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>#</span> pages in table
</span></span><span style=display:flex><span>    N <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>#</span> tuples in table
</span></span><span style=display:flex><span>    s <span style=color:#f92672>=</span> selectivity <span style=color:#f92672>=</span> fraction of table to be scanned
</span></span><span style=display:flex><span>    b <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>#</span> buffer pages available (we include kernel space here)
</span></span><span style=display:flex><span>      <span style=color:#f92672>=</span> (<span style=color:#66d9ef>double</span>) effective_cache_size <span style=color:#f92672>*</span> T <span style=color:#f92672>/</span> (root<span style=color:#f92672>-&gt;</span>total_table_pages <span style=color:#f92672>+</span> index_pages);
</span></span><span style=display:flex><span>      effective_cache_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>524288</span> KB <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>Gb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>brin
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span>startup_cost      <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>*</span> statsData.revmapNumPages
</span></span><span style=display:flex><span>total_cost        <span style=color:#f92672>=</span> indexTotalCost <span style=color:#f92672>+</span> max_IO_cost <span style=color:#f92672>+</span> csquared <span style=color:#f92672>*</span> (min_IO_cost <span style=color:#f92672>-</span> max_IO_cost) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.01</span> <span style=color:#f92672>*</span> ceil(indexSelectivity <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>tuples) 
</span></span><span style=display:flex><span>indexTotalCost    <span style=color:#f92672>=</span> startup_cost <span style=color:#f92672>+</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> (index<span style=color:#f92672>-&gt;</span>pages <span style=color:#f92672>-</span> statsData.revmapNumPages) <span style=color:#f92672>+</span> <span style=color:#ae81ff>0.00025</span> <span style=color:#f92672>*</span> estimatedRanges <span style=color:#f92672>*</span> statsData.pagesPerRange
</span></span><span style=display:flex><span>indexRanges       <span style=color:#f92672>=</span> max(ceil((<span style=color:#66d9ef>double</span>) baserel<span style=color:#f92672>-&gt;</span>pages <span style=color:#f92672>/</span> statsData.pagesPerRange), <span style=color:#ae81ff>1.0</span>)  
</span></span><span style=display:flex><span>minimalRanges     <span style=color:#f92672>=</span> ceil(indexRanges <span style=color:#f92672>*</span> qualSelectivity)   
</span></span><span style=display:flex><span>estimatedRanges   <span style=color:#f92672>=</span> min(minimalRanges <span style=color:#f92672>/</span> indexCorrelation, indexRanges)  
</span></span><span style=display:flex><span>indexSelectivity  <span style=color:#f92672>=</span> estimatedRanges <span style=color:#f92672>/</span> indexRanges  
</span></span><span style=display:flex><span>max_IO_cost     <span style=color:#f92672>=</span> PF <span style=color:#f92672>*</span> <span style=color:#ae81ff>4</span>
</span></span><span style=display:flex><span>min_IO_cost     <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> <span style=color:#f92672>+</span> (ceil(indexSelectivity <span style=color:#f92672>*</span> baserel<span style=color:#f92672>-&gt;</span>pages) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>csquared        <span style=color:#f92672>=</span> indexCorrelation <span style=color:#f92672>*</span> indexCorrelation
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>bitmap
</span></span><span style=display:flex><span><span style=color:#f92672>---</span>
</span></span><span style=display:flex><span>startup_cost  <span style=color:#f92672>=</span> ((IndexPath <span style=color:#f92672>*</span>) path)<span style=color:#f92672>-&gt;</span>indextotalcost <span style=color:#f92672>+</span>  <span style=color:#ae81ff>0.1</span> <span style=color:#f92672>*</span> cpu_operator_cost <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span>rows
</span></span><span style=display:flex><span>total_cost    <span style=color:#f92672>=</span> startup_cost <span style=color:#f92672>+</span> pages_fetched <span style=color:#f92672>*</span> cost_per_page <span style=color:#f92672>+</span> pathtarget<span style=color:#f92672>-&gt;</span>cost.per_tuple <span style=color:#f92672>*</span> path<span style=color:#f92672>-&gt;</span>rows <span style=color:#f92672>+</span> cpu_per_tuple <span style=color:#f92672>*</span> tuples_fetched
</span></span></code></pre></div><p>SELECT * FROM brin_page_items(get_raw_page(&lsquo;idxb&rsquo;, 2),&lsquo;idxb&rsquo;);
SELECT * FROM brin_revmap_data(get_raw_page(&lsquo;idxb&rsquo;, 1)) ;
SELECT * FROM brin_metapage_info(get_raw_page(&lsquo;idxb&rsquo;, 0));</p><p>cost_sort (path=0x7ffccbfceae0, root=0x563be3d33940, pathkeys=0x0, input_cost=15406, tuples=1000000, width=12, comparison_cost=0, sort_mem=4096, limit_tuples=-1)</p><p>type = 3821921280,
pathtype = 22075,
parent = 0x563be3cde400,
pathtarget = 0x563be3cacd40,
param_info = 0x563be3cada20,
parallel_aware = 80,
parallel_safe = 117,
parallel_workers = 1,
rows = 1000000,
startup_cost = 132154.34284662094,
total_cost = 134654.34284662094,
pathkeys = 0x563be3d86de0</p><h3 id=heading><a href=#heading class=h-anchor aria-hidden=true>#</a></h3><ol><li>FQS pgxc_FQS_create_remote_plan
æ²¡æœ‰è®¡ç®—ä»£ä»·ï¼Œcostä¸º0</li></ol><hr><p>Data Node Scan on &ldquo;<strong>REMOTE_FQS_QUERY</strong>&rdquo; (cost=0.00..0.00 rows=0 width=0)
Primary node/s: dn1
Node/s: dn1, dn2
(3 rows)</p><ol start=2><li>remote create path</li></ol><h2 id=query-plan>benchmarksql=# explain verbose select * from t1 ;
QUERY PLAN
<a href=#query-plan class=h-anchor aria-hidden=true>#</a></h2><p>Data Node Scan on t1 &ldquo;<em>REMOTE_TABLE_QUERY</em>&rdquo; (cost=0.00..82037.50 rows=90005 width=12)
Output: t1.c1, t1.c2, t1.c3
Primary node/s: dn1
Node/s: dn1, dn2
Remote query: SELECT c1, c2, c3 FROM ONLY public.t1 t1 WHERE true
(5 rows)</p><pre tabindex=0><code>ä½¿ç”¨seq scan çš„ä»£ä»·è®¡ç®—æ–¹æ³•ï¼Œåªæ˜¯tuple_cost ä¸º0.9ï¼Œclusterè¿™é‡Œè¿˜æ˜¯ä½¿ç”¨çš„seq çš„æ•°æ®è®¡ç®—ä»£ä»·ï¼Œæœ€åå†åˆ¤æ–­æ·»åŠ ä»€ä¹ˆç®—å­
run cost = cpu run cost + disk run cost
         = (cpu_tuple_cost + cpu_operator_cost) Ã— Ntuple + seq_page_cost Ã— Npage
         = 0.9 * 90005 + (1 * 1033)
         = 82037.50
</code></pre><ol start=2><li>cluster cost_cluster_gather
å•è¡¨æ‰§è¡Œè®¡åˆ’ä¸ºgather
rows = allrows / count(dn)
startup_cost = subpath->startup_cost
run_cost = subpath->run_cost + (remote_tuple_cost * rows)
total_cost = (startup_cost + run_cost)</li></ol><hr><p>Cluster Gather (cost=0.00..28934.25 rows=90004 width=12)
-> Seq Scan on t1 (cost=0.00..1933.05 rows=45002 width=12)
(2 rows)</p><pre><code>startup_cost = 0
run_cost = 1933.05 + (0.3 * 90004) = 28934.25
total_cost = (0 + 28934.25) = 28934.25
</code></pre><p>2.1 å•è¡¨çš„scan</p><pre tabindex=0><code>æ•°æ®çš„è¯»å–ï¼Œtupleçš„cpuä»£ä»·ï¼Œtargetlist çš„ eval ä»£ä»·

run cost = cpu run cost + disk run cost
         = (cpu_tuple_cost + cpu_operator_cost) Ã— Ntuple + seq_page_cost Ã— Npage
         = 0.01 * 90005 + (1 * 1033)
         = 1933.05
``


join
reduce ï¼Ÿ å¹¿æ’­

reduce_conn_cost 1 
reduce_page_cost 3
reduce_setup_cost 1000

COALESCE(hash_combin_mod(2, hashint4(t2.c2)), 0)

startup_cost = reduce_conn_cost + sort_startup_cost;

path-&gt;path.startup_cost = subpath-&gt;startup_cost + startup_cost;
path-&gt;path.total_cost = subpath-&gt;total_cost + startup_cost + reduce_run_cost + sort_run_cost;


  reduce_run_cost = remote_tuple_cost * reduce_max_rows  /* rows cost */
          /* plus page cost */
          + page_size(reduce_max_rows,  subpath-&gt;pathtarget-&gt;width) * reduce_page_cost
          /* here should plus reduce expr cost */
          ;

benchmarksql=# explain verbose  select * from t1 join t2 on t1.c1 = t2.c2;
                                                  QUERY PLAN
--------------------------------------------------------------------------------------------------------------
 Cluster Gather  (cost=1562.62..10639.74 rows=22501 width=24)
   Remote node: 16386,16387
   -&gt;  Hash Join  (cost=562.62..2889.44 rows=11250 width=24)
         Output: t1.c1, t1.c2, t1.c3, t2.c1, t2.c2, t2.c3
         Hash Cond: (t1.c1 = t2.c2)
         -&gt;  Seq Scan on public.t1  (cost=0.00..1933.05 rows=45002 width=12)
               Output: t1.c1, t1.c2, t1.c3
               Remote node: 16386,16387
         -&gt;  Hash  (cost=562.00..562.00 rows=50 width=12)
               Output: t2.c1, t2.c2, t2.c3
               -&gt;  Cluster Reduce  (cost=1.00..562.00 rows=50 width=12)
                     Reduce: (&#39;[0:1]={16386,16387}&#39;::oid[])[COALESCE(hash_combin_mod(2, hashint4(t2.c2)), 0)]
                     -&gt;  Seq Scan on public.t2  (cost=0.00..543.00 rows=50 width=12)
                           Output: t2.c1, t2.c2, t2.c3
                           Remote node: 16386,16387

join - remote 
rqpath-&gt;path.startup_cost = parallel_setup_cost * 2;
rqpath-&gt;path.total_cost = rqpath-&gt;path.startup_cost + rel-&gt;rows * pgxc_remote_tuple_cost;
å”¯ä¸€æœ‰å…³ç³»çš„åªæ˜¯è¡Œæ•°



å¤§è¡¨
10000  10

100


# hash join cost

hash join ä»£ä»·è®¡ç®—åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ  
å¯åŠ¨ä»£ä»· å¤§è‡´ä¸º æ„é€ å†…è¡¨ hash table çš„ä»£ä»·ï¼Œlchild å’Œ rchild çš„å¯åŠ¨ä»£ä»· ä»¥åŠè¡¨è¾¾å¼çš„ çš„å¯åŠ¨ä»£ä»·ï¼Œå…¶ä¸­ å†…è¡¨ è¿˜å¯èƒ½ åˆ†æ‰¹åˆ°å¤šæ¬¡ï¼Œæ­¤æ—¶è¿˜éœ€è¦åŠ ä¸Šç£ç›˜è¯»å†™çš„ä»£ä»·
æ‰§è¡Œä»£ä»· å¤§è‡´ä¸º å†…å¤–è¡¨çš„è¿è¡Œä»£ä»·ï¼Œåˆ†æ‰¹æ˜¯è¯»å†™æ•°æ®çš„ä»£ä»·ï¼›è¿˜æœ‰ä¸åŒ join type å®é™…æ“ä½œ tuple æ•°é‡å¯èƒ½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥cpuè¿è¡Œä»£ä»·ä¼°ç®—è¿˜éœ€è¦é…åˆç®—åˆ™ç‡è¿›è¡Œè®¡ç®—

```c++
initial_cost_hashjoin
=================
cpu_operator_cost = DEFAULT_CPU_OPERATOR_COST;
cpu_tuple_cost = DEFAULT_CPU_TUPLE_COST;
seq_page_cost = DEFAULT_SEQ_PAGE_COST;
num_hashclauses = list_length(hashclauses);
inner_path_rows = inner_path-&gt;rows;
outer_path_rows = outer_path-&gt;rows;
startup_cost = 0
run_cost = 0

startup_cost += outer_path-&gt;startup_cost;   // å¤–è¡¨å¯åŠ¨ä»£ä»·
startup_cost += inner_path-&gt;total_cost;     // å†…è¡¨éœ€è¦æ„é€  hash tableï¼Œ æ‰€ä»¥éœ€è¦å…¨éƒ¨æ•°æ®ï¼Œæ‰€ä»¥æ˜¯ total_cost
startup_cost += (cpu_operator_cost * num_hashclauses + cpu_tuple_cost) * inner_path_rows;  // æ„é€  hash table çš„ ä»£ä»·

run_cost += outer_path-&gt;total_cost - outer_path-&gt;startup_cost;        // å¤–è¡¨è¿è¡Œä»£ä»·
run_cost += cpu_operator_cost * num_hashclauses * outer_path_rows;    // å¤–è¡¨ hash ä»£ä»·
if (numbatches &gt; 1) {     // å¦‚æœwork_meme ä¸å¤Ÿå¤§ï¼Œåˆ™éœ€è¦åˆ†æ‰¹å¤„ç†ï¼Œä¼šæŠŠtuple å†™åˆ°ç£ç›˜
  innerpages = page_size(inner_path_rows, inner_path-&gt;pathtarget-&gt;width);
  outerpages = page_size(outer_path_rows, outer_path-&gt;pathtarget-&gt;width);

  startup_cost += seq_page_cost * innerpages;                           // å¯åŠ¨ä»£ä»·ï¼Œå†…è¡¨å¿…é¡»æœ‰è¯»å†™ç£ç›˜çš„æ“ä½œ
  run_cost += seq_page_cost * (innerpages + 2 * outerpages);            // å¯åŠ¨ä»£ä»·å’Œè¿è¡Œä»£ä»·
}

workspace-&gt;startup_cost = startup_cost;
workspace-&gt;total_cost = startup_cost + run_cost;


final_cost_hashjoin
===================
startup_cost = workspace-&gt;startup_cost;
run_cost = workspace-&gt;run_cost;
virtualbuckets = (double) numbuckets * (double) numbatches;

startup_cost += hash_qual_cost.startup;                     // hash è¿ç®—çš„ä»£ä»·
startup_cost += qp_qual_cost.startup;                       // å…¶ä»–è¡¨è¾¾å¼ other restriction clauses
startup_cost += path-&gt;jpath.path.pathtarget-&gt;cost.startup;  // targetlist çš„ä»£ä»·

// With a SEMI or ANTI join, or if the innerrel is known unique, the executor will stop after the first match.
//  æ‰€ä»¥ä»£ä»·ä¼šæ¯”å…¶ä»–ç±»å‹å°
//  è¿™é‡Œä¸»è¦è®¡ç®—çš„æ˜¯æ“ä½œlchildå’Œrchildå…ƒç»„çš„cpuä»£ä»·ï¼Œæ‰€ä»¥ä¸€äº›é€‰æ‹©ç‡çš„è®¡ç®—å’Œmagic numberï¼Œéƒ½æ˜¯ä¸ºäº†ä¼°ç®—å‡ºæ“ä½œçš„å…ƒç»„æ•°
if (path-&gt;jpath.jointype == JOIN_SEMI || path-&gt;jpath.jointype == JOIN_ANTI || extra-&gt;inner_unique) {
  run_cost += hash_qual_cost.per_tuple *                                                                  // hash è¡¨è¾¾å¼çš„tuple ä»£ä»·
              rint(outer_path_rows * extra-&gt;semifactors.outer_match_frac) *                               // å¤–è¡¨é¢„ä¼°çš„è¡Œæ•°ï¼Œouter_match_frac æ˜¯ä½¿ç”¨å‡½æ•° compute_semi_anti_join_factors è®¡ç®—çš„é€‰æ‹©ç‡
              rint(inner_path_rows * innerbucketsize * (2.0 / (extra-&gt;semifactors.match_count + 1.0))) *  // å†…è¡¨é¢„ä¼°çš„å‡½æ•°ï¼Œï¼Ÿï¼Ÿï¼Ÿ
              0.5;                                                                                        // 

  run_cost += hash_qual_cost.per_tuple *                                                                  // hash è¡¨è¾¾å¼çš„tuple ä»£ä»·   
              (outer_path_rows - rint(outer_path_rows * extra-&gt;semifactors.outer_match_frac)) *           // å¤–è¡¨ä¸åŒ¹é…çš„è¡Œæ•°
              rint(inner_path_rows / virtualbuckets) *                                                    // å†…è¡¨ä¸åŒ¹é…çš„è¡Œæ•°ï¼Œè¿™é‡Œç›´æ¥ä¼°è®¡ * 0.05
              0.05;                 

  if (path-&gt;jpath.jointype == JOIN_ANTI)
    hashjointuples = outer_path_rows - outer_matched_rows;
  else
    hashjointuples = outer_matched_rows;
} else {
  run_cost += hash_qual_cost.per_tuple *                                                                  // hash è¡¨è¾¾å¼çš„tuple ä»£ä»·  
              outer_path_rows *                                                                           // å¤–è¡¨è¡Œæ•°
              rint(inner_path_rows * innerbucketsize) * 0.5;                                              // å†…è¡¨è¡Œæ•°
  hashjointuples = approx_tuple_count(root, &amp;path-&gt;jpath, hashclauses);
}

run_cost += (cpu_tuple_cost + qp_qual_cost.per_tuple) * hashjointuples;                                   // è®¡ç®— å…¶ä»–è¡¨è¾¾å¼ çš„ä»£ä»·
run_cost += path-&gt;jpath.path.pathtarget-&gt;cost.per_tuple * path-&gt;jpath.path.rows;                          // è®¡ç®— target list çš„ä»£ä»·

path-&gt;jpath.path.startup_cost = startup_cost;
path-&gt;jpath.path.total_cost = startup_cost + run_cost;
</code></pre><p>è¾“å‡ºæ—¥å¿—</p><pre tabindex=0><code class=language-log data-lang=log>
  HashJoin(supplier nation) id 0x5574bc399c18 reduce_info_list ( storage_nodes: { 16386,16387,16388}, exclude_exec: {}, type: H storage_nodes: { 16386,16387,16388}, exclude_exec: {}, type: H) rows=356 cost=(4.35..943.53)=startup_cost:{workspace-&gt;startup_cost(4.35) + hash_qual_cost.startup(0.00) + qp_qual_cost.startup(0.00) + pathtarget-&gt;cost.startup(0.00)}..total_cost:{startup_cost(4.35) + workspace-&gt;run_cost(937.28) + qual_run_cost(1.33) + pathtarget_run_cost(0.00)}
    clauses: supplier.s_nationkey = nation.n_nationkey
    ClusterReducePath(supplier) id 0x5574bc3975f8 reduce_info_list ( storage_nodes: { 16386,16387,16388}, exclude_exec: {}, type: H) rows=3333 cost=(1.00..929.95)=startup_cost:{subpath-&gt;startup_cost(0.00) + reduce_conn_cost(1.00) + sort}..total_cost:{subpath-&gt;total_cost(324.00) + startup_cost(1.00) + reduce_r}
      SeqScan(supplier) id 0x5574bc35aa98 reduce_info_list ( storage_nodes: { 16386,16387,16388}, exclude_exec: {}, type: H) rows=3333 cost=(0.00..324.00)=startup_cost:{qpqual_cost.startup(0.00) + pathtarget-&gt;cost.startup(0.00)}..total_cost:{startup_cost(0.00) + cpu_run_cost(100.00) + disk_run_cost(224.00)}
    SeqScan(nation) id 0x5574bc362928 reduce_info_list ( storage_nodes: { 16386,16387,16388}, exclude_exec: {}, type: H) rows=8 cost=(0.00..3.25)=startup_cost:{qpqual_cost.startup(0.00) + pathtarget-&gt;cost.startup(0.00)}..total_cost:{startup_cost(0.00) + cpu_run_cost(0.25) + disk_run_cost(3.00)}
  
</code></pre></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://askyx.github.io/posts/defineinc/><span class=button__icon>â†</span>
<span class=button__text>å®ä½¿ç”¨æ¨¡æ¿é€ŸæŸ¥</span>
</a></span><span class="button next"><a href=https://askyx.github.io/posts/tx/><span class=button__text>äº‹åŠ¡çŸ¥è¯†ç®€è®°</span>
<span class=button__icon>â†’</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=https://askyx.github.io/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Asky</span>
<span class=logo__cursor></span></a><div class=copyright><span>Â© 2025 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://askyx.github.io/assets/main.js></script><script src=https://askyx.github.io/assets/prism.js></script></div></body></html>