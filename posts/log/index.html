<!doctype html><html lang=en>
<head>
<title>
::
Asky â€” My note blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="è¯­å¥
prepare s3(int, int) as select no_o_id from bmsql_new_order where no_w_id = $1 and no_d_id = $2 order by no_o_id asc; QUERY PLAN ---------------------------------------------------------------------------------------------------  Cluster Gather (cost=291.52..430.37 rows=459 width=4) Remote node: 16386 -&amp;gt; Sort (cost=291.52..292.67 rows=459 width=4) Output: no_o_id Sort Key: bmsql_new_order.no_o_id -&amp;gt; Bitmap Heap Scan on public.bmsql_new_order (cost=13.46..271.23 rows=459 width=4) Output: no_o_id Recheck Cond: ((bmsql_new_order.no_w_id = 1) AND (bmsql_new_order.no_d_id = 1)) -&amp;gt; Bitmap Index Scan on bmsql_new_order_pkey (cost=0.00..13.34 rows=918 width=0) Index Cond: ((bmsql_new_order.no_w_id = 1) AND (bmsql_new_order.no_d_id = 1)) Remote node: 16386 (11 rows) QUERY PLAN --------------------------------------------------------------------------------------------------------------------  Data Node Scan on &amp;#34;__REMOTE_SORT_QUERY__&amp;#34; (cost=0.00..0.00 rows=1000 width=4) Output: bmsql_new_order.no_o_id Node/s: data_1 Remote query: SELECT no_o_id FROM ONLY public.">
<meta name=keywords content="ç¨‹åºå‘˜ã€ç å†œã€databaseã€C++">
<meta name=robots content="noodp">
<link rel=canonical href=https://askyx.github.io/posts/log/>
<link rel=stylesheet href=//cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css media=print onload="this.media='all'">
<link rel=stylesheet href=https://askyx.github.io/assets/style.css>
<link rel=stylesheet href=https://askyx.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://askyx.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://askyx.github.io/favicon.ico>
<link rel=apple-touch-icon href=https://askyx.github.io/favicon.ico>
<link rel=bookmark href=https://askyx.github.io/favicon.ico>
<link rel=apple-touch-icon-precomposed sizes=180x180 href=https://askyx.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta name=twitter:title content>
<meta name=twitter:description content="è¯­å¥
prepare s3(int, int) as select no_o_id from bmsql_new_order where no_w_id = $1 and no_d_id = $2 order by no_o_id asc; QUERY PLAN ---------------------------------------------------------------------------------------------------  Cluster Gather (cost=291.52..430.37 rows=459 width=4) Remote node: 16386 -> Sort (cost=291.52..292.67 rows=459 width=4) Output: no_o_id Sort Key: bmsql_new_order.no_o_id -> Bitmap Heap Scan on public.bmsql_new_order (cost=13.46..271.23 rows=459 width=4) Output: no_o_id Recheck Cond: ((bmsql_new_order.no_w_id = 1) AND (bmsql_new_order.no_d_id = 1)) -> Bitmap Index Scan on bmsql_new_order_pkey (cost=0.00..13.34 rows=918 width=0) Index Cond: ((bmsql_new_order.no_w_id = 1) AND (bmsql_new_order.no_d_id = 1)) Remote node: 16386 (11 rows) QUERY PLAN --------------------------------------------------------------------------------------------------------------------  Data Node Scan on &#34;__REMOTE_SORT_QUERY__&#34; (cost=0.00..0.00 rows=1000 width=4) Output: bmsql_new_order.no_o_id Node/s: data_1 Remote query: SELECT no_o_id FROM ONLY public.">
<meta property="og:title" content>
<meta property="og:description" content="è¯­å¥
prepare s3(int, int) as select no_o_id from bmsql_new_order where no_w_id = $1 and no_d_id = $2 order by no_o_id asc; QUERY PLAN ---------------------------------------------------------------------------------------------------  Cluster Gather (cost=291.52..430.37 rows=459 width=4) Remote node: 16386 -> Sort (cost=291.52..292.67 rows=459 width=4) Output: no_o_id Sort Key: bmsql_new_order.no_o_id -> Bitmap Heap Scan on public.bmsql_new_order (cost=13.46..271.23 rows=459 width=4) Output: no_o_id Recheck Cond: ((bmsql_new_order.no_w_id = 1) AND (bmsql_new_order.no_d_id = 1)) -> Bitmap Index Scan on bmsql_new_order_pkey (cost=0.00..13.34 rows=918 width=0) Index Cond: ((bmsql_new_order.no_w_id = 1) AND (bmsql_new_order.no_d_id = 1)) Remote node: 16386 (11 rows) QUERY PLAN --------------------------------------------------------------------------------------------------------------------  Data Node Scan on &#34;__REMOTE_SORT_QUERY__&#34; (cost=0.00..0.00 rows=1000 width=4) Output: bmsql_new_order.no_o_id Node/s: data_1 Remote query: SELECT no_o_id FROM ONLY public.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://askyx.github.io/posts/log/"><meta property="article:section" content="posts">
</head>
<body class=light-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://askyx.github.io/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
<li><a href=/search>ğŸ”</a></li>
<li><a href=javascript:; onclick=randomPost() title=éšæœºè®¿é—®ä¸€ç¯‡æ–‡ç« ><svg t="1660103436159" class="icon search-box-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1184" width="32" height="32"><path d="M421.376 481.28s117.248 24.576 175.104-8.704c0 0-89.6 70.144-89.6 166.4.512-.512-8.192-121.344-85.504-157.696zm17.408 487.936s68.608 6.656 68.608-80.896c0 0 3.072 88.576 65.024 78.336.0.512-50.688 22.016-133.632 2.56zM161.28 238.08s-30.208 65.536 11.264 91.648c0 0-67.072-17.408-81.408 37.376.0.0 8.704-82.944 70.144-129.024zM857.6 227.328s49.152 50.176 1.024 81.408c0 0 58.88-18.432 66.56 36.352.0.0 5.12-69.632-67.584-117.76z" p-id="1185"/><path d="M443.392 970.752c-5.632.0-10.752-1.024-15.36-3.072L157.184 810.496l-1.536-1.024s-1.024-1.024-4.608-2.56c-51.2-29.184-62.976-94.208-65.536-120.832V386.56c0-3.072.512-7.168 1.024-11.264l.512-3.584 1.024-2.56c19.456-50.688 76.8-51.2 103.936-44.032l-1.536 5.632 4.096-6.144L476.16 486.4l18.944 37.888c20.992 36.864 29.184 77.824 32.768 99.84v258.048c-4.608 56.32-36.864 76.288-55.808 82.944-1.024.512-15.36 5.632-28.672 5.632zM181.248 774.656l263.168 152.576c12.288-.512 36.864-6.656 40.448-48.128V628.736c-4.608-31.744-20.992-103.936-72.192-128L322.56 445.44l1.536 3.072L181.76 366.08c-2.048-.512-40.448-9.216-52.736 15.872-.512 2.56-.512 4.608-.512 6.144v294.4c1.536 16.896 9.728 67.072 43.52 86.528 3.584 2.048 6.656 4.096 9.216 5.632z" p-id="1186"/><path d="M837.632 212.992c6.656 4.096 12.8 7.168 18.432 10.752l1.536 1.024 1.536 1.536c5.12 4.096 10.752 9.216 16.384 15.36 6.144 11.776 5.632 33.28 4.608 49.152-1.024 12.288-6.656 30.208-26.624 44.544l-1.024.512-247.808 156.672c-26.624 14.336-62.976 18.432-96.256 18.432-40.96.0-77.824-6.656-89.088-8.704l-3.072-.512-245.248-142.336c-39.424-29.696-28.16-85.504-15.36-113.664l2.56-6.144 263.68-166.912c29.184-14.336 104.448-43.008 173.056-1.024 3.584 2.56 58.368 34.304 119.296 69.632M431.616 460.8c40.448 7.168 114.176 13.824 152.576-6.144L828.928 299.52c7.168-5.632 8.192-10.24 8.704-12.8 1.024-11.264-9.728-26.624-15.36-32.768-55.808-32.256-243.712-141.312-250.368-145.408-49.664-30.72-107.008-9.216-130.048 2.56L192.512 268.8c-4.096 12.288-12.288 42.496 3.584 55.808L431.616 460.8z" p-id="1187"/><path d="M831.488 299.008c4.096-1.024 38.4-11.264 66.048 6.144 7.168 4.608 17.92 11.776 24.064 24.576 1.024 5.632 4.096 10.752 4.608 16.896v2.048l-1.024 323.072c-5.12 35.328-22.528 91.648-77.312 125.44l-5.12 3.584h-1.024L579.584 966.656l-4.608.512c-4.096.512-8.704 1.024-12.8 1.024-15.872.0-30.208-5.12-41.984-14.848-24.576-20.48-32.768-55.808-35.328-73.728l-1.024-252.928h1.536c6.144-96.768 88.576-164.864 96.768-171.008l-.512-.512L829.44 299.52M528.384 867.328c.512 10.24 5.12 41.472 19.968 53.76 3.072 2.56 7.68 5.632 16.384 5.12L829.44 758.272c56.32-38.4 53.76-115.712 53.76-116.224l-.512-32.256 1.024-250.368h-.512c-1.536-12.8-7.168-16.384-8.704-17.408-8.704-5.632-23.552-3.072-28.672-2.048L610.304 488.96c-1.024.512-80.896 65.024-80.896 149.504h-1.536l.512 228.864zM435.2 264.192c0 27.648 31.744 50.176 71.168 50.176s71.168-22.528 71.168-50.176-31.744-50.176-71.168-50.176S435.2 236.544 435.2 264.192z" p-id="1188"/><path d="M663.552 782.848c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-50.176-.512-50.176-31.232s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM760.32 602.624c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-49.664-.512-49.664-31.232s22.528-67.072 49.664-80.384c27.136-13.824 49.664.512 49.664 31.232zM867.84 428.032c0 30.72-22.528 67.072-49.664 80.384C790.528 522.24 768 507.904 768 477.184s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM270.848 538.112c0 30.72-22.016 41.984-48.64 24.576-27.136-16.896-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528zm161.28 285.184c0 30.72-22.016 41.984-48.64 24.576-26.624-17.408-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528z" p-id="1189"/></svg></a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
<li><a href=/search>ğŸ”</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<div class=breadcrumb>
<li>
<a href=https://askyx.github.io/>é¦–é¡µ</a>
</li>
<li>
<a href=https://askyx.github.io/posts/>Posts</a>
</li>
<li class=active>
<a href=https://askyx.github.io/posts/log/></a>
</li>
</div>
<h2 class=post-title><a href=https://askyx.github.io/posts/log/></a></h2>
<div class=post-meta>
</div>
<div class=post-content>
<p>è¯­å¥</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>prepare</span> s3(int, int) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>select</span> no_o_id <span style=color:#66d9ef>from</span> bmsql_new_order <span style=color:#66d9ef>where</span> no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>and</span> no_d_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> no_o_id <span style=color:#66d9ef>asc</span>;

                                            QUERY PLAN                                             
<span style=color:#75715e>---------------------------------------------------------------------------------------------------
</span><span style=color:#75715e></span> <span style=color:#66d9ef>Cluster</span> Gather  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>291</span>.<span style=color:#ae81ff>52</span>..<span style=color:#ae81ff>430</span>.<span style=color:#ae81ff>37</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>459</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
   Remote node: <span style=color:#ae81ff>16386</span>
   <span style=color:#f92672>-&gt;</span>  Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>291</span>.<span style=color:#ae81ff>52</span>..<span style=color:#ae81ff>292</span>.<span style=color:#ae81ff>67</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>459</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
         <span style=color:#66d9ef>Output</span>: no_o_id
         Sort <span style=color:#66d9ef>Key</span>: bmsql_new_order.no_o_id
         <span style=color:#f92672>-&gt;</span>  Bitmap Heap Scan <span style=color:#66d9ef>on</span> <span style=color:#66d9ef>public</span>.bmsql_new_order  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>13</span>.<span style=color:#ae81ff>46</span>..<span style=color:#ae81ff>271</span>.<span style=color:#ae81ff>23</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>459</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
               <span style=color:#66d9ef>Output</span>: no_o_id
               <span style=color:#66d9ef>Recheck</span> Cond: ((bmsql_new_order.no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AND</span> (bmsql_new_order.no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>))
               <span style=color:#f92672>-&gt;</span>  Bitmap <span style=color:#66d9ef>Index</span> Scan <span style=color:#66d9ef>on</span> bmsql_new_order_pkey  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>13</span>.<span style=color:#ae81ff>34</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>918</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
                     <span style=color:#66d9ef>Index</span> Cond: ((bmsql_new_order.no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AND</span> (bmsql_new_order.no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>))
                     Remote node: <span style=color:#ae81ff>16386</span>
(<span style=color:#ae81ff>11</span> <span style=color:#66d9ef>rows</span>)

                                                     QUERY PLAN                                                     
<span style=color:#75715e>--------------------------------------------------------------------------------------------------------------------
</span><span style=color:#75715e></span> <span style=color:#66d9ef>Data</span> Node Scan <span style=color:#66d9ef>on</span> <span style=color:#e6db74>&#34;__REMOTE_SORT_QUERY__&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span>..<span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>00</span> <span style=color:#66d9ef>rows</span><span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
   <span style=color:#66d9ef>Output</span>: bmsql_new_order.no_o_id
   Node<span style=color:#f92672>/</span>s: data_1
   Remote query: <span style=color:#66d9ef>SELECT</span> no_o_id <span style=color:#66d9ef>FROM</span> <span style=color:#66d9ef>ONLY</span> <span style=color:#66d9ef>public</span>.bmsql_new_order <span style=color:#66d9ef>WHERE</span> ((no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>AND</span> (no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)) <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#ae81ff>1</span>
(<span style=color:#ae81ff>4</span> <span style=color:#66d9ef>rows</span>)
</code></pre></div><p>æœ€ç›´æ¥åŸå› æ˜¯ä¼˜åŒ–å™¨ä»£ç å˜åŠ¨ï¼Œantdbä½¿ç”¨çš„å†…æ ¸ä»£ç æ¯”xcçš„æ–°ï¼Œantdbåœ¨æ·»åŠ remote query åŠŸèƒ½çš„æ—¶å€™ç”±äºä»£ç å˜åŠ¨ï¼Œæœ‰éƒ¨åˆ†å‡½æ•°ç”±äºä»£ç å˜åŠ¨ï¼Œå¯èƒ½æ²¡æœ‰è¦†ç›–åˆ°ï¼Œ
ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºä¾‹
åœ¨pgxcä¸­ï¼Œgrouping_plannerä¸­å¯¹sortçš„å¤„ç†é€»è¾‘å¦‚ä¸‹ï¼Œç›´æ¥ä½¿ç”¨åˆ›å»ºsortçš„pathä¹‹åä½¿ç”¨create_remotesort_planï¼Œåœ¨å¤„ç†åçš„æ‰§è¡Œè®¡åˆ’ä¸­æœ‰ä¸€ä¸ª<code>__REMOTE_SORT_QUERY__</code>çš„rteï¼Œè¿™é‡ŒæŠ“å–äº†pgxcå’Œantdbå…³é”®èŠ‚ç‚¹çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥ç›´æ¥å¯¹æ¯”<code>grouping_planner</code>å‰åçš„æ‰§è¡Œè®¡åˆ’çš„å˜åŒ–</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>	<span style=color:#66d9ef>if</span> (parse<span style=color:#f92672>-&gt;</span>sortClause)
	{
		<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>pathkeys_contained_in(root<span style=color:#f92672>-&gt;</span>sort_pathkeys, current_pathkeys))
		{
			result_plan <span style=color:#f92672>=</span> (Plan <span style=color:#f92672>*</span>) make_sort_from_pathkeys(root,
														   result_plan,
														 root<span style=color:#f92672>-&gt;</span>sort_pathkeys,
														   limit_tuples);
<span style=color:#75715e>#ifdef PGXC
</span><span style=color:#75715e></span>			<span style=color:#66d9ef>if</span> (IS_PGXC_COORDINATOR <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>IsConnFromCoord())
				result_plan <span style=color:#f92672>=</span> (Plan <span style=color:#f92672>*</span>) create_remotesort_plan(root,
														result_plan);
<span style=color:#75715e>#endif </span><span style=color:#75715e>/* PGXC */</span><span style=color:#75715e>
</span><span style=color:#75715e></span>			current_pathkeys <span style=color:#f92672>=</span> root<span style=color:#f92672>-&gt;</span>sort_pathkeys;
		}
	}
</code></pre></div><p>postgres ä¸»çº¿åœ¨ 3fc6e2d7f5b652b417fa6937c34de2438d60fa9f è¿™ä¸ªæäº¤ä¸­ä¿®æ”¹äº†sortçš„éƒ¨åˆ†é€»è¾‘ï¼Œä¿®æ”¹æœ‰ä¸Šä¸‡è¡Œä»£ç </p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>wen@wen:~/postgres/postgres$ git show 3fc6e2d7f5b652b417fa6937c34de2438d60fa9f | wc -l
<span style=color:#ae81ff>11932</span>
</code></pre></div><p>antdbä¸­å¯¹sortçš„ä¿®æ”¹å¯èƒ½æ²¡æœ‰è¦†ç›–åˆ°æ‰€æœ‰çš„sortåŠŸèƒ½ï¼Œæ¯•ç«Ÿè¿™é‡Œçš„é€»è¾‘å’Œxcçš„å·®åˆ«å¤ªå¤§äº†ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯ä¹‹å‰åœ¨å®ç°antdbä¸­çš„ç›¸å…³æ–¹æ³•çš„æ—¶å€™æœ‰ä»€ä¹ˆç‰¹æ®Šçš„è€ƒè™‘</p>
<p>ç®€å•SQLæ²¡æœ‰æ‰§è¡ŒRemoteQuery
prepare s3(int, int) as select no_o_id from bmsql_new_order where no_w_id = $1 and no_d_id = $2 order by no_o_id asc;
explain verbose execute s3(1, 1);</p>
<p>prepare s7(int, int, char(32)) as select c_id from bmsql_customer where c_w_id = $1 and c_d_id = $2 and c_last = $3 order by c_first;
explain verbose execute s7(1, 1, &lsquo;OUGHTBARPRESâ€™);</p>
<p>prepare s19(int, int, int) as select ol_i_id, ol_supply_w_id, ol_quantity, ol_amount, ol_delivery_d from bmsql_order_line where ol_w_id = $1 and ol_d_id = $2 and ol_o_id = $3 order by ol_w_id, ol_d_id, ol_o_id, ol_number;
explain verbose execute s19(1, 1, 1);</p>
<p>å¯¹æ¯”æ­£å¸¸çš„ç®€å•SQLæ‰§è¡ŒRemoteQuery ï¼š
prepare s1(int, int) as select d_tax, d_next_o_id from bmsql_district where d_w_id = $1 and d_id = $2 for update;
explain verbose execute s1(1, 1);</p>
<ul>
<li>
<p>pgxc_FQS_planner
remote queryçš„ä¼˜åŒ–é€»è¾‘ï¼Œåˆ¤æ–­è¯­å¥æ˜¯å¦å¯ä»¥ç›´æ¥å‘é€åˆ°datanodeæ‰§è¡Œï¼Œè€Œcoordinateåªè´Ÿè´£ä»£ç†</p>
<ol>
<li>select * from a; açš„æ•°æ®å¯ä»¥ä»ä¸€ä¸ªèŠ‚ç‚¹è·å–åˆ°ï¼Œå³ä½¿è¡¨æ˜¯åˆ†å¸ƒå¼çš„</li>
<li>select count(*) from a; éœ€è¦ç»Ÿè®¡æ‰€æœ‰å‡ ç‚¹çš„æ•°æ® &mdash;-åŸæ³¨é‡Šæ˜¯è¿™æ ·çš„ï¼Œä½†æ˜¯æˆ‘è§‰å¾—ç¡®å®šæ•°æ®åˆ†å¸ƒæƒ…å†µç„¶åå¯ä»¥å†åšå†³å®š</li>
<li>å¤åˆ¶è¡¨</li>
</ol>
</li>
<li>
<p>pgxc_is_query_shippable
æ”¶é›†ä¿¡æ¯ï¼Œåˆ¤æ–­è¯­å¥èƒ½å¦å‘é€åˆ°æŒ‡å®šèŠ‚ç‚¹æ‰§è¡Œ</p>
</li>
<li>
<p>pgxc_shippability_walker
éå†è¯­æ³•æ ‘ï¼Œæ”¶é›†æ¯ä¸ªèŠ‚ç‚¹çš„shippableä¿¡æ¯åˆ°Shippability_contextä¸­ï¼Œä¸»è¦ä¸ºäº†åˆ¤æ–­å­æŸ¥è¯¢æ˜¯å¦å¯ä»¥shippableï¼Œå³ä½¿é™¢è¯­å¥æ— æ³•shipï¼Œä½†æ˜¯è¿˜æ˜¯å°½é‡å°è¯•å­è¯­å¥
Shippability_context ä¸­sc_exec_nodesä»£è¡¨è¯­å¥åº”è¯¥æ‰§è¡Œçš„èŠ‚ç‚¹ï¼Œ</p>
</li>
</ul>
<p>pgxc_set_exprtype_shippability
if (RELKIND_SEQUENCE || RELKIND_FOREIGN_TABLE || RELKIND_VIEW)
SS_UNSHIPPABLE_TYPE</p>
<p>case T_Const pgxc_set_exprtype_shippability <br>
case T_CaseTestExpr pgxc_set_exprtype_shippability
case T_Var // å¦‚æœå­è¯­å¥å¼•ç”¨çˆ¶è¯­å¥ï¼Œåˆ™not shippableï¼Œ sc_max_varlevelsupä»£è¡¨ Shippability_contextçš„å±‚çº§</p>
<p>pgxc_is_func_shippable</p>
<p>query_tree_walker</p>
<p>expression_tree_walker</p>
<h1 id=ä¸Šé¢éå†è¯­æ³•æ ‘æ‰¾åˆ°ä¸å…è®¸shipçš„èŠ‚ç‚¹ä¸”è®°å½•åŸå› >
ä¸Šé¢éå†è¯­æ³•æ ‘æ‰¾åˆ°ä¸å…è®¸shipçš„èŠ‚ç‚¹ä¸”è®°å½•åŸå› 
<a href=#%e4%b8%8a%e9%9d%a2%e9%81%8d%e5%8e%86%e8%af%ad%e6%b3%95%e6%a0%91%e6%89%be%e5%88%b0%e4%b8%8d%e5%85%81%e8%ae%b8ship%e7%9a%84%e8%8a%82%e7%82%b9%e4%b8%94%e8%ae%b0%e5%bd%95%e5%8e%9f%e5%9b%a0 class=h-anchor aria-hidden=true>#</a>
</h1>
<p>pgxc_FQS_find_datanodes
æ›´å…·è¯­æ³•æ ‘æ‰¾åˆ°æ‰§è¡ŒèŠ‚ç‚¹</p>
<p>pgxc_FQS_find_datanodes_recurse
é€’å½’æŸ¥æ‰¾join treeæŸ¥æ‰¾å¯ä»¥shipçš„å­æŸ¥è¯¢</p>
<p>pgxc_FQS_datanodes_for_rtr
å¦‚æœåªæœ‰ä¸€ä¸ªè¡¨ï¼Œä¸Šé¢é€’å½’åˆ°è¿™é‡Œï¼Œè¿™é‡Œæ“ä½œçš„æ˜¯ä¸€ä¸ªref</p>
<pre><code>pgxc_FQS_get_relation_nodes

  GetRelationLocInfo
    è·å–è¡¨çš„ä¿¡æ¯  
   {relid = 16412, locatorType = 72 'H', keys = 0x55ead304d888, nodeids = 0x55ead304d8d8, values = 0x0, masternodeids = 0x55ead304d8d8, slavenodeids = 0x55ead304d928}

  relation_remote_by_constraints_base
    è·å¾—æ•°æ®åˆ†å¸ƒä¿¡æ¯ï¼Ÿ

  predicate_refuted_by
    æ£€æŸ¥æŸè¡¨è¾¾å¼æ˜¯å¦æ»¡è¶³ç»™å®šçš„çº¦æŸ

eval_const_expressions
å¸¸é‡æŠ˜å 
</code></pre>
<p>mutator_equal_expr
æ„é€ è¡¨è¾¾å¼ï¼Œcolumn = val éœ€è¦ä½¿ç”¨hash åˆ¤æ–­æ˜¯å¦åœ¨ æŸèŠ‚ç‚¹ä¸Š
let column=val to (like) hash(column)%remote_count = hash(value)%remote_count to hash(column)%remote_count = new_value
column [not] in (v1,v2) to hash(column)%remote [not] in (new_v1,new_v2)</p>
<p>hash(x) % node =</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span>
                              Table <span style=color:#e6db74>&#34;public.bmsql_new_order&#34;</span>
 Column  <span style=color:#f92672>|</span>  Type   <span style=color:#f92672>|</span> Nullable <span style=color:#f92672>|</span> Storage <span style=color:#f92672>|</span>
<span style=color:#f92672>---------+---------+----------+---------+</span>
 no_w_id <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span> not null <span style=color:#f92672>|</span> plain   <span style=color:#f92672>|</span> 
 no_d_id <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span> not null <span style=color:#f92672>|</span> plain   <span style=color:#f92672>|</span> 
 no_o_id <span style=color:#f92672>|</span> integer <span style=color:#f92672>|</span> not null <span style=color:#f92672>|</span> plain   <span style=color:#f92672>|</span> 
Indexes:
    <span style=color:#e6db74>&#34;bmsql_new_order_pkey&#34;</span> PRIMARY KEY, btree (no_w_id, no_d_id, no_o_id)
Foreign<span style=color:#f92672>-</span>key constraints:
    <span style=color:#e6db74>&#34;no_order_fkey&#34;</span> FOREIGN KEY (no_w_id, no_d_id, no_o_id) REFERENCES bmsql_oorder(o_w_id, o_d_id, o_id)
DISTRIBUTE BY HASH(no_w_id) TO NODE(dn1, dn2)
Access method: heap


<span style=color:#960050;background-color:#1e0010>æ•°æ®åˆ†å¸ƒ</span>
benchmarksql<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>#</span> execute direct on (dn1) <span style=color:#960050;background-color:#1e0010>&#39;</span>select distinct no_w_id from <span style=color:#66d9ef>public</span>.bmsql_new_order<span style=color:#960050;background-color:#1e0010>&#39;</span>;
 no_w_id 
<span style=color:#f92672>---------</span>
       <span style=color:#ae81ff>1</span>
       <span style=color:#ae81ff>5</span>
       <span style=color:#ae81ff>2</span>
(<span style=color:#ae81ff>3</span> rows)

benchmarksql<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>#</span> execute direct on (dn2) <span style=color:#960050;background-color:#1e0010>&#39;</span>select distinct no_w_id from <span style=color:#66d9ef>public</span>.bmsql_new_order<span style=color:#960050;background-color:#1e0010>&#39;</span>;
 no_w_id 
<span style=color:#f92672>---------</span>
       <span style=color:#ae81ff>4</span>
       <span style=color:#ae81ff>3</span>
(<span style=color:#ae81ff>2</span> rows)

<span style=color:#960050;background-color:#1e0010>è¯­å¥</span>select no_o_id from bmsql_new_order where no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> order by no_o_id asc;


<span style=color:#f92672>========================================</span>

(no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
COALESCE(hash_combin_mod(<span style=color:#ae81ff>2</span>, hash(no_w_id)), <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> and (no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)

hash(no_w_id) <span style=color:#f92672>%</span> node_count <span style=color:#f92672>=</span> hash(<span style=color:#ae81ff>4</span>) <span style=color:#f92672>%</span> node_count

<span style=color:#f92672>===============</span>

(no_w_id, no_d_id, no_o_id) is not null 
XC_NODE_ID is not null
ABLE.XC_NODE_ID<span style=color:#f92672>=</span>id
COALESCE(hash_combin_mod(<span style=color:#ae81ff>2</span>, hash(no_w_id))<span style=color:#960050;background-color:#1e0010>ï¼Œ</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>

<span style=color:#960050;background-color:#1e0010>ç¬¬ä¸€è½®ï¼Œæ£€æµ‹æ¡ä»¶</span>
<span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>é™åˆ¶æ¡ä»¶ä¸º</span>
<span style=color:#ae81ff>1.</span> <span style=color:#960050;background-color:#1e0010>ä¸»é”®ä¸ä¸º</span>NULL<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>
<span style=color:#ae81ff>2.</span> <span style=color:#960050;background-color:#1e0010>èŠ‚ç‚¹</span>XC_NODE_IDä¸ä¸ºnull
<span style=color:#ae81ff>3.</span> XC_NODE_ID<span style=color:#f92672>=</span>loc_info.nodeid
<span style=color:#ae81ff>4.</span> hash(no_w_id) <span style=color:#f92672>%</span> node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>

<span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>è¾“å…¥è¡¨è¾¾å¼ä¸º</span>
<span style=color:#ae81ff>1.</span> (no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
<span style=color:#ae81ff>2.</span> (hash(no_w_id) <span style=color:#f92672>%</span> node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> (<span style=color:#960050;background-color:#1e0010>è¯­å¥æ¡ä»¶æ ¹æ®åˆ†å¸ƒæ–¹å¼è®¡ç®—çš„</span>hash)

<span style=color:#960050;background-color:#1e0010>ç”±äº</span>hashå‡ºæ¥åˆ¤æ–­çš„èŠ‚ç‚¹ä¸ä¸€è‡´<span style=color:#960050;background-color:#1e0010>ï¼Œæ‰€ä»¥æ— æ³•é€šè¿‡åˆ¤æ–­</span>



<span style=color:#f92672>=============================================</span>


(no_w_id, no_d_id, no_o_id) is not null 
XC_NODE_ID is not null
XC_NODE_ID<span style=color:#f92672>=</span>id
COALESCE(hash_combin_mod(<span style=color:#ae81ff>2</span>, hash(no_w_id))<span style=color:#960050;background-color:#1e0010>ï¼Œ</span> <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>


(no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
COALESCE(hash_combin_mod(<span style=color:#ae81ff>2</span>, hash(no_w_id)), <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> and (no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)

<span style=color:#960050;background-color:#1e0010>ç¬¬è€Œè½®ï¼Œæ£€æµ‹æ¡ä»¶</span>
<span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>é™åˆ¶æ¡ä»¶ä¸º</span>
<span style=color:#ae81ff>1.</span> <span style=color:#960050;background-color:#1e0010>ä¸»é”®ä¸ä¸º</span>NULL<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>
<span style=color:#ae81ff>2.</span> <span style=color:#960050;background-color:#1e0010>èŠ‚ç‚¹</span>XC_NODE_IDä¸ä¸ºnull
<span style=color:#ae81ff>3.</span> XC_NODE_ID<span style=color:#f92672>=</span>loc_info.nodeid
<span style=color:#ae81ff>4.</span> hash(no_w_id) <span style=color:#f92672>%</span> node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>

<span style=color:#f92672>-</span> <span style=color:#960050;background-color:#1e0010>è¾“å…¥è¡¨è¾¾å¼ä¸º</span>
<span style=color:#ae81ff>1.</span> (no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span> and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>)
<span style=color:#ae81ff>2.</span> (hash(no_w_id) <span style=color:#f92672>%</span> node_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) and no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span> (<span style=color:#960050;background-color:#1e0010>è¯­å¥æ¡ä»¶æ ¹æ®åˆ†å¸ƒæ–¹å¼è®¡ç®—çš„</span>hash)


<span style=color:#960050;background-color:#1e0010>åˆ¤å®šè¡¨è¾¾å¼æ˜¯å¦å¯ä»¥é€šè¿‡çº¦æŸçš„æ£€æŸ¥</span>

<span style=color:#960050;background-color:#1e0010>åˆ¤å®šé€šè¿‡</span>

<span style=color:#75715e>// é€’å½’åœ°æ£€æŸ¥å­å¥clause_listä¸­çš„å­å¥æ˜¯å¦é©³æ–¥ç»™å®šçš„predicate_list(ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯æ˜å®ƒä¸º false)ã€‚
</span><span style=color:#75715e></span>

<span style=color:#75715e>/*
</span><span style=color:#75715e>predicate_list
</span><span style=color:#75715e>* no_w_id is not null
</span><span style=color:#75715e>* no_d_id is not null
</span><span style=color:#75715e>* no_o_id is not null
</span><span style=color:#75715e>* XC_NODE_ID is not null
</span><span style=color:#75715e>* XC_NODE_ID = nodeid
</span><span style=color:#75715e>* hash(no_w_id) % node_count = 0
</span><span style=color:#75715e>
</span><span style=color:#75715e>clause_list
</span><span style=color:#75715e>* no_w_id = 4
</span><span style=color:#75715e>* no_d_id = 1
</span><span style=color:#75715e>* hash(no_w_id) % node_count = 1
</span><span style=color:#75715e>* no_d_id = 1
</span><span style=color:#75715e>*/</span>

<span style=color:#75715e>/*
</span><span style=color:#75715e>
</span><span style=color:#75715e>predicate_list
</span><span style=color:#75715e>* no_w_id is not null
</span><span style=color:#75715e>* no_d_id is not null
</span><span style=color:#75715e>* no_o_id is not null
</span><span style=color:#75715e>* XC_NODE_ID is not null
</span><span style=color:#75715e>* XC_NODE_ID = nodeid
</span><span style=color:#75715e>* hash(no_w_id) % node_count = 0
</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e>clause_list
</span><span style=color:#75715e>* no_w_id = $1
</span><span style=color:#75715e>* no_d_id = $2
</span><span style=color:#75715e>*/</span>

predicate_refuted_by(<span style=color:#f92672>*</span>predicate_list, <span style=color:#f92672>*</span>clause_list) {

  predicate_refuted_by_recurse() {
    pclass <span style=color:#f92672>=</span> predicate_classify(predicate, <span style=color:#f92672>&amp;</span>pred_info);

    <span style=color:#75715e>// æ‹†è§£è¡¨è¾¾å¼ï¼Œæœ€ç»ˆä¸èƒ½æ‹†è§£çš„è¡¨è¾¾ä¹¦ä¸ºatom
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>switch</span> (predicate_classify(clause, <span style=color:#f92672>&amp;</span>clause_info)) {
      <span style=color:#66d9ef>case</span> CLASS_AND:
        <span style=color:#66d9ef>switch</span> (pclass) {
          <span style=color:#66d9ef>case</span> CLASS_AND: 
            iterate_begin(pitem, predicate, pred_info) {
              <span style=color:#66d9ef>if</span> (predicate_refuted_by_recurse(clause, pitem, weak)) {
                result <span style=color:#f92672>=</span> true;
                <span style=color:#66d9ef>break</span>;
              }
            }
            iterate_begin(citem, clause, clause_info) {
              <span style=color:#66d9ef>if</span> (predicate_refuted_by_recurse(citem, predicate, weak)) {
                result <span style=color:#f92672>=</span> true;
                <span style=color:#66d9ef>break</span>;
              }
            }
          <span style=color:#66d9ef>case</span> CLASS_OR:
          <span style=color:#66d9ef>case</span> CLASS_ATOM:
            not_arg <span style=color:#f92672>=</span> extract_not_arg(predicate);
            <span style=color:#66d9ef>if</span> (not_arg <span style=color:#f92672>&amp;&amp;</span> predicate_implied_by_recurse(clause, not_arg, false))
              <span style=color:#66d9ef>return</span> true;
            iterate_begin(citem, clause, clause_info) {
              <span style=color:#66d9ef>if</span> (predicate_refuted_by_recurse(citem, predicate, weak)) {
                result <span style=color:#f92672>=</span> true;
                <span style=color:#66d9ef>break</span>;
              }
            }
        }
        <span style=color:#66d9ef>break</span>;
        .....
        <span style=color:#66d9ef>case</span> CLASS_ATOM: {
          .....
          <span style=color:#66d9ef>case</span> CLASS_ATOM:
            <span style=color:#75715e>// ä½¿ç”¨æ­¤æ–¹æ³•åˆ¤æ–­æœ€ç»ˆçš„atomè¡¨è¾¾å¼
</span><span style=color:#75715e></span>            <span style=color:#66d9ef>return</span> predicate_refuted_by_simple_clause((Expr <span style=color:#f92672>*</span>) predicate, clause, weak) {
              <span style=color:#75715e>// 
</span><span style=color:#75715e></span>              <span style=color:#66d9ef>if</span> (predicate <span style=color:#f92672>&amp;&amp;</span> IsA(predicate, NullTest) <span style=color:#f92672>&amp;&amp;</span> ((NullTest <span style=color:#f92672>*</span>) predicate)<span style=color:#f92672>-&gt;</span>nulltesttype <span style=color:#f92672>==</span> IS_NULL) {
                <span style=color:#75715e>// åˆ¤æ–­nullï¼Œargisrowç›´æ¥falseï¼Œä¸€ä¸ªæ˜¯is not nullï¼Œ æ‹ä¸€ä¸ªæ˜¯is nullï¼Œåˆ™ç›´æ¥true
</span><span style=color:#75715e></span>              }

              <span style=color:#75715e>// å¯¹ç®€å•è¡¨è¾¾å¼çš„åˆ¤æ–­ï¼Œç®€å•è¡¨è¾¾å¼è¿™é‡ŒæŒ‡çš„æ˜¯ op(left, right)
</span><span style=color:#75715e></span>              <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>operator_predicate_proof</span>(predicate, clause, true, weak) {
                <span style=color:#75715e>// no_w_id is not null ä»è¿™é‡Œè·³å‡º
</span><span style=color:#75715e></span>                <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>is_opclause(predicate))
                  <span style=color:#66d9ef>return</span> false;
                pred_opexpr <span style=color:#f92672>=</span> (OpExpr <span style=color:#f92672>*</span>) predicate;
                <span style=color:#66d9ef>if</span> (list_length(pred_opexpr<span style=color:#f92672>-&gt;</span>args) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>2</span>)
                  <span style=color:#66d9ef>return</span> false;
                ....(<span style=color:#66d9ef>do</span> same as clause)

                <span style=color:#66d9ef>if</span> (pred_opexpr<span style=color:#f92672>-&gt;</span>inputcollid <span style=color:#f92672>!=</span> clause_opexpr<span style=color:#f92672>-&gt;</span>inputcollid)
                  <span style=color:#66d9ef>return</span> false;

                <span style=color:#66d9ef>if</span> (equal(pred_leftop, clause_leftop)) {
                  <span style=color:#66d9ef>if</span> (equal(pred_rightop, clause_rightop)) {
                    <span style=color:#66d9ef>return</span> operator_same_subexprs_proof(pred_op, clause_op, refute_it);
                  } <span style=color:#66d9ef>else</span> {
                    <span style=color:#66d9ef>if</span> (pred_rightop <span style=color:#f92672>==</span> NULL <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>IsA(pred_rightop, Const))
                      <span style=color:#66d9ef>return</span> false;
                    pred_const <span style=color:#f92672>=</span> (Const <span style=color:#f92672>*</span>) pred_rightop;
                    ....
                    <span style=color:#75715e>// ä¸‹é¢ä½¿ç”¨const_væ„é€ ä¸€ä¸ª ï¼ˆl_const != r_contï¼‰å¹¶è®¡ç®—ï¼Œç›´æ¥è¿”å›è®¡ç®—ç»“æœï¼Œä¸‹é¢çš„æ­¥éª¤ç±»ä¼¼
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//  ä½¿ç”¨
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//    hash(no_w_id) % node_count = 0
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//  å’Œ
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//    hash(no_w_id) % node_count = 1
</span><span style=color:#75715e></span>                    <span style=color:#75715e>//   ä¸ºä¾‹ã€‚æœ€ç»ˆæ‰§è¡Œåˆ°è¿™é‡Œï¼Œconstå¯¹æ¯”ä¸ä¸€æ ·ï¼Œè¿”å›false
</span><span style=color:#75715e></span>                  }
                  
                } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (equal(pred_rightop, clause_rightop)) {

                } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (equal(pred_leftop, clause_rightop)) {

                } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (equal(pred_rightop, clause_leftop)) {

                } <span style=color:#66d9ef>else</span> {
                  <span style=color:#66d9ef>return</span> false;
                }
              }
            }
        }
    }
  }
}
<span style=color:#75715e>/*
</span><span style=color:#75715e>  çº¦æŸä½¿ç”¨åˆ†åŒºæ–¹å¼å’ŒèŠ‚ç‚¹åºå·æ„é€ è¡¨è¾¾å¼ï¼ŒæŸ¥è¯¢çš„whereè¡¨è¾¾å¼éœ€è¦åˆ¤æ–­èŠ‚ç‚¹ï¼Œä¹Ÿéœ€è¦æ„é€ ç±»ä¼¼çš„è¡¨è¾¾å¼
</span><span style=color:#75715e>*/</span>

make_new_qual_list() {
  <span style=color:#75715e>/*
</span><span style=color:#75715e>  * let column=val to (like) hash(column)%remote_count = hash(value)%remote_count to hash(column)%remote_count = new_value
</span><span style=color:#75715e>  *   column [not] in (v1,v2) to hash(column)%remote [not] in (new_v1,new_v2)
</span><span style=color:#75715e>  */</span>
  <span style=color:#75715e>// è¡¨è¾¾å¼ä½¿ç”¨åˆ†åŒºä¿¡æ¯æ„é€  æ–°çš„clauseï¼Œè§„åˆ™å¦‚ä¸Š 
</span><span style=color:#75715e></span>  mutator_equal_expr() {
    get_var_equal_const(op<span style=color:#f92672>-&gt;</span>args, op<span style=color:#f92672>-&gt;</span>opno, context<span style=color:#f92672>-&gt;</span>relid, context<span style=color:#f92672>-&gt;</span>varattno, <span style=color:#f92672>&amp;</span>var) <span style=color:#f92672>==</span> null;
      <span style=color:#66d9ef>goto</span> next_mutator_equal_expr_;

  next_mutator_equal_expr_:
	  <span style=color:#66d9ef>return</span> expression_tree_mutator(node, mutator_equal_expr, context);
  }
}


</code></pre></div><h2 id=åŠ¨æ€è¯­å¥ä¼˜åŒ–æ‰§è¡Œé€»è¾‘>
åŠ¨æ€è¯­å¥ä¼˜åŒ–æ‰§è¡Œé€»è¾‘
<a href=#%e5%8a%a8%e6%80%81%e8%af%ad%e5%8f%a5%e4%bc%98%e5%8c%96%e6%89%a7%e8%a1%8c%e9%80%bb%e8%be%91 class=h-anchor aria-hidden=true>#</a>
</h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>prepare <span style=color:#a6e22e>s35</span>(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) as select a.no_o_id from bmsql_new_order a join bmsql_new_order_bak1 b on  a.no_w_id  <span style=color:#f92672>=</span> b.no_w_id and  a.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> order by no_o_id asc;

explain verbose execute <span style=color:#a6e22e>s35</span>(<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>1</span>); 

<span style=color:#75715e>/*
</span><span style=color:#75715e>SS_replace_correlation_vars è¿›è¡Œå‚æ•°æ›¿æ¢
</span><span style=color:#75715e>*/</span>

 Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>3318690.29</span>.<span style=color:#ae81ff>.3368908.54</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>20087300</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
   Output: a.no_o_id
   Sort Key: a.no_o_id
   <span style=color:#f92672>-&gt;</span>  Nested Loop  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.332853.86</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>20087300</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
         Output: a.no_o_id
         <span style=color:#f92672>-&gt;</span>  Data Node Scan on bmsql_new_order <span style=color:#e6db74>&#34;_REMOTE_TABLE_QUERY_&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40877.74</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4514</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
               Output: a.no_o_id, a.no_w_id
               Node<span style=color:#f92672>/</span>s: dn2
               Remote query: SELECT no_o_id, no_w_id FROM ONLY <span style=color:#66d9ef>public</span>.bmsql_new_order a WHERE (no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>)
         <span style=color:#f92672>-&gt;</span>  Materialize  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40895.99</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4450</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
               Output: b.no_w_id
               <span style=color:#f92672>-&gt;</span>  Data Node Scan on bmsql_new_order_bak1 <span style=color:#e6db74>&#34;_REMOTE_TABLE_QUERY__1&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40873.74</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4450</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
                     Output: b.no_w_id
                     Node<span style=color:#f92672>/</span>s: dn2
                     Remote query: SELECT no_w_id FROM ONLY <span style=color:#66d9ef>public</span>.bmsql_new_order_bak1 b WHERE (no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>)
(<span style=color:#ae81ff>15</span> rows)

                                                  QUERY PLAN                                                   
<span style=color:#f92672>---------------------------------------------------------------------------------------------------------------</span>
 Cluster Merge Gather  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>2372049.11</span>.<span style=color:#ae81ff>.2397384.11</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>20268004</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
   Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>
   Sort Key: a.no_o_id
   <span style=color:#f92672>-&gt;</span>  Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>1965689.03</span>.<span style=color:#ae81ff>.1991024.03</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>10134002</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
         Output: a.no_o_id
         Sort Key: a.no_o_id
         <span style=color:#f92672>-&gt;</span>  Nested Loop  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>73.82</span>.<span style=color:#ae81ff>.509359.05</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>10134002</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
               Output: a.no_o_id
               <span style=color:#f92672>-&gt;</span>  Cluster Reduce  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>73.82</span>.<span style=color:#ae81ff>.1839.97</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>9004</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
                     Reduce: unnest(<span style=color:#960050;background-color:#1e0010>&#39;</span>[<span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>=</span>{<span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>}<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>::</span>oid[])
                     <span style=color:#f92672>-&gt;</span>  Bitmap Heap Scan on <span style=color:#66d9ef>public</span>.bmsql_new_order a  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>72.82</span>.<span style=color:#ae81ff>.434.37</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4502</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>)
                           Output: a.no_w_id, a.no_d_id, a.no_o_id
                           Recheck Cond: (a.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>)
                           <span style=color:#f92672>-&gt;</span>  Bitmap Index Scan on bmsql_new_order_pkey  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.71.70</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>9004</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
                                 Index Cond: (a.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>)
                                 Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>
               <span style=color:#f92672>-&gt;</span>  Materialize  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.830.24</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4502</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
                     Output: b.no_w_id
                     <span style=color:#f92672>-&gt;</span>  Seq Scan on <span style=color:#66d9ef>public</span>.bmsql_new_order_bak1 b  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.807.73</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4502</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
                           Output: b.no_w_id
                           Filter: (b.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>)
                           Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>




<span style=color:#960050;background-color:#1e0010>æ‰§è¡Œ</span><span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>æ¬¡ä¹‹åæ‰§è¡Œè®¡åˆ’ä¸ä¸€æ ·ï¼ŒåŸå› æ˜¯å› ä¸ºå‰å‡ æ¬¡çš„</span>planä½¿ç”¨boundParamsç”Ÿæˆè®¡åˆ’<span style=color:#960050;background-color:#1e0010>ï¼Œæ‰€ä»¥å¯ä»¥å–å¾—èŠ‚ç‚¹ä¿¡æ¯ï¼Œä½†æ˜¯</span><span style=color:#ae81ff>5</span><span style=color:#960050;background-color:#1e0010>æ¬¡ä¹‹åï¼Œä¸ä½¿ç”¨</span>boundParams<span style=color:#960050;background-color:#1e0010>ï¼Œæ‰€ä»¥ç”Ÿæˆçš„æ‰§è¡Œè®¡åˆ’ä¸­ä½¿ç”¨</span>hostvar


prepare s35(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) as select a.no_o_id from bmsql_new_order a join bmsql_new_order_bak1 b on  a.no_w_id  <span style=color:#f92672>=</span> b.no_w_id and  a.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> order by no_o_id asc;

benchmarksql<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>#</span> explain (verbose, analyze) execute s35(<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>1</span>); 
                                                             QUERY PLAN                                                              
<span style=color:#f92672>-------------------------------------------------------------------------------------------------------------------------------------</span>
 Cluster Merge Gather  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>2372049.11</span>.<span style=color:#ae81ff>.2397384.11</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>20268004</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>48502.583</span>.<span style=color:#ae81ff>.413914.132</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80838081</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
   Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>
   Sort Key: a.no_o_id
   <span style=color:#f92672>-&gt;</span>  Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>1965689.03</span>.<span style=color:#ae81ff>.1991024.03</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>10134002</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.017</span>.<span style=color:#ae81ff>.0.020</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
         Output: a.no_o_id
         Sort Key: a.no_o_id
         Sort Method: quicksort  Memory: <span style=color:#ae81ff>25</span>kB
         Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>23528.119</span>.<span style=color:#ae81ff>.23528.120</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
         Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>48501.986</span>.<span style=color:#ae81ff>.65663.191</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80838081</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
         <span style=color:#f92672>-&gt;</span>  Nested Loop  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>73.82</span>.<span style=color:#ae81ff>.509359.05</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>10134002</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.008</span>.<span style=color:#ae81ff>.0.010</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
               Output: a.no_o_id
               Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>23528.111</span>.<span style=color:#ae81ff>.23528.112</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
               Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>1.999</span>.<span style=color:#ae81ff>.10602.102</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80838081</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
               <span style=color:#f92672>-&gt;</span>  Cluster Reduce  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>73.82</span>.<span style=color:#ae81ff>.1839.97</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>9004</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.002</span>.<span style=color:#ae81ff>.0.003</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                     Reduce: unnest(<span style=color:#960050;background-color:#1e0010>&#39;</span>[<span style=color:#ae81ff>0</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>]<span style=color:#f92672>=</span>{<span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>}<span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>::</span>oid[])
                     Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.618</span>.<span style=color:#ae81ff>.23491.822</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                     Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>1.667</span>.<span style=color:#ae81ff>.407.128</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                     <span style=color:#f92672>-&gt;</span>  Bitmap Heap Scan on <span style=color:#66d9ef>public</span>.bmsql_new_order a  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>72.82</span>.<span style=color:#ae81ff>.434.37</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4502</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>) (never executed)
                           Output: a.no_w_id, a.no_d_id, a.no_o_id
                           Recheck Cond: (a.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>)
                           Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.019</span>.<span style=color:#ae81ff>.0.019</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                           Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.741</span>.<span style=color:#ae81ff>.21.944</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                           <span style=color:#f92672>-&gt;</span>  Bitmap Index Scan on bmsql_new_order_pkey  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.71.70</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>9004</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) (never executed)
                                 Index Cond: (a.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>)
                                 Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>
                                 Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.017</span>.<span style=color:#ae81ff>.0.017</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                                 Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.723</span>.<span style=color:#ae81ff>.0.723</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>9009</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
               <span style=color:#f92672>-&gt;</span>  Materialize  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.830.24</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4502</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (never executed)
                     Output: b.no_w_id
                     Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.001</span>.<span style=color:#ae81ff>.0.001</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span>)
                     Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.000</span>.<span style=color:#ae81ff>.0.414</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span>)
                     <span style=color:#f92672>-&gt;</span>  Seq Scan on <span style=color:#66d9ef>public</span>.bmsql_new_order_bak1 b  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.807.73</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4502</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (never executed)
                           Output: b.no_w_id
                           Filter: (b.no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>)
                           Remote node: <span style=color:#ae81ff>16386</span>,<span style=color:#ae81ff>16387</span>
                           Node <span style=color:#ae81ff>16386</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>3.320</span>.<span style=color:#ae81ff>.3.320</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                           Node <span style=color:#ae81ff>16387</span><span style=color:#f92672>:</span> (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.325</span>.<span style=color:#ae81ff>.2.621</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
 Planning Time: <span style=color:#ae81ff>0.019</span> ms
 Execution Time: <span style=color:#ae81ff>418376.338</span> ms
(<span style=color:#ae81ff>39</span> rows)

Time: <span style=color:#ae81ff>418377.013</span> ms (<span style=color:#ae81ff>06</span><span style=color:#f92672>:</span><span style=color:#ae81ff>58.377</span>)

   QUERY PLAN                                                            
<span style=color:#f92672>-------------------------------------------------------------------------</span>
 Gather Motion <span style=color:#ae81ff>1</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span>  (slice1; segments: <span style=color:#ae81ff>1</span>)  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>10010754784.29</span>.<span style=color:#ae81ff>.10010895164.35</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>56152025</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>169250.450</span>.<span style=color:#ae81ff>.224356.779</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80964004</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
   Output: a.no_o_id
   Merge Key: a.no_o_id
   <span style=color:#f92672>-&gt;</span>  Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>10010754784.29</span>.<span style=color:#ae81ff>.10010895164.35</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>28076013</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>169248.624</span>.<span style=color:#ae81ff>.210801.666</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80964004</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
         Output: a.no_o_id
         Sort Key: a.no_o_id
         Sort Method:  external merge  Disk: <span style=color:#ae81ff>633184</span>kB  Max Memory: <span style=color:#ae81ff>633184</span>kB  Avg Memory: <span style=color:#ae81ff>633184</span>kb (<span style=color:#ae81ff>1</span> segments)
         Executor Memory: <span style=color:#ae81ff>67387</span>kB  Segments: <span style=color:#ae81ff>1</span>  Max: <span style=color:#ae81ff>67387</span>kB (segment <span style=color:#ae81ff>0</span>)
         work_mem: <span style=color:#ae81ff>67387</span>kB  Segments: <span style=color:#ae81ff>1</span>  Max: <span style=color:#ae81ff>67387</span>kB (segment <span style=color:#ae81ff>0</span>)  Workfile: (<span style=color:#ae81ff>1</span> spilling)
         Work_mem wanted: <span style=color:#ae81ff>5059596</span>K bytes to lessen workfile I<span style=color:#f92672>/</span>O.
         <span style=color:#f92672>-&gt;</span>  Nested Loop  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>10000000000.00</span>.<span style=color:#ae81ff>.10000703168.82</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>28076013</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.872</span>.<span style=color:#ae81ff>.22492.433</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80964004</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
               Output: a.no_o_id
               <span style=color:#f92672>-&gt;</span>  Seq Scan on <span style=color:#66d9ef>public</span>.bmsql_new_order a  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.624.91</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>3757</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.440</span>.<span style=color:#ae81ff>.60.571</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8998</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                     Output: a.no_w_id, a.no_d_id, a.no_o_id
                     Filter: (a.no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>)
               <span style=color:#f92672>-&gt;</span>  Materialize  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.662.28</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>3737</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.000</span>.<span style=color:#ae81ff>.1.157</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8998</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>8998</span>)
                     Output: b.no_w_id
                     work_mem: <span style=color:#ae81ff>128</span>kB  Segments: <span style=color:#ae81ff>1</span>  Max: <span style=color:#ae81ff>128</span>kB (segment <span style=color:#ae81ff>0</span>)  Workfile: (<span style=color:#ae81ff>0</span> spilling)
                     Work_mem wanted: <span style=color:#ae81ff>96</span>K bytes to lessen workfile I<span style=color:#f92672>/</span>O.
                     <span style=color:#f92672>-&gt;</span>  Seq Scan on <span style=color:#66d9ef>public</span>.bmsql_new_order_bak1 b  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.624.91</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>3737</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.413</span>.<span style=color:#ae81ff>.5.295</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8998</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                           Output: b.no_w_id
                           Filter: (b.no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>)
   (slice0)    Executor memory: <span style=color:#ae81ff>247</span>K bytes.
 <span style=color:#f92672>*</span> (slice1)    Executor memory: <span style=color:#ae81ff>67588</span>K bytes (seg0).  Work_mem: <span style=color:#ae81ff>67387</span>K by
tes max, <span style=color:#ae81ff>5059596</span>K bytes wanted.
 Memory used:  <span style=color:#ae81ff>128000</span>kB
 Memory wanted:  <span style=color:#ae81ff>10119590</span>kB
 Optimizer: Postgres query optimizer
 Execution time: <span style=color:#ae81ff>227858.105</span> ms
(<span style=color:#ae81ff>28</span> rows)


benchmarksql<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>#</span> explain (verbose, analyze) execute s35(<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>1</span>); 
                                                                                QUERY PLAN                                                                                 
<span style=color:#f92672>---------------------------------------------------------------------------------------------------------------------------------------------------------------------------</span>
 Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>3318690.29</span>.<span style=color:#ae81ff>.3368908.54</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>20087300</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>47658.096</span>.<span style=color:#ae81ff>.57545.533</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80838081</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
   Output: a.no_o_id
   Sort Key: a.no_o_id
   Sort Method: external merge  Disk: <span style=color:#ae81ff>1107456</span>kB
   <span style=color:#f92672>-&gt;</span>  Nested Loop  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.332853.86</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>20087300</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>53.724</span>.<span style=color:#ae81ff>.10131.385</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>80838081</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
         Output: a.no_o_id
         <span style=color:#f92672>-&gt;</span>  Data Node Scan on bmsql_new_order <span style=color:#e6db74>&#34;_REMOTE_TABLE_QUERY_&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40877.74</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4514</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>8</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>4.288</span>.<span style=color:#ae81ff>.13.794</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
               Output: a.no_o_id, a.no_w_id
               Node<span style=color:#f92672>/</span>s: dn2
               Remote query: SELECT no_o_id, no_w_id FROM ONLY <span style=color:#66d9ef>public</span>.bmsql_new_order a WHERE (no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>)
         <span style=color:#f92672>-&gt;</span>  Materialize  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40895.99</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4450</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>0.006</span>.<span style=color:#ae81ff>.0.424</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span>)
               Output: b.no_w_id
               <span style=color:#f92672>-&gt;</span>  Data Node Scan on bmsql_new_order_bak1 <span style=color:#e6db74>&#34;_REMOTE_TABLE_QUERY__1&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40873.74</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>4450</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>) (actual time<span style=color:#f92672>=</span><span style=color:#ae81ff>49.423</span>.<span style=color:#ae81ff>.80.558</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>8991</span> loops<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                     Output: b.no_w_id
                     Node<span style=color:#f92672>/</span>s: dn2
                     Remote query: SELECT no_w_id FROM ONLY <span style=color:#66d9ef>public</span>.bmsql_new_order_bak1 b WHERE (no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>)
 Planning Time: <span style=color:#ae81ff>0.437</span> ms
 Execution Time: <span style=color:#ae81ff>60158.685</span> ms
(<span style=color:#ae81ff>18</span> rows)

Time: <span style=color:#ae81ff>60159.959</span> ms (<span style=color:#ae81ff>01</span><span style=color:#f92672>:</span><span style=color:#ae81ff>00.160</span>)


SELECT d_tax, d_next_o_id FROM bmsql_district WHERE d_w_id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span> AND d_id <span style=color:#f92672>=</span> <span style=color:#f92672>?</span> FOR UPDATE;



create table <span style=color:#a6e22e>test_a</span>(a <span style=color:#66d9ef>int</span>, b <span style=color:#66d9ef>int</span>, c <span style=color:#66d9ef>int</span>, d <span style=color:#66d9ef>int</span>);

insert into test_a select <span style=color:#a6e22e>generate_series</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>), floor(random() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>), floor(random() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>), floor(random() <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);

EXPLAIN SELECT <span style=color:#f92672>*</span> FROM TEST_A WHERE a <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>1</span> ORDER BY a; 

CREATE INDEX TEST_A_A_IDX ON <span style=color:#a6e22e>TEST_A</span>(a) ; 

</code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>

set enable_cluster_plan<span style=color:#f92672>=</span>false;
set pgxc_enable_remote_query<span style=color:#f92672>=</span>false;


prepare <span style=color:#a6e22e>s3</span>(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) as select no_o_id from bmsql_new_order where no_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> and no_d_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> order by no_o_id asc;
benchmarksql<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>#</span> explain verbose execute s3(<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>);
                                                          QUERY PLAN                                                           
<span style=color:#f92672>-------------------------------------------------------------------------------------------------------------------------------</span>
 Sort  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>41034.79</span>.<span style=color:#ae81ff>.41037.05</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>906</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
   Output: bmsql_new_order.no_o_id
   Sort Key: bmsql_new_order.no_o_id
   <span style=color:#f92672>-&gt;</span>  Data Node Scan on bmsql_new_order <span style=color:#e6db74>&#34;_REMOTE_TABLE_QUERY_&#34;</span>  (cost<span style=color:#f92672>=</span><span style=color:#ae81ff>0.00</span>.<span style=color:#ae81ff>.40990.29</span> rows<span style=color:#f92672>=</span><span style=color:#ae81ff>906</span> width<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span>)
         Output: bmsql_new_order.no_o_id
         Primary node<span style=color:#f92672>/</span>s: dn1
         Node<span style=color:#f92672>/</span>s: dn1
         Remote query: SELECT no_o_id FROM ONLY <span style=color:#66d9ef>public</span>.bmsql_new_order bmsql_new_order WHERE ((no_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>) AND (no_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>))
(<span style=color:#ae81ff>8</span> rows)



<span style=color:#ae81ff>1.</span> <span style=color:#960050;background-color:#1e0010>é™æ€è¯­å¥å’ŒåŠ¨æ€è¯­å¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ä¸ä¸€æ ·ã€‚ç†è®ºä¸Šé™æ€è¯­å¥ä»£ä»·ä½ï¼Œä¸ä¼šè¢«æ›¿æ¢ï¼Œä½†æ˜¯æ‰§è¡Œå‡ æ¬¡ä¹‹åè¢«æ›¿æ¢ä¸ºåŠ¨æ€å‚æ•°çš„è¯­å¥ï¼Œ</span>
<span style=color:#ae81ff>2.</span> <span style=color:#960050;background-color:#1e0010>é™æ€è¯­å¥çš„æ—¶å€™ã€‚</span>cluster qyeryå’Œremote queryçš„æ‰§è¡Œè®¡åˆ’éƒ½èƒ½æ­£ç¡®çš„é€‰æ‹©èŠ‚ç‚¹
<span style=color:#ae81ff>3.</span> <span style=color:#960050;background-color:#1e0010>ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„æ—¶å€™ï¼Œä½¿ç”¨é™æ€è¯­å¥å¯ä»¥ç”Ÿæˆ</span>remote queryçš„æ‰§è¡Œè®¡åˆ’<span style=color:#960050;background-color:#1e0010>ï¼Œä½†æ˜¯ä¹‹åä½¿ç”¨åŠ¨æ€è¯­å¥çš„æ—¶å€™ã€‚ç”Ÿæˆçš„æ˜¯</span>cluster queryçš„æ‰§è¡Œè®¡åˆ’
<span style=color:#ae81ff>4.</span> <span style=color:#ae81ff>20</span><span style=color:#960050;background-color:#1e0010>äº¿çš„è¡¨ï¼Œä¸€æ¡æŸ¥è¯¢ç»“æœä¸º</span><span style=color:#ae81ff>8</span>kwæ•°æ®çš„è¯­å¥<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>remote queryçš„æ‰§è¡Œæ—¶é—´ä¸º1min<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>clusteræ‰§è¡Œæ—¶é—´ä¸º7min<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>
<span style=color:#ae81ff>5.</span> <span style=color:#960050;background-color:#1e0010>ç®€å•è¯­å¥çš„ç¼–è¯‘æ—¶é—´å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®°ï¼Œå¹¶ä¸”åœ¨é›†ç¾¤ç¯å¢ƒä¸Šï¼Œæ˜¯å¦æœ‰å¿…è¦ä½¿ç”¨ç§¯ç´¯ä»£ä»·ç„¶åé‡æ–°è®¡ç®—æ‰§è¡Œè®¡åˆ’çš„æ–¹å¼ï¼Œä¸ªäººçœ‹æ¥ï¼Œé”™è¯¯çš„æ‰§è¡Œè®¡åˆ’å¯¼è‡´çš„æ—¶é—´æ¶ˆè€—æ›´å¤§</span>
<span style=color:#ae81ff>6.</span> clusterå’Œremoteçš„æ‰§è¡Œè®¡åˆ’è®¡åˆ’å·®ä¸å¤š<span style=color:#960050;background-color:#1e0010>ï¼ŒåŒºåˆ«ä¸»è¦åœ¨</span>remoteèŠ‚ç‚¹çš„æ•°æ®çš„è·å–æ–¹å¼<span style=color:#960050;background-color:#1e0010>ï¼Œ</span>clusteræœ‰æ›´å¤šçš„remote <span style=color:#960050;background-color:#1e0010>æ–¹æ³•ï¼Œ</span>(<span style=color:#960050;background-color:#1e0010>åæœŸè°ƒç ”</span>)
<span style=color:#ae81ff>7.</span> remote queryåº”è¯¥å¯ä»¥æœ‰æ›´ä¼˜çš„æ‰§è¡Œè®¡åˆ’<span style=color:#960050;background-color:#1e0010>ï¼Œå¦‚æœå¯ä»¥ç¡®åˆ‡çš„çŸ¥é“æ•°æ®åˆ†å¸ƒçš„è¯</span>

<span style=color:#ae81ff>1.</span> remote queryæ‰§è¡Œè®¡åˆ’çš„ç”Ÿæˆæ–¹å¼
  <span style=color:#960050;background-color:#1e0010>ä¸»è¦æœ‰ä¸¤ç§ï¼Œä¸€æ˜¯ä½¿ç”¨</span>pgxc_try_plannerå¿«é€Ÿåˆ¤æ–­ç®€å•è¯­å¥æ˜¯å¦å¯ä»¥ä½¿ç”¨remote query<span style=color:#960050;background-color:#1e0010>ï¼Œå¦‚æœè¿™é‡Œæ— æ³•åˆ¤æ–­ï¼Œåˆ™ä½¿ç”¨æ­£å¸¸çš„</span>standard_planneræµç¨‹<span style=color:#960050;background-color:#1e0010>ï¼Œç„¶ååˆ¤æ–­ä¸€äº›å…³é”®èŠ‚ç‚¹æ˜¯å¦å¯ä»¥ä½¿ç”¨</span>remote queryæ‰§è¡Œæˆ–è€…cluster remote
  <span style=color:#ae81ff>1.</span> pgxc_try_planner
    <span style=color:#ae81ff>1.</span> pgxc_handle_unsupported_stmtsé™åˆ¶ä¸æ”¯æŒçš„è¯­å¥
    <span style=color:#ae81ff>2.</span> pgxc_handle_exec_direct <span style=color:#960050;background-color:#1e0010>å¯¹äº</span>utilityStmt<span style=color:#960050;background-color:#1e0010>ï¼Œä¾‹å¦‚</span>execute direct<span style=color:#960050;background-color:#1e0010>ï¼Œåˆ™ç›´æ¥ç”Ÿæˆ</span>remote <span style=color:#960050;background-color:#1e0010>æ‰§è¡Œè®¡åˆ’</span>
    <span style=color:#ae81ff>3.</span> pgxc_FQS_planner <span style=color:#960050;background-color:#1e0010>å¤„ç†å¸¸è§„è¯­å¥ï¼Œä¸æ”¯æŒçš„ç›´æ¥</span><span style=color:#66d9ef>return</span> null
      <span style=color:#960050;background-color:#1e0010>ä¸»è¦æµç¨‹ä¸ºå…ˆæ ¹æ®è¯­å¥å¾—åˆ°å…·ä½“çš„æ‰§è¡ŒèŠ‚ç‚¹ï¼Œç„¶åç”±æ‰§è¡ŒèŠ‚ç‚¹çš„æƒ…å†µåˆ¤æ–­æ˜¯å¦ç”Ÿæˆ</span>remote queryçš„æ‰§è¡Œè®¡åˆ’
      <span style=color:#ae81ff>1.</span> pgxc_is_query_shippable  <span style=color:#960050;background-color:#1e0010>éå†è¯­æ³•æ ‘çš„èŠ‚ç‚¹æ”¶é›†èŠ‚ç‚¹ä¿¡æ¯ï¼Œåˆ¤æ–­å¯ä»¥ä½¿ç”¨</span>remote query<span style=color:#960050;background-color:#1e0010>ï¼ŒåŒæ—¶æ ¹æ®è¡¨åˆ†åŒºä¿¡æ¯ä»¥åŠæŸ¥è¯¢æ¡ä»¶è·å¾—</span>exec_node<span style=color:#960050;background-color:#1e0010>ï¼Œåœ¨æ­¤æ–¹æ³•å†…éƒ¨ï¼Œå·²ç»åˆ¤æ–­è¯­å¥æ˜¯å¦å¯ä»¥ç”Ÿæˆ</span>remote queryçš„æ‰§è¡Œè®¡åˆ’<span style=color:#960050;background-color:#1e0010>ï¼Œå¦‚æœæ— æ³•ç”Ÿæˆï¼Œåˆ™è¿”å›</span>null
      <span style=color:#ae81ff>2.</span> pgxc_FQS_create_remote_plan <span style=color:#960050;background-color:#1e0010>ç”Ÿæˆ</span>remote queryçš„æ‰§è¡Œè®¡åˆ’<span style=color:#960050;background-color:#1e0010>ï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„åœ¨</span>queryçš„ä¸Šå±‚æ„é€ ä¸€ä¸ªremote query<span style=color:#960050;background-color:#1e0010>ï¼Œç„¶åæŠŠåŸæ¥çš„</span>queryæŒ‚åœ¨ä¸‹é¢<span style=color:#960050;background-color:#1e0010>ï¼Œæ²¡æœ‰å¤ªå¤æ‚çš„æƒ…å†µï¼Œå› ä¸ºè¿™é‡Œå¤„ç†ç®€å•è¯­å¥ï¼Œå¯¹äºå¤æ‚çš„è¯­å¥ï¼Œä½¿ç”¨</span>standard_plannerå¤„ç†

      <span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>ä¸Šé¢çš„æ–¹æ³•å¤„ç†ç®€ç­”çš„è¯­å¥ï¼Œä¸”ç”±äºéœ€è¦ä½¿ç”¨åˆ†åŒºä¿¡æ¯å’Œæ‰§è¡Œæ¡ä»¶è·å¾—æ‰§è¡ŒèŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨åŠ¨æ€å‚æ•°ï¼ŒåŠ¨æ€å‚æ•°åªèƒ½å¾—åˆ°æ‰€æœ‰çš„æ‰§è¡ŒèŠ‚ç‚¹ï¼Œè€Œæ‰€æœ‰èŠ‚ç‚¹çš„æ—¶å€™åœ¨ç”±èšåˆå‡½æ•°ä½†æ˜¯æ²¡æœ‰è®¾ç½®</span>SS_NEED_SINGLENODEçš„æ—¶å€™æ˜¯å¯ä»¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’çš„<span style=color:#960050;background-color:#1e0010>ã€‚ã€‚ã€‚ã€‚ã€‚</span>
  <span style=color:#ae81ff>2.</span> standard_planner
    <span style=color:#960050;background-color:#1e0010>å‰é¢çš„åŸºäºè§„åˆ™çš„ä¼˜åŒ–å’Œæ™®é€šè¯­å¥ç±»ä¼¼ï¼Œå·®åˆ«åœ¨äºç”Ÿæˆ</span>pathçš„æ—¶å€™<span style=color:#960050;background-color:#1e0010>ï¼Œä¼šåŠ ä¸Š</span>remote queryçš„path<span style=color:#960050;background-color:#1e0010>ï¼Œç„¶ååŸºäºä»£ä»·ï¼Œé€‰æ‹©å…·ä½“çš„æ‰§è¡Œè®¡åˆ’</span>
    <span style=color:#960050;background-color:#1e0010>ä¸»è¦åˆ†ä¸ºä¸¤é˜¶æ®µï¼Œä¸€æ˜¯ç”Ÿæˆæ‰«æè·¯å¾„ï¼ŒäºŒæ˜¯ç”Ÿæˆé“¾æ¥è·¯å¾„</span>
    <span style=color:#ae81ff>1.</span> set_base_rel_sizes <span style=color:#960050;background-color:#1e0010>ä¼°è®¡è¡¨è¾¾å°ï¼Œå¹¶ä¸”è®¡ç®—ä»£ä»·</span>
    <span style=color:#ae81ff>2.</span> set_base_rel_pathlists <span style=color:#960050;background-color:#1e0010>ç”Ÿæˆ</span>scan <span style=color:#960050;background-color:#1e0010>è·¯å¾„</span>
    <span style=color:#ae81ff>3.</span> make_rel_from_joinlist <span style=color:#960050;background-color:#1e0010>ç”Ÿæˆé“¾æ¥è·¯å¾„</span>




prepare s2(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) as
SELECT c_discount, c_last, c_credit, w_tax FROM bmsql_customer JOIN bmsql_warehouse 
ON (w_id <span style=color:#f92672>=</span> c_w_id) WHERE c_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> AND c_d_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> AND c_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>;
explain verbose execute <span style=color:#a6e22e>s2</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>);

execute direct <span style=color:#a6e22e>on</span> (dn1) <span style=color:#960050;background-color:#1e0010>&#39;</span>SELECT c_discount, c_last, c_credit, w_tax FROM bmsql_customer JOIN bmsql_warehouse ON (w_id <span style=color:#f92672>=</span> c_w_id) WHERE c_w_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> AND c_d_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>2</span> AND c_id <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>&#39;</span>;

Query [commandType<span style=color:#f92672>=</span>CMD_SELECT querySource<span style=color:#f92672>=</span>QSRC_ORIGINAL queryId<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> canSetTag<span style=color:#f92672>=</span>True resultRelation<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>]
        [rtable]
                RangeTblEntry (rtekind<span style=color:#f92672>=</span>RTE_RELATION relid<span style=color:#f92672>=</span><span style=color:#ae81ff>16401</span> relkind<span style=color:#f92672>=</span>r inh<span style=color:#f92672>=</span>True)
                RangeTblEntry (rtekind<span style=color:#f92672>=</span>RTE_RELATION relid<span style=color:#f92672>=</span><span style=color:#ae81ff>16395</span> relkind<span style=color:#f92672>=</span>r inh<span style=color:#f92672>=</span>True)
                RangeTblEntry (rtekind<span style=color:#f92672>=</span>RTE_JOIN relid<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> relkind<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>\</span><span style=color:#ae81ff>000</span>)
        [jointree] FromExpr
                [fromlist]
                        JoinExpr [jointype<span style=color:#f92672>=</span>JOIN_INNER isNatural<span style=color:#f92672>=</span>False]
                                [larg] RangeTblRef (rtindex<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                                [rarg] RangeTblRef (rtindex<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
                                [quals] OpExpr [opno<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> opfuncid<span style=color:#f92672>=</span><span style=color:#ae81ff>65</span> opresulttype<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>]
                                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>113</span>]
                                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>120</span>]
                [quals] BoolExpr [op<span style=color:#f92672>=</span>AND_EXPR]
                        OpExpr [opno<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> opfuncid<span style=color:#f92672>=</span><span style=color:#ae81ff>65</span> opresulttype<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>]
                                Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>134</span>]
                                Param (paramkind<span style=color:#f92672>=</span>PARAM_EXTERN paramid<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> paramtype<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span> paramtypmod<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>143</span>)
                        OpExpr [opno<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> opfuncid<span style=color:#f92672>=</span><span style=color:#ae81ff>65</span> opresulttype<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>]
                                Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>150</span>]
                                Param (paramkind<span style=color:#f92672>=</span>PARAM_EXTERN paramid<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> paramtype<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span> paramtypmod<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>159</span>)
                        OpExpr [opno<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> opfuncid<span style=color:#f92672>=</span><span style=color:#ae81ff>65</span> opresulttype<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>]
                                Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>166</span>]
                                Param (paramkind<span style=color:#f92672>=</span>PARAM_EXTERN paramid<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> paramtype<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span> paramtypmod<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>173</span>)
        [targetList]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;c_discount&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16401</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>31</span>]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;c_last&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16401</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>6</span> varcollid<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>43</span>]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;c_credit&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16401</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>5</span> varcollid<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>51</span>]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;w_tax&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16395</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>61</span>]


prepare s6(<span style=color:#66d9ef>int</span>) as
SELECT i_price, i_name, i_data FROM bmsql_item WHERE i_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>;	
explain verbose execute <span style=color:#a6e22e>s6</span>(<span style=color:#ae81ff>1</span>);

Query [commandType<span style=color:#f92672>=</span>CMD_SELECT querySource<span style=color:#f92672>=</span>QSRC_ORIGINAL queryId<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> canSetTag<span style=color:#f92672>=</span>True resultRelation<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>]
        [rtable]
                RangeTblEntry (rtekind<span style=color:#f92672>=</span>RTE_RELATION relid<span style=color:#f92672>=</span><span style=color:#ae81ff>16421</span> relkind<span style=color:#f92672>=</span>r inh<span style=color:#f92672>=</span>True)
        [jointree] FromExpr
                [fromlist]
                        RangeTblRef (rtindex<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>)
                [quals] OpExpr [opno<span style=color:#f92672>=</span><span style=color:#ae81ff>96</span> opfuncid<span style=color:#f92672>=</span><span style=color:#ae81ff>65</span> opresulttype<span style=color:#f92672>=</span><span style=color:#ae81ff>16</span>]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>72</span>]
                        Param (paramkind<span style=color:#f92672>=</span>PARAM_EXTERN paramid<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> paramtype<span style=color:#f92672>=</span><span style=color:#ae81ff>23</span> paramtypmod<span style=color:#f92672>=-</span><span style=color:#ae81ff>1</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>79</span>)
        [targetList]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;i_price&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16421</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>26</span>]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;i_name&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16421</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span> varcollid<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>35</span>]
                TargetEntry [resno<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> resname<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;i_data&#34;</span> ressortgroupref<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> origtbl<span style=color:#f92672>=</span><span style=color:#ae81ff>16421</span> origcol<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> junk<span style=color:#f92672>=</span>False]
                        Var [varno<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> varattno<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> varcollid<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span> levelsup<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> location<span style=color:#f92672>=</span><span style=color:#ae81ff>43</span>]



pgxc_FQS_find_datanodes_recurse
  <span style=color:#66d9ef>case</span> T_FromExpr: {

    FromExpr	<span style=color:#f92672>*</span>from_expr <span style=color:#f92672>=</span> (FromExpr <span style=color:#f92672>*</span>)node;
    Node <span style=color:#f92672>*</span> quals <span style=color:#f92672>=</span> from_expr<span style=color:#f92672>-&gt;</span>quals
    List <span style=color:#f92672>*</span> expr <span style=color:#f92672>=</span> from_expr<span style=color:#f92672>-&gt;</span>fromlist;
  }

prepare <span style=color:#a6e22e>s4</span>(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) as
SELECT c_discount, c_last, c_credit, w_tax FROM bmsql_customer JOIN bmsql_warehouse 
where (w_id <span style=color:#f92672>=</span> c_w_id)  c_w_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> AND c_d_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> AND c_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>;
explain verbose execute <span style=color:#a6e22e>s5</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>);

prepare <span style=color:#a6e22e>s17</span>(<span style=color:#66d9ef>int</span>, <span style=color:#66d9ef>int</span>) as
SELECT c_discount, c_last, c_credit, w_tax FROM bmsql_customer JOIN bmsql_warehouse 
ON (w_id <span style=color:#f92672>&gt;</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>) WHERE c_w_id <span style=color:#f92672>=</span> w_id AND c_d_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span> AND c_id <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>3</span>;
explain verbose execute <span style=color:#a6e22e>s17</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>1</span>);

pgxc_FQS_find_datanodes_recurse_join() {
  JoinExpr <span style=color:#f92672>*</span>join_expr <span style=color:#f92672>=</span> ((JoinExpr <span style=color:#f92672>*</span>)fromlist_entry);
  Node <span style=color:#f92672>*</span> quals <span style=color:#f92672>=</span> from_expr<span style=color:#f92672>-&gt;</span>quals;
  Node <span style=color:#f92672>*</span> jquals <span style=color:#f92672>=</span> ((JoinExpr <span style=color:#f92672>*</span>)fromlist_entry)<span style=color:#f92672>-&gt;</span>quals;

  <span style=color:#75715e>// 1. è¡¨è¾¾å¼å±•å¼€
</span><span style=color:#75715e></span>  <span style=color:#75715e>//    join and 
</span><span style=color:#75715e></span>
  List <span style=color:#f92672>*</span>lquals;
  List <span style=color:#f92672>*</span>jjquals;

  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>IsA(quals, List))
		lquals <span style=color:#f92672>=</span> make_ands_implicit((Expr <span style=color:#f92672>*</span>)quals);
	<span style=color:#66d9ef>else</span>
		lquals <span style=color:#f92672>=</span> (List <span style=color:#f92672>*</span>)quals;

  <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>IsA(jquals, List))
		jjquals <span style=color:#f92672>=</span> make_ands_implicit((Expr <span style=color:#f92672>*</span>)jquals);
	<span style=color:#66d9ef>else</span>
		jjquals <span style=color:#f92672>=</span> (List <span style=color:#f92672>*</span>)jquals;


  pgxc_find_distcol_expr() <span style=color:#75715e>// æ‰©å±• ï¼Œæ‹¿åˆ°è¡¨è¾¾å¼ (a = 2+3) å¾—åˆ°(2+3)
</span><span style=color:#75715e></span>
  <span style=color:#66d9ef>int</span> cc <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  <span style=color:#66d9ef>for</span> (jj : jjquals) {
    <span style=color:#66d9ef>if</span> (jj<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>!=</span> var <span style=color:#f92672>&amp;&amp;</span> jj<span style=color:#f92672>-&gt;</span>right <span style=color:#f92672>!=</span> var)
      cc <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
    <span style=color:#66d9ef>for</span> (qual : lquals) {
      <span style=color:#66d9ef>if</span> (jj<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>==</span> var <span style=color:#f92672>&amp;&amp;</span> jj<span style=color:#f92672>-&gt;</span>right <span style=color:#f92672>==</span> var) {
        <span style=color:#66d9ef>if</span> (qual<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>==</span> var <span style=color:#f92672>&amp;&amp;</span> qual<span style=color:#f92672>-&gt;</span>right <span style=color:#f92672>==</span> var) 
          <span style=color:#66d9ef>continue</span>;
        <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>if</span> (qual<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>==</span> var <span style=color:#f92672>||</span> qual<span style=color:#f92672>-&gt;</span>right <span style=color:#f92672>==</span> var) {
          <span style=color:#66d9ef>if</span> (jj<span style=color:#f92672>-&gt;</span>left <span style=color:#f92672>==</span> qual<span style=color:#f92672>-&gt;</span>left) {

          }
        }

      }

      
    }
    cc <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
  }


}




</code></pre></div><p>create table bmsql_new_order_bak1 (no_w_id int, no_d_id int, no_o_id int) DISTRIBUTE BY HASH(no_w_id) TO NODE(dn1, dn2) ;</p>
<p>insert into bmsql_new_order_bak1 select * from bmsql_new_order;</p>
<p>prepare s3(int, int) as select no_o_id from bmsql_new_order where no_w_id = $1 and no_d_id = $2 order by no_o_id asc;
explain verbose execute s3(1, 1);</p>
<h2 id=query-plan>
benchmarksql=# explain verbose select no_o_id from bmsql_new_order where no_w_id = 1 and no_d_id = 1 order by no_o_id asc;
QUERY PLAN
<a href=#query-plan class=h-anchor aria-hidden=true>#</a>
</h2>
<p>Data Node Scan on &ldquo;<strong>REMOTE_FQS_QUERY</strong>&rdquo; (cost=0.00..0.00 rows=0 width=0)
Output: bmsql_new_order.no_o_id
Primary node/s: dn1
Node/s: dn1
Remote query: SELECT no_o_id FROM public.bmsql_new_order bmsql_new_order WHERE ((no_w_id = 1) AND (no_d_id = 1)) ORDER BY no_o_id
(5 rows)</p>
<p>SS_NEED_SINGLENODE</p>
<p>enable_pushdown_art // å¼€å…³æ²¡å¼€
pgxc_is_all_replicated_table</p>
<ul>
<li>pgxc_query_needs_coord
å¦‚æœæŸ¥è¯¢åªæœ‰å…ƒæ•°æ®ä¿¡æ¯</li>
</ul>
<p>#0 0x00007fb722fdad47 in __GI___poll (fds=0x7ffca50462a0, nfds=1, timeout=-1) at ../sysdeps/unix/sysv/linux/poll.c:29
#1 0x000056051841fcc1 in PQNOneExecFinish (conn=0x560519c7cd10, hook=0x7ffca50462e0, blocking=true) at /home/wen/postgres/xx/../AntDB/src/backend/libpq/libpq-node.c:424
#2 0x00005605188f4bf7 in HandleFetchRemote (handle=0x560519ca83a8, node=0x560519d73a08, destslot=0x560519d74028, blocking=true, batch=false)
at /home/wen/postgres/xx/../AntDB/src/backend/intercomm/inter-query.c:573
#3 0x00005605188f4429 in InterXactQuery (state=0x560518c48700 <topinterxactstatedata>, node=0x560519d73a08, destslot=0x560519d74028)
at /home/wen/postgres/xx/../AntDB/src/backend/intercomm/inter-query.c:370
#4 0x00005605188f41b2 in StartRemoteQuery (node=0x560519d73a08, destslot=0x560519d74028) at /home/wen/postgres/xx/../AntDB/src/backend/intercomm/inter-query.c:312
#5 0x00005605188e962b in RemoteQueryNext (scan_node=0x560519d73a08) at /home/wen/postgres/xx/../AntDB/src/backend/pgxc/pool/execRemote.c:298
#6 0x0000560518395a41 in ExecScanFetch (node=0x560519d73a08, accessMtd=0x5605188e95a5 <remotequerynext>, recheckMtd=0x5605188e958e <remotequeryrecheck>)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execScan.c:133
#7 0x0000560518395aba in ExecScan (node=0x560519d73a08, accessMtd=0x5605188e95a5 <remotequerynext>, recheckMtd=0x5605188e958e <remotequeryrecheck>)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execScan.c:182
#8 0x00005605188e958c in ExecRemoteQuery (ps=0x560519d73a08) at /home/wen/postgres/xx/../AntDB/src/backend/pgxc/pool/execRemote.c:250
#9 0x0000560518391bc3 in ExecProcNodeFirst (node=0x560519d73a08) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execProcnode.c:511
#10 0x0000560518385f68 in ExecProcNode (node=0x560519d73a08) at /home/wen/postgres/xx/../AntDB/src/include/executor/executor.h:269
#11 0x0000560518388ac1 in ExecutePlan (estate=0x560519d737d8, planstate=0x560519d73a08, use_parallel_mode=false, operation=CMD_SELECT, sendTuples=true, numberTuples=0,
direction=ForwardScanDirection, dest=0x560519cd71c0, execute_once=true) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:1699
#12 0x00005605183865ae in standard_ExecutorRun (queryDesc=0x560519cf3928, direction=ForwardScanDirection, count=0, execute_once=true)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:368
#13 0x0000560518386415 in ExecutorRun (queryDesc=0x560519cf3928, direction=ForwardScanDirection, count=0, execute_once=true)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:312
#14 0x00005605186b5bf1 in PortalRunSelect (portal=0x560519c35968, forward=true, count=0, dest=0x560519cd71c0) at /home/wen/postgres/xx/../AntDB/src/backend/tcop/pquery.c:1034</p>
<p>#0 ExecProcNode (node=0x55cd1e4dbe40) at /home/wen/postgres/xx/../AntDB/src/include/executor/executor.h:261
#1 0x000055cd1d039ac1 in ExecutePlan (estate=0x55cd1e4dbc18, planstate=0x55cd1e4dbe40, use_parallel_mode=false, operation=CMD_SELECT, sendTuples=true, numberTuples=0,
direction=ForwardScanDirection, dest=0x55cd1e560d48, execute_once=true) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:1699
#2 0x000055cd1d0375ae in standard_ExecutorRun (queryDesc=0x55cd1e5621f8, direction=ForwardScanDirection, count=0, execute_once=true)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:368
#3 0x000055cd1d037415 in ExecutorRun (queryDesc=0x55cd1e5621f8, direction=ForwardScanDirection, count=0, execute_once=true) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:312
#4 0x000055cd1d09be3f in ExecClusterPlanStmt (buf=0x7ffe9df51920, info=0x55cd1e560d28) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execCluster.c:329
#5 0x000055cd1d09bbb1 in exec_cluster_plan (splan=0x55cd1e4b6f88, length=1784) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execCluster.c:254
#6 0x000055cd1d364b4e in PostgresMain (argc=1, argv=0x55cd1e4e1998, dbname=0x55cd1e4e17e8 &ldquo;benchmarksql&rdquo;, username=0x55cd1e4b3628 &ldquo;wen&rdquo;)
at /home/wen/postgres/xx/../AntDB/src/backend/tcop/postgres.c:5554
#7 0x000055cd1d29eab9 in BackendRun (port=0x55cd1e4db120) at /home/wen/postgres/xx/../AntDB/src/backend/postmaster/postmaster.c:5199
#8 0x000055cd1d29e141 in BackendStartup (port=0x55cd1e4db120) at /home/wen/postgres/xx/../AntDB/src/backend/postmaster/postmaster.c:4864
#9 0x000055cd1d299bd1 in ServerLoop () at /home/wen/postgres/xx/../AntDB/src/backend/postmaster/postmaster.c:1933
#10 0x000055cd1d299338 in PostmasterMain (argc=5, argv=0x55cd1e4b1580) at /home/wen/postgres/xx/../AntDB/src/backend/postmaster/postmaster.c:1603
#11 0x000055cd1d0d4ccb in main (argc=5, argv=0x55cd1e4b1580) at /home/wen/postgres/xx/../AntDB/src/backend/main/main.c:217</p>
<p>#0 0x00007fb722fdad47 in __GI___poll (fds=0x7ffca5046580, nfds=1, timeout=-1) at ../sysdeps/unix/sysv/linux/poll.c:29
#1 0x000056051841fcc1 in PQNOneExecFinish (conn=0x560519cacc70, hook=0x560519cf96b8, blocking=true) at /home/wen/postgres/xx/../AntDB/src/backend/libpq/libpq-node.c:424
#2 0x00005605183f0a73 in cmg_get_remote_slot (conn=0x560519cacc70, slot=0x560519d17818, ps=0x560519cf95b0) at /home/wen/postgres/xx/../AntDB/src/backend/executor/nodeClusterMergeGather.c:291
#3 0x00005605183f03f1 in ExecClusterMergeGather (pstate=0x560519cf95b0) at /home/wen/postgres/xx/../AntDB/src/backend/executor/nodeClusterMergeGather.c:148
#4 0x0000560518391bc3 in ExecProcNodeFirst (node=0x560519cf95b0) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execProcnode.c:511
#5 0x0000560518385f68 in ExecProcNode (node=0x560519cf95b0) at /home/wen/postgres/xx/../AntDB/src/include/executor/executor.h:269
#6 0x0000560518388ac1 in ExecutePlan (estate=0x560519cf9388, planstate=0x560519cf95b0, use_parallel_mode=false, operation=CMD_SELECT, sendTuples=true, numberTuples=0,
direction=ForwardScanDirection, dest=0x560519cd71c0, execute_once=true) at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:1699
#7 0x00005605183865ae in standard_ExecutorRun (queryDesc=0x560519cf3928, direction=ForwardScanDirection, count=0, execute_once=true)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:368
#8 0x0000560518386415 in ExecutorRun (queryDesc=0x560519cf3928, direction=ForwardScanDirection, count=0, execute_once=true)
at /home/wen/postgres/xx/../AntDB/src/backend/executor/execMain.c:312
#9 0x00005605186b5bf1 in PortalRunSelect (portal=0x560519c35968, forward=true, count=0, dest=0x560519cd71c0) at /home/wen/postgres/xx/../AntDB/src/backend/tcop/pquery.c:1034
#10 0x00005605186b5784 in PortalRun (portal=0x560519c35968, count=9223372036854775807, isTopLevel=false, run_once=true, dest=0x560519cd71c0, altdest=0x560519cd71c0, qc=0x7ffca5046c60)
at /home/wen/postgres/xx/../AntDB/src/backend/tcop/pquery.c:842
#11 0x00005605183033b1 in ExecuteQuery (pstate=0x560519cd7280, stmt=0x560519bb8608, intoClause=0x0, params=0x0, dest=0x560519cd71c0, qc=0x7ffca5046c60, cluster_safe=true)
at /home/wen/postgres/xx/../AntDB/src/backend/commands/prepare.c:316
#12 0x00005605186b7fe7 in standard_ProcessUtility (pstmt=0x560519bb86b8, queryString=0x560519bb7b78 &ldquo;execute s3(1, 1);&rdquo;, context=PROCESS_UTILITY_TOPLEVEL, params=0x0, queryEnv=0x0,
dest=0x560519cd71c0, sentToRemote=false, qc=0x7ffca5046c60) at /home/wen/postgres/xx/../AntDB/src/backend/tcop/utility.c:941
#13 0x00005605186b757a in ProcessUtility (pstmt=0x560519bb86b8, queryString=0x560519bb7b78 &ldquo;execute s3(1, 1);&rdquo;, context=PROCESS_UTILITY_TOPLEVEL, params=0x0, queryEnv=0x0,
dest=0x560519cd71c0, sentToRemote=false, qc=0x7ffca5046c60) at /home/wen/postgres/xx/../AntDB/src/backend/tcop/utility.c:614</p>
<p>cluter he remote query de qube</p>
<p>åˆ†åŒºé”®</p>
<h1 id=antdb>
antdb
<a href=#antdb class=h-anchor aria-hidden=true>#</a>
</h1>
<hr>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>#0  create_remotesort_plan (root=0x25a8cd8, local_plan=0x25cc1d8) at pgxcplan.c:2934
</span><span style=color:#75715e>#1  0x00000000006e5abc in grouping_planner (root=0x25a88c8, tuple_fraction=0) at planner.c:1816
</span><span style=color:#75715e>#2  0x00000000006e3ccd in subquery_planner (glob=0x25a8838, parse=0x25a6b40, parent_root=0x0, hasRecursion=0 &#39;\000&#39;, tuple_fraction=0, subroot=0x7ffca4225500) at planner.c:596
</span><span style=color:#75715e>#3  0x00000000006e3345 in standard_planner (parse=0x25a6b40, cursorOptions=0, boundParams=0x25a6a50) at planner.c:225
</span><span style=color:#75715e>#4  0x00000000006f3a99 in pgxc_planner (query=0x25a6b40, cursorOptions=0, boundParams=0x25a6a50) at pgxcplan.c:2419
</span><span style=color:#75715e>#5  0x00000000006e318d in planner (parse=0x25a6b40, cursorOptions=0, boundParams=0x25a6a50) at planner.c:151
</span><span style=color:#75715e>#6  0x0000000000783038 in pg_plan_query (querytree=0x25a6b40, cursorOptions=0, boundParams=0x25a6a50) at postgres.c:830
</span><span style=color:#75715e>#7  0x00000000007830eb in pg_plan_queries (querytrees=0x2472078, cursorOptions=0, boundParams=0x25a6a50) at postgres.c:889
</span><span style=color:#75715e>#8  0x000000000089658a in BuildCachedPlan (plansource=0x24710c0, qlist=0x2472078, boundParams=0x25a6a50) at plancache.c:942
</span><span style=color:#75715e>#9  0x0000000000896ae1 in GetCachedPlan (plansource=0x24710c0, boundParams=0x25a6a50, useResOwner=0 &#39;\000&#39;) at plancache.c:1236
</span><span style=color:#75715e>#10 0x00000000005d6785 in ExecuteQuery (stmt=0x2539c90, intoClause=0x0, queryString=0x25391e0 &#34;execute s3(1, 1);&#34;, params=0x0, dest=0x2471e08, completionTag=0x7ffca4225ae0 &#34;&#34;)
</span><span style=color:#75715e></span>    at prepare.c:<span style=color:#ae81ff>251</span>
<span style=color:#75715e>#11 0x000000000078bd7f in standard_ProcessUtility (parsetree=0x2539c90, queryString=0x25391e0 &#34;execute s3(1, 1);&#34;, context=PROCESS_UTILITY_TOPLEVEL, params=0x0, dest=0x2471e08, 
</span><span style=color:#75715e></span>    sentToRemote<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#39;\000&#39;</span>, completionTag<span style=color:#f92672>=</span><span style=color:#ae81ff>0x7ffca4225ae0</span> <span style=color:#e6db74>&#34;&#34;</span>) at utility.c:<span style=color:#ae81ff>751</span>
<span style=color:#75715e>#12 0x000000000078b3da in ProcessUtility (parsetree=0x2539c90, queryString=0x25391e0 &#34;execute s3(1, 1);&#34;, context=PROCESS_UTILITY_TOPLEVEL, params=0x0, dest=0x2471e08, sentToRemote=0 &#39;\000&#39;, 
</span><span style=color:#75715e></span>    completionTag<span style=color:#f92672>=</span><span style=color:#ae81ff>0x7ffca4225ae0</span> <span style=color:#e6db74>&#34;&#34;</span>) at utility.c:<span style=color:#ae81ff>404</span>
<span style=color:#75715e>#13 0x000000000078a314 in PortalRunUtility (portal=0x25a2990, utilityStmt=0x2539c90, isTopLevel=1 &#39;\001&#39;, dest=0x2471e08, completionTag=0x7ffca4225ae0 &#34;&#34;) at pquery.c:1285
</span><span style=color:#75715e>#14 0x000000000078a06b in FillPortalStore (portal=0x25a2990, isTopLevel=1 &#39;\001&#39;) at pquery.c:1155
</span><span style=color:#75715e>#15 0x000000000078994b in PortalRun (portal=0x25a2990, count=9223372036854775807, isTopLevel=1 &#39;\001&#39;, dest=0x253a000, altdest=0x253a000, completionTag=0x7ffca4225cd0 &#34;&#34;) at pquery.c:851
</span><span style=color:#75715e>#16 0x0000000000783534 in exec_simple_query (query_string=0x25391e0 &#34;execute s3(1, 1);&#34;) at postgres.c:1140
</span><span style=color:#75715e>#17 0x00000000007878dc in PostgresMain (argc=1, argv=0x2458370, dbname=0x2458220 &#34;benchmarksql&#34;, username=0x2458200 &#34;postgres&#34;) at postgres.c:4251
</span><span style=color:#75715e>#18 0x0000000000727802 in BackendRun (port=0x24780b0) at postmaster.c:4205
</span><span style=color:#75715e></span>
</code></pre></div><p>benchmarksql=# prepare s2(int, int, int, int) as select count(*) as low_stock from (select s_w_id, s_i_id, s_quantity from bmsql_stock where s_w_id = $1 and s_quantity &lt; $2 and s_i_id in (select ol_i_id from bmsql_district join bmsql_order_line on ol_w_id = d_w_id and ol_d_id = d_id and ol_o_id >= d_next_o_id - 20 and ol_o_id &lt; d_next_o_id where d_w_id = $3 and d_id = $4)) as l;
PREPARE</p>
<p>benchmarksql=# explain verbose execute s2(1, 1, 1, 1);
QUERY PLAN</p>
<hr>
<hr>
<hr>
<p>Aggregate (cost=0.02..0.03 rows=1 width=0)
Output: count(*)
-> Nested Loop Semi Join (cost=0.00..0.01 rows=1 width=0)
Join Filter: (bmsql_stock.s_i_id = bmsql_order_line.ol_i_id)
-> Data Node Scan on bmsql_stock &ldquo;<em>REMOTE_TABLE_QUERY</em>&rdquo; (cost=0.00..0.00 rows=1000 width=4)
Output: bmsql_stock.s_i_id
Node/s: data_1
Remote query: SELECT s_i_id FROM ONLY public.bmsql_stock WHERE ((s_quantity &lt; 1) AND (s_w_id = 1))
-> Data Node Scan on &ldquo;<em>REMOTE_TABLE_QUERY</em>&rdquo; (cost=0.00..0.00 rows=1000 width=4)
Output: bmsql_order_line.ol_i_id
Node/s: data_1
Remote query: SELECT r.a_4 FROM ((SELECT bmsql_district.d_w_id, bmsql_district.d_id, bmsql_district.d_next_o_id FROM ONLY public.bmsql_district WHERE ((bmsql_district.d_id = 1) AND (bmsql_district.d_w_id = 1))) l(a_1, a_2, a_3) JO
IN (SELECT bmsql_order_line.ol_w_id, bmsql_order_line.ol_d_id, bmsql_order_line.ol_o_id, bmsql_order_line.ol_i_id FROM ONLY public.bmsql_order_line WHERE ((bmsql_order_line.ol_d_id = 1) AND (bmsql_order_line.ol_w_id = 1))) r(a_1, a_2, a_3, a_4)
ON (true)) WHERE ((r.a_3 >= (l.a_3 - 20)) AND (r.a_3 &lt; l.a_3))
(12 rows)</p>
<p>create function mlparted5abrtrig_func1() returns trigger as $$ begin new.b = 100; return new; end; $$ language plpgsql;</p>
<p>create trigger mlparted5abrtrig before insert on mlparted5 for each row execute procedure mlparted5abrtrig_func1();</p>
<p>CREATE FUNCTION trigger_func() RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
RAISE NOTICE &lsquo;trigger_func(%) called: action = %, when = %, level = %&rsquo;,
TG_ARGV[0], TG_OP, TG_WHEN, TG_LEVEL;
RETURN NULL;
END;$$;
create trigger test_trigger before insert on t1 for each row execute procedure trigger_func();
explain insert into t1 values(1,1,1);</p>
<p>prepare s25(int) as select * from (select * from t1 where c1 = $1) a;
prepare s26(int) as select * from (select max(c2) from t1 where c1 = $1) a;
explain verbose execute s26(2);</p>
<p>create rule test_rule as on insert to t1 where new.c1 = 10 do instead nothing;
explain verbose insert into t1 values(10,10,10);</p>
<p>prepare s22(int) as insert into t1 values($1,1,1);
explain execute s22(2);</p>
<p>with t as
(
select * from t1 where c1 = 2
)
select * from t order by 3,2,1;</p>
<p>create view vt1(a,b,c,d) as select c1, c1+2, c2, c2+4 from t1;</p>
<p>create table t4(a int default 10, b int, c int);
create table t5(a int default 10);
INSERT INTO t5 DEFAULT VALUES;</p>
<p>create table test_default_req (
no_w_id integer,
no_d_id integer not null
) distribute by replication;
insert into test_default_req(no_w_id, no_d_id) values (3,1);
create sequence test_id_seq;
prepare s6(int) as update test_default_req set no_d_id = nextval(&lsquo;test_id_seq&rsquo;) where no_w_id = $1 ;
explain verbose execute s6(3);</p>
<p>create table test_insert_dist (
no_w_id integer ,
no_d_id integer not null
) distribute by hash(no_w_id);
explain verbose insert into test_insert_dist (no_w_id, no_d_id) values (3,currval(&lsquo;test_id_seq&rsquo;));</p>
<p>create table t1 (c1 int, c2 int, c3 int);
explain select distinct c2 from t1 where c1 = 10;
explain select max(c2) from t1 where c1 = 10 group by c3;</p>
<p>cn sname
dn sname</p>
<p>1 å¤šè¡¨deparseå‡ºåŒæ ·çš„ä¸€æ¡è¯­å¥
2 cnæ‰§è¡Œè®¡åˆ’å˜åŒ–
3 cnè®¡åˆ’
4 dnå¤ç”¨è¿›ç¨‹ï¼Œstmtæ¸…ç†ï¼Ÿ</p>
<p>ä½¿ç”¨è¯­å¥çš„hashä½œä¸ºstmtçš„nameï¼Œæ‰€ä»¥dnä¸Šprepareçš„è¯­å¥ä¸éœ€è¦æ¸…ç†ï¼Œä¸‹æ¬¡å…¶ä»–è¿›ç¨‹é“¾æ¥ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨
ï¼Ÿcnä¿å­˜prepareçš„è¯­å¥ï¼Œæ€ä¹ˆ</p>
<p>remote</p>
<ol>
<li>ç›´æ¥æ‰§è¡Œè¯­å¥èµ°Qåè®®ï¼ŒDNå›å¤Hä¹‹åå»ºç«‹é“¾æ¥ï¼Œç„¶åDNä½¿ç”¨Då‘é€æ•°æ®</li>
<li>prepareæ²¡æœ‰å‚æ•°çš„è¯­å¥CNå‘é€æ˜¯Qï¼Œå’ŒQçš„æµç¨‹æ˜¯ä¸€æ ·çš„</li>
<li>prepareå¸¦å‚æ•°è¯­å¥èµ°çš„æ˜¯pï¼Œå‚æ•°å’Œè¯­å¥æ‰“åŒ…åœ¨ä¸€èµ·ï¼ŒDNæ¥åˆ°pä¹‹åç›´æ¥æ‰§è¡Œç„¶åè¿”å›D</li>
<li>åœ¨æŸ¥è¯¢å¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œremoteä¸ä¼šç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹å‡†å¤‡å¥½ã€‚åªè¦æ”¶åˆ°Hä¹‹åï¼Œå°±ç›´æ¥æ¥å—æ•°æ®ç„¶åå‘é€äº†</li>
<li>æ•°æ®å¤šçš„æ—¶å€™ï¼Œä»–ä¼šæŠŠslotä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œæ‰€ä»¥ç®€å•çš„selectä¼šæ¯”ä¸ä¸Šcluster</li>
<li>å¦‚æœcnçš„ä¸€æ¡è¯­å¥åœ¨deparseä¹‹åï¼Œåœ¨ä¸€ä¸ªDNä¸Šæœ‰å¤šæ¡è¯­å¥ï¼Œåˆ™æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¹‹å‰çš„è¯­å¥çš„æ•°æ®æ²¡æœ‰å–å®Œï¼Œä¹‹åçš„è¯­å¥ä¸ä¼šè¿è¡Œï¼Œæ‰€ä»¥slotä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶å¯ä»¥ç†è§£</li>
</ol>
<p>cluster</p>
<ol>
<li>æ— è®ºæ˜¯ç›´æ¥æ‰§è¡Œï¼Œè¿˜æ˜¯prepareå¸¦å‚è¿˜æ˜¯æ— å‚ï¼Œéƒ½èµ°påè®®</li>
<li>ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹è¿”å›Wä¹‹åï¼Œæ‰æ¥æ”¶æ•°æ®</li>
<li>æœ€åDNä¼šå‘é€cåˆ°DNï¼ŒDNä¹Ÿä¼šå›å¤c</li>
</ol>
<p>socket::recv
spcket::send</p>
<pre><code>if (!node-&gt;query_Done)
{
	/* Fire BEFORE STATEMENT triggers just before the query execution */
	pgxc_rq_fire_bstriggers(node);
	scanslot = StartRemoteQuery(node, scanslot);
	node-&gt;query_Done = true;
}
</code></pre>
<p>vscode âœ /workspaces/antdb (ADB6_2_STABLE_HZ_TEST_FORMAL âœ—) $ strace -cp 23768
strace: Process 23768 attached
^Cstrace: Process 23768 detached
% time seconds usecs/call calls errors syscall</p>
<hr>
<p>39.43 0.025764 24 1048 1 recvfrom
22.15 0.014474 19 747 pwrite64
20.20 0.013199 13 946 pread64
16.98 0.011093 20 542 poll
0.42 0.000273 45 6 brk
0.25 0.000166 166 1 unlink
0.25 0.000161 32 5 sendto
0.15 0.000097 97 1 epoll_wait
0.14 0.000092 23 4 rt_sigprocmask
0.02 0.000014 14 1 close
0.02 0.000014 14 1 newfstatat
0.00 0.000000 0 1 openat</p>
<hr>
<p>100.00 0.065347 19 3303 1 total</p>
<p>remote query ä¼šæŠŠæ•°æ®å­˜ä¸‹æ¥ï¼Œæ‰€ä»¥æœ‰é¢å¤–çš„èŠ±è´¹
è¯»å†™æ–‡ä»¶
cluster æ²¡æœ‰</p>
<p>#0 FileWrite (file=16, buffer=0x561e2541d6d0 &ldquo;\032&rdquo;, amount=8192, offset=0, wait_event_info=167772161)
at /workspaces/antdb/src/backend/storage/file/fd.c:2066
#1 0x0000561e23cbe379 in BufFileDumpBuffer (file=0x561e2541d688)
at /workspaces/antdb/src/backend/storage/file/buffile.c:494
#2 0x0000561e23cbe607 in BufFileWrite (file=0x561e2541d688, ptr=0x7ffd01b8e79e, size=2)
at /workspaces/antdb/src/backend/storage/file/buffile.c:595
#3 0x0000561e23efdb73 in write_remotetup_heap (state=0x561e2545fa78, tup=0x561e25405328)
at /workspaces/antdb/src/backend/utils/sort/tuplestore.c:1663
#4 0x0000561e23efce3c in dumptuples (state=0x561e2545fa78)
at /workspaces/antdb/src/backend/utils/sort/tuplestore.c:1223
#5 0x0000561e23efc37a in tuplestore_puttuple_common (state=0x561e2545fa78, tuple=0x561e258f8b68)
at /workspaces/antdb/src/backend/utils/sort/tuplestore.c:832
#6 0x0000561e23efd9c0 in tuplestore_put_remotetupleslot (state=0x561e2545fa78, remoteSlot=0x561e25460008)
at /workspaces/antdb/src/backend/utils/sort/tuplestore.c:1601
#7 0x0000561e23f423f2 in StoreRemoteSlot (context=0x7ffd01b8ea60, iterslot=0x561e25460008,
destslot=0x561e2545fea8) at /workspaces/antdb/src/backend/intercomm/inter-query.c:639
#8 0x0000561e23f4271a in HandleCopyOutData (pub=0x7ffd01b8ea60, conn=0x561e25306990,
buf=0x561e254962c5 &ldquo;D\034&rdquo;, len=29) at /workspaces/antdb/src/backend/intercomm/inter-query.c:726
#9 0x0000561e23a6e010 in PQNExecFinish (conn=0x561e25306990, hook=0x7ffd01b8ea60)
at /workspaces/antdb/src/backend/libpq/libpq-node.c:637
#10 0x0000561e23a6d854 in PQNListExecFinish (conn_list=0x561e254607c0,
get_pgconn_hook=0x561e23f3c711 <handlegetpgconn>, hook=0x7ffd01b8ea60, blocking=true)
at /workspaces/antdb/src/backend/libpq/libpq-node.c:480
#11 0x0000561e23f42112 in FetchRemoteQuery (node=0x561e2545f788, destslot=0x561e2545fea8)
at /workspaces/antdb/src/backend/intercomm/inter-query.c:548
#12 0x0000561e23f36d41 in RemoteQueryNext (scan_node=0x561e2545f788)
at /workspaces/antdb/src/backend/pgxc/pool/execRemote.c:319</p>
<p>#0 PQsendQueryTree (conn=0x561e253a7c60,
query=0x561e254065a8 &ldquo;SELECT c1, c2, c3 FROM ONLY public.t1 t1 WHERE true LIMIT &lsquo;500&rsquo;::bigint&rdquo;,
query_tree=0x0, tree_len=0) at /workspaces/antdb/src/interfaces/libpq/fe-exec.c:1350
#1 0x0000561e23f3e088 in HandleSendQueryTree (handle=0x561e253d32f8, cid=0, snapshot=0x561e254695d8,
query=0x561e254065a8 &ldquo;SELECT c1, c2, c3 FROM ONLY public.t1 t1 WHERE true LIMIT &lsquo;500&rsquo;::bigint&rdquo;,
query_tree=0x0) at /workspaces/antdb/src/backend/intercomm/inter-comm.c:571
#2 0x0000561e23f41ec9 in HandleStartRemoteQuery (handle=0x561e253d32f8, node=0x561e253e1638)
at /workspaces/antdb/src/backend/intercomm/inter-query.c:492
#3 0x0000561e23f41905 in InterXactQuery (state=0x561e24294680 <topinterxactstatedata>, node=0x561e253e1638,
destslot=0x561e253e1d08) at /workspaces/antdb/src/backend/intercomm/inter-query.c:348
#4 0x0000561e23f417a6 in StartRemoteQuery (node=0x561e253e1638, destslot=0x561e253e1d08)
at /workspaces/antdb/src/backend/intercomm/inter-query.c:312
#5 0x0000561e23f36ca8 in RemoteQueryNext (scan_node=0x561e253e1638)
at /workspaces/antdb/src/backend/pgxc/pool/execRemote.c:298
#6 0x0000561e239e34b3 in ExecScanFetch (node=0x561e253e1638, accessMtd=0x561e23f36c22 <remotequerynext>,
recheckMtd=0x561e23f36c0b <remotequeryrecheck>) at /workspaces/antdb/src/backend/executor/execScan.c:133
#7 0x0000561e239e352c in ExecScan (node=0x561e253e1638, accessMtd=0x561e23f36c22 <remotequerynext>,
recheckMtd=0x561e23f36c0b <remotequeryrecheck>) at /workspaces/antdb/src/backend/executor/execScan.c:182
#8 0x0000561e23f36c09 in ExecRemoteQuery (ps=0x561e253e1638)
at /workspaces/antdb/src/backend/pgxc/pool/execRemote.c:250
#9 0x0000561e239df635 in ExecProcNodeFirst (node=0x561e253e1638)
at /workspaces/antdb/src/backend/executor/execProcnode.c:511
#10 0x0000561e23a1040d in ExecProcNode (node=0x561e253e1638)
at /workspaces/antdb/src/include/executor/executor.h:269
#11 0x0000561e23a10644 in ExecLimit (pstate=0x561e253e1348)</p>
<p>#0 secure_raw_write (port=0x561e253072d0, ptr=0x561e2530be08, len=8192)
at /workspaces/antdb/src/backend/libpq/be-secure.c:350
#1 0x0000561e23a5e1ca in secure_write (port=0x561e253072d0, ptr=0x561e2530be08, len=8192)
at /workspaces/antdb/src/backend/libpq/be-secure.c:293
#2 0x0000561e23a69e03 in internal_flush () at /workspaces/antdb/src/backend/libpq/pqcomm.c:1645
#3 0x0000561e23a69cd2 in internal_putbytes (s=0x561e253e2a79 &ldquo;&rdquo;, len=12)
at /workspaces/antdb/src/backend/libpq/pqcomm.c:1591
#4 0x0000561e23a6a04e in socket_putmessage (msgtype=68 &lsquo;D&rsquo;, s=0x561e253e2a70 &ldquo;&rdquo;, len=21)
at /workspaces/antdb/src/backend/libpq/pqcomm.c:1788
#5 0x0000561e23a6b00f in pq_endmessage_reuse (buf=0x561e25407c10)
at /workspaces/antdb/src/backend/libpq/pqformat.c:319
#6 0x0000561e236f87af in printtup (slot=0x561e253e1d08, self=0x561e25407bb0)
at /workspaces/antdb/src/backend/access/common/printtup.c:633
#7 0x0000561e239d655b in ExecutePlan (estate=0x561e253e1118, planstate=0x561e253e1348, use_parallel_mode=false,
operation=CMD_SELECT, sendTuples=true, numberTuples=0, direction=ForwardScanDirection, dest=0x561e25407bb0,
execute_once=true) at /workspaces/antdb/src/backend/executor/execMain.c:1734
#8 0x0000561e239d3fba in standard_ExecutorRun (queryDesc=0x561e253046e8, direction=ForwardScanDirection,
count=0, execute_once=true) at /workspaces/antdb/src/backend/executor/execMain.c:368
#9 0x0000561e239d3e21 in ExecutorRun (queryDesc=0x561e253046e8, direction=ForwardScanDirection, count=0,
execute_once=true) at /workspaces/antdb/src/backend/executor/execMain.c:312
#10 0x0000561e23d03e3f in PortalRunSelect (portal=0x561e25360f98, forward=true, count=0, dest=0x561e25407bb0)
at /workspaces/antdb/src/backend/tcop/pquery.c:1034</p>
<p>prepare s(int, int) as select * from t1 join t2 on t1.c1 = $1 and t2.c1 = $2;</p>
<p>cache</p>
<p>B | pname | sname | 0 | 0 | D | p | e | s</p>
<p>B | 0 | name |
5 | 1 | 8 |</p>
<p>39</p>
<p>strlen(portal_name)</p>
<p>0x55f5e2c52370: 66 0 0 0 16 0 115 49
0x55f5e2c52378: 64 64 35 35 48 0 0 0
0x55f5e2c52380: 0 1 0 0 0 1 49 0
0x55f5e2c52388: 0 0 0 0 9 0 0 0
0x55f5e2c52390: 0 0 83 0 0 0 4 108</p>
<p>0x5595fed95638: 0 115 49 64 64 35 35 48
0x5595fed95640: 0 0 0 0 1 0 0 0
0x5595fed95648: 1 49 0 0 0 32 102 111
0x5595fed95650: 114 99 101 95 103 101 110 101
0x5595fed95658: 114 105 99 95 112 108 97 110</p>
<p><a href="https://www.jianshu.com/p/70069c663554?u_atoken=32991cbe-1955-40bc-9718-8d3a35665f89&u_asession=01c4OwPpzAFvgvxZm5PHV1hhBw4zAaxWLCjNLOUx1S0r65K5j_Co9qzK2QP3djrxxlX0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K8kc-sAmRM1ALm4x465txKiLDnIvqHhvwKBSiCA9W2pPWBkFo3NEHBv0PZUm6pbxQU&u_asig=05Y3_7uvSQPfeIm07fP1vQdkWeuCRx6EeGjwlKCyZv-3VFasqiGjJkIYokMAzoIY3OUnpfq31N9-YnXa7iZsAG0GGa_jplO472u1JsgaBhVgawWIt-WyU9QFJBdx-2l9l6Kh9xGFYxS8c7EmhEJD97Ui2KtWnr1tnaOIbJC5SZpuT9JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzUMyz75HKVeBaK2YeP8Z-vshy4LDmw1kx2t7EvJMCe7BT6aHbewJv6RwWiEQAUeSSO3h9VXwMyh6PgyDIVSG1W8q4Tc-oNDe7qAOFBZNsoQ4TOybdtHlb3igdkDLY_odFR1XLKRTU_RDIFE8Sle2zKb4_cTkWcIdlnLWPTLKoE4CmWspDxyAEEo4kbsryBKb9Q&u_aref=4hkwpSZ%2B%2BpvZu6cQGg9n3Ljxk8g%3D">https://www.jianshu.com/p/70069c663554?u_atoken=32991cbe-1955-40bc-9718-8d3a35665f89&u_asession=01c4OwPpzAFvgvxZm5PHV1hhBw4zAaxWLCjNLOUx1S0r65K5j_Co9qzK2QP3djrxxlX0KNBwm7Lovlpxjd_P_q4JsKWYrT3W_NKPr8w6oU7K8kc-sAmRM1ALm4x465txKiLDnIvqHhvwKBSiCA9W2pPWBkFo3NEHBv0PZUm6pbxQU&u_asig=05Y3_7uvSQPfeIm07fP1vQdkWeuCRx6EeGjwlKCyZv-3VFasqiGjJkIYokMAzoIY3OUnpfq31N9-YnXa7iZsAG0GGa_jplO472u1JsgaBhVgawWIt-WyU9QFJBdx-2l9l6Kh9xGFYxS8c7EmhEJD97Ui2KtWnr1tnaOIbJC5SZpuT9JS7q8ZD7Xtz2Ly-b0kmuyAKRFSVJkkdwVUnyHAIJzUMyz75HKVeBaK2YeP8Z-vshy4LDmw1kx2t7EvJMCe7BT6aHbewJv6RwWiEQAUeSSO3h9VXwMyh6PgyDIVSG1W8q4Tc-oNDe7qAOFBZNsoQ4TOybdtHlb3igdkDLY_odFR1XLKRTU_RDIFE8Sle2zKb4_cTkWcIdlnLWPTLKoE4CmWspDxyAEEo4kbsryBKb9Q&u_aref=4hkwpSZ%2B%2BpvZu6cQGg9n3Ljxk8g%3D</a></p>
<p>0x55f5e2c52370: 66 0 0 0 16 0 115 64
0x55f5e2c52378: 64 35 35 48 0 0 0 0
0x55f5e2c52380: 0 68 0 0 0 6 80 0
0x55f5e2c52388: 69 0 0 0 9 0 0 0
0x55f5e2c52390: 0 0 83 0 0 0 4 0</p>
<p>0x5595fed95638: 0 115 64 64 35 35 48 0
0x5595fed95640: 0 0 0 0 0 0 0 0
0x5595fed95648: 1 49 0 0 0 32 102 111
0x5595fed95650: 114 99 101 95 103 101 110 101
0x5595fed95658: 114 105 99 95 112 108 97 110</p>
<p>0x5595fed95638: 0 115 64 64 35 35 48 0
0x5595fed95640: 0 0 0 0</p>
<p>benchmarksql=#
prepare s2(int, int, int, int) as
select count(*) as low_stock from
(
select s_w_id, s_i_id, s_quantity from bmsql_stock
where
s_w_id = $1 and
s_quantity &lt; $2 and
s_i_id in (
select ol_i_id from bmsql_district join bmsql_order_line
on
ol_w_id = d_w_id and
ol_d_id = d_id and
ol_o_id >= d_next_o_id - 20 and
ol_o_id &lt; d_next_o_id
where
d_w_id = $3 and d_id = $4
)
) as l;</p>
<p>benchmarksql=#
explain verbose execute s2(1, 1, 1, 1);</p>
<p>[
COALESCE(hash_combin_mod(2, hashint4(t2.c2)), 0)
]</p>
<p>select COALESCE(hash_combin_mod(2, hashint4($1)), 0), COALESCE(hash_combin_mod(2, hashint4($2)), 0) from t2;</p>
<ol>
<li>
<p>è¾…åŠ©æ–‡ä»¶æ”¯æŒ</p>
</li>
<li></li>
<li>
<p>ç¬¬ä¸€æ¬¡æå–åˆ†åŒºé”®æ¡ä»¶</p>
</li>
</ol>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://askyx.github.io/posts/adbplan/>
<span class=button__icon>â†</span>
<span class=button__text></span>
</a>
</span>
<span class="button next">
<a href=https://askyx.github.io/posts/%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%80%BB%E8%BE%91/>
<span class=button__text></span>
<span class=button__icon>â†’</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=https://askyx.github.io/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>Â© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://askyx.github.io/assets/main.js></script>
<script src=https://askyx.github.io/assets/prism.js></script>
</div>
</body>
</html>