<!doctype html><html lang=en>
<head>
<title>
vacuum 和 analyze 过程分析 ::
Esoye — My note blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="语句的具体信息参考pg说明文档
 http://postgres.cn/docs/12/routine-vacuuming.html http://postgres.cn/docs/12/sql-vacuum.html http://postgres.cn/docs/12/sql-analyze.html   antdb对功能进行增强，可以cn上执行语句然后收集统计信息，更新cn的元数据信息等操作，且数据变动会同步到其他cn节点和gtm 节点
vacuum #  cn执行vacuum的入口为ExecVacuum，具体执行函数为vacuum，此函数在后续会被其他节点调用，用来更新本节点的元数据信息，所以他按不同的角色执行不同的代码逻辑
对于当前执行语句的cn，主要任务为
 执行语句 使用ExecClusterCustomFunction通知其他节点进行vacuum操作 进行数据中转  从dn收集统计信息的数据 转发到其他cn和gtm以及slave    其他cn和gtm
 接受cn的消息，启动vacuum操作，但是由于本地没有数据，所以主要目的是为了能执行相同的代码逻辑，进行元数据更新 接收cn的数据，更新本节点元数据信息  dn
 接受cn的消息，启动vacuum操作 更新本节点的元数据信息 发送数据到cn  大致流程如下图
具体的数据交互过程以vacuum t1为例，如下图
recvfrom(11, &amp;#34;Q\0\0\0\20vacuum t1;\0&amp;#34;, 8192, 0, NULL, NULL) = 17 sendto(10, &amp;#34;\1\0\0\0\0\0\0\nX\243\335\215\214\2\0\352\266\233\335\215\214\2\0w2\0\0\0\0\0\0&amp;#34;, 32, 0, NULL, 0) = 32 sendto(17, &amp;#34;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&amp;#34;..., 157, 0, NULL, 0) = 157 sendto(15, &amp;#34;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&amp;#34;..., 157, 0, NULL, 0) = 157 sendto(50, &amp;#34;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&amp;#34;.">
<meta name=keywords content="数据库">
<meta name=robots content="noodp">
<link rel=canonical href=https://askyx.github.io/posts/postgres/vacuum/>
<link rel=stylesheet href=https://askyx.github.io/assets/style.css>
<link rel=stylesheet href=https://askyx.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://askyx.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://askyx.github.io/img/favicon.png>
<link href=https://askyx.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://askyx.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://askyx.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://askyx.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://askyx.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://askyx.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="vacuum 和 analyze 过程分析">
<meta name=twitter:description content="AntDB VACUUM 流程">
<meta property="og:title" content="vacuum 和 analyze 过程分析">
<meta property="og:description" content="AntDB VACUUM 流程">
<meta property="og:type" content="article">
<meta property="og:url" content="https://askyx.github.io/posts/postgres/vacuum/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2022-09-26T16:37:37+08:00">
<meta property="article:modified_time" content="2022-09-26T16:37:37+08:00"><meta property="og:site_name" content="Esoye">
</head>
<body class=light-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Esoye</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/archive>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/archive>Archive</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title>vacuum 和 analyze 过程分析</h1>
<div class=post-meta>
<span class=post-date>
2022-09-26
</span>
</div>
<span class=post-tags>
<a href=https://askyx.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>#数据库</a>&nbsp;
<a href=https://askyx.github.io/tags/postgres/>#Postgres</a>&nbsp;
<a href=https://askyx.github.io/tags/vacuum/>#VACUUM</a>&nbsp;
</span>
<div class=post-content>
<p>语句的具体信息参考pg说明文档</p>
<ol>
<li><a href=http://postgres.cn/docs/12/routine-vacuuming.html>http://postgres.cn/docs/12/routine-vacuuming.html</a></li>
<li><a href=http://postgres.cn/docs/12/sql-vacuum.html>http://postgres.cn/docs/12/sql-vacuum.html</a></li>
<li><a href=http://postgres.cn/docs/12/sql-analyze.html>http://postgres.cn/docs/12/sql-analyze.html</a></li>
</ol>
<hr>
<p>antdb对功能进行增强，可以cn上执行语句然后收集统计信息，更新cn的元数据信息等操作，且数据变动会同步到其他cn节点和gtm 节点</p>
<h2 id=vacuum>
vacuum
<a href=#vacuum class=h-anchor aria-hidden=true>#</a>
</h2>
<p>cn执行vacuum的入口为<code>ExecVacuum</code>，具体执行函数为<code>vacuum</code>，此函数在后续会被其他节点调用，用来更新本节点的元数据信息，所以他按不同的角色执行不同的代码逻辑</p>
<p>对于当前执行语句的cn，主要任务为</p>
<ol>
<li>执行语句</li>
<li>使用<code>ExecClusterCustomFunction</code>通知其他节点进行vacuum操作</li>
<li>进行数据中转
<ol>
<li>从dn收集统计信息的数据</li>
<li>转发到其他cn和gtm以及slave</li>
</ol>
</li>
</ol>
<p>其他cn和gtm</p>
<ol>
<li>接受cn的消息，启动vacuum操作，但是由于本地没有数据，所以主要目的是为了能执行相同的代码逻辑，进行元数据更新</li>
<li>接收cn的数据，更新本节点元数据信息</li>
</ol>
<p>dn</p>
<ol>
<li>接受cn的消息，启动vacuum操作</li>
<li>更新本节点的元数据信息</li>
<li>发送数据到cn</li>
</ol>
<p>大致流程如下图</p>
<p><img src=/posts/postgres/images/vacuum1.svg alt=rplan1></p>
<p>具体的数据交互过程以<code>vacuum t1</code>为例，如下图</p>
<p><img src=/posts/postgres/images/vacuum2.svg alt=rplan1></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>recvfrom(<span style=color:#ae81ff>11</span>, <span style=color:#e6db74>&#34;Q</span><span style=color:#ae81ff>\0\0\0\20</span><span style=color:#e6db74>vacuum  t1;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>8192</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>17</span>
sendto(<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\1\0\0\0</span><span style=color:#e6db74> </span><span style=color:#ae81ff>\0\0\0\n</span><span style=color:#e6db74>X</span><span style=color:#ae81ff>\243\335\215\214\2\0\352\266\233\335\215\214\2\0</span><span style=color:#e6db74>w2</span><span style=color:#ae81ff>\0\0\0\0\0\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>32</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>32</span>
sendto(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;p</span><span style=color:#ae81ff>\0\0\0\234\v\377\377\377\20\0\0\0</span><span style=color:#e6db74>cluster_vacuum</span><span style=color:#ae81ff>\0\0\1\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>157</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>157</span>
sendto(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;p</span><span style=color:#ae81ff>\0\0\0\234\v\377\377\377\20\0\0\0</span><span style=color:#e6db74>cluster_vacuum</span><span style=color:#ae81ff>\0\0\1\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>157</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>157</span>
sendto(<span style=color:#ae81ff>50</span>, <span style=color:#e6db74>&#34;p</span><span style=color:#ae81ff>\0\0\0\234\v\377\377\377\20\0\0\0</span><span style=color:#e6db74>cluster_vacuum</span><span style=color:#ae81ff>\0\0\1\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>157</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>157</span>
sendto(<span style=color:#ae81ff>49</span>, <span style=color:#e6db74>&#34;p</span><span style=color:#ae81ff>\0\0\0\234\v\377\377\377\20\0\0\0</span><span style=color:#e6db74>cluster_vacuum</span><span style=color:#ae81ff>\0\0\1\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>157</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>157</span>
recvfrom(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;W</span><span style=color:#ae81ff>\0\0\0\7\1\0\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
recvfrom(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;W</span><span style=color:#ae81ff>\0\0\0\7\1\0\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
recvfrom(<span style=color:#ae81ff>50</span>, <span style=color:#e6db74>&#34;W</span><span style=color:#ae81ff>\0\0\0\7\1\0\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
recvfrom(<span style=color:#ae81ff>49</span>, <span style=color:#e6db74>&#34;W</span><span style=color:#ae81ff>\0\0\0\7\1\0\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>8</span>
sendto(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\23\200\232\2\0\0</span><span style=color:#e6db74>public</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>t1</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span> TCP b3b87dd4fb6c:<span style=color:#ae81ff>59200</span><span style=color:#f92672>-&gt;</span>b3b87dd4fb6c:<span style=color:#ae81ff>65032</span> (ESTABLISHED) cn1
sendto(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\23\200\232\2\0\0</span><span style=color:#e6db74>public</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>t1</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span> TCP b3b87dd4fb6c:<span style=color:#ae81ff>46498</span><span style=color:#f92672>-&gt;</span>b3b87dd4fb6c:<span style=color:#ae81ff>65011</span> (ESTABLISHED) gtm
sendto(<span style=color:#ae81ff>50</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\23\200\232\2\0\0</span><span style=color:#e6db74>public</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>t1</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span> TCP b3b87dd4fb6c:<span style=color:#ae81ff>54044</span><span style=color:#f92672>-&gt;</span>b3b87dd4fb6c:<span style=color:#ae81ff>65013</span> (ESTABLISHED) dn1
sendto(<span style=color:#ae81ff>49</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\23\200\232\2\0\0</span><span style=color:#e6db74>public</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>t1</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>20</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>20</span> TCP b3b87dd4fb6c:<span style=color:#ae81ff>55242</span><span style=color:#f92672>-&gt;</span>b3b87dd4fb6c:<span style=color:#ae81ff>65014</span> (ESTABLISHED) dn2
recvfrom(<span style=color:#ae81ff>50</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\266</span><span style=color:#e6db74>T</span><span style=color:#ae81ff>\5\0\0\0\0</span><span style=color:#e6db74>new_rel_pages</span><span style=color:#ae81ff>\0\377\377\377\377\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>237</span>
recvfrom(<span style=color:#ae81ff>49</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\266</span><span style=color:#e6db74>T</span><span style=color:#ae81ff>\5\0\0\0\0</span><span style=color:#e6db74>new_rel_pages</span><span style=color:#ae81ff>\0\377\377\377\377\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>237</span>
sendto(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\266</span><span style=color:#e6db74>T</span><span style=color:#ae81ff>\5\0\0\0\0</span><span style=color:#e6db74>new_rel_pages</span><span style=color:#ae81ff>\0\377\377\377\377\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>231</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>231</span>
sendto(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\266</span><span style=color:#e6db74>T</span><span style=color:#ae81ff>\5\0\0\0\0</span><span style=color:#e6db74>new_rel_pages</span><span style=color:#ae81ff>\0\377\377\377\377\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>231</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>231</span>
recvfrom(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>Md</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>M&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>
recvfrom(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;d</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>Md</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>M&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>12</span>
sendto(<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n\0\0\000</span><span style=color:#e6db74>0</span><span style=color:#ae81ff>\0\0\0</span><span style=color:#e6db74>w2</span><span style=color:#ae81ff>\0\0\4</span><span style=color:#e6db74>@</span><span style=color:#ae81ff>\0\0\0\214</span><span style=color:#e6db74>2</span><span style=color:#ae81ff>\177\262</span><span style=color:#e6db74>U</span><span style=color:#ae81ff>\0\0</span><span style=color:#e6db74>y</span><span style=color:#ae81ff>\224\243\335\215\214\2\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>48</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>48</span>
sendto(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>)  <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
sendto(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>)  <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
sendto(<span style=color:#ae81ff>50</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>)  <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
sendto(<span style=color:#ae81ff>49</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>&#34;</span>, <span style=color:#ae81ff>5</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>)  <span style=color:#f92672>=</span> <span style=color:#ae81ff>5</span>
recvfrom(<span style=color:#ae81ff>17</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>I&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span>
recvfrom(<span style=color:#ae81ff>15</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>I&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span>
recvfrom(<span style=color:#ae81ff>50</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>I&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span>
recvfrom(<span style=color:#ae81ff>49</span>, <span style=color:#e6db74>&#34;c</span><span style=color:#ae81ff>\0\0\0\4</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>I&#34;</span>, <span style=color:#ae81ff>16384</span>, <span style=color:#ae81ff>0</span>, NULL, NULL) <span style=color:#f92672>=</span> <span style=color:#ae81ff>11</span>
sendto(<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\2\0\0\0\230\0\0\0</span><span style=color:#e6db74>w2</span><span style=color:#ae81ff>\0\0\1\0\0\0\3\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>152</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>152</span>
sendto(<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\2\0\0\0\230\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>152</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>152</span>
sendto(<span style=color:#ae81ff>10</span>, <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\16\0\0\0</span><span style=color:#e6db74>H</span><span style=color:#ae81ff>\0\0\0\6\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0</span><span style=color:#e6db74>&#34;</span>..., <span style=color:#ae81ff>72</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>72</span>
sendto(<span style=color:#ae81ff>11</span>, <span style=color:#e6db74>&#34;C</span><span style=color:#ae81ff>\0\0\0\v</span><span style=color:#e6db74>VACUUM</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>Z</span><span style=color:#ae81ff>\0\0\0\5</span><span style=color:#e6db74>I&#34;</span>, <span style=color:#ae81ff>18</span>, <span style=color:#ae81ff>0</span>, NULL, <span style=color:#ae81ff>0</span>) <span style=color:#f92672>=</span> <span style=color:#ae81ff>18</span>
</code></pre></div><p>从具体的数据交互的trace信息可以看出，cn需要使用p消息发送一个函数调用到具体的节点上去执行，cn执行vacuum的函数主要是在<code>vacuum_rel</code>中进行的，这里会把需要操作的表传输到其他节点上去，主要传输的数据如下，他先设置消息类型为<code>CLUSTER_VACUUM_CMD_VACUUM</code>，之后再打包xid和name。消息类型在后面的<code>process_master_vacuum_cmd</code>中会进行处理。<code>CLUSTER_VACUUM_CMD_VACUUM</code>对应vacuum</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>			appendStringInfoChar(<span style=color:#f92672>&amp;</span>buf, CLUSTER_VACUUM_CMD_VACUUM);
			appendBinaryStringInfo(<span style=color:#f92672>&amp;</span>buf, (<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>xid, <span style=color:#66d9ef>sizeof</span>(xid));
			<span style=color:#66d9ef>namespace</span> <span style=color:#f92672>=</span> get_namespace_name(RelationGetNamespace(onerel));
			save_node_string(<span style=color:#f92672>&amp;</span>buf, <span style=color:#66d9ef>namespace</span>);
			save_node_string(<span style=color:#f92672>&amp;</span>buf, RelationGetRelationName(onerel));
</code></pre></div><p>发送数据之后按原来的逻辑继续运行，后面使用<code>lazy_vacuum_rel_ext</code>函数处理vacuum，这里需要注意的是pg支持两种vacuum操作，一种是<code>vacuum lazy</code>，一种是<code>vacuum full</code>，前者不会跨page操作表，只是标记下过期数据然后更新fsm和vm，后者简单的理解会重建的表</p>
<p>(<a href=https://cloud.tencent.com/developer/article/1743815>openGauss/PostgreSQL vacuum full源码解析 - 腾讯云开发者社区-腾讯云 (tencent.com)</a>)</p>
<p>在<code>lazy_vacuum_rel_ext</code>中，则进行具体的vacuum操作，cn会接收dn的数据，转发到其他节点。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>IsToastRelation(onerel) <span style=color:#f92672>&amp;&amp;</span> (onerel<span style=color:#f92672>-&gt;</span>rd_locator_info <span style=color:#f92672>!=</span> NULL))
	{
		<span style=color:#66d9ef>if</span> (IsCnMaster() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>IsConnFromCoord())
		{
			<span style=color:#66d9ef>if</span> (dn_conns <span style=color:#f92672>!=</span> NIL)
			{
				<span style=color:#75715e>/* recv vacuum sync info from datanode */</span>
				VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;cnmaster relname %s wait vacuum sync info from dn</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RelationGetRelationName(onerel))));
				acquire_vsi_coord_master(dn_conns, <span style=color:#f92672>&amp;</span>sum_vsi);
				VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;acquire_vsi_coord_master:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>)));
				PrintDebugVsi(<span style=color:#f92672>&amp;</span>sum_vsi);
				new_rel_pages <span style=color:#f92672>=</span> sum_vsi.new_rel_pages;
				new_live_tuples <span style=color:#f92672>=</span> sum_vsi.new_live_tuples;
				new_rel_allvisible <span style=color:#f92672>=</span> sum_vsi.new_rel_allvisible;
				new_frozen_xid <span style=color:#f92672>=</span> sum_vsi.new_frozen_xid;
				new_min_multi <span style=color:#f92672>=</span> sum_vsi.new_min_multi;
			}

			<span style=color:#66d9ef>if</span> (cn_conns <span style=color:#f92672>!=</span> NIL)
			{
				<span style=color:#75715e>/* send relfreezeid to other coordinator */</span>
				VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;cnmaster relname %s send vacuum info to other cn slave:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RelationGetRelationName(onerel))));
				send_vsi_other_coord(cn_conns, <span style=color:#f92672>&amp;</span>sum_vsi);
			}

			<span style=color:#66d9ef>if</span> (cn_conns)
			{
				VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;cnmaster relname %s waiter cn slave ack:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RelationGetRelationName(onerel))));
				cluster_recv_exec_end(cn_conns);
			}
		}
		<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> ((params<span style=color:#f92672>-&gt;</span>options <span style=color:#f92672>&amp;</span> VACOPT_IN_CLUSTER) <span style=color:#f92672>==</span> VACOPT_IN_CLUSTER <span style=color:#f92672>&amp;&amp;</span>
			IS_PGXC_COORDINATOR <span style=color:#f92672>&amp;&amp;</span>
			IsConnFromCoord())
		{
			<span style=color:#75715e>/* recv freeze xid from master */</span>
			VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;cn slave relname %s waiter cn master vacuum info:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RelationGetRelationName(onerel))));
			acquire_relvsi_coord_slave(<span style=color:#f92672>&amp;</span>sum_vsi);
			VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;cn slave relname %s get cn master vacuum info:</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RelationGetRelationName(onerel))));
			PrintDebugVsi(<span style=color:#f92672>&amp;</span>sum_vsi);
			new_rel_pages <span style=color:#f92672>=</span> sum_vsi.new_rel_pages;
			new_live_tuples <span style=color:#f92672>=</span> sum_vsi.new_live_tuples;
			new_rel_allvisible <span style=color:#f92672>=</span> sum_vsi.new_rel_allvisible;
			new_frozen_xid <span style=color:#f92672>=</span> sum_vsi.new_frozen_xid;
			new_min_multi <span style=color:#f92672>=</span> sum_vsi.new_min_multi;
		}
	}
</code></pre></div><hr>
<h3 id=对于dn>
对于DN
<a href=#%e5%af%b9%e4%ba%8edn class=h-anchor aria-hidden=true>#</a>
</h3>
<p>cn发送的函数为cluster_vacuum，此函数会设置标记<code>VACOPT_IN_CLUSTER</code>，用来区分在vacuum中的角色，之后会调用vacuum函数</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>cluster_vacuum</span>(<span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>StringInfoData</span> <span style=color:#f92672>*</span>msg)
{
	StringInfoData	buf;
	VacuumParams	params;

	buf.data <span style=color:#f92672>=</span> mem_toc_lookup(msg, REMOTE_KEY_VACUUM_INFO, <span style=color:#f92672>&amp;</span>buf.maxlen);
	<span style=color:#66d9ef>if</span> (buf.data <span style=color:#f92672>==</span> NULL)
	{
		ereport(ERROR,
				(errcode(ERRCODE_PROTOCOL_VIOLATION),
				 errmsg(<span style=color:#e6db74>&#34;Can not found vacuum info&#34;</span>)));
	}
	buf.cursor <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
	buf.len <span style=color:#f92672>=</span> buf.maxlen;

	pq_copymsgbytes(<span style=color:#f92672>&amp;</span>buf, (<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>params, <span style=color:#66d9ef>sizeof</span>(params));

	params.options <span style=color:#f92672>|=</span> VACOPT_IN_CLUSTER;
	vacuum(NIL,
		   <span style=color:#f92672>&amp;</span>params,
		   NULL,
		   true);
}
</code></pre></div><p>这里调用的时候relation指定为null，后面<code>SimpleNextCopyFromNewFE</code>会从cn接收数据进行具体的vacuum操作</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=color:#75715e>#ifdef ADB
</span><span style=color:#75715e></span>		<span style=color:#66d9ef>if</span> (params<span style=color:#f92672>-&gt;</span>options <span style=color:#f92672>&amp;</span> VACOPT_IN_CLUSTER)
		{
			ClusterVacuumCmdContext context;
			context.params <span style=color:#f92672>=</span> params;
			context.use_own_xacts <span style=color:#f92672>=</span> use_own_xacts;
			context.in_outer_xact <span style=color:#f92672>=</span> in_outer_xact;

			SimpleNextCopyFromNewFE((SimpleCopyDataFunction)process_master_vacuum_cmd, <span style=color:#f92672>&amp;</span>context);
		}
<span style=color:#75715e>#endif </span><span style=color:#75715e>/* ADB */</span><span style=color:#75715e>
</span></code></pre></div><p>这里的回调函数<code>process_master_vacuum_cmd</code>会按照语句的类型执行不同的方法，如果是vacuum方法，则执行<code>vacuum_rel</code>，最终在<code>lazy_vacuum_rel_ext</code>中，执行完vacuum之后得到具体的统计数据，在更新完<code>pg_class</code>之后，调用<code>send_localvsi_to_coord</code>发送数据到cn。</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>IsToastRelation(onerel) <span style=color:#f92672>&amp;&amp;</span> IsConnFromCoord() <span style=color:#f92672>&amp;&amp;</span> IS_PGXC_DATANODE)
	{
		<span style=color:#75715e>/* send freeze xid to master */</span>
		VACUUM_CLUSTER_DEBUG_LOG((errmsg(<span style=color:#e6db74>&#34;dn relname %s send local vacuum info to cn master :</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>, RelationGetRelationName(onerel))));
		PrintDebugVsi(<span style=color:#f92672>&amp;</span>local_vsi);
		send_localvsi_to_coord(<span style=color:#f92672>&amp;</span>local_vsi);
	}
</code></pre></div><p><code>lazy_vacuum_rel_ext</code>中的流程大致如下</p>
<p><img src=/posts/postgres/images/vacuum3.svg alt=rplan1></p>
<h2 id=analyze>
analyze
<a href=#analyze class=h-anchor aria-hidden=true>#</a>
</h2>
<p>analyze 的大致流程和vacuum类似，vacuum支持使用<code>vacuum analyze</code>命令在进行vacuum之后同时调用analyze收集统计信息。所以在功能上他们是类似的，所以pg把vacuum和analyze实现在同一个函数中，最终在执行的时候，vacuum使用<code>vacuum_rel</code>进行vacuum，之后紧接着使用<code>analyze_rel</code>执行analyze，在<code>analyze_rel</code>中，数据的交互和vacuum类似，在下发到dn的数据打包的时候，标记类型为<code>CLUSTER_VACUUM_CMD_ANALYZE</code>或者<code>CLUSTER_VACUUM_CMD_ANALYZE_FORCE_INH</code></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>			initStringInfo(<span style=color:#f92672>&amp;</span>buf);
			<span style=color:#66d9ef>if</span> (onerel<span style=color:#f92672>-&gt;</span>rd_rel<span style=color:#f92672>-&gt;</span>relhassubclass)
				appendStringInfoChar(<span style=color:#f92672>&amp;</span>buf, CLUSTER_VACUUM_CMD_ANALYZE_FORCE_INH);
			<span style=color:#66d9ef>else</span>
				<span style=color:#a6e22e>appendStringInfoChar</span>(<span style=color:#f92672>&amp;</span>buf, CLUSTER_VACUUM_CMD_ANALYZE);
			
			xid <span style=color:#f92672>=</span> GetTopTransactionId();
			appendBinaryStringInfo(<span style=color:#f92672>&amp;</span>buf, (<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>)<span style=color:#f92672>&amp;</span>xid, <span style=color:#66d9ef>sizeof</span>(xid));
			save_node_string(<span style=color:#f92672>&amp;</span>buf, <span style=color:#66d9ef>namespace</span>);
			save_node_string(<span style=color:#f92672>&amp;</span>buf, RelationGetRelationName(onerel));
</code></pre></div><p>dn上<code>process_master_vacuum_cmd</code>使用analyze_rel函数处理analyze操作，在进行analyze之后，会把数据传送到cn，在analyze_rel中，也区分角色，执行不同的操作流程</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>	<span style=color:#66d9ef>if</span> (acquirefunc <span style=color:#f92672>==</span> acquire_sample_rows_coord_master <span style=color:#f92672>||</span>
		((params<span style=color:#f92672>-&gt;</span>options <span style=color:#f92672>&amp;</span> VACOPT_IN_CLUSTER) <span style=color:#f92672>==</span> VACOPT_IN_CLUSTER <span style=color:#f92672>&amp;&amp;</span>
		 IsCnMaster() <span style=color:#f92672>&amp;&amp;</span>
		 (onerel<span style=color:#f92672>-&gt;</span>rd_rel<span style=color:#f92672>-&gt;</span>relkind <span style=color:#f92672>==</span> RELKIND_MATVIEW <span style=color:#f92672>||</span>
		  onerel<span style=color:#f92672>-&gt;</span>rd_rel<span style=color:#f92672>-&gt;</span>relkind <span style=color:#f92672>==</span> RELKIND_FOREIGN_TABLE)))
	{
        ......
		<span style=color:#66d9ef>if</span> (onerel<span style=color:#f92672>-&gt;</span>rd_rel<span style=color:#f92672>-&gt;</span>relkind <span style=color:#f92672>!=</span> RELKIND_PARTITIONED_TABLE)
		{
			<span style=color:#66d9ef>if</span> (dnlist <span style=color:#f92672>!=</span> NIL)
			{
				<span style=color:#75715e>/* recv relpages from datanode */</span>
				relpages <span style=color:#f92672>=</span> acquire_relpage_num_coord_master(dnlist);
			}

			<span style=color:#66d9ef>if</span> (cnlist <span style=color:#f92672>!=</span> NIL)
			{
				<span style=color:#75715e>/* send relpages to other coordinator */</span>
				send_relpage_num_to_other_coord(cnlist, relpages);
			}
		}
	}<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (acquirefunc <span style=color:#f92672>==</span> acquire_sample_rows_coord_slave <span style=color:#f92672>&amp;&amp;</span>
		onerel<span style=color:#f92672>-&gt;</span>rd_rel<span style=color:#f92672>-&gt;</span>relkind <span style=color:#f92672>!=</span> RELKIND_PARTITIONED_TABLE)
	{
		<span style=color:#75715e>/* recv relpages from master */</span>
		relpages <span style=color:#f92672>=</span> acquire_relpage_num_coord_slave();
	}<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (IS_PGXC_DATANODE <span style=color:#f92672>&amp;&amp;</span>
		IsConnFromCoord() <span style=color:#f92672>&amp;&amp;</span>
		(params<span style=color:#f92672>-&gt;</span>options <span style=color:#f92672>&amp;</span> VACOPT_IN_CLUSTER) <span style=color:#f92672>==</span> VACOPT_IN_CLUSTER <span style=color:#f92672>&amp;&amp;</span>
		onerel<span style=color:#f92672>-&gt;</span>rd_rel<span style=color:#f92672>-&gt;</span>relkind <span style=color:#f92672>!=</span> RELKIND_PARTITIONED_TABLE)
	{
		<span style=color:#75715e>/* send relpages to master */</span>
		send_relpage_num_to_coord(relpages);
	}

</code></pre></div><p>统计信息主要用于指导优化器优化执行计划。元数据中pg_statistic主要存储统计信息，但是不是可以人读的，官网的解释是表中的数据是比较敏感的。所以pg建立了两个视图，<code>pg_stats</code>和<code>pg_statistic_ext</code>，前者是常规的统计信息，后者主要是自定义表达式的统计信息。</p>
<p>pg_statistic的数据由analyze 收集，具体的收集过程在函数<code>analyze_rel</code>中的<code>do_analyze_rel</code>函数，在<code>analyze_rel</code>前面处理完前置判断之后，<code>do_analyze_rel</code>读表抽样，然后计算统计信息，读表使用的是<code>acquire_sample_rows</code>函数，这里需要注意的是</p>
<ol>
<li>抽样比例按表的大小，默认最多只抽取30000行，少于30000则全量统计，有一个参数可以进行控制，</li>
<li>抽样有具体的算法，和列类型密切相关</li>
<li>先抽取所有page，然后在page里面在抽样</li>
</ol>
<p>可以参考代码<code>std_typanalyze</code>里面的片段，其中attstattarget由guc参数default_statistics_target控制，默认为100.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>	<span style=color:#66d9ef>if</span> (OidIsValid(eqopr) <span style=color:#f92672>&amp;&amp;</span> OidIsValid(ltopr))
	{
		<span style=color:#75715e>/* Seems to be a scalar datatype */</span>
		stats<span style=color:#f92672>-&gt;</span>compute_stats <span style=color:#f92672>=</span> compute_scalar_stats;
		<span style=color:#75715e>/*--------------------
</span><span style=color:#75715e>		 * The following choice of minrows is based on the paper
</span><span style=color:#75715e>		 * &#34;Random sampling for histogram construction: how much is enough?&#34;
</span><span style=color:#75715e>		 * by Surajit Chaudhuri, Rajeev Motwani and Vivek Narasayya, in
</span><span style=color:#75715e>		 * Proceedings of ACM SIGMOD International Conference on Management
</span><span style=color:#75715e>		 * of Data, 1998, Pages 436-447.  Their Corollary 1 to Theorem 5
</span><span style=color:#75715e>		 * says that for table size n, histogram size k, maximum relative
</span><span style=color:#75715e>		 * error in bin size f, and error probability gamma, the minimum
</span><span style=color:#75715e>		 * random sample size is
</span><span style=color:#75715e>		 *		r = 4 * k * ln(2*n/gamma) / f^2
</span><span style=color:#75715e>		 * Taking f = 0.5, gamma = 0.01, n = 10^6 rows, we obtain
</span><span style=color:#75715e>		 *		r = 305.82 * k
</span><span style=color:#75715e>		 * Note that because of the log function, the dependence on n is
</span><span style=color:#75715e>		 * quite weak; even at n = 10^12, a 300*k sample gives &lt;= 0.66
</span><span style=color:#75715e>		 * bin size error with probability 0.99.  So there&#39;s no real need to
</span><span style=color:#75715e>		 * scale for n, which is a good thing because we don&#39;t necessarily
</span><span style=color:#75715e>		 * know it at this point.
</span><span style=color:#75715e>		 *--------------------
</span><span style=color:#75715e>		 */</span>
		stats<span style=color:#f92672>-&gt;</span>minrows <span style=color:#f92672>=</span> <span style=color:#ae81ff>300</span> <span style=color:#f92672>*</span> attr<span style=color:#f92672>-&gt;</span>attstattarget;
	}
</code></pre></div><p>确定行数之后使用<code>acquire_sample_rows</code>抽取数据，存储到row中，这里需要注意的是他使用不同的随机算法，需要均衡到page和tuples，是有具体的理论(Jeff Vitter)指导的，大致来说就是两阶段采样</p>
<blockquote>
<p>第一阶段对数据页进行采样。在这个阶段，数据页是可以准确获得的，使用随机采样法-S算法，相对简单。第二阶段是对元组进行采样由于数据量不可知，采用的是蓄水池算法-Z(Vitter)算法。</p>
</blockquote>
<ul>
<li><a href=https://www.cnblogs.com/python27/p/Reservoir_Sampling_Algorithm.html>蓄水池抽样算法（Reservoir Sampling）</a></li>
</ul>
<p>之后就是使用具体的统计算法对数据进行处理，当前代码中有</p>
<ol>
<li><code>compute_scalar_stats</code></li>
<li><code>compute_distinct_stats</code></li>
<li><code>compute_trivial_stats</code></li>
</ol>
<p>具体适用的场景见注释，大致是否是满足可以使用<code>=</code>和<code>></code>对列进行操作，所以这里的具体的算法选择和列类型有关。</p>
<p>处理完之后使用<code>update_attstats</code>函数更新到 pg_statistics 。</p>
<p>AntDB 在dn处理完自身的任务之后，还会把数据传输到cn节点，由cn再进行计算。cn先是汇总所有的dn抽样之后的数据之后，在此基础上进行30000行的抽样，然后在进行常规的统计信息的计算，他属于抽样之上再抽样。这里不能直接使用dn计算之后的结果直接更新统计信息，因为统计信息需要综合数据，从数据中进行计算，当然如果非常清楚算法的计算过程，然后保留中间结果，然后由cn进行二次计算理论上也可行，只是现在cn上的统计信息则是基于<code>30000*count(dn)</code>计算，应该是可以更准确的。但是没有仔细探究算法实现，所以还不知道是否确实可行。</p>
<p>还有一点问题就是，当前的cn会把数据转发到其他cn或者gtm，由他们在数据上进行二次计算，所以网络io较大，是不是可以直接传输计算的结果，毕竟理论上cn的数据都得保持一致。</p>
<p>使用下面的例子，然后使用strace 观察cn的网络交互，可以明显的看出上面的问题</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> t1 (c1 int , c2 int , c3 int);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t1 <span style=color:#66d9ef>select</span>  floor(random() <span style=color:#f92672>*</span> <span style=color:#ae81ff>100000</span>)::int <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>, floor(random() <span style=color:#f92672>*</span> <span style=color:#ae81ff>100000</span>)::int <span style=color:#f92672>%</span> <span style=color:#ae81ff>10</span>, generate_series(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>100000</span>);

<span style=color:#66d9ef>analyze</span> <span style=color:#66d9ef>verbose</span> t1;
INFO:  <span style=color:#e6db74>&#34;t1&#34;</span>:containing <span style=color:#ae81ff>100000</span> live <span style=color:#66d9ef>rows</span> <span style=color:#66d9ef>and</span> <span style=color:#ae81ff>0</span> dead <span style=color:#66d9ef>rows</span>;<span style=color:#ae81ff>30000</span> <span style=color:#66d9ef>rows</span> <span style=color:#66d9ef>in</span> sample, <span style=color:#ae81ff>60000</span> total sample <span style=color:#66d9ef>rows</span> <span style=color:#66d9ef>from</span> datanode(s)

strace <span style=color:#f92672>-</span>p  <span style=color:#ae81ff>1443</span> <span style=color:#f92672>-</span>e trace<span style=color:#f92672>=</span>network
</code></pre></div><h2 id=总结>
总结
<a href=#%e6%80%bb%e7%bb%93 class=h-anchor aria-hidden=true>#</a>
</h2>
<ol>
<li>vacuum和analyze执行代码在上层是相同的，底层使用<code>analyze_rel</code>和<code>vacuum_rel</code>执行不同的操作，或者在<code>vacuum analyze table</code>中一起执行。</li>
<li>antdb在其逻辑上进行扩展，在原有的逻辑上添加接口，和其他节点进行数据交互。</li>
<li><code>vacuum full</code>使用<code>cluster_rel</code>实现，没有实现分布式vacuum功能。执行<code>vacuum full</code>之后，cn的pg_class数据不变，但是dn的是变动的。</li>
<li>vacuum是把dn的数据进行汇总相加，然后更新到元数据信息。</li>
<li>analyze也是类似的操作，但是analyze需要在接收到抽样数据之后在cn上进行抽样再计算，因为pg_statsitics 表中的信息是直方图，直接汇总相加会不正确。</li>
<li>analyze时cn会收集所有dn的抽样数据，转发到其他节点，而不是计算之后的数据，理论上所有cn上的元数据信息应该一致，所以这里是不是可以传输计算之后的数据而不是rows</li>
</ol>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://askyx.github.io/posts/postgres/locks/>
<span class=button__icon>←</span>
<span class=button__text>Locks</span>
</a>
</span>
<span class="button next">
<a href=https://askyx.github.io/posts/postgres/opt/>
<span class=button__text>Postgres Optimizer</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Esoye</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://askyx.github.io/assets/main.js></script>
<script src=https://askyx.github.io/assets/prism.js></script>
</div>
</body>
</html>