<!doctype html><html lang=en>
<head>
<title>
::
Esoye — My note blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="oid | 12179 rulename | pg_settings_n ev_class | 12175 ev_type | 2 ev_enabled | O is_instead | t ev_qual | &amp;lt;&amp;gt; ev_action | ( {QUERY : commandType 6 : querySource 0 : canSetTag false : utilityStmt &amp;lt;&amp;gt; : resultRelation 0 : hasAggs false : hasWindowFuncs false : hasTargetSRFs false : hasSubLinks false : hasDistinctOn false : hasRecursive false : hasModifyingCTE false : hasForUpdate false : hasRowSecurity false : cteList &amp;lt;&amp;gt; : rtable ( {RTE : alias {ALIAS : aliasname old : colnames &amp;lt;&amp;gt; } : eref {ALIAS : aliasname old : colnames (&amp;ldquo;name&amp;rdquo; &amp;ldquo;setting&amp;rdquo; &amp;ldquo;unit&amp;rdquo; &amp;ldquo;category&amp;rdquo; &amp;ldquo;short_d &amp;ldquo;extra_desc&amp;rdquo; &amp;ldquo;context&amp;rdquo; &amp;ldquo;vartype&amp;rdquo; &amp;ldquo;source&amp;rdquo; &amp;ldquo;min_val&amp;rdquo; &amp;ldquo;max_ &amp;ldquo;enumvals&amp;rdquo; &amp;ldquo;boot_val&amp;rdquo; &amp;ldquo;reset_val&amp;rdquo; &amp;ldquo;sourcefile&amp;rdquo; &amp;ldquo;sourcel &amp;ldquo;pending_restart&amp;rdquo;) } : rtekind 0 : relname pg_settings : relid 12175 : relkind v : rellockmode 1 : tablesample &amp;lt;&amp;gt; : lateral false : inh false : inFromCl false : requiredPerms 0 : checkAsUser 0 : selectedCols (b) : insertedCols (b) : updatedCols (b) : extraUpdatedCols (b) : securityQuals &amp;lt;&amp;gt; } {RTE : alias {ALIAS : aliasname new : colnames &amp;lt;&amp;gt; } : eref {ALIAS : aliasname new : colnames (&amp;ldquo;name&amp;rdquo; &amp;ldquo;setting&amp;rdquo; &amp;ldquo;unit&amp;rdquo; &amp;ldquo;category&amp;rdquo; &amp;ldquo;short_desc&amp;rdquo; &amp;ldquo;extra_desc&amp;rdquo; &amp;ldquo;context&amp;rdquo; &amp;ldquo;vartype&amp;rdquo; &amp;ldquo;source&amp;rdquo; &amp;ldquo;min_val&amp;rdquo; &amp;ldquo;max_val&amp;rdquo; &amp;ldquo;enumvals&amp;rdquo; &amp;ldquo;boot_val&amp;rdquo; &amp;ldquo;reset_val&amp;rdquo; &amp;ldquo;sourcefile&amp;rdquo; &amp;ldquo;sourceline&amp;rdquo; &amp;ldquo;pending_restart&amp;rdquo;) } : rtekind 0 : relname pg_settings : relid 12175 : relkind v : rellockmode 1 : tablesample &amp;lt;&amp;gt; : lateral false : inh false : inFromCl false : requiredPerms 0 : checkAsUser 0 : selectedCols (b) : insertedCols (b) : updatedCols (b) : extraUpdatedCols (b) : securityQuals &amp;lt;&amp;gt; } ) : jointree {FROMEXPR : fromlist &amp;lt;&amp;gt; : quals &amp;lt;&amp;gt; } : targetList &amp;lt;&amp;gt; : override 0 : onConflict &amp;lt;&amp;gt; : returningList &amp;lt;&amp;gt; : groupClause &amp;lt;&amp;gt; : groupingSets &amp;lt;&amp;gt; : havingQual &amp;lt;&amp;gt; : windowClause &amp;lt;&amp;gt; : distinctClause &amp;lt;&amp;gt; : sortClause &amp;lt;&amp;gt; : limitOffset &amp;lt;&amp;gt; : limitCount &amp;lt;&amp;gt; : limitOption 0 : rowMarks &amp;lt;&amp;gt; : setOperations &amp;lt;&amp;gt; : constraintDeps &amp;lt;&amp;gt; : withCheckOptions &amp;lt;&amp;gt; : stmt_location 0 : stmt_len 0 : connect_by &amp;lt;&amp;gt; } )">
<meta name=keywords content="数据库">
<meta name=robots content="noodp">
<link rel=canonical href=https://select1fromdual.github.io/posts/postgres/%E5%85%83%E6%95%B0%E6%8D%AE/>
<link rel=stylesheet href=https://select1fromdual.github.io/assets/style.css>
<link rel=stylesheet href=https://select1fromdual.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://select1fromdual.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://select1fromdual.github.io/img/favicon.png>
<link href=https://select1fromdual.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://select1fromdual.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://select1fromdual.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://select1fromdual.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://select1fromdual.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin>
<link href=https://select1fromdual.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin>
<meta name=twitter:card content="summary">
<meta name=twitter:title content>
<meta name=twitter:description content="oid | 12179 rulename | pg_settings_n ev_class | 12175 ev_type | 2 ev_enabled | O is_instead | t ev_qual | <> ev_action | ( {QUERY : commandType 6 : querySource 0 : canSetTag false : utilityStmt <> : resultRelation 0 : hasAggs false : hasWindowFuncs false : hasTargetSRFs false : hasSubLinks false : hasDistinctOn false : hasRecursive false : hasModifyingCTE false : hasForUpdate false : hasRowSecurity false : cteList <> : rtable ( {RTE : alias {ALIAS : aliasname old : colnames <> } : eref {ALIAS : aliasname old : colnames (&ldquo;name&rdquo; &ldquo;setting&rdquo; &ldquo;unit&rdquo; &ldquo;category&rdquo; &ldquo;short_d &ldquo;extra_desc&rdquo; &ldquo;context&rdquo; &ldquo;vartype&rdquo; &ldquo;source&rdquo; &ldquo;min_val&rdquo; &ldquo;max_ &ldquo;enumvals&rdquo; &ldquo;boot_val&rdquo; &ldquo;reset_val&rdquo; &ldquo;sourcefile&rdquo; &ldquo;sourcel &ldquo;pending_restart&rdquo;) } : rtekind 0 : relname pg_settings : relid 12175 : relkind v : rellockmode 1 : tablesample <> : lateral false : inh false : inFromCl false : requiredPerms 0 : checkAsUser 0 : selectedCols (b) : insertedCols (b) : updatedCols (b) : extraUpdatedCols (b) : securityQuals <> } {RTE : alias {ALIAS : aliasname new : colnames <> } : eref {ALIAS : aliasname new : colnames (&ldquo;name&rdquo; &ldquo;setting&rdquo; &ldquo;unit&rdquo; &ldquo;category&rdquo; &ldquo;short_desc&rdquo; &ldquo;extra_desc&rdquo; &ldquo;context&rdquo; &ldquo;vartype&rdquo; &ldquo;source&rdquo; &ldquo;min_val&rdquo; &ldquo;max_val&rdquo; &ldquo;enumvals&rdquo; &ldquo;boot_val&rdquo; &ldquo;reset_val&rdquo; &ldquo;sourcefile&rdquo; &ldquo;sourceline&rdquo; &ldquo;pending_restart&rdquo;) } : rtekind 0 : relname pg_settings : relid 12175 : relkind v : rellockmode 1 : tablesample <> : lateral false : inh false : inFromCl false : requiredPerms 0 : checkAsUser 0 : selectedCols (b) : insertedCols (b) : updatedCols (b) : extraUpdatedCols (b) : securityQuals <> } ) : jointree {FROMEXPR : fromlist <> : quals <> } : targetList <> : override 0 : onConflict <> : returningList <> : groupClause <> : groupingSets <> : havingQual <> : windowClause <> : distinctClause <> : sortClause <> : limitOffset <> : limitCount <> : limitOption 0 : rowMarks <> : setOperations <> : constraintDeps <> : withCheckOptions <> : stmt_location 0 : stmt_len 0 : connect_by <> } )">
<meta property="og:title" content>
<meta property="og:description" content="oid | 12179 rulename | pg_settings_n ev_class | 12175 ev_type | 2 ev_enabled | O is_instead | t ev_qual | <> ev_action | ( {QUERY : commandType 6 : querySource 0 : canSetTag false : utilityStmt <> : resultRelation 0 : hasAggs false : hasWindowFuncs false : hasTargetSRFs false : hasSubLinks false : hasDistinctOn false : hasRecursive false : hasModifyingCTE false : hasForUpdate false : hasRowSecurity false : cteList <> : rtable ( {RTE : alias {ALIAS : aliasname old : colnames <> } : eref {ALIAS : aliasname old : colnames (&ldquo;name&rdquo; &ldquo;setting&rdquo; &ldquo;unit&rdquo; &ldquo;category&rdquo; &ldquo;short_d &ldquo;extra_desc&rdquo; &ldquo;context&rdquo; &ldquo;vartype&rdquo; &ldquo;source&rdquo; &ldquo;min_val&rdquo; &ldquo;max_ &ldquo;enumvals&rdquo; &ldquo;boot_val&rdquo; &ldquo;reset_val&rdquo; &ldquo;sourcefile&rdquo; &ldquo;sourcel &ldquo;pending_restart&rdquo;) } : rtekind 0 : relname pg_settings : relid 12175 : relkind v : rellockmode 1 : tablesample <> : lateral false : inh false : inFromCl false : requiredPerms 0 : checkAsUser 0 : selectedCols (b) : insertedCols (b) : updatedCols (b) : extraUpdatedCols (b) : securityQuals <> } {RTE : alias {ALIAS : aliasname new : colnames <> } : eref {ALIAS : aliasname new : colnames (&ldquo;name&rdquo; &ldquo;setting&rdquo; &ldquo;unit&rdquo; &ldquo;category&rdquo; &ldquo;short_desc&rdquo; &ldquo;extra_desc&rdquo; &ldquo;context&rdquo; &ldquo;vartype&rdquo; &ldquo;source&rdquo; &ldquo;min_val&rdquo; &ldquo;max_val&rdquo; &ldquo;enumvals&rdquo; &ldquo;boot_val&rdquo; &ldquo;reset_val&rdquo; &ldquo;sourcefile&rdquo; &ldquo;sourceline&rdquo; &ldquo;pending_restart&rdquo;) } : rtekind 0 : relname pg_settings : relid 12175 : relkind v : rellockmode 1 : tablesample <> : lateral false : inh false : inFromCl false : requiredPerms 0 : checkAsUser 0 : selectedCols (b) : insertedCols (b) : updatedCols (b) : extraUpdatedCols (b) : securityQuals <> } ) : jointree {FROMEXPR : fromlist <> : quals <> } : targetList <> : override 0 : onConflict <> : returningList <> : groupClause <> : groupingSets <> : havingQual <> : windowClause <> : distinctClause <> : sortClause <> : limitOffset <> : limitCount <> : limitOption 0 : rowMarks <> : setOperations <> : constraintDeps <> : withCheckOptions <> : stmt_location 0 : stmt_len 0 : connect_by <> } )">
<meta property="og:type" content="article">
<meta property="og:url" content="https://select1fromdual.github.io/posts/postgres/%E5%85%83%E6%95%B0%E6%8D%AE/"><meta property="article:section" content="posts">
<meta property="og:site_name" content="Esoye">
</head>
<body class=light-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Esoye</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/archive>Archive</a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/archive>Archive</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<h1 class=post-title></h1>
<div class=post-meta>
</div>
<div class=post-content>
<p>oid | 12179
rulename | pg_settings_n
ev_class | 12175
ev_type | 2 <br>
ev_enabled | O <br>
is_instead | t <br>
ev_qual | &lt;> <br>
ev_action | (
{QUERY <br>
: commandType 6
: querySource 0 <br>
: canSetTag false <br>
: utilityStmt &lt;> <br>
: resultRelation 0 <br>
: hasAggs false <br>
: hasWindowFuncs false <br>
: hasTargetSRFs false <br>
: hasSubLinks false <br>
: hasDistinctOn false <br>
: hasRecursive false <br>
: hasModifyingCTE false <br>
: hasForUpdate false <br>
: hasRowSecurity false <br>
: cteList &lt;> <br>
: rtable (
{RTE <br>
: alias
{ALIAS <br>
: aliasname old <br>
: colnames &lt;>
} <br>
: eref
{ALIAS <br>
: aliasname old <br>
: colnames (&ldquo;name&rdquo; &ldquo;setting&rdquo; &ldquo;unit&rdquo; &ldquo;category&rdquo; &ldquo;short_d &ldquo;extra_desc&rdquo; &ldquo;context&rdquo; &ldquo;vartype&rdquo; &ldquo;source&rdquo; &ldquo;min_val&rdquo; &ldquo;max_ &ldquo;enumvals&rdquo; &ldquo;boot_val&rdquo; &ldquo;reset_val&rdquo; &ldquo;sourcefile&rdquo; &ldquo;sourcel &ldquo;pending_restart&rdquo;)
} <br>
: rtekind 0 <br>
: relname pg_settings <br>
: relid 12175 <br>
: relkind v <br>
: rellockmode 1 <br>
: tablesample &lt;> <br>
: lateral false <br>
: inh false <br>
: inFromCl false <br>
: requiredPerms 0 <br>
: checkAsUser 0 <br>
: selectedCols (b) <br>
: insertedCols (b) <br>
: updatedCols (b) <br>
: extraUpdatedCols (b) <br>
: securityQuals &lt;>
}
{RTE <br>
: alias
{ALIAS <br>
: aliasname new
: colnames &lt;>
} <br>
: eref
{ALIAS <br>
: aliasname new <br>
: colnames (&ldquo;name&rdquo; &ldquo;setting&rdquo; &ldquo;unit&rdquo; &ldquo;category&rdquo; &ldquo;short_desc&rdquo; &ldquo;extra_desc&rdquo; &ldquo;context&rdquo; &ldquo;vartype&rdquo; &ldquo;source&rdquo; &ldquo;min_val&rdquo; &ldquo;max_val&rdquo; &ldquo;enumvals&rdquo; &ldquo;boot_val&rdquo; &ldquo;reset_val&rdquo; &ldquo;sourcefile&rdquo; &ldquo;sourceline&rdquo; &ldquo;pending_restart&rdquo;)
} <br>
: rtekind 0 <br>
: relname pg_settings <br>
: relid 12175 <br>
: relkind v <br>
: rellockmode 1 <br>
: tablesample &lt;> <br>
: lateral false <br>
: inh false <br>
: inFromCl false <br>
: requiredPerms 0 <br>
: checkAsUser 0 <br>
: selectedCols (b) <br>
: insertedCols (b) <br>
: updatedCols (b) <br>
: extraUpdatedCols (b) <br>
: securityQuals &lt;>
}
) <br>
: jointree
{FROMEXPR <br>
: fromlist &lt;> <br>
: quals &lt;>
} <br>
: targetList &lt;> <br>
: override 0 <br>
: onConflict &lt;> <br>
: returningList &lt;> <br>
: groupClause &lt;> <br>
: groupingSets &lt;> <br>
: havingQual &lt;> <br>
: windowClause &lt;> <br>
: distinctClause &lt;> <br>
: sortClause &lt;> <br>
: limitOffset &lt;> <br>
: limitCount &lt;> <br>
: limitOption 0 <br>
: rowMarks &lt;> <br>
: setOperations &lt;> <br>
: constraintDeps &lt;> <br>
: withCheckOptions &lt;> <br>
: stmt_location 0 <br>
: stmt_len 0 <br>
: connect_by &lt;>
}
)</p>
<p>create table t1 (c1 int , c2 int , c3 int);
create table t2 (c1 int , c2 int , c3 int);
create table t3 (c1 int , c2 int , c3 int);</p>
<p>insert into t1 select floor(random() * 100000)::int % 10, floor(random() * 100000)::int % 10, generate_series(1,10000);
insert into t2 select floor(random() * 100000)::int % 10, floor(random() * 100000)::int % 10, generate_series(1,10000);
insert into t3 select floor(random() * 100000)::int % 10, floor(random() * 100000)::int % 10, generate_series(1,10000);</p>
<p>select oid,relname, relpages, reltuples from pg_class where relname = &lsquo;t1&rsquo;;</p>
<p>统计信息收集
<a href=http://postgres.cn/docs/12/routine-vacuuming.html>http://postgres.cn/docs/12/routine-vacuuming.html</a>
<a href=https://cloud.tencent.com/developer/article/1743815>https://cloud.tencent.com/developer/article/1743815</a></p>
<p>relpages page数量，估计IO代价
reltuples tuple数量，估计CPU代价</p>
<p>cluster_rel(){
rebuild_relation(){
make_new_heap()
copy_heap_data()
finsh_heap_swap(){
swap_relation_files()
reindex_relation()
performDeletion()
RelationMapRemoveMapping()
}
}
}</p>
<p>Vacuum</p>
<p>ExecClusterCustomFunction cluster_vacuum</p>
<p>#0 pqFlush (conn=0x5633a9825940) at /workspaces/antdb/src/interfaces/libpq/fe-misc.c:1017
#1 0x00007f2eae5546d4 in PQsendPlan (conn=0x5633a9825940, plan=0x5633a9998ce8 &ldquo;\v\377\377\377\020&rdquo;, length=168) at /workspaces/antdb/src/interfaces/libpq/fe-exec.c:1396
#2 0x00005633a7bf16ff in StartRemotePlan (msg=0x7fff17885590, rnodes=0x5633a9999468, context=0x7fff17885464, start_trans=false) at /workspaces/antdb/src/backend/executor/execCluster.c:1402
#3 0x00005633a7bef9ea in ExecClusterCustomFunction (rnodes=0x5633a9999468, mem_toc=0x7fff17885590, flag=16) at /workspaces/antdb/src/backend/executor/execCluster.c:709
#4 0x00005633a7b680f4 in vacuum (relations=0x5633a993f718, params=0x7fff178856f0, bstrategy=0x5633a993f588, isTopLevel=true) at /workspaces/antdb/src/backend/commands/vacuum.c:510
#5 0x00005633a7b67a7e in ExecVacuum (pstate=0x5633a9928fe8, vacstmt=0x5633a97ff1d8, isTopLevel=true) at /workspaces/antdb/src/backend/commands/vacuum.c:292</p>
<p>Analyze</p>
<p>recvfrom(11, &ldquo;p\0\0\0\254\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&rdquo;&mldr;, 8192, 0, NULL, NULL) = 173
sendto(11, &ldquo;W\0\0\0\7\1\0\0&rdquo;, 8, 0, NULL, 0) = 8
recvfrom(11, 0x563ced6288a0, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)
recvfrom(11, &ldquo;d\0\0\0\23\200\245\256\0\0public\0t4\0&rdquo;, 8192, 0, NULL, NULL) = 20
sendto(11, &ldquo;N\0\0\0QSINFO\0VINFO\0C00000\0Mvacuumi&rdquo;&mldr;, 82, 0, NULL, 0) = 82
sendto(11, &ldquo;N\0\0\0\333SINFO\0VINFO\0C00000\0M"t4": f&rdquo;&mldr;, 220, 0, NULL, 0) = 220
sendto(11, &ldquo;d\0\0\0\5M&rdquo;, 6, 0, NULL, 0) = 6
recvfrom(11, 0x563ced6288a0, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)
recvfrom(11, &ldquo;c\0\0\0\4&rdquo;, 8192, 0, NULL, NULL) = 5
sendto(10, &ldquo;\2\0\0\0\250\3\0\0w2\0\0\10\0\0\0\3\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&rdquo;&mldr;, 936, 0, NULL, 0) = 936
sendto(10, &ldquo;\2\0\0\0\250\3\0\0w2\0\0\10\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&rdquo;&mldr;, 936, 0, NULL, 0) = 936
sendto(10, &ldquo;\2\0\0\08\3\0\0w2\0\0\7\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&rdquo;&mldr;, 824, 0, NULL, 0) = 824
sendto(10, &ldquo;\2\0\0\0\350\1\0\0\0\0\0\0\4\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&rdquo;&mldr;, 488, 0, NULL, 0) = 488
sendto(10, &ldquo;\16\0\0\0H\0\0\0\6\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\3\0\0\0\0\0\0\0&rdquo;&mldr;, 72, 0, NULL, 0) = 72
sendto(11, &ldquo;c\0\0\0\4Z\0\0\0\5I&rdquo;, 11, 0, NULL, 0) = 11
recvfrom(11, 0x563ced6288a0, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</p>
<p>recvfrom(11, &ldquo;Q\0\0\0\20vacuum t1;\0&rdquo;, 8192, 0, NULL, NULL) = 17
sendto(10, &ldquo;\1\0\0\0 \0\0\0\nX\243\335\215\214\2\0\352\266\233\335\215\214\2\0w2\0\0\0\0\0\0&rdquo;, 32, 0, NULL, 0) = 32
sendto(17, &ldquo;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&rdquo;&mldr;, 157, 0, NULL, 0) = 157
sendto(15, &ldquo;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&rdquo;&mldr;, 157, 0, NULL, 0) = 157
sendto(50, &ldquo;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&rdquo;&mldr;, 157, 0, NULL, 0) = 157
sendto(49, &ldquo;p\0\0\0\234\v\377\377\377\20\0\0\0cluster_vacuum\0\0\1\0\0&rdquo;&mldr;, 157, 0, NULL, 0) = 157
recvfrom(17, &ldquo;W\0\0\0\7\1\0\0&rdquo;, 16384, 0, NULL, NULL) = 8
recvfrom(15, &ldquo;W\0\0\0\7\1\0\0&rdquo;, 16384, 0, NULL, NULL) = 8
recvfrom(50, &ldquo;W\0\0\0\7\1\0\0&rdquo;, 16384, 0, NULL, NULL) = 8
recvfrom(49, &ldquo;W\0\0\0\7\1\0\0&rdquo;, 16384, 0, NULL, NULL) = 8
sendto(17, &ldquo;d\0\0\0\23\200\232\2\0\0public\0t1\0&rdquo;, 20, 0, NULL, 0) = 20 TCP b3b87dd4fb6c:59200->b3b87dd4fb6c:65032 (ESTABLISHED) cn1
sendto(15, &ldquo;d\0\0\0\23\200\232\2\0\0public\0t1\0&rdquo;, 20, 0, NULL, 0) = 20 TCP b3b87dd4fb6c:46498->b3b87dd4fb6c:65011 (ESTABLISHED) gtm
sendto(50, &ldquo;d\0\0\0\23\200\232\2\0\0public\0t1\0&rdquo;, 20, 0, NULL, 0) = 20 TCP b3b87dd4fb6c:54044->b3b87dd4fb6c:65013 (ESTABLISHED) dn1
sendto(49, &ldquo;d\0\0\0\23\200\232\2\0\0public\0t1\0&rdquo;, 20, 0, NULL, 0) = 20 TCP b3b87dd4fb6c:55242->b3b87dd4fb6c:65014 (ESTABLISHED) dn2
recvfrom(50, &ldquo;d\0\0\0\266T\5\0\0\0\0new_rel_pages\0\377\377\377\377\0\0\0&rdquo;&mldr;, 16384, 0, NULL, NULL) = 237
recvfrom(49, &ldquo;d\0\0\0\266T\5\0\0\0\0new_rel_pages\0\377\377\377\377\0\0\0&rdquo;&mldr;, 16384, 0, NULL, NULL) = 237
sendto(17, &ldquo;d\0\0\0\266T\5\0\0\0\0new_rel_pages\0\377\377\377\377\0\0\0&rdquo;&mldr;, 231, 0, NULL, 0) = 231
sendto(15, &ldquo;d\0\0\0\266T\5\0\0\0\0new_rel_pages\0\377\377\377\377\0\0\0&rdquo;&mldr;, 231, 0, NULL, 0) = 231
recvfrom(17, &ldquo;d\0\0\0\5Md\0\0\0\5M&rdquo;, 16384, 0, NULL, NULL) = 12
recvfrom(15, &ldquo;d\0\0\0\5Md\0\0\0\5M&rdquo;, 16384, 0, NULL, NULL) = 12
sendto(10, &ldquo;\n\0\0\0000\0\0\0w2\0\0\4@\0\0\0\2142\177\262U\0\0y\224\243\335\215\214\2\0&rdquo;&mldr;, 48, 0, NULL, 0) = 48
sendto(17, &ldquo;c\0\0\0\4&rdquo;, 5, 0, NULL, 0) = 5
sendto(15, &ldquo;c\0\0\0\4&rdquo;, 5, 0, NULL, 0) = 5
sendto(50, &ldquo;c\0\0\0\4&rdquo;, 5, 0, NULL, 0) = 5
sendto(49, &ldquo;c\0\0\0\4&rdquo;, 5, 0, NULL, 0) = 5
recvfrom(17, &ldquo;c\0\0\0\4Z\0\0\0\5I&rdquo;, 16384, 0, NULL, NULL) = 11
recvfrom(15, &ldquo;c\0\0\0\4Z\0\0\0\5I&rdquo;, 16384, 0, NULL, NULL) = 11
recvfrom(50, &ldquo;c\0\0\0\4Z\0\0\0\5I&rdquo;, 16384, 0, NULL, NULL) = 11
recvfrom(49, &ldquo;c\0\0\0\4Z\0\0\0\5I&rdquo;, 16384, 0, NULL, NULL) = 11
sendto(10, &ldquo;\2\0\0\0\230\0\0\0w2\0\0\1\0\0\0\3\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&rdquo;&mldr;, 152, 0, NULL, 0) = 152
sendto(10, &ldquo;\2\0\0\0\230\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&rdquo;&mldr;, 152, 0, NULL, 0) = 152
sendto(10, &ldquo;\16\0\0\0H\0\0\0\6\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\1\0\0\0\0\0\0\0&rdquo;&mldr;, 72, 0, NULL, 0) = 72
sendto(11, &ldquo;C\0\0\0\vVACUUM\0Z\0\0\0\5I&rdquo;, 18, 0, NULL, 0) = 18
recvfrom(11, 0x55b27e6b78a0, 8192, 0, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</p>
<ol>
<li>full 没有更新master的pg_class</li>
</ol>
<p>antdb vacuum 和 analyze 过程说明</p>
<p>语句的具体信息参考pg说明文档
<a href=http://postgres.cn/docs/12/routine-vacuuming.html>http://postgres.cn/docs/12/routine-vacuuming.html</a>
<a href=http://postgres.cn/docs/12/sql-vacuum.html>http://postgres.cn/docs/12/sql-vacuum.html</a>
<a href=http://postgres.cn/docs/12/sql-analyze.html>http://postgres.cn/docs/12/sql-analyze.html</a></p>
<p>pg事务</p>
<ol>
<li>mvcc</li>
<li>读写不阻塞</li>
<li>写使用锁控制</li>
</ol>
<p>事务管理器的
锁管理器
clog 事务执行的结果状态记录
xlog 事务数据变动的日志&mdash;更多的关注这个</p>
<p>2PC</p>
<p>2种隔离级别
read committed
serializable
用这两种种去模拟其他隔离级别</p>
<p>三种锁</p>
<p>StartTransactionCommand
StartTransaction
CommitTransactionCommand
CommitTransaction
AbortCurrentTransaction
AbortTransaction
CleanupTransaction</p>
<p>BeginTransactionBlock
EndTransactionBlock
PrepareTransactionBlock</p>
<p>锁</p>
<p><a href="http://www.postgres.cn/docs/9.4/view-pg-locks.html#:~:text=pg_locks">http://www.postgres.cn/docs/9.4/view-pg-locks.html#:~:text=pg_locks</a></p>
<p>因为在读已提交模式里，每个新的命令都是从一个新的快照开始的
而这个快照包含所有到该时刻为止已提交的事务</p>
<p>分佈式食物</p>
<p>select pg_locks.*, pg_class.relname from pg_locks join pg_class where pg_locks.relation = pg_class.oid;</p>
<p>insert
在heap 的時候取xid</p>
<p>#0 futex_abstimed_wait_cancelable (private=128, abstime=0x0, clockid=0, expected=0, futex_word=0x7f15c404d1b8) at ../sysdeps/nptl/futex-internal.h:320
#1 do_futex_wait (sem=sem@entry=0x7f15c404d1b8, abstime=0x0, clockid=0) at sem_waitcommon.c:112
#2 0x00007f15cd6ca548 in __new_sem_wait_slow (sem=0x7f15c404d1b8, abstime=0x0, clockid=0) at sem_waitcommon.c:184
#3 0x000055949ad11612 in PGSemaphoreLock (sema=0x7f15c404d1b8) at pg_sema.c:327
#4 0x000055949adc8402 in LWLockAcquire (lock=0x7f15c45eca64, mode=LW_SHARED) at /home/esoye/postgres/src/backend/storage/lmgr/lwlock.c:1315
#5 0x000055949ad99fd7 in LockBuffer (buffer=1786, mode=1) at /home/esoye/postgres/src/backend/storage/buffer/bufmgr.c:4188
#6 0x000055949a92c7c8 in heapgetpage (sscan=0x55949babab50, page=0) at /home/esoye/postgres/src/backend/access/heap/heapam.c:422
#7 0x000055949a92d3f5 in heapgettup_pagemode (scan=0x55949babab50, dir=ForwardScanDirection, nkeys=0, key=0x0) at /home/esoye/postgres/src/backend/access/heap/heapam.c:901
#8 0x000055949a92e05b in heap_getnextslot (sscan=0x55949babab50, direction=ForwardScanDirection, slot=0x55949baba570) at /home/esoye/postgres/src/backend/access/heap/heapam.c:1352
#9 0x000055949abc5bd0 in table_scan_getnextslot (sscan=0x55949babab50, direction=ForwardScanDirection, slot=0x55949baba570) at /home/esoye/postgres/src/include/access/tableam.h:1046
#10 0x000055949abc5c9c in SeqNext (node=0x55949baba398) at /home/esoye/postgres/src/backend/executor/nodeSeqscan.c:80
#11 0x000055949ab89cf0 in ExecScanFetch (node=0x55949baba398, accessMtd=0x55949abc5c04 <seqnext>, recheckMtd=0x55949abc5cad <seqrecheck>) at /home/esoye/postgres/src/backend/executor/execScan.c:133
#12 0x000055949ab89d69 in ExecScan (node=0x55949baba398, accessMtd=0x55949abc5c04 <seqnext>, recheckMtd=0x55949abc5cad <seqrecheck>) at /home/esoye/postgres/src/backend/executor/execScan.c:182
#13 0x000055949abc5cf9 in ExecSeqScan (pstate=0x55949baba398) at /home/esoye/postgres/src/backend/executor/nodeSeqscan.c:112</p>
<p><a href=https://zhmin.github.io/posts/postgresql-lwlock/>https://zhmin.github.io/posts/postgresql-lwlock/</a>
LWLock
lightweight lock
使用信号量设置，初始化的时候已经设置</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>--MGR执行 
</span><span style=color:#75715e></span> <span style=color:#66d9ef>set</span> GTMCOORD <span style=color:#66d9ef>all</span> (plan_cache_mode <span style=color:#f92672>=</span> force_generic_plan);
 <span style=color:#66d9ef>set</span> COORDINATOR <span style=color:#66d9ef>all</span> (plan_cache_mode <span style=color:#f92672>=</span> force_generic_plan);
 <span style=color:#66d9ef>set</span> DATANODE <span style=color:#66d9ef>all</span> (plan_cache_mode <span style=color:#f92672>=</span> force_generic_plan);
 <span style=color:#66d9ef>set</span> GTMCOORD <span style=color:#66d9ef>all</span> (enable_fast_query_shipping <span style=color:#f92672>=</span> <span style=color:#66d9ef>on</span>);
 <span style=color:#66d9ef>set</span> COORDINATOR <span style=color:#66d9ef>all</span> (enable_fast_query_shipping <span style=color:#f92672>=</span> <span style=color:#66d9ef>on</span>);
 <span style=color:#66d9ef>set</span> DATANODE <span style=color:#66d9ef>all</span> (enable_fast_query_shipping <span style=color:#f92672>=</span> <span style=color:#66d9ef>on</span>);
 <span style=color:#75715e>--SQL1 
</span><span style=color:#75715e></span> <span style=color:#66d9ef>set</span> enable_fast_query_shipping<span style=color:#f92672>=</span><span style=color:#66d9ef>on</span>;
 <span style=color:#66d9ef>set</span> enable_remotejoin<span style=color:#f92672>=</span><span style=color:#66d9ef>on</span>;
 <span style=color:#66d9ef>set</span> enable_remotelimit<span style=color:#f92672>=</span><span style=color:#66d9ef>on</span>;
 <span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> t_int;
 <span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> t_int(id int,iid int,name varchar) distribute <span style=color:#66d9ef>by</span> hash(id);
 <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t_int <span style=color:#66d9ef>select</span> i,floor(random()<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>*</span>i),<span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>||</span>i <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1000</span>) i;
 <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t_int <span style=color:#66d9ef>select</span> i,floor(random()<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>*</span>i),<span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>||</span>i <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1000</span>) i;
 <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t_int <span style=color:#66d9ef>select</span> i,floor(random()<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>*</span>i),<span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>||</span>i <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1000</span>) i;
 <span style=color:#66d9ef>drop</span> <span style=color:#66d9ef>table</span> t_char;
 <span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> t_char(id int,iid int,name varchar) distribute <span style=color:#66d9ef>by</span> hash(name);
 <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t_char <span style=color:#66d9ef>select</span> i,floor(random()<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>*</span>i),<span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>||</span>i <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1000</span>) i;
 <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t_char <span style=color:#66d9ef>select</span> i,floor(random()<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>*</span>i),<span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>||</span>i <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1000</span>) i;
 <span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t_char <span style=color:#66d9ef>select</span> i,floor(random()<span style=color:#f92672>*</span><span style=color:#ae81ff>100</span><span style=color:#f92672>*</span>i),<span style=color:#e6db74>&#39;name&#39;</span><span style=color:#f92672>||</span>i <span style=color:#66d9ef>from</span> generate_series(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1000</span>) i;

<span style=color:#75715e>--SQL1 
</span><span style=color:#75715e></span> <span style=color:#66d9ef>prepare</span> st3(int,int) <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>select</span> <span style=color:#66d9ef>count</span>(iid) <span style=color:#66d9ef>from</span> t_int <span style=color:#66d9ef>where</span> id<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>or</span> id<span style=color:#f92672>=</span><span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>;
 <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>analyze</span> <span style=color:#66d9ef>verbose</span> <span style=color:#66d9ef>EXECUTE</span> st3(<span style=color:#ae81ff>808</span>,<span style=color:#ae81ff>809</span>);
 <span style=color:#66d9ef>explain</span> <span style=color:#66d9ef>analyze</span> <span style=color:#66d9ef>verbose</span> <span style=color:#66d9ef>EXECUTE</span> st3(<span style=color:#ae81ff>808</span>,<span style=color:#ae81ff>807</span>);
</code></pre></div><p>select b.name as b_name, b.setting as b_setting, e.name as b_name, e.setting as b_setting
from (select * from t_join_yngs where db_id = 1 and snap_id = 1 and name = &lsquo;shared_buffers&rsquo; and node_name = &lsquo;gc_m&rsquo;) as b,
(select * from t_join_yngs where db_id = 1 and snap_id = 2 and name = &lsquo;shared_buffers&rsquo; and node_name = &lsquo;gc_m&rsquo;) as e;</p>
<p><a href=mailto:root@10.1.207.164>root@10.1.207.164</a>
aidb@123!@#</p>
<p>sudo perf script -i dn2_off.data -f |/home/maoxp/tools/FlameGraph/stackcollapse-perf.pl > dn2.perf-folded
sudo cat dn2.perf-folded | /home/maoxp/tools/FlameGraph/flamegraph.pl > dn2.svg</p>
<p>ERROR: Cannot create foreign key whose evaluation cannot be enforced to remote nodes</p>
<p>08:39:32,619 [Thread-4] ERROR jTPCCTData : ERROR: could not resize shared memory segment &ldquo;/PostgreSQL.1542249946&rdquo; to 131124 bytes: No space left on device</p>
<p>debug</p>
<p>before
Term-00, Running Average tpmTOTAL: 13053.52 Current tpmTOTAL: 259572 Memory Usage: 150MB / 396MB
08:55:28,253 [Thread-8] INFO jTPCC : Term-00,
08:55:28,255 [Thread-8] INFO jTPCC : Term-00,
08:55:28,256 [Thread-8] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 5871.78
08:55:28,257 [Thread-8] INFO jTPCC : Term-00, Measured tpmTOTAL = 13053.4
08:55:28,257 [Thread-8] INFO jTPCC : Term-00, Session Start = 2022-10-10 08:52:28
08:55:28,257 [Thread-8] INFO jTPCC : Term-00, Session End = 2022-10-10 08:55:28
08:55:28,257 [Thread-8] INFO jTPCC : Term-00, Transaction Count = 39174</p>
<p>after
Term-00, Running Average tpmTOTAL: 19956.11 Current tpmTOTAL: 395160 Memory Usage: 54MB / 396MB
08:59:45,928 [Thread-8] INFO jTPCC : Term-00,
08:59:45,930 [Thread-8] INFO jTPCC : Term-00,
08:59:45,932 [Thread-8] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 9018.69
08:59:45,932 [Thread-8] INFO jTPCC : Term-00, Measured tpmTOTAL = 19953.68
08:59:45,932 [Thread-8] INFO jTPCC : Term-00, Session Start = 2022-10-10 08:56:45
08:59:45,932 [Thread-8] INFO jTPCC : Term-00, Session End = 2022-10-10 08:59:45
08:59:45,932 [Thread-8] INFO jTPCC : Term-00, Transaction Count = 59882</p>
<p>Term-00, Running Average tpmTOTAL: 21317.76 Current tpmTOTAL: 426936 Memory Usage: 62MB / 396MB
09:06:53,708 [Thread-11] INFO jTPCC : Term-00,
09:06:53,710 [Thread-11] INFO jTPCC : Term-00,
09:06:53,711 [Thread-11] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 9510.13
09:06:53,711 [Thread-11] INFO jTPCC : Term-00, Measured tpmTOTAL = 21316.64
09:06:53,711 [Thread-11] INFO jTPCC : Term-00, Session Start = 2022-10-10 09:03:53
09:06:53,711 [Thread-11] INFO jTPCC : Term-00, Session End = 2022-10-10 09:06:53
09:06:53,712 [Thread-11] INFO jTPCC : Term-00, Transaction Count = 63966</p>
<p>09:39:47,511 [Thread-13] INFO jTPCC : Term-00,
09:39:47,513 [Thread-13] INFO jTPCC : Term-00,
09:39:47,514 [Thread-13] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 6269.97
09:39:47,515 [Thread-13] INFO jTPCC : Term-00, Measured tpmTOTAL = 13835.51
09:39:47,515 [Thread-13] INFO jTPCC : Term-00, Session Start = 2022-10-10 09:36:47
09:39:47,516 [Thread-13] INFO jTPCC : Term-00, Session End = 2022-10-10 09:39:47
09:39:47,516 [Thread-13] INFO jTPCC : Term-00, Transaction Count = 41530</p>
<p>Term-00, Running Average tpmTOTAL: 34161.47 Current tpmTOTAL: 676428 Memory Usage: 231MB / 396MB
09:43:44,450 [Thread-11] INFO jTPCC : Term-00,
09:43:44,452 [Thread-11] INFO jTPCC : Term-00,
09:43:44,453 [Thread-11] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 15450.82
09:43:44,454 [Thread-11] INFO jTPCC : Term-00, Measured tpmTOTAL = 34158.97
09:43:44,454 [Thread-11] INFO jTPCC : Term-00, Session Start = 2022-10-10 09:40:44
09:43:44,454 [Thread-11] INFO jTPCC : Term-00, Session End = 2022-10-10 09:43:44
09:43:44,455 [Thread-11] INFO jTPCC : Term-00, Transaction Count = 102497</p>
<p>Term-00, Running Average tpmTOTAL: 14736.67 Current tpmTOTAL: 293076 Memory Usage: 72MB / 396MB
09:49:05,607 [Thread-13] INFO jTPCC : Term-00,
09:49:05,609 [Thread-13] INFO jTPCC : Term-00,
09:49:05,610 [Thread-13] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 6631.61
09:49:05,610 [Thread-13] INFO jTPCC : Term-00, Measured tpmTOTAL = 14732.66
09:49:05,610 [Thread-13] INFO jTPCC : Term-00, Session Start = 2022-10-10 09:46:05
09:49:05,611 [Thread-13] INFO jTPCC : Term-00, Session End = 2022-10-10 09:49:05
09:49:05,611 [Thread-13] INFO jTPCC : Term-00, Transaction Count = 44224</p>
<p>Term-00, Running Average tpmTOTAL: 14687.50 Current tpmTOTAL: 293400 Memory Usage: 142MB / 396MB
06:52:00,510 [Thread-11] INFO jTPCC : Term-00,
06:52:00,512 [Thread-11] INFO jTPCC : Term-00,
06:52:00,513 [Thread-11] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 6569.22
06:52:00,514 [Thread-11] INFO jTPCC : Term-00, Measured tpmTOTAL = 14685.79
06:52:00,514 [Thread-11] INFO jTPCC : Term-00, Session Start = 2022-10-11 06:49:00
06:52:00,515 [Thread-11] INFO jTPCC : Term-00, Session End = 2022-10-11 06:52:00
06:52:00,515 [Thread-11] INFO jTPCC : Term-00, Transaction Count = 44075</p>
<p>Term-00, Running Average tpmTOTAL: 13083.63 Current tpmTOTAL: 261084 Memory Usage: 222MB / 396MB
06:56:21,060 [Thread-3] INFO jTPCC : Term-00,
06:56:21,062 [Thread-3] INFO jTPCC : Term-00,
06:56:21,063 [Thread-3] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 5857.66
06:56:21,063 [Thread-3] INFO jTPCC : Term-00, Measured tpmTOTAL = 13079.72
06:56:21,063 [Thread-3] INFO jTPCC : Term-00, Session Start = 2022-10-11 06:53:20
06:56:21,064 [Thread-3] INFO jTPCC : Term-00, Session End = 2022-10-11 06:56:21
06:56:21,064 [Thread-3] INFO jTPCC : Term-00, Transaction Count = 39265</p>
<p>Term-00, Running Average tpmTOTAL: 13580.28 Current tpmTOTAL: 270120 Memory Usage: 43MB / 396MB
06:59:27,980 [Thread-12] INFO jTPCC : Term-00,
06:59:27,982 [Thread-12] INFO jTPCC : Term-00,
06:59:27,983 [Thread-12] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 6113.11
06:59:27,984 [Thread-12] INFO jTPCC : Term-00, Measured tpmTOTAL = 13579.34
06:59:27,984 [Thread-12] INFO jTPCC : Term-00, Session Start = 2022-10-11 06:56:27
06:59:27,984 [Thread-12] INFO jTPCC : Term-00, Session End = 2022-10-11 06:59:27
06:59:27,985 [Thread-12] INFO jTPCC : Term-00, Transaction Count = 40754</p>
<p>这个他们一般测多少遍啊。还有测的过程中每次差别大吗。我自己环境上，连续跑几次，高的到7000多，地的可以到</p>
<p>Term-00, Running Average tpmTOTAL: 15367.24 Current tpmTOTAL: 303036 Memory Usage: 232MB / 396MB
07:03:46,549 [Thread-10] INFO jTPCC : Term-00,
07:03:46,551 [Thread-10] INFO jTPCC : Term-00,
07:03:46,552 [Thread-10] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 6985.89
07:03:46,552 [Thread-10] INFO jTPCC : Term-00, Measured tpmTOTAL = 15365.17
07:03:46,553 [Thread-10] INFO jTPCC : Term-00, Session Start = 2022-10-11 07:00:46
07:03:46,553 [Thread-10] INFO jTPCC : Term-00, Session End = 2022-10-11 07:03:46
07:03:46,553 [Thread-10] INFO jTPCC : Term-00, Transaction Count = 46115</p>
<p>Term-00, Running Average tpmTOTAL: 15864.15 Current tpmTOTAL: 312384 Memory Usage: 210MB / 396MB
07:20:25,370 [Thread-4] INFO jTPCC : Term-00,
07:20:25,372 [Thread-4] INFO jTPCC : Term-00,
07:20:25,373 [Thread-4] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 7222.8
07:20:25,373 [Thread-4] INFO jTPCC : Term-00, Measured tpmTOTAL = 15861.24
07:20:25,373 [Thread-4] INFO jTPCC : Term-00, Session Start = 2022-10-11 07:17:25
07:20:25,374 [Thread-4] INFO jTPCC : Term-00, Session End = 2022-10-11 07:20:25
07:20:25,375 [Thread-4] INFO jTPCC : Term-00, Transaction Count = 47606</p>
<p>Term-00, Running Average tpmTOTAL: 15657.47 Current tpmTOTAL: 310248 Memory Usage: 237MB / 396MB
07:24:21,304 [Thread-8] INFO jTPCC : Term-00,
07:24:21,306 [Thread-8] INFO jTPCC : Term-00,
07:24:21,308 [Thread-8] INFO jTPCC : Term-00, Measured tpmC (NewOrders) = 7067.76
07:24:21,308 [Thread-8] INFO jTPCC : Term-00, Measured tpmTOTAL = 15654.75
07:24:21,308 [Thread-8] INFO jTPCC : Term-00, Session Start = 2022-10-11 07:21:21
07:24:21,308 [Thread-8] INFO jTPCC : Term-00, Session End = 2022-10-11 07:24:21
07:24:21,309 [Thread-8] INFO jTPCC : Term-00, Transaction Count = 46987</p>
<p>./configure &ndash;prefix=/home/vscode/psqlodbc &ndash;with-libpq=/home/vscode/.build &ndash;with-unixodbc=/home/vscode/unixODBC &ndash;enable-static &ndash;enable-shared</p>
<p>/usr/local/antdb/lib/libpq.so
/usr/lib64/libodbc.so.1</p>
<p>./configure &ndash;prefix=/home/vscode/psqlodbc &ndash;with-libpq=/home/vscode/.build &ndash;with-unixodbc=/home/vscode/unixODBC</p>
<p>inner_process_tokens</p>
<p>类型</p>
<p>insert values 部分有值
/*
[insert_values] 处理 语句 参数
限定insert 语句
获得values 后面的参数 (x,x,x)
auto_commit不需要，需要判断事务状态
1. null 值
2. 大字段
3. lob</p>
<pre><code>	处理之后的数据在qb中
 */
</code></pre>
<p>语句性能追踪
time</p>
<p><a href=mailto:dockerxc@10.21.13.208>dockerxc@10.21.13.208</a></p>
<p>AntDB119</p>
<p><a href=mailto:zjdev2@10.19.14.51>zjdev2@10.19.14.51</a></p>
<p>7114a758f5042a5e476bfbafd3ba509f db_test</p>
<p>/data01/zjgrp/zjdev2/config/zfz/antDb_test_wl
/data01/zjgrp/zjdev2/config/zfz/antDb_test_wl/build
fa16322aa95f0c5b9d2c63986a8196ad db_test_select_to_in</p>
<p>./configure &ndash;prefix=/data01/zjgrp/zjdev2/config/zfz/antDb_test_wl/psqlodbc-13.02.0000/build &ndash;with-libpq=/usr/local/antdb</p>
<p>/data01/zjgrp/zjdev2/config/zfz/antDb_test_wl/psqlodbc-13.02.0000/build/lib</p>
<p>f18a2ba7c010f2417a5e4e058944d7ac db_test</p>
<p>88c445dbf13e0babc7dad3a8d372b516 db_test_in_buffer
4ec9050c5a94df85dc7cee3fa58ef047 db_test_buffer
b44437172e089cd7eca9835843d31157 db_test_in2_buf</p>
<p>Tue Oct 18 15:01:53 CST 2022
59476112c66b236c9aa5891483c804a8 db_test_in2_buf
037855f9e3a1e2e5a5253a996941985a db_test_buf</p>
<p>select * from am_ps_payment_h_571_p_202209 where 1 = 1 and mod(ACCT_ID, 10) = 6 and rownum &lt;= 1</p>
<p>create table am_ps_payment_h_571_p_202209(ACCT_ID int, a int, b int, c int);</p>
<p>insert into am_ps_payment_h_571_p_202209 select floor(random() * 100000)::int % 10, floor(random() * 100000)::int % 10, floor(random() * 100000)::int % 10, generate_series(1,10000);</p>
<p>shared_preload_libraries = ' auto_explain '
fsync = off
plan_cache_mode = force_custom_plan
auto_explain.log_min_duration = -1
#auto_explain.log_analyz=on
#auto_explain.log_verbose=on
#auto_explain.log_nested_statements=on</p>
<p>insert into a select mod(g, 3), g from generate_series(1,100000) g;
create</p>
<p>create table b (a int, b int, c int, d int, e int);
create index idxaa on b (mod(b, 2)) include (b,c,d);
insert into b select g, mod(g, 3),mod(g, 3),mod(g, 3), g from generate_series(1,100000) g;</p>
<p>ideas
&ndash; pg_stat_activity 分布式</p>
<p>100a+10b+c + 100c+10b+a =
101a+20b+101c = 4 100 + 4 10 + 3
303 - 101c +20b+101c
303 + 20b
a+c = 3
a = 3-c 303 - 101c</p>
<p>openGauss 完成了 XID 64位的改造，其他人就不必再头疼事务号回卷问题，又例如 openGauss 通过 Ustore 增加了Undo机制，解决了空间膨胀和收缩的 Vacuum 问题，再例如区块链表的实现追平了Oracle 21c在这一方向的创新。这就是众志和开源的力量。</p>
<p>pg中的xlog日志是在写满后才会分配下一个日志，这样带来的问题是在操作系统写一个16M的xlog日志时会有等待，那时候可能会卡一下，这也是为什么pg在做并发insert测试的时候性能抖动的原因。</p>
<p>openGauss支持了列存表，通过cstore_buffers控制列存缓冲区大小，列存表支持压缩。并且当前版本的高斯优化了列存表的并发插入性能，解决了插入时一行数据占一个cu造成空间急剧膨胀的问题。通过开启enable_delta_store参数控制列存表的插入使用临时表向主表merge的方式进行，既保证了性能，也解决了膨胀的问题</p>
<p>SQL by pas s</p>
<h2 id=buffer-manager>
Buffer Manager
<a href=#buffer-manager class=h-anchor aria-hidden=true>#</a>
</h2>
<p>ReadBuffer_common(SMgrRelation smgr, char relpersistence, ForkNumber forkNum, BlockNumber blockNum, ReadBufferMode mode, BufferAccessStrategy strategy, _Bool * hit) (\home\esoye\postgres\src\backend\storage\buffer\bufmgr.c:827)
ReadBufferExtended(Relation reln, ForkNumber forkNum, BlockNumber blockNum, ReadBufferMode mode, BufferAccessStrategy strategy) (\home\esoye\postgres\src\backend\storage\buffer\bufmgr.c:780)
heapgetpage(TableScanDesc sscan, BlockNumber page) (\home\esoye\postgres\src\backend\access\heap\heapam.c:402)
heapgettup_pagemode(HeapScanDesc scan, ScanDirection dir, int nkeys, ScanKey key) (\home\esoye\postgres\src\backend\access\heap\heapam.c:901)
heap_getnextslot(TableScanDesc sscan, ScanDirection direction, TupleTableSlot * slot) (\home\esoye\postgres\src\backend\access\heap\heapam.c:1352)
table_scan_getnextslot(TableScanDesc sscan, ScanDirection direction, TupleTableSlot * slot) (\home\esoye\postgres\src\include\access\tableam.h:1046)
SeqNext(SeqScanState * node) (\home\esoye\postgres\src\backend\executor\nodeSeqscan.c:80)
ExecScanFetch(ScanState * node, ExecScanAccessMtd accessMtd, ExecScanRecheckMtd recheckMtd) (\home\esoye\postgres\src\backend\executor\execScan.c:133)
ExecScan(ScanState * node, ExecScanAccessMtd accessMtd, ExecScanRecheckMtd recheckMtd) (\home\esoye\postgres\src\backend\executor\execScan.c:182)
ExecSeqScan(PlanState * pstate) (\home\esoye\postgres\src\backend\executor\nodeSeqscan.c:112)
ExecProcNodeFirst(PlanState * node) (\home\esoye\postgres\src\backend\executor\execProcnode.c:463)
ExecProcNode(PlanState * node) (\home\esoye\postgres\src\include\executor\executor.h:259)
ExecutePlan(EState * estate, PlanState * planstate, _Bool use_parallel_mode, CmdType operation, _Bool sendTuples, uint64 numberTuples, ScanDirection direction, DestReceiver * dest, _Bool execute_once) (\home\esoye\postgres\src\backend\executor\execMain.c:1636)
standard_ExecutorRun(QueryDesc * queryDesc, ScanDirection direction, uint64 count, _Bool execute_once) (\home\esoye\postgres\src\backend\executor\execMain.c:363)
ExecutorRun(QueryDesc * queryDesc, ScanDirection direction, uint64 count, _Bool execute_once) (\home\esoye\postgres\src\backend\executor\execMain.c:307)
PortalRunSelect(Portal portal, _Bool forward, long count, DestReceiver * dest) (\home\esoye\postgres\src\backend\tcop\pquery.c:924)
PortalRun(Portal portal, long count, _Bool isTopLevel, _Bool run_once, DestReceiver * dest, DestReceiver * altdest, QueryCompletion * qc) (\home\esoye\postgres\src\backend\tcop\pquery.c:768)
exec_simple_query(const char * query_string) (\home\esoye\postgres\src\backend\tcop\postgres.c:1236)
PostgresMain(const char * dbname, const char * username) (\home\esoye\postgres\src\backend\tcop\postgres.c:4549)
BackendRun(Port * port) (\home\esoye\postgres\src\backend\postmaster\postmaster.c:4482)</p>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://select1fromdual.github.io/posts/postgres/xx/>
<span class=button__icon>←</span>
<span class=button__text></span>
</a>
</span>
<span class="button next">
<a href=https://select1fromdual.github.io/posts/postgres/%E9%85%8D%E7%BD%AE/>
<span class=button__text></span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Esoye</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://select1fromdual.github.io/assets/main.js></script>
<script src=https://select1fromdual.github.io/assets/prism.js></script>
</div>
</body>
</html>