<!doctype html><html lang=en>
<head>
<title>
Postgres Executor ::
Asky — My note blog
</title>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Tue Feb 7 10:19:24 CST 2023 重构， 不想文章变成无用的流水线
节点 #  refs #  openGauss数据库源码解析系列文章——执行器解析（二
Postgresql查询执行模块README笔记
执行方式分为两大类，一类是 utility 执行，用于ddl等，底层直接对接某个函数，一类是 dml 算子执行，按树的形式执行，这里关注 dml 算子
总的四大类
 控制节点 扫描节点 物化节点 链接节点  每一个算子分为
 初始化
对应函数以 ExecInitxxx 构造 state 结构体，执行时候使用，exestate 也是树形结构，和 plantree 一一对应，保存运行时的关键信息 打开表或者其他资源 初始化子节点 初始化表达式上下文 初始化表达式 初始化tuple type 初始化project  这里其他的都好理解，但是tuple相关的操作每个算子调用的函数看起来大同小异，但是细节作用不一样 一般 execstats 和 plan tree 是一一对应的，但是也是有例外的，如分区裁剪的时候，确定不需要的分区，init 的时候直接不生成对应的子树的 state   执行 主要的执行逻辑，其中会涉及到表达式的执行 清理 清理资源，之前初始化的时候申请的空间  Rescan command to reset a node and make it generate its output sequence over again.
一个简单总结
 CreateQueryDesc ExecutorStart CreateExecutorState creates per-query context switch to per-query context to run ExecInitNode AfterTriggerBeginQuery ExecInitNode --- recursively scans plan tree ExecInitNode recurse into subsidiary nodes CreateExprContext creates per-tuple context ExecInitExpr ExecutorRun ExecProcNode --- recursively called in per-query context ExecEvalExpr --- called in per-tuple context ResetExprContext --- to free memory ExecutorFinish ExecPostprocessPlan --- run any unfinished ModifyTable nodes AfterTriggerEndQuery ExecutorEnd ExecEndNode --- recursively releases resources FreeExecutorState frees per-query context and child contexts FreeQueryDesc 表达式 #  介绍了pg表达式的具体的运行机制">
<meta name=keywords content="程序员、码农、database、C++">
<meta name=robots content="noodp">
<link rel=canonical href=https://askyx.github.io/posts/postgres_executor/>
<link rel=stylesheet href=//cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.6.0/lxgwwenkaiscreen.css media=print onload="this.media='all'">
<link rel=stylesheet href=https://askyx.github.io/assets/style.css>
<link rel=stylesheet href=https://askyx.github.io/style.css>
<link rel=apple-touch-icon-precomposed sizes=144x144 href=https://askyx.github.io/img/apple-touch-icon-144-precomposed.png>
<link rel="shortcut icon" href=https://askyx.github.io/favicon.ico>
<link rel=apple-touch-icon href=https://askyx.github.io/favicon.ico>
<link rel=bookmark href=https://askyx.github.io/favicon.ico>
<link rel=apple-touch-icon-precomposed sizes=180x180 href=https://askyx.github.io/favicon.ico>
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Postgres Executor">
<meta name=twitter:description content="Postgres 执行器 及其扩展 总结">
<meta property="og:title" content="Postgres Executor">
<meta property="og:description" content="Postgres 执行器 及其扩展 总结">
<meta property="og:type" content="article">
<meta property="og:url" content="https://askyx.github.io/posts/postgres_executor/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2023-02-10T09:26:50+08:00">
<meta property="article:modified_time" content="2023-02-10T09:26:50+08:00">
</head>
<body class=light-theme>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=https://askyx.github.io/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a>
<span class=header__right>
<nav class=menu>
<ul class="menu__inner menu__inner--desktop">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
<li><a href=/search>🔍</a></li>
<li><a href=javascript:; onclick=randomPost() title=随机访问一篇文章><svg t="1660103436159" class="icon search-box-icon" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" p-id="1184" width="32" height="32"><path d="M421.376 481.28s117.248 24.576 175.104-8.704c0 0-89.6 70.144-89.6 166.4.512-.512-8.192-121.344-85.504-157.696zm17.408 487.936s68.608 6.656 68.608-80.896c0 0 3.072 88.576 65.024 78.336.0.512-50.688 22.016-133.632 2.56zM161.28 238.08s-30.208 65.536 11.264 91.648c0 0-67.072-17.408-81.408 37.376.0.0 8.704-82.944 70.144-129.024zM857.6 227.328s49.152 50.176 1.024 81.408c0 0 58.88-18.432 66.56 36.352.0.0 5.12-69.632-67.584-117.76z" p-id="1185"/><path d="M443.392 970.752c-5.632.0-10.752-1.024-15.36-3.072L157.184 810.496l-1.536-1.024s-1.024-1.024-4.608-2.56c-51.2-29.184-62.976-94.208-65.536-120.832V386.56c0-3.072.512-7.168 1.024-11.264l.512-3.584 1.024-2.56c19.456-50.688 76.8-51.2 103.936-44.032l-1.536 5.632 4.096-6.144L476.16 486.4l18.944 37.888c20.992 36.864 29.184 77.824 32.768 99.84v258.048c-4.608 56.32-36.864 76.288-55.808 82.944-1.024.512-15.36 5.632-28.672 5.632zM181.248 774.656l263.168 152.576c12.288-.512 36.864-6.656 40.448-48.128V628.736c-4.608-31.744-20.992-103.936-72.192-128L322.56 445.44l1.536 3.072L181.76 366.08c-2.048-.512-40.448-9.216-52.736 15.872-.512 2.56-.512 4.608-.512 6.144v294.4c1.536 16.896 9.728 67.072 43.52 86.528 3.584 2.048 6.656 4.096 9.216 5.632z" p-id="1186"/><path d="M837.632 212.992c6.656 4.096 12.8 7.168 18.432 10.752l1.536 1.024 1.536 1.536c5.12 4.096 10.752 9.216 16.384 15.36 6.144 11.776 5.632 33.28 4.608 49.152-1.024 12.288-6.656 30.208-26.624 44.544l-1.024.512-247.808 156.672c-26.624 14.336-62.976 18.432-96.256 18.432-40.96.0-77.824-6.656-89.088-8.704l-3.072-.512-245.248-142.336c-39.424-29.696-28.16-85.504-15.36-113.664l2.56-6.144 263.68-166.912c29.184-14.336 104.448-43.008 173.056-1.024 3.584 2.56 58.368 34.304 119.296 69.632M431.616 460.8c40.448 7.168 114.176 13.824 152.576-6.144L828.928 299.52c7.168-5.632 8.192-10.24 8.704-12.8 1.024-11.264-9.728-26.624-15.36-32.768-55.808-32.256-243.712-141.312-250.368-145.408-49.664-30.72-107.008-9.216-130.048 2.56L192.512 268.8c-4.096 12.288-12.288 42.496 3.584 55.808L431.616 460.8z" p-id="1187"/><path d="M831.488 299.008c4.096-1.024 38.4-11.264 66.048 6.144 7.168 4.608 17.92 11.776 24.064 24.576 1.024 5.632 4.096 10.752 4.608 16.896v2.048l-1.024 323.072c-5.12 35.328-22.528 91.648-77.312 125.44l-5.12 3.584h-1.024L579.584 966.656l-4.608.512c-4.096.512-8.704 1.024-12.8 1.024-15.872.0-30.208-5.12-41.984-14.848-24.576-20.48-32.768-55.808-35.328-73.728l-1.024-252.928h1.536c6.144-96.768 88.576-164.864 96.768-171.008l-.512-.512L829.44 299.52M528.384 867.328c.512 10.24 5.12 41.472 19.968 53.76 3.072 2.56 7.68 5.632 16.384 5.12L829.44 758.272c56.32-38.4 53.76-115.712 53.76-116.224l-.512-32.256 1.024-250.368h-.512c-1.536-12.8-7.168-16.384-8.704-17.408-8.704-5.632-23.552-3.072-28.672-2.048L610.304 488.96c-1.024.512-80.896 65.024-80.896 149.504h-1.536l.512 228.864zM435.2 264.192c0 27.648 31.744 50.176 71.168 50.176s71.168-22.528 71.168-50.176-31.744-50.176-71.168-50.176S435.2 236.544 435.2 264.192z" p-id="1188"/><path d="M663.552 782.848c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-50.176-.512-50.176-31.232s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM760.32 602.624c0 30.72-22.528 67.072-49.664 80.384-27.648 13.824-49.664-.512-49.664-31.232s22.528-67.072 49.664-80.384c27.136-13.824 49.664.512 49.664 31.232zM867.84 428.032c0 30.72-22.528 67.072-49.664 80.384C790.528 522.24 768 507.904 768 477.184s22.528-67.072 50.176-80.384c27.136-13.824 49.664.0 49.664 31.232zM270.848 538.112c0 30.72-22.016 41.984-48.64 24.576-27.136-16.896-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528zm161.28 285.184c0 30.72-22.016 41.984-48.64 24.576-26.624-17.408-48.64-55.808-48.64-86.528s22.016-41.984 48.64-24.576c26.624 16.896 48.64 55.808 48.64 86.528z" p-id="1189"/></svg></a></li>
</ul>
<ul class="menu__inner menu__inner--mobile">
<li><a href=/about>About</a></li>
<li><a href=/archive>Archive</a></li>
<li><a href=/search>🔍</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg>
</span>
</span>
</span>
</header>
<div class=content>
<div class=post>
<div class=breadcrumb>
<li>
<a href=https://askyx.github.io/>首页</a>
</li>
<li>
<a href=https://askyx.github.io/posts/>Posts</a>
</li>
<li class=active>
<a href=https://askyx.github.io/posts/postgres_executor/>Postgres Executor</a>
</li>
</div>
<h2 class=post-title><a href=https://askyx.github.io/posts/postgres_executor/>Postgres Executor</a></h2>
<div class=post-meta>
<span class=post-date>
2023-02-10
</span>
</div>
<span class=post-tags>
<a href=https://askyx.github.io/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/>#数据库</a>&nbsp;
<a href=https://askyx.github.io/tags/postgres/>#Postgres</a>&nbsp;
<a href=https://askyx.github.io/tags/%E6%89%A7%E8%A1%8C%E5%99%A8/>#执行器</a>&nbsp;
</span>
<div class=post-content>
<p>Tue Feb 7 10:19:24 CST 2023 重构， 不想文章变成无用的流水线</p>
<h2 id=节点>
节点
<a href=#%e8%8a%82%e7%82%b9 class=h-anchor aria-hidden=true>#</a>
</h2>
<h3 id=refs>
refs
<a href=#refs class=h-anchor aria-hidden=true>#</a>
</h3>
<p><a href=https://zhuanlan.zhihu.com/p/407421928>openGauss数据库源码解析系列文章——执行器解析（二</a><br>
<a href=https://blog.csdn.net/jackgo73/article/details/126604426>Postgresql查询执行模块README笔记</a></p>
<p>执行方式分为两大类，一类是 utility 执行，用于ddl等，底层直接对接某个函数，一类是 dml 算子执行，按树的形式执行，这里关注 dml 算子</p>
<p>总的四大类</p>
<ol>
<li>控制节点</li>
<li>扫描节点</li>
<li>物化节点</li>
<li>链接节点</li>
</ol>
<p>每一个算子分为</p>
<ol>
<li>初始化<br>
对应函数以 ExecInitxxx
构造 state 结构体，执行时候使用，exestate 也是树形结构，和 plantree 一一对应，保存运行时的关键信息
打开表或者其他资源
初始化子节点
初始化表达式上下文
初始化表达式
初始化tuple type
初始化project
<ul>
<li>这里其他的都好理解，但是tuple相关的操作每个算子调用的函数看起来大同小异，但是细节作用不一样</li>
<li>一般 execstats 和 plan tree 是一一对应的，但是也是有例外的，如分区裁剪的时候，确定不需要的分区，init 的时候直接不生成对应的子树的 state</li>
</ul>
</li>
<li>执行
主要的执行逻辑，其中会涉及到表达式的执行</li>
<li>清理
清理资源，之前初始化的时候申请的空间</li>
</ol>
<p>Rescan command to reset a node and make it generate its output sequence over again.</p>
<p><a href=https://www.cnblogs.com/opensource-db/p/15323425.html>一个简单总结</a></p>
<pre tabindex=0><code>  CreateQueryDesc

  ExecutorStart
    CreateExecutorState
      creates per-query context
    switch to per-query context to run ExecInitNode
    AfterTriggerBeginQuery
    ExecInitNode --- recursively scans plan tree
      ExecInitNode
        recurse into subsidiary nodes
      CreateExprContext
        creates per-tuple context
      ExecInitExpr

  ExecutorRun
    ExecProcNode --- recursively called in per-query context
      ExecEvalExpr --- called in per-tuple context
      ResetExprContext --- to free memory

  ExecutorFinish
    ExecPostprocessPlan --- run any unfinished ModifyTable nodes
    AfterTriggerEndQuery

  ExecutorEnd
    ExecEndNode --- recursively releases resources
    FreeExecutorState
      frees per-query context and child contexts

  FreeQueryDesc

</code></pre><h3 id=表达式>
表达式
<a href=#%e8%a1%a8%e8%be%be%e5%bc%8f class=h-anchor aria-hidden=true>#</a>
</h3>
<p><a href=https://blog.csdn.net/jackgo73/article/details/127282902>介绍了pg表达式的具体的运行机制</a><br>
<a href=https://www.cnblogs.com/opensource-db/p/15323425.html>对比不同数据库中表达式机制的实现</a></p>
<ol>
<li>表达式按照数组的形式组织的</li>
<li>表达式尽量在初始化的时候做完所有的准备工作，执行时候只需要执行即可</li>
</ol>
<ul>
<li>重点函数和流程</li>
</ul>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>  CreateExprContext  <span style=color:#f92672>--</span> or use GetPerTupleExprContext(estate)
    creates per<span style=color:#f92672>-</span>tuple context

  ExecPrepareExpr
    temporarily <span style=color:#66d9ef>switch</span> to per<span style=color:#f92672>-</span>query context
    run the expression through expression_planner
    ExecInitExpr

  Repeatedly <span style=color:#66d9ef>do</span><span style=color:#f92672>:</span>
    ExecEvalExprSwitchContext
      ExecEvalExpr <span style=color:#f92672>---</span> called in per<span style=color:#f92672>-</span>tuple context
    ResetExprContext <span style=color:#f92672>---</span> to free memory

  FreeExecutorState
    frees per<span style=color:#f92672>-</span>query context, as well as ExprContext
    (a separate FreeExprContext call is not necessary)

<span style=color:#960050;background-color:#1e0010>其中函数</span>
  ExecInitExpr <span style=color:#960050;background-color:#1e0010>用于初始化表达式，输出为</span> ExprState
  ExecEvalExprSwitchContext <span style=color:#960050;background-color:#1e0010>用于</span> eval <span style=color:#960050;background-color:#1e0010>表达式，输入为</span> ExprState
  <span style=color:#960050;background-color:#1e0010>表达式保存在</span> ExprState.ExprState <span style=color:#960050;background-color:#1e0010>中，使用</span> evalfunc <span style=color:#960050;background-color:#1e0010>执行，</span>evalfunc <span style=color:#960050;background-color:#1e0010>可以有解释和编译执行，当前大部分还是使用</span> ExecInterpExprStillValid <span style=color:#960050;background-color:#1e0010>中函数解释执行，</span>
  <span style=color:#960050;background-color:#1e0010>这里一般使用</span> ExecInterpExpr <span style=color:#960050;background-color:#1e0010>，其他的用在特殊场景，不关注</span>

  ExecInterpExpr <span style=color:#960050;background-color:#1e0010>现在有两种执行逻辑，一种是使用</span> <span style=color:#66d9ef>if</span> <span style=color:#960050;background-color:#1e0010>分支执行，一种是直接使用</span> <span style=color:#66d9ef>goto</span> <span style=color:#960050;background-color:#1e0010>配合</span> swith <span style=color:#960050;background-color:#1e0010>执行，具体在</span> EEO_USE_COMPUTED_GOTO <span style=color:#960050;background-color:#1e0010>定义中</span>
  <span style=color:#66d9ef>goto</span><span style=color:#f92672>:</span>
    <span style=color:#960050;background-color:#1e0010>大意是先</span><span style=color:#66d9ef>switch</span> <span style=color:#960050;background-color:#1e0010>到</span> <span style=color:#960050;background-color:#1e0010>分支，执行之后，然后</span> <span style=color:#960050;background-color:#1e0010>移动到下一个表达式，再</span> <span style=color:#66d9ef>switch</span> <span style=color:#960050;background-color:#1e0010>到具体得分支执行，如此设计可能和</span> cpu <span style=color:#960050;background-color:#1e0010>指令的</span> pipline <span style=color:#960050;background-color:#1e0010>有关</span>

  <span style=color:#960050;background-color:#1e0010>另一种执行方式是使用</span> llvm <span style=color:#960050;background-color:#1e0010>进行编译执行，</span> llvm_compile_expr <span style=color:#960050;background-color:#1e0010>会编译表达式且设置</span> evalfunc <span style=color:#f92672>=</span> ExecRunCompiledExpr

</code></pre></div><p>pg 的 表达式 运行机制有次大改，主要是从 dfs 转换到 bfs ，具体的修改的目的及有点如下， 这里记录下来，<strong>熟记理解，然后在加上codegen和向量化，可以唬人</strong></p>
<pre tabindex=0><code>Faster expression evaluation and targetlist projection.
This replaces the old, recursive tree-walk based evaluation, with non-recursive, opcode dispatch based, expression evaluation. 
Projection is now implemented as part of expression evaluation.
This both leads to significant performance improvements, and makes future just-in-time compilation of expressions easier.

更快的表达式评估和目标列表投影。
这用非递归的、基于操作码分派的表达式求值取代了旧的、基于递归树遍历的求值。
投影现在作为表达式评估的一部分实现。
这既可以显着提高性能，也可以使将来的表达式即时编译变得更容易。

The speed gains primarily come from:
- non-recursive implementation reduces stack usage / overhead
- simple sub-expressions are implemented with a single jump, without function calls
- sharing some state between different sub-expressions
- reduced amount of indirect/hard to predict memory accesses by laying out operation metadata sequentially; including the avoidance of nearly all of the previously used linked lists
- more code has been moved to expression initialization, avoiding constant re-checks at evaluation time

速度增益主要来自：
- 非递归实现减少堆栈使用/开销
- 简单的子表达式通过单次跳转实现，无需函数调用
- 在不同的子表达式之间共享一些状态
- 通过按顺序排列操作元数据来减少间接/难以预测的内存访问量； 包括避免几乎所有以前使用的链表
- 更多代码已移至表达式初始化，避免在评估时不断重新检查


Future just-in-time compilation (JIT) has become easier, as demonstrated by released patches intended to be merged in a later release, for primarily two reasons: Firstly, due to a stricter split between expression initialization and evaluation, less code has to be handled by the JIT. Secondly, due to the non-recursive nature of the generated &quot;instructions&quot;, less performance-critical code-paths can easily be shared between interpreted and compiled evaluation.

未来的即时编译 (JIT) 已经变得更加容易，正如旨在在以后的版本中合并的已发布补丁所证明的那样，主要有两个原因：首先，由于表达式初始化和评估之间的划分更加严格，因此需要更少的代码 由 JIT 处理。 其次，由于生成的“指令”的非递归性质，对性能不太重要的代码路径可以很容易地在解释和编译评估之间共享。


The new framework allows for significant future optimizations. E.g.:
- basic infrastructure for to later reduce the per executor-startup overhead of expression evaluation, by caching state in prepared statements.  That'd be helpful in OLTPish scenarios where initialization overhead is measurable.
- optimizing the generated &quot;code&quot;. A number of proposals for potential work has already been made.
- optimizing the interpreter. Similarly a number of proposals have been made here too.

新框架允许在未来进行重大优化。 例如。：
- 用于稍后通过在准备好的语句中缓存状态来减少表达式评估的每个执行程序启动开销的基本基础架构。 这在初始化开销是可测量的 OLTP 场景中很有帮助。
- 优化生成的“代码”。 已经提出了一些关于潜在工作的建议。
- 优化解释器。 同样，这里也提出了一些建议。


The move of logic into the expression initialization step leads to some backward-incompatible changes:
- Function permission checks are now done during expression initialization, whereas previously they were done during execution. In edge cases this can lead to errors being raised that previously wouldn't have been, e.g. a NULL array being coerced to a different array type previously didn't perform checks.
- The set of domain constraints to be checked, is now evaluated once during expression initialization, previously it was re-built every time a domain check was evaluated. For normal queries this doesn't change much, but e.g. for plpgsql functions, which caches ExprStates, the old set could stick around longer.  The behavior around might still change.

将逻辑转移到表达式初始化步骤会导致一些向后不兼容的更改：
- 函数权限检查现在在表达式初始化期间完成，而以前它们是在执行期间完成的。 在边缘情况下，这可能会导致出现以前不会出现的错误，例如 一个 NULL 数组被强制转换为不同的数组类型，以前没有执行检查。
- 要检查的域约束集现在在表达式初始化期间评估一次，以前每次评估域检查时都会重新构建。 对于普通查询，这并没有太大变化，但是例如 对于缓存 ExprStates 的 plpgsql 函数，旧集合可能会保留更长时间。 周围的行为可能仍然会改变。


</code></pre><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>select <span style=color:#f92672>*</span> from a where a <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>for</span> update
 <span style=color:#f92672>--</span><span style=color:#ae81ff>99.51</span><span style=color:#f92672>%--</span>PortalRun
           <span style=color:#f92672>|</span>
            <span style=color:#f92672>--</span><span style=color:#ae81ff>99.51</span><span style=color:#f92672>%--</span>PortalRunSelect
                      <span style=color:#f92672>|</span>
                       <span style=color:#f92672>--</span><span style=color:#ae81ff>99.50</span><span style=color:#f92672>%--</span>standard_ExecutorRun
                                 <span style=color:#f92672>|</span>
                                  <span style=color:#f92672>--</span><span style=color:#ae81ff>99.47</span><span style=color:#f92672>%--</span>ExecLockRows
                                            <span style=color:#f92672>|</span>
                                             <span style=color:#f92672>--</span><span style=color:#ae81ff>98.45</span><span style=color:#f92672>%--</span>ExecScan
                                                       <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|--</span><span style=color:#ae81ff>55.88</span><span style=color:#f92672>%--</span>ExecInterpExpr
                                                       <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>32.43</span><span style=color:#f92672>%--</span>slot_getsomeattrs_int
                                                       <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>29.48</span><span style=color:#f92672>%--</span>tts_buffer_heap_getsomeattrs
                                                       <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>3.54</span><span style=color:#f92672>%--</span>ExecEvalParamExtern
                                                       <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|--</span><span style=color:#ae81ff>34.60</span><span style=color:#f92672>%--</span>SeqNext
                                                       <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>29.53</span><span style=color:#f92672>%--</span>heap_getnextslot
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|--</span><span style=color:#ae81ff>21.52</span><span style=color:#f92672>%--</span>heapgettup_pagemode
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>12.41</span><span style=color:#f92672>%--</span>heapgetpage
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|--</span><span style=color:#ae81ff>4.04</span><span style=color:#f92672>%--</span>HeapCheckForSerializableConflictOut
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>2.12</span><span style=color:#f92672>%--</span>CheckForSerializableConflictOutNeeded
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.12</span><span style=color:#f92672>%--</span>ReadBufferExtended
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>1.01</span><span style=color:#f92672>%--</span>ReadBuffer_common
                                                       <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>3.79</span><span style=color:#f92672>%--</span>ExecStoreBufferHeapTuple
                                                       <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.70</span><span style=color:#f92672>%--</span>heap_getnextslot
                                                       <span style=color:#f92672>|</span>
                                                       <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.65</span><span style=color:#f92672>%--</span>MemoryContextReset
                                                       <span style=color:#f92672>|</span>
                                                        <span style=color:#f92672>--</span><span style=color:#ae81ff>0.50</span><span style=color:#f92672>%--</span>int4eq


tpch q1 perf
<span style=color:#960050;background-color:#1e0010>简要分析可以看出，大部分操作在</span>hash相关的运算上<span style=color:#960050;background-color:#1e0010>，</span>q1也确实有大量聚合运算<span style=color:#960050;background-color:#1e0010>，这里不知道使用</span> jit <span style=color:#960050;background-color:#1e0010>能否有一定的提升</span>

select
  s_acctbal,
  s_name,
  n_name,
  p_partkey,
  p_mfgr,
  s_address,
  s_phone,
  s_comment
from
  part,
  supplier,
  partsupp,
  nation,
  region
where
  p_partkey <span style=color:#f92672>=</span> ps_partkey
  and s_suppkey <span style=color:#f92672>=</span> ps_suppkey
  and p_size <span style=color:#f92672>=</span> <span style=color:#ae81ff>15</span>
  and p_type like <span style=color:#960050;background-color:#1e0010>&#39;</span><span style=color:#f92672>%</span>BRASS<span style=color:#960050;background-color:#1e0010>&#39;</span>
  and s_nationkey <span style=color:#f92672>=</span> n_nationkey
  and n_regionkey <span style=color:#f92672>=</span> r_regionkey
  and r_name <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>EUROPE<span style=color:#960050;background-color:#1e0010>&#39;</span>
  and ps_supplycost <span style=color:#f92672>=</span> (
    select
      min(ps_supplycost)
    from
      partsupp,
      supplier,
      nation,
      region
    where
      p_partkey <span style=color:#f92672>=</span> ps_partkey
      and s_suppkey <span style=color:#f92672>=</span> ps_suppkey
      and s_nationkey <span style=color:#f92672>=</span> n_nationkey
      and n_regionkey <span style=color:#f92672>=</span> r_regionkey
      and r_name <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&#39;</span>EUROPE<span style=color:#960050;background-color:#1e0010>&#39;</span>
  )
order by
  s_acctbal desc,
  n_name,
  s_name,
  p_partkey limit <span style=color:#ae81ff>100</span>;

<span style=color:#75715e># Total Lost Samples: 0
</span><span style=color:#75715e>#
</span><span style=color:#75715e># Samples: 99K of event &#39;cpu-clock:pppH&#39;
</span><span style=color:#75715e># Event count (approx.): 100006005906
</span><span style=color:#75715e>#
</span><span style=color:#75715e># Children      Self  Command   Shared Object                                 Symbol                                                        
</span><span style=color:#75715e># ........  ........  ........  ............................................  ..............................................................
</span><span style=color:#75715e>#
</span><span style=color:#75715e></span>   <span style=color:#ae81ff>100.00</span><span style=color:#f92672>%</span>     <span style=color:#ae81ff>0.00</span><span style=color:#f92672>%</span>  postgres  <span style=color:#f92672>/</span>usr<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>x86_64<span style=color:#f92672>-</span>linux<span style=color:#f92672>-</span>gnu<span style=color:#f92672>/</span>libc<span style=color:#f92672>-</span><span style=color:#ae81ff>2.31</span>.so        <span style=color:#ae81ff>0x7fe4b684e083</span>     D [.] putenv
            <span style=color:#f92672>|</span>
            <span style=color:#f92672>---</span>putenv
               startup_hacks
               PostmasterMain
               ServerLoop
               BackendStartup
               ExitPostmaster
               PostgresMain
               exec_simple_query
               PortalRun
               PortalRunSelect
               ExecutorRun
               standard_ExecutorRun
               ExecutePlan
               ExecProcNode
               ExecProcNodeFirst
               ExecSort
               ExecProcNode
               ExecProcNodeFirst
               ExecAgg
               <span style=color:#f92672>|</span>          
                <span style=color:#f92672>--</span><span style=color:#ae81ff>99.98</span><span style=color:#f92672>%--</span>agg_fill_hash_table
                          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|--</span><span style=color:#ae81ff>67.56</span><span style=color:#f92672>%--</span>advance_aggregates
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>67.35</span><span style=color:#f92672>%--</span>ExecEvalExprSwitchContext
                          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>66.93</span><span style=color:#f92672>%--</span>ExecInterpExpr
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|--</span><span style=color:#ae81ff>26.72</span><span style=color:#f92672>%--</span>numeric_mul
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>23.48</span><span style=color:#f92672>%--</span>numeric_mul_opt_error
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>14.06</span><span style=color:#f92672>%--</span>mul_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.89</span><span style=color:#f92672>%--</span>pfree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.63</span><span style=color:#f92672>%--</span>AllocSetFree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.54</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.43</span><span style=color:#f92672>%--</span>alloc_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.82</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.15</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.98</span><span style=color:#f92672>%--</span>palloc0
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.14</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.03</span><span style=color:#f92672>%--</span>round_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>0.85</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.51</span><span style=color:#f92672>%--</span>strip_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>3.57</span><span style=color:#f92672>%--</span>make_result_opt_error
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.80</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.30</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>3.34</span><span style=color:#f92672>%--</span>free_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>2.91</span><span style=color:#f92672>%--</span>pfree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.74</span><span style=color:#f92672>%--</span>AllocSetFree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.56</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.10</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.51</span><span style=color:#f92672>%--</span>__nss_disable_nscd
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.13</span><span style=color:#f92672>%--</span>pg_detoast_datum
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.67</span><span style=color:#f92672>%--</span>detoast_attr
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.13</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.75</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.61</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|--</span><span style=color:#ae81ff>13.61</span><span style=color:#f92672>%--</span>numeric_sub
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>10.80</span><span style=color:#f92672>%--</span>numeric_sub_opt_error
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>4.12</span><span style=color:#f92672>%--</span>sub_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>3.20</span><span style=color:#f92672>%--</span>sub_abs
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.26</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.91</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.76</span><span style=color:#f92672>%--</span>make_result_opt_error
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.43</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.10</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.29</span><span style=color:#f92672>%--</span>free_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.92</span><span style=color:#f92672>%--</span>pfree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.25</span><span style=color:#f92672>%--</span>AllocSetFree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.76</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>2.02</span><span style=color:#f92672>%--</span>pg_detoast_datum
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.55</span><span style=color:#f92672>%--</span>detoast_attr
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>1.05</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                            <span style=color:#f92672>--</span><span style=color:#ae81ff>0.78</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|--</span><span style=color:#ae81ff>13.50</span><span style=color:#f92672>%--</span>ExecAggPlainTransByVal
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>10.34</span><span style=color:#f92672>%--</span>numeric_avg_accum
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>5.83</span><span style=color:#f92672>%--</span>do_numeric_accum
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.07</span><span style=color:#f92672>%--</span>accum_sum_add
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.95</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.71</span><span style=color:#f92672>%--</span>__nss_disable_nscd
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>3.04</span><span style=color:#f92672>%--</span>pg_detoast_datum
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>2.46</span><span style=color:#f92672>%--</span>detoast_attr
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>1.62</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>1.13</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.58</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.10</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.58</span><span style=color:#f92672>%--</span>__nss_disable_nscd
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|--</span><span style=color:#ae81ff>6.32</span><span style=color:#f92672>%--</span>numeric_add
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>5.07</span><span style=color:#f92672>%--</span>numeric_add_opt_error
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.12</span><span style=color:#f92672>%--</span>add_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.96</span><span style=color:#f92672>%--</span>add_abs
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.70</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.50</span><span style=color:#f92672>%--</span>AllocSetAlloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.21</span><span style=color:#f92672>%--</span>make_result_opt_error
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.57</span><span style=color:#f92672>%--</span>palloc
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.97</span><span style=color:#f92672>%--</span>free_var
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.86</span><span style=color:#f92672>%--</span>pfree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.50</span><span style=color:#f92672>%--</span>AllocSetFree
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.91</span><span style=color:#f92672>%--</span>pg_detoast_datum
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.68</span><span style=color:#f92672>%--</span>detoast_attr
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|--</span><span style=color:#ae81ff>1.65</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.54</span><span style=color:#f92672>%--</span>__nss_disable_nscd
                          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|--</span><span style=color:#ae81ff>18.34</span><span style=color:#f92672>%--</span>lookup_hash_entries
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>16.52</span><span style=color:#f92672>%--</span>LookupTupleHashEntry
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>8.86</span><span style=color:#f92672>%--</span>LookupTupleHashEntry_internal
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>8.70</span><span style=color:#f92672>%--</span>tuplehash_insert_hash
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>8.52</span><span style=color:#f92672>%--</span>tuplehash_insert_hash_internal
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>7.82</span><span style=color:#f92672>%--</span>TupleHashTableMatch
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|--</span><span style=color:#ae81ff>6.93</span><span style=color:#f92672>%--</span>ExecQualAndReset
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>6.54</span><span style=color:#f92672>%--</span>ExecQual
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>6.40</span><span style=color:#f92672>%--</span>ExecEvalExprSwitchContext
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>6.00</span><span style=color:#f92672>%--</span>ExecInterpExpr
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.58</span><span style=color:#f92672>%--</span>bpchareq
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          <span style=color:#f92672>|--</span><span style=color:#ae81ff>0.83</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.79</span><span style=color:#f92672>%--</span>bcTruelen
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                            <span style=color:#f92672>--</span><span style=color:#ae81ff>1.31</span><span style=color:#f92672>%--</span>slot_getsomeattrs
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                                      <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                                       <span style=color:#f92672>--</span><span style=color:#ae81ff>1.15</span><span style=color:#f92672>%--</span>slot_getsomeattrs_int
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                                                 <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                                                  <span style=color:#f92672>--</span><span style=color:#ae81ff>0.94</span><span style=color:#f92672>%--</span>tts_minimal_getsomeattrs
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                                                            <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                                                             <span style=color:#f92672>--</span><span style=color:#ae81ff>0.80</span><span style=color:#f92672>%--</span>slot_deform_heap_tuple
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                                            <span style=color:#f92672>--</span><span style=color:#ae81ff>0.58</span><span style=color:#f92672>%--</span>ExecStoreMinimalTuple
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>6.96</span><span style=color:#f92672>%--</span>TupleHashTableHash_internal
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|--</span><span style=color:#ae81ff>4.98</span><span style=color:#f92672>%--</span>FunctionCall1Coll
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>4.42</span><span style=color:#f92672>%--</span>hashbpchar
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|--</span><span style=color:#ae81ff>2.26</span><span style=color:#f92672>%--</span>hash_any
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.97</span><span style=color:#f92672>%--</span>hash_bytes
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.73</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.73</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.52</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.22</span><span style=color:#f92672>%--</span>prepare_hash_slot
                          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.53</span><span style=color:#f92672>%--</span>ExecClearTuple
                          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|--</span><span style=color:#ae81ff>12.30</span><span style=color:#f92672>%--</span>fetch_input_tuple
                          <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>12.10</span><span style=color:#f92672>%--</span>ExecProcNode
                          <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>11.93</span><span style=color:#f92672>%--</span>ExecSeqScan
                          <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>11.74</span><span style=color:#f92672>%--</span>ExecScan
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|--</span><span style=color:#ae81ff>5.89</span><span style=color:#f92672>%--</span>ExecQual
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>5.72</span><span style=color:#f92672>%--</span>ExecEvalExprSwitchContext
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>5.29</span><span style=color:#f92672>%--</span>ExecInterpExpr
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|--</span><span style=color:#ae81ff>3.57</span><span style=color:#f92672>%--</span>slot_getsomeattrs
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>3.42</span><span style=color:#f92672>%--</span>slot_getsomeattrs_int
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>3.13</span><span style=color:#f92672>%--</span>tts_buffer_heap_getsomeattrs
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>2.97</span><span style=color:#f92672>%--</span>slot_deform_heap_tuple
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>                                            <span style=color:#f92672>--</span><span style=color:#ae81ff>0.67</span><span style=color:#f92672>%--</span>__nss_database_lookup2
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.59</span><span style=color:#f92672>%--</span>date_le_timestamp
                          <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                            <span style=color:#f92672>--</span><span style=color:#ae81ff>5.34</span><span style=color:#f92672>%--</span>ExecScanFetch
                          <span style=color:#f92672>|</span>                                                      <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                       <span style=color:#f92672>--</span><span style=color:#ae81ff>5.18</span><span style=color:#f92672>%--</span>SeqNext
                          <span style=color:#f92672>|</span>                                                                 <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                  <span style=color:#f92672>--</span><span style=color:#ae81ff>4.87</span><span style=color:#f92672>%--</span>table_scan_getnextslot
                          <span style=color:#f92672>|</span>                                                                            <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                             <span style=color:#f92672>--</span><span style=color:#ae81ff>4.56</span><span style=color:#f92672>%--</span>heap_getnextslot
                          <span style=color:#f92672>|</span>                                                                                       <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                        <span style=color:#f92672>--</span><span style=color:#ae81ff>3.82</span><span style=color:#f92672>%--</span>heapgettup_pagemode
                          <span style=color:#f92672>|</span>                                                                                                  <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                   <span style=color:#f92672>--</span><span style=color:#ae81ff>2.50</span><span style=color:#f92672>%--</span>heapgetpage
                          <span style=color:#f92672>|</span>                                                                                                             <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                              <span style=color:#f92672>--</span><span style=color:#ae81ff>1.56</span><span style=color:#f92672>%--</span>ReadBufferExtended
                          <span style=color:#f92672>|</span>                                                                                                                        <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                         <span style=color:#f92672>--</span><span style=color:#ae81ff>1.55</span><span style=color:#f92672>%--</span>ReadBuffer_common
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|--</span><span style=color:#ae81ff>0.79</span><span style=color:#f92672>%--</span>smgrread
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>          <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>           <span style=color:#f92672>--</span><span style=color:#ae81ff>0.78</span><span style=color:#f92672>%--</span>mdread
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                     <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.75</span><span style=color:#f92672>%--</span>__libc_pread64
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.74</span><span style=color:#f92672>%--</span>entry_SYSCALL_64_after_hwframe
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                           do_syscall_64
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                           <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                            <span style=color:#f92672>--</span><span style=color:#ae81ff>0.71</span><span style=color:#f92672>%--</span>ksys_pread64
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                      <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                       <span style=color:#f92672>--</span><span style=color:#ae81ff>0.69</span><span style=color:#f92672>%--</span>vfs_read
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                 <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                  <span style=color:#f92672>--</span><span style=color:#ae81ff>0.67</span><span style=color:#f92672>%--</span>new_sync_read
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                            <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                             <span style=color:#f92672>--</span><span style=color:#ae81ff>0.66</span><span style=color:#f92672>%--</span>filemap_read
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                                       <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                                        <span style=color:#f92672>--</span><span style=color:#ae81ff>0.52</span><span style=color:#f92672>%--</span>copy_page_to_iter
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                                                  <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                                                   <span style=color:#f92672>--</span><span style=color:#ae81ff>0.51</span><span style=color:#f92672>%--</span>copyout
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>                                                                                                             copy_user_enhanced_fast_string
                          <span style=color:#f92672>|</span>                                                                                                                                   <span style=color:#f92672>|</span>          
                          <span style=color:#f92672>|</span>                                                                                                                                    <span style=color:#f92672>--</span><span style=color:#ae81ff>0.65</span><span style=color:#f92672>%--</span>BufferAlloc
                          <span style=color:#f92672>|</span>          
                           <span style=color:#f92672>--</span><span style=color:#ae81ff>1.17</span><span style=color:#f92672>%--</span>MemoryContextReset
                                     <span style=color:#f92672>|</span>          
                                      <span style=color:#f92672>--</span><span style=color:#ae81ff>0.85</span><span style=color:#f92672>%--</span>MemoryContextResetOnly
                                                <span style=color:#f92672>|</span>          
                                                 <span style=color:#f92672>--</span><span style=color:#ae81ff>0.57</span><span style=color:#f92672>%--</span>AllocSetReset

</code></pre></div><h3 id=cluster-算子>
Cluster 算子
<a href=#cluster-%e7%ae%97%e5%ad%90 class=h-anchor aria-hidden=true>#</a>
</h3>
<h4 id=clustergather>
ClusterGather
<a href=#clustergather class=h-anchor aria-hidden=true>#</a>
</h4>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>ExecInitClusterGather() {
  gatherstate<span style=color:#f92672>-&gt;</span>ps.ExecProcNode <span style=color:#f92672>=</span> ExecClusterGather;

  <span style=color:#75715e>// 主要是构造 PlanState
</span><span style=color:#75715e></span>  outerPlanState(gatherstate) <span style=color:#f92672>=</span> ExecStartClusterPlan() { <span style=color:#75715e>//分发执行计划 {}
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 只是explan 的话，并不需要发送执行计划。直接这里返回即可
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (EXEC_FLAG_EXPLAIN_ONLY)
      <span style=color:#66d9ef>return</span> ExecInitNode(plan, estate, eflags);
    
    <span style=color:#75715e>// 执行计划需要传输到其他节点，需要进行序列化，当前序列化操作使用的是查表的方法，可以不关注先后顺序，使用flag遍历查找，主要方法在mem_toc.h中
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 针对不同的类型的数据的序列化和反序列化也是后来实现的
</span><span style=color:#75715e></span>    StartRemotePlan() {
      <span style=color:#75715e>// 发送执行计划到远程节点
</span><span style=color:#75715e></span>      foreach(lc, state<span style=color:#f92672>-&gt;</span>cur_handle<span style=color:#f92672>-&gt;</span>handles) {
        PQsendPlan() 
      }

      PG_TRY() {
        <span style=color:#75715e>// 如果执行计划中由reduce 节点，则启动 StartDynamicReduceWorker
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>if</span> (context<span style=color:#f92672>-&gt;</span>have_reduce <span style=color:#f92672>&amp;&amp;</span> context<span style=color:#f92672>-&gt;</span>start_self_reduce) {
          StartDynamicReduceWorker();
        }

        <span style=color:#75715e>// 并且接收dn的消息，查看dn状态是否正常
</span><span style=color:#75715e></span>        foreach(lc, list_conn) {
          PQgetResult(conn);
        }
      }

      <span style=color:#75715e>// 作用未知
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (context<span style=color:#f92672>-&gt;</span>have_reduce) {
        StartRemoteReduceGroup();
      }
    }
    <span style=color:#75715e>// 初始化下层节点，这里cn上其实应该只有一个 cluster gather 及之上的算子起作用才对，但是实际上下层节点中如果存在reduce 节点，且 如果 优化中选择再 cn 进行 reduce ，则下层还是会进行一些reduce 相关得操作，
</span><span style=color:#75715e></span>    <span style=color:#75715e>// 包括上面reduce 得一些设置
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>ExecInitNode</span>(plan, estate, eflags);
  } 
}

ExecClusterGather() {
  <span style=color:#75715e>// 获得下层节点的数据，这里分为两个不同的部分，先尝试从remote获得的数据，再尝试local的执行计划
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>while</span>(node<span style=color:#f92672>-&gt;</span>remote_running <span style=color:#f92672>!=</span> NIL <span style=color:#f92672>||</span> node<span style=color:#f92672>-&gt;</span>local_end <span style=color:#f92672>==</span> false) {
    <span style=color:#66d9ef>if</span>(node<span style=color:#f92672>-&gt;</span>remote_running <span style=color:#f92672>!=</span> NIL <span style=color:#f92672>&amp;&amp;</span> PQNListExecFinish(node<span style=color:#f92672>-&gt;</span>remote_running, NULL, <span style=color:#f92672>&amp;</span>node<span style=color:#f92672>-&gt;</span>hook_funcs, blocking)) {
      <span style=color:#75715e>// PQNListExecFinish 负责获取dn上得数据，这里 remote_running 记录的是运行中的dn，如果dn 运行结束，则加入到 last_run_end ，后续会从 remote_running 中剔除 运行结束的dn
</span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> node<span style=color:#f92672>-&gt;</span>ps.ps_ResultTupleSlot;
    }

    <span style=color:#75715e>// 获取cn上的数据
</span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span>(node<span style=color:#f92672>-&gt;</span>local_end <span style=color:#f92672>==</span> false) {
      slot <span style=color:#f92672>=</span> ExecProcNode(outerPlanState(node));
    }
  }

}


ExecFinishClusterGather() {
  <span style=color:#75715e>// 清理工作
</span><span style=color:#75715e></span>}

</code></pre></div><h4 id=clustermergegather>
ClusterMergeGather
<a href=#clustermergegather class=h-anchor aria-hidden=true>#</a>
</h4>
<p>功能和 ClusterGather 类似，但是会对 dn 收集的 数据进行排序， 在优化阶段中，如果语句最终的输出需要排序，则在构造顶层节点的时候，会生成 sort 算子，然后在生成 ClusterMergeGather 算子
ClusterMergeGather plan 中，dn的输出一定是有序的</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>ExecInitClusterMergeGather() {
  ps<span style=color:#f92672>-&gt;</span>ps.ExecProcNode <span style=color:#f92672>=</span> ExecClusterMergeGather;
  <span style=color:#75715e>// 使用 ExecStartClusterPlan 初始化的 planstat
</span><span style=color:#75715e></span>  outerPlanState(ps) <span style=color:#f92672>=</span> ExecStartClusterPlan();

  <span style=color:#75715e>// 如果是需要排序输出，则在初始化 slot 的时候，需要使用 sort tuple 相关的函数，具体参考 tuplesort_begin_heap
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span>(i<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>;i<span style=color:#f92672>&lt;</span>node<span style=color:#f92672>-&gt;</span>numCols;<span style=color:#f92672>++</span>i) {
    PrepareSortSupportFromOrderingOp();
  }
}

ExecClusterMergeGather() {
  <span style=color:#75715e>// 获得元组，然后进行排序，这里也区分cn和dn混合使用 ExecProcNode 和 cmg_get_remote_slot
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 其中 cmg_get_remote_slot 实际调用的是 PQNOneExecFinish
</span><span style=color:#75715e></span>  <span style=color:#75715e>// 之后使用 binaryheap***进行排序
</span><span style=color:#75715e></span>}


ExecFinishClusterMergeGather() {
  <span style=color:#75715e>// 清理工作
</span><span style=color:#75715e></span>}
</code></pre></div><h4 id=clusterreduce>
ClusterReduce
<a href=#clusterreduce class=h-anchor aria-hidden=true>#</a>
</h4>
<p>recuce 用于在cn 和 dn， dn 和 dn 之间传递数据，并且还会启动 一个 新进程负责此工作，这里简单梳理</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++>
<span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>ReduceType</span>
{
  RT_NOTHING <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>,                 <span style=color:#75715e>// 不执行reduce 
</span><span style=color:#75715e></span>  RT_NORMAL,                      <span style=color:#75715e>// 常规reduce
</span><span style=color:#75715e></span>  RT_REDUCE_FIRST,                <span style=color:#75715e>// 优点向上发送数据而不是向其他节点
</span><span style=color:#75715e></span>  RT_REDUCE_FIRST_EPQ,            <span style=color:#75715e>// EPQ EvalPlanQual，子链接 中的子查询
</span><span style=color:#75715e></span>  RT_PARALLEL_REDUCE_FIRST,       <span style=color:#75715e>//
</span><span style=color:#75715e></span>  RT_ADVANCE,                     <span style=color:#75715e>// 提前进行reduce
</span><span style=color:#75715e></span>  RT_ADVANCE_PARALLEL,
  RT_MERGE                        <span style=color:#75715e>// reduce 要求有序
</span><span style=color:#75715e></span>}ReduceType;

<span style=color:#75715e>#define CRF_FETCH_LOCAL_FIRST  0x0001  </span><span style=color:#75715e>/* fetch all local first */</span><span style=color:#75715e>          </span><span style=color:#75715e>// 
</span><span style=color:#75715e></span><span style=color:#75715e>#define CRF_DISK_UNNECESSARY  0x0002  </span><span style=color:#75715e>/* don&#39;t need cache on disk */</span><span style=color:#75715e>
</span><span style=color:#75715e>#define CRF_DISK_ALWAYS      0x0004  </span><span style=color:#75715e>/* always cache tuples on disk */</span><span style=color:#75715e>
</span><span style=color:#75715e>#define CRF_MAYBE_EPQ      0x0008  </span><span style=color:#75715e>/* maybe execute in EPQ */</span><span style=color:#75715e>
</span><span style=color:#75715e></span>
ExecInitClusterReduce() {

  crstate<span style=color:#f92672>-&gt;</span>ps.ExecProcNode <span style=color:#f92672>=</span> ExecDefaultClusterReduce;

  <span style=color:#75715e>// 如果有 PGXCNodeOid ，则设置 模式为 RT_NOTHING
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (list_member_oid(node<span style=color:#f92672>-&gt;</span>reduce_oids, PGXCNodeOid) <span style=color:#f92672>==</span> false)
    crstate<span style=color:#f92672>-&gt;</span>reduce_method <span style=color:#f92672>=</span> (uint8)RT_NOTHING;
  <span style=color:#75715e>// 如果要求排序，则 设置 为 RT_MERGE，numCols 大致指得是需要排序的列得数量
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (node<span style=color:#f92672>-&gt;</span>numCols <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
    crstate<span style=color:#f92672>-&gt;</span>reduce_method <span style=color:#f92672>=</span> (uint8)RT_MERGE;
  <span style=color:#75715e>// 判断需要优先执行reduce
</span><span style=color:#75715e></span>  <span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (node<span style=color:#f92672>-&gt;</span>reduce_flags <span style=color:#f92672>&amp;</span> (CRF_FETCH_LOCAL_FIRST<span style=color:#f92672>|</span>CRF_DISK_ALWAYS) <span style=color:#f92672>||</span>
       crstate<span style=color:#f92672>-&gt;</span>eflags <span style=color:#f92672>!=</span> <span style=color:#ae81ff>0</span>)
    crstate<span style=color:#f92672>-&gt;</span>reduce_method <span style=color:#f92672>=</span> (uint8)RT_REDUCE_FIRST;
  <span style=color:#66d9ef>else</span>
    crstate<span style=color:#f92672>-&gt;</span>reduce_method <span style=color:#f92672>=</span> (uint8)RT_NORMAL;

  <span style=color:#66d9ef>if</span> ((eflags <span style=color:#f92672>&amp;</span> EXEC_FLAG_IN_EPQ) <span style=color:#f92672>&amp;&amp;</span>
    crstate<span style=color:#f92672>-&gt;</span>reduce_method <span style=color:#f92672>!=</span> RT_NOTHING)
    crstate<span style=color:#f92672>-&gt;</span>ps.ExecProcNode <span style=color:#f92672>=</span> ExecEPQDefaultClusterReduce;
}

<span style=color:#75715e>// ExecProcNodeReal 函数指针， ExecDefaultClusterReduce 和  ExecEPQDefaultClusterReduce 都只是一个warpper， 调用的时候，会按照不同reduce 策略，调用不同的 init 函数， 对函数指针赋值
</span><span style=color:#75715e></span>
<span style=color:#75715e>// 默认的reduce 函数
</span><span style=color:#75715e></span>ExecDefaultClusterReduce() {
  ClusterReduceState <span style=color:#f92672>*</span>crstate <span style=color:#f92672>=</span> castNode(ClusterReduceState, pstate);
  <span style=color:#66d9ef>if</span> (crstate<span style=color:#f92672>-&gt;</span>private_state <span style=color:#f92672>!=</span> NULL)
    <span style=color:#66d9ef>return</span> pstate<span style=color:#f92672>-&gt;</span>ExecProcNodeReal(pstate);

  InitReduceMethod(crstate);

  <span style=color:#66d9ef>return</span> pstate<span style=color:#f92672>-&gt;</span>ExecProcNodeReal(pstate);
}

<span style=color:#75715e>// EPQ reduce
</span><span style=color:#75715e></span>ExecEPQDefaultClusterReduce() {
  <span style=color:#66d9ef>switch</span>(origin<span style=color:#f92672>-&gt;</span>reduce_method) {
    <span style=color:#66d9ef>case</span> RT_REDUCE_FIRST:
      InitEPQReduceFirst(node, origin);
    <span style=color:#66d9ef>case</span> RT_MERGE:
      InitEPQMergeReduce(node, origin);
    <span style=color:#66d9ef>case</span> RT_ADVANCE:
      InitEPQAdvanceReduce(node, origin);
  }

  <span style=color:#66d9ef>return</span> pstate<span style=color:#f92672>-&gt;</span>ExecProcNodeReal(pstate);
}

<span style=color:#66d9ef>void</span> <span style=color:#a6e22e>InitReduceMethod</span>(ClusterReduceState <span style=color:#f92672>*</span>crstate) {
  <span style=color:#66d9ef>switch</span>(crstate<span style=color:#f92672>-&gt;</span>reduce_method) {
    <span style=color:#66d9ef>case</span> RT_NOTHING:
      <span style=color:#75715e>// 设置 ExecProcNodeReal 为 ExecNothingReduce， 内部不具体得任务
</span><span style=color:#75715e></span>      ExecSetExecProcNode(<span style=color:#f92672>&amp;</span>crstate<span style=color:#f92672>-&gt;</span>ps, ExecNothingReduce);
    <span style=color:#66d9ef>case</span> RT_NORMAL:
      InitNormalReduce(crstate);
    <span style=color:#66d9ef>case</span> RT_REDUCE_FIRST:
      InitReduceFirst(crstate);
    <span style=color:#66d9ef>case</span> RT_MERGE:
      InitMergeReduce(crstate);
  }
}



</code></pre></div><h4 id=execinitreducescan>
ExecInitReduceScan
<a href=#execinitreducescan class=h-anchor aria-hidden=true>#</a>
</h4>
</div>
<div class=pagination>
<div class=pagination__title>
<span class=pagination__title-h>Read other posts</span>
<hr>
</div>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://askyx.github.io/posts/cost/>
<span class=button__icon>←</span>
<span class=button__text>执行计划代价计算规则梳理</span>
</a>
</span>
<span class="button next">
<a href=https://askyx.github.io/posts/tx/>
<span class=button__text>事务知识简记</span>
<span class=button__icon>→</span>
</a>
</span>
</div>
</div>
</div>
</div>
<footer class=footer>
<div class=footer__inner>
<a href=https://askyx.github.io/ class=logo style=text-decoration:none>
<span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg>
</span>
<span class=logo__text>Asky</span>
<span class=logo__cursor></span>
</a>
<div class=copyright>
<span>© 2024 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span>
</div>
</div>
</footer>
<script src=https://askyx.github.io/assets/main.js></script>
<script src=https://askyx.github.io/assets/prism.js></script>
</div>
</body>
</html>