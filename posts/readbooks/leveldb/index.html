<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>LevelDBÊ∫êÁ†ÅÈòÖËØª | Askyx's Blog</title><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>üå±</text></svg>"></link>
<link rel=canonical href=https://askyx.github.io/posts/readbooks/leveldb/><meta name=author content="Askyx"><meta name=description content="leveldb Ê∫êÁ†ÅÊÄªÁªìÂàÜÊûê"><meta name=keywords content="Ê∫êÁ†ÅÈòÖËØª,LevelDB,Â≠òÂÇ®ÂºïÊìé"><meta name=generator content="Hugo 0.148.1"><meta property="og:url" content="https://askyx.github.io/posts/readbooks/leveldb/"><meta property="og:site_name" content="Askyx's Blog"><meta property="og:title" content="LevelDBÊ∫êÁ†ÅÈòÖËØª"><meta property="og:description" content="leveldb Ê∫êÁ†ÅÊÄªÁªìÂàÜÊûê"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-15T21:59:53+08:00"><meta property="article:modified_time" content="2025-07-18T17:05:11+08:00"><meta property="article:tag" content="Ê∫êÁ†ÅÈòÖËØª"><meta property="article:tag" content="LevelDB"><meta property="article:tag" content="Â≠òÂÇ®ÂºïÊìé"><meta property="og:image" content="https://askyx.github.io/img/global-background.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://askyx.github.io/img/global-background.jpg"><meta name=twitter:title content="LevelDBÊ∫êÁ†ÅÈòÖËØª"><meta name=twitter:description content="leveldb Ê∫êÁ†ÅÊÄªÁªìÂàÜÊûê"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><link rel=stylesheet href=/css/custom.css><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title="Flip it!"><div class="h-10 rounded-full"><img src=/img/personal/avatar.jpg alt="Askyx's Blog"></div></div><div><a href=https://askyx.github.io/ class="text-lg font-semibold cursor-pointer">Askyx's Blog</a><div class="text-base-content/60 text-sm">life is short, use Python</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=About><ion-icon name=information-circle></ion-icon>About</div></li><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=Search><ion-icon name=search></ion-icon>Search</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=https://github.com/askyx target=_blank title=GitHub><ion-icon name=logo-github></ion-icon>GitHub</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=About>About</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=Search><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=https://github.com/askyx target=_blank title=GitHub><ion-icon class=group-hover:text-primary-content name=logo-github></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="LevelDBÊ∫êÁ†ÅÈòÖËØª"><meta itemprop=description content="leveldb Ê∫êÁ†ÅÊÄªÁªìÂàÜÊûê"><meta itemprop=datePublished content="2022-05-15T21:59:53+08:00"><meta itemprop=dateModified content="2025-07-18T17:05:11+08:00"><meta itemprop=wordCount content="7998"><meta itemprop=image content="https://askyx.github.io/img/global-background.jpg"><meta itemprop=keywords content="Ê∫êÁ†ÅÈòÖËØª,LevelDB,Â≠òÂÇ®ÂºïÊìé"><header><h1 itemprop=headline>LevelDBÊ∫êÁ†ÅÈòÖËØª</h1><p class=text-sm><span data-format=luxon>2022-05-15T21:59:53+08:00</span>
| <span>16 minute read</span>
| <span>Updated at
<span data-format=luxon>2025-07-18T17:05:11+08:00</span></span></p></header><section id=dream-single-post-content itemprop=articleBody><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>LevelDB:    version <span style=color:#ae81ff>1.23</span>
</span></span><span style=display:flex><span>Date:       Thu Oct <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#f92672>:</span><span style=color:#ae81ff>32</span><span style=color:#f92672>:</span><span style=color:#ae81ff>47</span> <span style=color:#ae81ff>2022</span>
</span></span><span style=display:flex><span>CPU:        <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> AMD Ryzen <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>5900</span>HS with Radeon Graphics
</span></span><span style=display:flex><span>CPUCache:   <span style=color:#ae81ff>512</span> KB
</span></span><span style=display:flex><span>Keys:       <span style=color:#ae81ff>16</span> bytes each
</span></span><span style=display:flex><span>Values:     <span style=color:#ae81ff>100</span> bytes each (<span style=color:#ae81ff>50</span> bytes after compression)
</span></span><span style=display:flex><span>Entries:    <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>RawSize:    <span style=color:#ae81ff>110.6</span> MB (estimated)
</span></span><span style=display:flex><span>FileSize:   <span style=color:#ae81ff>62.9</span> MB (estimated)
</span></span><span style=display:flex><span><span style=color:#f92672>------------------------------------------------</span>
</span></span><span style=display:flex><span>fillseq      :       <span style=color:#ae81ff>1.394</span> micros<span style=color:#f92672>/</span>op;   <span style=color:#ae81ff>79.3</span> MB<span style=color:#f92672>/</span>s     
</span></span><span style=display:flex><span>fillsync     :    <span style=color:#ae81ff>1208.178</span> micros<span style=color:#f92672>/</span>op;    <span style=color:#ae81ff>0.1</span> MB<span style=color:#f92672>/</span>s (<span style=color:#ae81ff>1000</span> ops)
</span></span><span style=display:flex><span>fillrandom   :       <span style=color:#ae81ff>1.948</span> micros<span style=color:#f92672>/</span>op;   <span style=color:#ae81ff>56.8</span> MB<span style=color:#f92672>/</span>s     
</span></span><span style=display:flex><span>overwrite    :       <span style=color:#ae81ff>2.448</span> micros<span style=color:#f92672>/</span>op;   <span style=color:#ae81ff>45.2</span> MB<span style=color:#f92672>/</span>s     
</span></span><span style=display:flex><span>readrandom   :       <span style=color:#ae81ff>3.251</span> micros<span style=color:#f92672>/</span>op; (<span style=color:#ae81ff>864322</span> of <span style=color:#ae81ff>1000000</span> found)
</span></span><span style=display:flex><span>readrandom   :       <span style=color:#ae81ff>2.947</span> micros<span style=color:#f92672>/</span>op; (<span style=color:#ae81ff>864083</span> of <span style=color:#ae81ff>1000000</span> found)
</span></span><span style=display:flex><span>readseq      :       <span style=color:#ae81ff>0.126</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>878.1</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>readreverse  :       <span style=color:#ae81ff>0.216</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>511.4</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>compact      :  <span style=color:#ae81ff>473557.000</span> micros<span style=color:#f92672>/</span>op;
</span></span><span style=display:flex><span>readrandom   :       <span style=color:#ae81ff>2.174</span> micros<span style=color:#f92672>/</span>op; (<span style=color:#ae81ff>864105</span> of <span style=color:#ae81ff>1000000</span> found)
</span></span><span style=display:flex><span>readseq      :       <span style=color:#ae81ff>0.111</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>997.1</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>readreverse  :       <span style=color:#ae81ff>0.185</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>598.0</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>fill100K     :     <span style=color:#ae81ff>530.603</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>179.8</span> MB<span style=color:#f92672>/</span>s (<span style=color:#ae81ff>1000</span> ops)
</span></span><span style=display:flex><span>crc32c       :       <span style=color:#ae81ff>0.904</span> micros<span style=color:#f92672>/</span>op; <span style=color:#ae81ff>4322.1</span> MB<span style=color:#f92672>/</span>s (<span style=color:#ae81ff>4</span>K per op)
</span></span><span style=display:flex><span>snappycomp   :       <span style=color:#ae81ff>2.353</span> micros<span style=color:#f92672>/</span>op; <span style=color:#ae81ff>1659.9</span> MB<span style=color:#f92672>/</span>s (output: <span style=color:#ae81ff>55.1</span><span style=color:#f92672>%</span>)
</span></span><span style=display:flex><span>snappyuncomp :       <span style=color:#ae81ff>0.390</span> micros<span style=color:#f92672>/</span>op; <span style=color:#ae81ff>10026.4</span> MB<span style=color:#f92672>/</span>s 
</span></span></code></pre></div><hr><pre><code>read: d019e3605f222ebc5a3a2484a2cb29db537551dd
</code></pre><p>Â∞è‰∏îÂÆåÊï¥ÁöÑÂ∑•‰∏öÂ≠òÂÇ®ÂÆûÁé∞ÔºåÂÖ∂‰∏≠ÊúâËÆ∏Â§öÁªÜËäÇÊòØÂèØ‰ª•ÂÄüÈâ¥ÁöÑ„ÄÇËøôÈáåÊ≤°ÊúâÂÆåÊï¥ÁöÑÊ∑±ÂÖ•ÊØè‰∏ÄË°å‰ª£Á†ÅÔºåÂêéÁª≠‰ºöÊó∂‰∏çÊó∂ÁöÑÊÖ¢ÊÖ¢Ë°•ÂÖÖ</p><ul><li>2022-05-17 ÂàùÊ≠•ÈòÖËØª‰ª£Á†ÅÔºå‰∫ÜËß£ÁªÑ‰ª∂ÂèäÂ§ßËá¥ÊâßË°åÈÄªËæë</li><li>2022-10-20 ÈáçËØªÈÉ®ÂàÜ‰ª£Á†ÅÔºåÊÑüËßâËá™Â∑±Ë≤å‰ººÊúâ‰∫Ü‰∫õËÆ∏ÈïøËøõ</li></ul><h2 id=ÁºñËØë>ÁºñËØë</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone --recurse-submodules https://github.com/google/leveldb.git
</span></span><span style=display:flex><span>cd leveldb
</span></span></code></pre></div><p><code>VSCode</code>ÂÆâË£Ö<code>cmake</code>Êèí‰ª∂‰πãÂêéÔºåÊâìÂºÄÈ°πÁõÆÔºåcmakeÊèí‰ª∂Ëá™Âä®ÈÖçÁΩÆÔºåÊ≠§Êó∂‰ΩøÁî®<code>shift+p</code>ËÆæÁΩÆ<code>cmake: set build target</code>‰πãÂêéÔºåÂÜç‰ΩøÁî®<code>shift+p</code>ÈÄâÊã©<code>cmake: build</code>Âç≥ÂèØÁºñËØëÁõÆÊ†áÊ®°ÂùóÔºåd019e3605f222ebc5a3a2484a2cb29db537551dd‰∏≠ÊµãËØïÊñá‰ª∂ËøõË°å‰∫ÜË∞ÉÊï¥ÔºåÂÖ®ÈÉ®ÂêàÂπ∂Âà∞<code>leveldb_tests</code>‰∏≠ÔºåË∞ÉËØïÊó∂ÊåâÁÖßÊÉ≥Ë¶Å‰∫ÜËß£ÁöÑÊ®°ÂùóÔºåËá™Â∑±Ê≥®ÈáäÂÖ∂‰ªñÊµãËØïÊñá‰ª∂ÔºåÈáçÊñ∞ÁºñËØëÂç≥ÂèØ„ÄÇÊ≠§Êó∂ÂèØ‰ª•Âú®Êñá‰ª∂‰∏≠Êñ≠ÁÇπË∞ÉËØïÔºåÊàñËÄÖ‰ΩøÁî®gdbË∞ÉËØï</p><h2 id=slice>slice</h2><p>Â≠óÁ¨¶‰∏≤ÁöÑÊµÖÊã∑Ë¥ùÂÆûÁé∞Ôºå‰ΩøÁî®‰∏Ä‰∏™ÊåáÈíàÂíåÊåáÈíàÈïøÂ∫¶ÂÆûÁé∞ÔºåÁ±ª‰ººc++ÂêéÊù•ÂÆûÁé∞ÁöÑstring_viewÔºåÂ¶ÇÊûú‰ΩøÁî®stringÔºåÂàôÂú®‰º†ÈÄíÊï∞ÊçÆÁöÑÊó∂ÂÄô‰ºöËøõË°åÊã∑Ë¥ùÊìç‰ΩúÔºåÊúâÊÄßËÉΩÊçüÂ§±„ÄÇÂè¶‰∏Ä‰∏™ÁõÆÁöÑÊòØ‰∏∫‰∫ÜËá™‰∏ªÂèØÊéßÔºåÁ°Æ‰øùÊï∞ÊçÆÂú®‰º†ËæìÁöÑËøáÁ®ã‰∏≠‰∏ç‰ºöÈÄ†ÊàêÂ§™Â§öÁöÑÊï∞ÊçÆÂâØÊú¨„ÄÇÊâÄ‰ª•Êã∑Ë¥ùÊûÑÈÄ†ÂáΩÊï∞‰ΩøÁî®ÁöÑÊòØÈªòËÆ§ÁöÑÁ≥ªÁªüÂáΩÊï∞Ôºå‰ΩøÁî®ÊµÖÊã∑Ë¥ù</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Slice(<span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>Slice<span style=color:#f92672>&amp;</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span>(<span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span></code></pre></div><h2 id=status>status</h2><p>Ëá™ÂÆö‰πâ‰ø°ÊÅØÊ®°ÂùóÔºåÊääÁä∂ÊÄÅÁ†ÅÂíåÁä∂ÊÄÅ‰ø°ÊÅØËøõË°åÂéãÁº©ÔºåÂéãÁº©Ê†ºÂºèÂ¶Ç‰∏ã</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Status<span style=color:#f92672>::</span>Status(Code code, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> msg, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> msg2) {
</span></span><span style=display:flex><span>  assert(code <span style=color:#f92672>!=</span> kOk);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> len1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint32_t</span><span style=color:#f92672>&gt;</span>(msg.size());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> len2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint32_t</span><span style=color:#f92672>&gt;</span>(msg2.size());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> size <span style=color:#f92672>=</span> len1 <span style=color:#f92672>+</span> (len2 <span style=color:#f92672>?</span> (<span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> len2) <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>char</span>[size <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>];
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>memcpy(result, <span style=color:#f92672>&amp;</span>size, <span style=color:#66d9ef>sizeof</span>(size));
</span></span><span style=display:flex><span>  result[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span><span style=color:#f92672>&gt;</span>(code);
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>memcpy(result <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, msg.data(), len1);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (len2) {
</span></span><span style=display:flex><span>    result[<span style=color:#ae81ff>5</span> <span style=color:#f92672>+</span> len1] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;:&#39;</span>;
</span></span><span style=display:flex><span>    result[<span style=color:#ae81ff>6</span> <span style=color:#f92672>+</span> len1] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>memcpy(result <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>+</span> len1, msg2.data(), len2);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  state_ <span style=color:#f92672>=</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>TIPS: ÂØπ‰∫éÊï∞Â≠óÔºå‰πãÈôÖÊã∑Ë¥ùÂú∞ÂùÄÂèØ‰ª•Áõ¥Êé•Â∫èÂàóÂåñÔºå‰∏çÈúÄË¶Å‰ΩøÁî® to_stringÔºåÂèñÊï∞ÁöÑÊó∂ÂÄôÁõ¥Êé•ÂèñÂ≠óËäÇÁ†ÅÔºåÁÑ∂Âêéstatic_castÂ∞±ÂèØ‰ª•‰∫Ü</p></blockquote><h2 id=Êï∞ÂÄºÁºñÁ†Å>Êï∞ÂÄºÁºñÁ†Å</h2><p>leveldb‰∏≠Âá†‰πéÊâÄÊúâÁöÑÊï∞ÊçÆÈÉΩ‰ºöÂíåÊï∞ÊçÆÊ†ºÂºèÁöÑÁºñÁ†ÅÊàñÂ§öÊàñÂ∞ëÁöÑÊúâËÅîÁ≥ªÔºåÈ¶ñÂÖàÊï∞ÊçÆÁöÑÂ≠òÂÇ®‰∏çËÉΩÁõ¥Êé•ÁÆÄÂçïÁöÑto_stringÁÑ∂ÂêéÂ≠òÂÇ®Â≠óÁ¨¶‰∏≤ÔºåÂÖ∂Ê¨°ÂØπ‰∫éÊï¥ÂΩ¢ÁöÑÂèòÈïøÁºñÁ†ÅÔºå‰ªñ‰ºöÊääÊï∞ÊçÆÁöÑ‰∫åËøõÂà∂ÁºñÁ†ÅÊåâ7ÊãÜÂàÜÔºåÂú®ÊØè‰∏™Â≠óËäÇÁöÑÁ¨¨‰∏Ä‰Ωç‰ΩøÁî®1Ë°®Á§∫ÊòØÂê¶‰∏∫Êï∞ÊçÆÁöÑÁªìÂ∞æÔºå‰æãÂ¶Ç<code>int(1)</code>ÁºñÁ†Å‰∏∫<code>00000001</code>Ôºå<code>11 10101010</code>‰ºöÁºñÁ†Å‰∏∫<code>10101010 00000111</code>ÔºåÂØπÂ∫îÂéãÁº©ÂíåËß£Âéã‰ª£Á†ÅÂ¶Ç‰∏ãÔºåÂèòÈïøÁºñÁ†ÅÊòØ‰∏ÄÁßçÁºñÁ®ãÊäÄÂ∑ßÔºåintÁ±ªÂûãÊòØ4Â≠óËäÇÔºålongÊòØ8Â≠óËäÇ„ÄÇÂΩìÂ≠òÂÇ®ÁöÑÊï∞ÊçÆÂ∞èÁöÑÊó∂ÂÄô„ÄÇÂèØ‰ª•ËäÇÁ∫¶Á©∫Èó¥„ÄÇÂπ∂‰∏îÊàë‰ª¨ÊúâÁêÜÁî±Áõ∏‰ø°ÔºåÁ®ãÂ∫è‰∏≠Â§ßÈÉ®ÂàÜÂú∫ÊôØ‰ΩøÁî®ÁöÑÊòØÂ∞èÊï∞Â≠ó„ÄÇ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>EncodeVarint32</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> dst, <span style=color:#66d9ef>uint32_t</span> v) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Operate on characters as unsigneds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*</span> ptr <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*&gt;</span>(dst);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> B <span style=color:#f92672>=</span> <span style=color:#ae81ff>128</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>7</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>14</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>|</span> B;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>7</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>21</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>|</span> B;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> (v <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>7</span>) <span style=color:#f92672>|</span> B;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>14</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>28</span>)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> GetVarint32PtrFallback(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> p, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> limit,
</span></span><span style=display:flex><span>                                   <span style=color:#66d9ef>uint32_t</span><span style=color:#f92672>*</span> value) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint32_t</span> result <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; shift <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>28</span> <span style=color:#f92672>&amp;&amp;</span> p <span style=color:#f92672>&lt;</span> limit; shift <span style=color:#f92672>+=</span> <span style=color:#ae81ff>7</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> byte <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*&gt;</span>(p));
</span></span><span style=display:flex><span>    p<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (byte <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>128</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// More bytes are present
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      result <span style=color:#f92672>|=</span> ((byte <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>127</span>) <span style=color:#f92672>&lt;&lt;</span> shift);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      result <span style=color:#f92672>|=</span> (byte <span style=color:#f92672>&lt;&lt;</span> shift);
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span>value <span style=color:#f92672>=</span> result;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*&gt;</span>(p);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Èô§‰∫ÜÂèòÈïø‰πãÂ§ñÔºåËøòÊúâÂÆöÈïøÁºñÁ†ÅÔºå‰ª•ÂèäÂØπÂ∫îÁöÑ32‰ΩçÔºå64‰ΩçÁöÑÂÆûÁé∞Á≠âÔºåÂú®ÂÆûÈôÖÁöÑÊï∞ÊçÆÂ§ÑÁêÜ‰∏≠Ôºå‰ºöÊúâËÆ∞ÂΩïÊï∞ÊçÆÈïøÂ∫¶Á≠âÊìç‰ΩúÔºåÂ∞±‰ºö‰ΩøÁî®ÁºñÁ†ÅÊìç‰ΩúÔºåÊääÊï∞ÂÄºÁºñÁ†ÅÂà∞Êï∞ÊçÆ‰∏≠„ÄÇÂÆöÈïøÁºñÁ†ÅÊòØÁõ¥Êé•Â≠òÂÇ®Â≠óËäÇÂ∫è„ÄÇ</p><h2 id=arena>Arena</h2><p>Ëá™ÂÆö‰πâÂÜÖÂ≠òÊ±†ÔºåËÆæËÆ°ÊÄùË∑ØÊòØÁî≥ËØ∑ÂÜÖÂ≠òÂíåÂàÜÈÖçÂÜÖÂ≠òÈöîÁ¶ªÔºåÁî≥ËØ∑ÂÜÖÂ≠òÁöÑÊó∂ÂÄôÂ§öÁî≥ËØ∑ÔºåÂàÜÈÖçÂÜÖÂ≠òÁöÑÊó∂ÂÄô‰ªéÂ∑≤Áî≥ËØ∑ÁöÑÂÜÖÂ≠ò‰∏≠ÂàÜÈÖçÔºå‰ΩøÁî®vectorÁª¥Êä§ÂÜÖÂ≠òÁ©∫Èó¥ÔºåLevelDB‰∏≠Âú®memtable‰∏≠‰ΩøÁî®ÔºåÁêÜËÆ∫‰∏äÂèØ‰ª•Áî®Âú®‰ªª‰ΩïÊÉ≥‰ΩøÁî®ÁöÑÁªÑ‰ª∂‰∏≠Ôºå‰ΩÜÊòØÂÆûÈôÖ‰∏äÊï∞ÊçÆÂèòÂä®ÊúÄÂ§öÁöÑÂú∞ÊñπÊòØmemtableÔºåÊâÄ‰ª•ÊöÇÊó∂Âè™ÂèëÁé∞Âè™ÊúâËøôÈáå‰ΩøÁî®„ÄÇ</p><ul><li>ÂØπ‰∫éÂ§ßÁ©∫Èó¥(Â§ß‰∫ékBlockSize / 4ÁöÑÁ©∫Èó¥ÔºåÂ§ß‰∫ékBlockSize = 4096)ÔºåÂàôÁõ¥Êé•Áî≥ËØ∑ÔºåÁã¨Âç†‰∏Ä‰∏™blockÔºå‰∏çÂèóblockÂ§ßÂ∞èÁöÑÈôêÂà∂Ôºå‰∏î‰∏çÊîπÂèò‰πãÂâçËÆ∞ÂΩïÁöÑblockÁöÑÊåáÈíàÁä∂ÊÄÅ</li><li>ÂØπ‰∫éÂ∞èÁ©∫Èó¥<ul><li>Á¨¨‰∏ÄÊ¨°‰ºöÁî≥ËØ∑Â§ßÂ∞è‰∏∫4kÁöÑÁ©∫Èó¥ÔºåÁÑ∂ÂêéËÆ∞ÂΩïÂΩìÂâçÁ©∫Èó¥ÁöÑÊåáÈíàÂèäÁ©∫Èó¥‰ΩøÁî®ÊÉÖÂÜµÔºåÁÑ∂Âêé‰ªéÁ©∫Èó¥‰∏äÂàÜÈÖçÂÜÖÂ≠òÔºå‰∏îÁ©∫Èó¥pushÂà∞vector‰∏≠</li><li>‰πãÂêéÁöÑÁ©∫Èó¥Áî≥ËØ∑Â¶ÇÊûúÂú®ÂΩìÂâçblock‰∏äÂèØ‰ª•ÁªßÁª≠ÂàÜÈÖçÔºåÂàôÂú®block‰∏äÁõ¥Êé•ÂàÜÈÖç</li><li>Â¶ÇÊûú‰∏çÊª°Ë∂≥Êù°‰ª∂ÔºåÂàôÈáçÊñ∞ÂàÜÈÖçÔºå‰πãÂâçÊÆãÁïôÁöÑÁ©∫Èó¥Áõ¥Êé•‰∏¢ÂºÉÔºå‰∏î‰∏çËÆ°ÂÖ•‰ΩøÁî®Á©∫Èó¥ÁªüËÆ°</li></ul></li><li>ÂØπ‰∫éÁ©∫Èó¥ÁöÑÁªüËÆ°ÊÉÖÂÜµÔºå‰ΩøÁî®ÂéüÂ≠êÂèòÈáè<code>std::atomic&lt;size_t> memory_usage_;</code>ËÆ∞ÂΩïÔºåÂõ†‰∏∫ArenaÂú®skiplist‰∏≠‰ΩøÁî®ÁöÑÊó∂ÂÄôÔºåÂèØËÉΩÊúâÂπ∂ÂèëÁöÑÊÉÖÂÜµ</li></ul><blockquote><p>TIPS: ÂéüÂ≠êÁ±ªÂûãÁöÑÁªÜËäÇÈúÄË¶ÅË∞ÉÁ†î</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> pool <span style=color:#f92672>=</span> area<span style=color:#f92672>-&gt;</span>Allocate(size);               <span style=color:#75715e>// ‰∏çÂØπÈΩêÁöÑÁî≥ËØ∑
</span></span></span><span style=display:flex><span><span style=color:#75715e>// char * pool = area-&gt;AllocateAligned(size);     // Áî≥ËØ∑ÂØπÈΩêÁöÑÁ©∫Èó¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>auto</span> mem <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> (pool) <span style=color:#66d9ef>char</span>(size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Allocate(size) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (size <span style=color:#f92672>&lt;</span> alloc_bytes_remaining_) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> result <span style=color:#f92672>=</span> alloc_ptr_;
</span></span><span style=display:flex><span>    alloc_ptr_ <span style=color:#f92672>+=</span> bytes;
</span></span><span style=display:flex><span>    alloc_bytes_remaining_ <span style=color:#f92672>-=</span> bytes;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>AllocateFallback</span>(size);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=skiplist>SkipList</h2><p>Êù•Ëá™ËÆ∫Êñá<a href=https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990. target=_blank>Skip lists: a probabilistic alternative to balanced trees</a>
ÔºåÂÖ∂‰∏≠‰ªãÁªç‰∫ÜË∑≥Ë°®ÁöÑÂÆûÁé∞ÂíåÂÖ∂‰ªñ‰∏çÂêåÁªìÊûÑ‰πãÈó¥ÁöÑÂØπÊØîÊÉÖÂÜµÔºå</p><blockquote><p>ÈúÄË¶ÅÈáç‰øÆÊ¶ÇÁéáËÆ∫</p></blockquote><p>Ë∑≥Ë°®‰ΩøÁî®‰ΩøÁî®Ê¶ÇÁéáÂùáË°°ÁöÑÊäÄÊúØÔºåÂ§ßÈÉ®ÂàÜÊìç‰ΩúÈÉΩÂèØ‰ª•ÂÆûÁé∞<code>O(log n)</code>ÁöÑÊó∂Èó¥Â§çÊùÇÂ∫¶ÔºåÂèØ‰ª•ÂèÇËÄÉ‰∏äÈù¢ÁöÑÊñáÁ´†ÔºåËøôÈáåÊÄªÁªìÂá†‰∏™ÁÇπ</p><ol><li>Ë∑≥Ë°®ÂèØ‰ª•ÁÆÄÂçïÁöÑÁêÜËß£‰∏∫ÈìæË°®ÁöÑ+indexÁöÑÂÆûÁé∞ÔºåindexÁöÑÁõÆÁöÑÊòØ‰∏∫‰∫ÜÂø´ÈÄüÁöÑÊü•ÊâæÊï∞ÊçÆ</li><li>Ë∑≥Ë°®Âú®Â¢ûÂä†ËäÇÁÇπÁöÑÊó∂ÂÄôÔºå‰ΩøÁî®Ê¶ÇÁéá‰∏∫0.25Êù•Á°ÆÂÆö‰ΩøÂæóÂê¶Â¢ûÂä†‰∏ã‰∏ÄÂ±ÇÔºåÂú®Ëøô‰∏™Ê¶ÇÁéá‰∏ãÔºåÁ©∫Èó¥ÈúÄË¶ÅËä±Ë¥πÁöÑ‰ª£‰ª∑‰∏∫<code>(cost(node) * 1.33)</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> kBranching <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> height <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (height <span style=color:#f92672>&lt;</span> kMaxHeight <span style=color:#f92672>&amp;&amp;</span> rnd_.OneIn(kBranching)) {
</span></span><span style=display:flex><span>    height<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ol start=3><li>Êü•ÊâæÁöÑÊó∂Èó¥Â§çÊùÇÂ∫¶ÂèØ‰ª•ÊäΩË±°ÁöÑÁêÜËß£‰∏∫‰∫åÂàÜÊü•ÊâæÁöÑ<code>O(log n)</code></li><li>Ë∑≥Ë°®ÁöÑÊìç‰ΩúÁöÑÊó∂Èó¥Â§çÊùÇÂ∫¶ÂíåÁ∫¢ÈªëÊ†ëÂá†‰πéÂ∑Æ‰∏çÂ§öÔºå‰ΩÜÊòØÊúâ‰∏ÄÁÇπÂäüËÉΩÊòØÁ∫¢ÈªëÊ†ëÊó†Ê≥ïÂÆûÁé∞ÁöÑÔºåÂç≥<code>range search</code>ÔºåÁ∫¢ÈªëÊ†ëÁî±‰∫éÁªìÊûÑÁâπÊÄßÔºåÊó†Ê≥ïËøõË°åÁ±ª‰ººÁöÑÊìç‰ΩúÔºåË∑≥Ë°®ÂèØ‰ª•ÂÆö‰Ωçnode‰πãÂêéÔºåÂèØ‰ª•Ê†πÊçÆnodeÈó¥ÁöÑÈìæÊé•ÂÆûÁé∞È°∫Â∫èÈÅçÂéÜ</li><li>insertÁöÑÊó∂ÂÄôÂÖàÊü•Êâæ‰ΩçÁΩÆÔºåÁÑ∂ÂêéÊåâÊ¶ÇÁéáËÆ°ÁÆóÂ±ÇÈ´òÔºåÂÜçËøõË°åÊèíÂÖ•
<img src=/posts/readbooks/images/skiplist.png alt=skiplist></li><li>ÂÆπÊòìÂÆûÁé∞Âπ∂ÂèëÊìç‰ΩúÔºåÂπ∂ÂèëÁöÑÊó∂ÂÄôÂè™ÈúÄË¶ÅÂØπÊûÅÂ∞ëÁöÑËäÇÁÇπÂä†ÈîÅÂç≥ÂèØÔºå‰ΩÜÊòØÁ∫¢ÈªëÊ†ëÁî±‰∫éÈúÄË¶ÅÂèòÂΩ¢ÊóãËΩ¨ÈúÄË¶ÅÂØπÊï¥Ê£µÊ†ëÂä†ÈîÅÔºåÊâÄ‰ª•Ëøô‰πüÊòØÂ§ßÈÉ®ÂàÜÂ≠òÂÇ®‰ΩøÁî®skiplistÁöÑ‰Ωú‰∏∫memtableÁöÑÁêÜÁî±‰πã‰∏Ä<br>1. <a href=https://www.bookstack.cn/read/Cpp_Concurrency_In_Action/README.md target=_blank>c++Âπ∂ÂèëÁºñÁ®ã</a><br>2. ‰∏âÁßçÂπ∂Âèë<ol><li>max_heights_ ‰ΩøÁî®memory_order_relaxedÔºåskiplistÂè™ÂÖÅËÆ∏‰∏ÄÂÜôÂ§öËØªÔºåmax_height_Âè™ÊúâÂÜôÊâç‰ºöÊîπÂèò</li><li>insertËÆæÁΩÆÊñ∞ËäÇÁÇπÁöÑnextÔºå‰ΩøÁî®NoBarrier_NextÂíåNoBarrier_SetNextÊìç‰ΩúÔºåÊ≠§Êó∂ÂØπnode‰ΩøÁî®memory_order_relaxedÊìç‰ΩúÔºåÊ≠§Êó∂ÂÖ∂‰ªñÁ∫øÁ®ãÊó†Ê≥ïÁúãËßÅÊñ∞ËäÇÁÇπ</li><li>insertËÆæÁΩÆÊñ∞ËäÇÁÇπÁöÑforwardÔºåÊ≠§Êó∂‰ΩøÁî®SetNextÁöÑmemory_order_releaseÔºåÊ≠§Êó∂ÊâÄÊúâÁ∫øÁ®ãÂèØ‰ª•ÁúãËßÅÊñ∞ËäÇÁÇπ<br>‰ΩÜÊòØÁî±‰∫éskiplist ÂàÜÂ±ÇÔºåÊâÄ‰ª•Ê≠§Êó∂Âè™ËÉΩÁúãËßÅÂΩìÂâçÊèíÂÖ•ÁöÑËøô‰∏ÄÂ±ÇÔºåËÄåÊü•ËØ¢ÊòØÈúÄË¶Å‰ªéÈ°∂Â±ÇÂæÄ‰∏ãÊü•ÁöÑÔºåÊâÄ‰ª•insertÈúÄË¶Å‰ªéÂ∫ïÂ±ÇÂºÄÂßãÔºåÂê¶ÂàôÂèØËÉΩÂá∫Áé∞‰∏äÂ±ÇÊü•ËØ¢ËäÇÁÇπÂ≠òÂú®Ôºå‰ΩÜÊòØ‰∏ãÂ±Ç‰∏çÂ≠òÂú®</li></ol></li><li>leveldb‰∏≠ÔºåskiplistÊ≤°ÊúâdeleteÊìç‰ΩúÔºåÂ¶ÇÊûúÈúÄË¶ÅÂÆûÁé∞ÔºåÂàôÈúÄË¶ÅÂÆûÁé∞Á±ª‰ººinsert‰∏≠ÁöÑÈÉ®ÂàÜÊìç‰ΩúÔºåÊü•ÊâæÂà∞preÔºåÂú®ËÆæÁΩÆËäÇÁÇπÂç≥ÂèØ„ÄÇ</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> Key, <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Comparator</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> SkipList<span style=color:#f92672>&lt;</span>Key, Comparator<span style=color:#f92672>&gt;::</span>Insert(<span style=color:#66d9ef>const</span> Key<span style=color:#f92672>&amp;</span> key) {
</span></span><span style=display:flex><span>  Node<span style=color:#f92672>*</span> prev[kMaxHeight];
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ËÆæÁΩÆpreÔºå‰ªéÈ°∂Â±ÇÂºÄÂßãÊü•ÊâæÔºåËÆ∞ÂΩïÁöÑÊòØÊØè‰∏ÄÂ±ÇÁöÑÂΩìÂâçËäÇÁÇπÁöÑpreËäÇÁÇπ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Node<span style=color:#f92672>*</span> x <span style=color:#f92672>=</span> FindGreaterOrEqual(key, prev);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  assert(x <span style=color:#f92672>==</span> <span style=color:#66d9ef>nullptr</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>Equal(key, x<span style=color:#f92672>-&gt;</span>key));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//   ÈöèÂç≥È´òÂ∫¶
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> height <span style=color:#f92672>=</span> RandomHeight();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (height <span style=color:#f92672>&gt;</span> GetMaxHeight()) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Â¶ÇÊûúÈ´òÂ∫¶ÊØî‰πãÂâçÁöÑÈ´òÔºåÂàôÊääprev‰πãÂâçÈ´òÂ∫¶ËäÇÁÇπÂà∞height‰πãÈó¥ÁöÑnodeËÆæÁΩÆ‰∏∫head_
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> GetMaxHeight(); i <span style=color:#f92672>&lt;</span> height; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      prev[i] <span style=color:#f92672>=</span> head_;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    max_height_.store(height, std<span style=color:#f92672>::</span>memory_order_relaxed);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  x <span style=color:#f92672>=</span> NewNode(key, height);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ‰ΩøÁî®heightËÆæÁΩÆÂΩìÂâçËäÇÁÇπÂíåpre‰ª•ÂèänextÈò∂ÊÆµ‰πãÈó¥ÁöÑÈìæÊé•
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> height; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    x<span style=color:#f92672>-&gt;</span>NoBarrier_SetNext(i, prev[i]<span style=color:#f92672>-&gt;</span>NoBarrier_Next(i));
</span></span><span style=display:flex><span>    prev[i]<span style=color:#f92672>-&gt;</span>SetNext(i, x);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=8><li><code>std::atomic&lt;Node*> next_[1];</code>Ôºå‰∏çËÉΩÊòØ<code>next_[0]</code>ÔºåÂõ†‰∏∫0ÁöÑÊó∂ÂÄôsizeof‰∏çËÆ°ÁÆóËøô‰ΩçÔºåÂ§ßÂ∞è‰∏çÂØπÔºå‰∏çËÉΩÊòØ‰∫åÁ∫ßÊåáÈíàÔºåÂõ†‰∏∫Ê≠§Êó∂nextÂú®ÂêéÁª≠ÁöÑ‰ΩøÁî®‰∏≠Ôºå‰∏äÂ±Çnext_ÊòØnullptrÔºåÊó†Ê≥ïÁõ¥Êé•Êìç‰ΩúÔºåÂè™Êúâ‰ΩøÁî®Êï∞ÁªÑÊèêÂâçÂç†‰ΩçÔºåÊâçÂèØ‰ª•ËÆæÁΩÆnodeÔºåËá™Â∑±ÊâãÂÜôÁöÑÊó∂ÂÄôÈúÄË¶ÅÊ≥®ÊÑè„ÄÇ‰πüÂèØ‰ª•ÂÜçinsertÁöÑÊó∂ÂÄôÊ≥®ÊÑè‰∫éheadÁöÑÁõ∏ÂØπÂÖ≥Á≥ª„ÄÇ</li></ol><h2 id=memtable>MemTable</h2><p>SkipListÁöÑÂ∞ÅË£ÖÔºåÈïøÊúüÂ§Ñ‰∫éÂÜÖÂ≠ò‰∏≠ÔºåÊ¥ªÂä®ÁöÑtableÂè™Êúâ‰∏Ä‰∏™ÔºåÊª°ÁöÑ‰πãÂêéÂÜªÁªìËêΩÁõò„ÄÇÂü∫Á°ÄÊìç‰Ωú‰∏∫addÂíågetÔºå‰ΩøÁî®MemTableIteratorËÆøÈóÆmemtable„ÄÇ<br>MemTableIteratorÊòØSkipListÁöÑËø≠‰ª£Âô®ÁöÑÂ∞ÅË£Ö„ÄÇÊåÅÊúâ‰∏Ä‰∏™Ë∑≥Ë°®ÂíånodeÔºå‰ΩøÁî®SeekToFirstÂíåSeekToLastÂÆö‰Ωçnode‰πãÂêéÔºåÂºÄÂßã‰ΩøÁî®</p><ol><li>addÁºñÁ†ÅÊï∞ÊçÆÂíåÁ±ªÂûã‰ª•ÂèäÈïøÂ∫¶ÂíåkeyÁ≠âÔºåÊãºÊé•‰∏∫‰∏Ä‰∏™bufferÔºåÁÑ∂ÂêéinsertÂà∞skiplist‰∏≠</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// Format of an entry is concatenation of:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  key_size     : varint32 of internal_key.size()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  key bytes    : char[internal_key.size()]
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  tag          : uint64((sequence &lt;&lt; 8) | type)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  value_size   : varint32 of value.size()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  value bytes  : char[value.size()]
</span></span></span></code></pre></div><ol start=2><li>‰ΩøÁî®Ëø≠‰ª£Âô®seekÂà∞nodeÔºåÁÑ∂ÂêéËé∑ÂæóÊï∞ÊçÆÔºåËß£Á†ÅÔºåÂà§Êñ≠Êï∞ÊçÆÁ±ªÂûã</li></ol><h2 id=dbimpl>DBImpl</h2><p>DBÁöÑÂÖ∑‰ΩìÂÆûÁé∞ÔºåÂØπÂ§ñÊé•Âè£‰ΩøÁî®DBÂØπË±°Ôºå‰ΩÜÊòØÂÜÖÈÉ®ÂÆûÈôÖË∞ÉÁî®ÁöÑËøòÊòØDBImplÂÆû‰æã</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Status DBImpl<span style=color:#f92672>::</span>Put(<span style=color:#66d9ef>const</span> WriteOptions<span style=color:#f92672>&amp;</span> o, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> key, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> val) {
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> DB<span style=color:#f92672>::</span>Put(o, key, val);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Status DBImpl<span style=color:#f92672>::</span>Delete(<span style=color:#66d9ef>const</span> WriteOptions<span style=color:#f92672>&amp;</span> options, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> key) {
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> DB<span style=color:#f92672>::</span>Delete(options, key);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>Êñ∞Âª∫</li><li>ÊÅ¢Â§ç</li><li>ÂÜô<br>1. ‰ΩøÁî®WriteBatchÊâìÂåÖ‰∏ÄÊâπÂÜôÂÖ•Êï∞ÊçÆ
2. ÈôêÂà∂‰∏ÄÂÜôÂ§öËØªÔºåWriteBatch‰ºöÊ∑ªÂä†Âà∞ÈòüÂàóÔºåÁ≠âÂæÖÂÜôÂÖ•Ê∂àËÄó
3. ÂÜôÂÖ•‰ºöÊúâÂ§öÁßç‰∏≠Èó¥Áä∂ÂÜµ<ol><li>ÂΩìÂâçÊ≠£Âú®L0ÁöÑcompactÔºåÊ≠§Êó∂Â¶ÇÊûú‰∏çÊòØÂº∫Âà∂ÂºÇÊ≠•ÂÜôÔºåÂàôÈúÄË¶ÅÁ≠âÂæÖ1sËÆ©Âá∫ËµÑÊ∫êÔºåÁ≠âÂæÖcompactÂÆåÊàêÔºå‰ΩÜÊòØÊúÄÂ§öÂè™ËÉΩÁ≠âÂæÖ‰∏ÄÊ¨°</li><li>memÁ©∫Èó¥‰∏çË∂≥ÔºåÈúÄË¶ÅËøõË°å compactÔºå Á≠âÂæÖ</li><li>L0 SSTË∂ÖËøáÈôêÂà∂ÔºåÁ≠âÂæÖcompact</li></ol><blockquote><p>ËøôÈáåÂá†Êù°Â∫îËØ•ÊòØÂÜôÂÖ•ÁöÑÊúÄÂ§ßÁöÑÊÄßËÉΩÁì∂È¢àÔºåRocksDB‰∏≠Â∫îËØ•ÊúâËß£ÂÜ≥ÁöÑÊñπÊ°àÔºåÂêéÁª≠ÂèØ‰ª•ÁúãÁúã‰ªñÁöÑÂÜôÂÖ•ÊµÅÁ®ã</p></blockquote></li><li>ËØª<br>1. ‰∏âÂ±ÇËØªÂèñ„ÄÇÂ≠òÂú®ËØªÊîæÂ§ßÁöÑÈóÆÈ¢ò<br>2. ÂÖàÈÉΩmemtable
3. ÂÜçÈÉΩinmem
4. ËØªÂèñL0Â±Ç
5. ËØªÂèñÂÖ∂‰ªñÂ±Ç
6. ËØªÂèñÊñá‰ª∂‰∏äÁöÑÊï∞ÊçÆÁöÑÊó∂ÂÄô‰ΩøÁî®<code>Version::Get</code>ÔºåÂÜÖÈÉ®ÂÖà‰ªéL0ÂºÄÂßãÔºåÁÑ∂ÂêéÂú®‰æùÊ¨°Âêë‰∏ãËØªÂèñÔºåËÉΩËøõË°åkeyÁöÑÊØîÂØπÁöÑ‰æùÊçÆÊòØversion‰∏≠‰øùÂ≠òÊñá‰ª∂ÁöÑFileMetaData</li><li>compact</li><li>lockÊú∫Âà∂</li></ol><h2 id=writebatch>WriteBatch</h2><p><img src=/posts/readbooks/images/xx.webp alt></p><p>ÂÜôÊìç‰ΩúÁöÑ‰∏ªË¶ÅÊìç‰ΩúÂØπË±°Ôºå‰∏ªË¶ÅÊ≠•È™§ÊòØÊääÊìç‰ΩúÁöÑÊï∞ÊçÆÊâìÂåÖ‰∏∫‰∏Ä‰∏™bufferÔºåÁÑ∂Âêé‰ΩøÁî®<code>WriteBatch::Iterate</code>Êìç‰ΩúhandlerÂÆûÁé∞insertÊìç‰ΩúÔºåhanleÊòØ‰∏Ä‰∏™ÂÆûÁé∞putÂíådeleteÁöÑÊé•Âè£ÔºåÊâÄ‰ª•ËøôÈáåÊòØÊääÊï∞ÊçÆÂíåÊìç‰ΩúÂàÜÁ¶ª‰∫ÜÔºåËøôÈáåÊúâÂá†ÁÇπÁªÜËäÇ</p><ol><li>WriteBatchÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏∫ <code>seq|countkey|{type|key|val}</code>ÔºåbatchÊ∑ªÂä†‰∏Ä‰∏™Êï∞ÊçÆÁöÑÊó∂ÂÄôÔºåÈô§‰∫ÜÊ≠£Â∏∏Ê∑ªÂä†Êï∞ÊçÆÔºåËøò‰ºöcount++ÔºåÁî®‰∫éÂú®<code>WriteBatch::Iterate</code>ÁöÑÊó∂ÂÄôÊ£ÄÊµãÂΩìÂâçÊâπÊ¨°Êï∞ÊçÆÊï∞ÈáèÊòØÂê¶Ê≠£Á°Æ</li><li>‰∏Ä‰∏™batchÁöÑÊï∞ÊçÆÂè™Êúâ‰∏Ä‰∏™sequenceÔºåbatchÂÜôÂÆå‰πãÂêéÔºåÊï∞ÂÄºÂä†‰∏ÄÔºå</li><li>ÊúâÊ®ôË®òÊéßÂà∂ÊòØÂê¶‰ΩøÁî®‰ΩøÁî®ÂêåÊ≠•ÂØ´„ÄÇÈªòË™çÁÇ∫ÂêåÊ≠•ÂØ´ÔºåÁï∞Ê≠•ÂØ´ÂÖ•ÁöÑÈÄüÂ∫¶Âø´Ôºå‰ΩÜÊòØÂèØËÉΩÂ∞éËá¥Á≥ªÁµ±Â¥©ÊΩ∞ÁöÑÊôÇÂÄô‰∏üÊï∏ÊìöÔºåÊâÄ‰ª•Áà≤‰∫ÜÂàÜÊî§Â§ßÈáèÊï∏ÊìöÁöÑÂêåÊ≠•ÂØ´ÁöÑcostÔºåÈÄôË£èË®≠Ë®àWriteBatch‰æÜÊâìÂåÖÊï∏ÊìöÔºåÈÄ≤Ë°å‰∏ÄÊ¨°ÂêåÊ≠•ÂØ´Êìç‰ΩúÔºåÂõ†Áà≤ÊòØÈ†ÜÂ∫èÂØ´ÂÖ•Á£ÅÁõ§ÔºåÊâÄ‰ª•ÂØ´ÂÖ•ÈÄüÂ∫¶ÂèØ‰ª•Êé•Âèó</li><li>ÂÜôÂÖ•Êìç‰ΩúÂÖ∑ÊúâÂéüÂ≠êÊÄßÔºåÂú®ÂÜôÊï∞ÊçÆÁöÑÊó∂ÂÄô‰ºöÂÖàÂÜôÊó•ÂøóÁÑ∂ÂêéÂÜçÂÜôÊï∞ÊçÆÔºåÂΩìÂÜôÊó•Âøó‰πãÂâçÊàñËÄÖÂÜôÊó•ÂøóËøáÁ®ã‰∏≠ÂÆïÊú∫Ôºå‰∏ãÊ¨°ÈáçÂêØÊó∂ÊÅ¢Â§çÊï∞ÊçÆÂ∫ìÁöÑÊó∂ÂÄôÁõ¥Êé•‰∏¢ÂºÉÂºÇÂ∏∏Êó•Âøó„ÄÇÊàñËÄÖÂÜôÂÆåÊó•Âøó‰πãÂêéÂÆïÊú∫ÔºåÁ≥ªÁªüÂú®‰∏ãÊ¨°ÂêØÂä®‰πãÂêéÈÉΩÊòØÁ°Æ‰øùÊï∞ÊçÆÁöÑÂéüÂ≠êÊÄßÔºå</li></ol><h2 id=posixenv>PosixEnv</h2><p>posixÁéØÂ¢ÉËµÑÊ∫êÁöÑÂÆûÁé∞ÔºåÁªßÊâøËá™envÔºåÁõÆÁöÑÊòØ‰æø‰∫éÂÆûÁé∞‰∏çÂêåÂπ≥Âè∞‰∏ãÁöÑ‰ª£Á†ÅÔºå</p><ul><li>Á∫øÁ®ãÊ±†Ôºå‰∏Ä‰∏™ÁÆÄÂçïÁöÑ‰æãÂ≠ê <a href=https://github.com/progschj/ThreadPool target=_blank>https://github.com/progschj/ThreadPool</a></li><li>Êó•Âøó</li><li>Êñá‰ª∂</li></ul><h2 id=walÊó•Âøó>WALÊó•Âøó</h2><blockquote><p><a href=https://leveldb-handbook.readthedocs.io/zh/latest/journal.html target=_blank>https://leveldb-handbook.readthedocs.io/zh/latest/journal.html</a></p></blockquote><p>Êó•ÂøóÂú®ÂÜôÊï∞ÊçÆ‰πãÂâçËÆ∞ÂΩïÔºåÂÜôÂÆå‰πãÂêéÁ´ãÂàªflushÔºå‰πãÂêéÊâçÊòØÁúüÊ≠£ÁöÑÂÜôÊï∞ÊçÆÂà∞memtableÔºåÊó•ÂøóÊñá‰ª∂‰ºö‰∏ÄÁõ¥‰øùÂ≠òÔºåÁõ¥Âà∞Êï∞ÊçÆËêΩÁõòÊâçÂà†Èô§ÔºåÂç≥memtableÂèò‰∏∫immemtable‰∏îcompact(Êï∞ÊçÆËêΩÁõò)‰πãÂêéÊâçÂà†Èô§ÔºåÂ¶ÇÊûúÊúüÈó¥Á≥ªÁªüÂºÇÂ∏∏ÔºåÂàôÊó•ÂøóÊñá‰ª∂‰øùÂ≠òÔºåÂà∞‰∏ãÊ¨°ÈáçÂêØ‰πãÂêéÂõûÂ§ç‰πãÂêéÊâçÂà†Èô§Ôºå</p><p>(log::Writer)<br>ÂÜôÊï∞ÊçÆ‰πãÂâçÈúÄË¶ÅÈ¢ÑÂÜôÊó•ÂøóÔºåÁõÆÁöÑÊòØ‰∏∫‰∫Ü‰øùËØÅÊï∞ÊçÆÂÆâÂÖ®ÔºåÂú®Êìç‰ΩúÊï∞ÊçÆÂºÇÂ∏∏ÁöÑÊó∂ÂÄôÂèØ‰ª•‰ΩøÁî®Êó•ÂøóÊÅ¢Â§çÊï∞ÊçÆÔºåÊåâblockÂàíÂàÜÔºå‰∏Ä‰∏™blockÂ§ßÂ∞è‰∏∫32kÔºå‰∏Ä‰∏™blockÊúâÂõõÁßçÁä∂ÊÄÅ</p><ol><li>kFullType<br>‰∏Ä‰∏™blockÂèØ‰ª•Â≠òÂÆåÊï∞ÊçÆ</li><li>kFirstType<br>‰∏Ä‰∏™blockÂ≠ò‰∏ç‰∏ãÊï∞ÊçÆÔºåÊ†áËÆ∞‰∏∫Á¨¨‰∏Ä‰∏™block</li><li>kLastType<br>ÊúÄÂêé‰∏Ä‰∏™block</li><li>kMiddleType<br>‰∏≠Èó¥ÁöÑblock</li></ol><p>ÊØè‰∏Ä‰∏™block‰∏≠ÁöÑÊï∞ÊçÆÁöÑÁªÑÁªáÊ†ºÂºè‰∏∫<code>crc|len(2)|type(1)|values</code>ÔºåÂÖ∂‰∏≠valuesÁöÑÊï∞ÊçÆÊù•Ëá™‰∫éÂâçÈù¢ÁöÑWriteBatchÊâìÂåÖÁöÑÊï∞ÊçÆÔºåÊòØ‰∏Ä‰∏™Êï¥‰ΩìÔºåÊ≤°ÊúâÂÅöÂ§™Â§öÁöÑÂ§ÑÁêÜÔºå‰∏ªË¶ÅÁöÑË∞ÉÁî®ÊñπÊ≥ï‰∏∫</p><ul><li>DBImpl::Write</li><li>DBImpl::NewDB</li><li>VersionSet::LogAndApply</li><li>VersionSet::WriteSnapshot</li></ul><p>(log::Reader)<br>walÂØπÂ∫îÁöÑËØªÂèñÊìç‰Ωú</p><h2 id=lrucache>LRUCache</h2><blockquote><p><a href=https://leveldb-handbook.readthedocs.io/zh/latest/cache.html target=_blank>https://leveldb-handbook.readthedocs.io/zh/latest/cache.html</a></p></blockquote><p>ÁºìÂ≠òÊ®°ÂùóÔºåÊµãËØïÊñá‰ª∂‰∏∫<code>cache_test.cc</code>„ÄÇ</p><ul><li><p>ShardedLRUCache<br>LRUHandleÁöÑÂåÖË£ÖÔºå‰∏ªË¶ÅÂéüÂõ†ÊòØLRUHandleÁöÑÊé•Âè£ÈÉΩÂä†ÈîÅÔºåÊâÄ‰ª•ËøôÈáå‰ΩøÁî®ShardedLRUCacheÂåÖË£Ö‰∏Ä‰∏ãÔºå‰ΩøÁî®16‰∏™LRUHandleÊù•ÁÆ°ÁêÜÁºìÂ≠òÔºå‰ª•ÊèêÈ´òÂπ∂ÂèëÊó∂ÂÄôÁöÑÊìç‰ΩúÊïàÁéá„ÄÇ<code>uint32_t Shard(uint32_t hash) { return hash >> (32 - kNumShardBits); }</code>‰ºö‰ΩøÁî®Ââç4‰∏™bitËÆ°ÁÆó‰ΩçÁΩÆÔºåÂæóÂà∞ÂØπÂ∫îÁöÑLRUHandleÂØπË±°Ôºå‰πãÂêéÁöÑÊìç‰Ωú‰ΩøÁî®Ê≠§ÂØπË±°Â§ÑÁêÜÔºåÁõ∏ÂΩì‰∫éLRUHandleÁöÑhashË°®„ÄÇ</p></li><li><p>LRUCache</p><blockquote><p><a href=https://leetcode.cn/problems/lru-cache/ target=_blank>https://leetcode.cn/problems/lru-cache/</a></p></blockquote><p>LRUÁöÑÂÆûÁé∞Ôºå‰ΩøÁî®HandleTable‰Ωú‰∏∫hashË°®‰øùÂ≠òÁöÑÊï∞ÊçÆ„ÄÇLRUHandle‰∏∫ÈìæË°®‰øùÂ≠òÊï∞ÊçÆÔºå‰∏ªË¶ÅÁªÜËäÇ‰∏∫</p><ul><li>‰ΩøÁî®hashË°®‰øùÂ≠òÊï∞ÊçÆ</li><li>‰ΩøÁî®‰∏Ä‰∏™LRUHandleÁª¥Êä§‰ΩøÁî®ÊÉÖÂÜµÔºåÊï∞ÊçÆÂú®ÁºìÂ≠ò‰∏≠ÁöÑÊó∂ÂÄôÔºåË¶Å‰πàÂè™ÊòØÂú®ÁºìÂ≠ò‰∏≠Ôºå‰øùÂ≠òÂú®lru_ÈìæË°®‰∏≠ÔºåÊàñËÄÖÊòØ‰ΩøÁî®‰∏≠ÁöÑÊï∞ÊçÆÔºå‰øùÂ≠òÂú®<code>in_use_</code>‰∏≠</li><li>‰ΩøÁî®ÂºïÁî®Ê†áËÆ∞Êï∞ÊçÆÁöÑ‰ΩøÁî®ÔºåÂè™ÊúâÂΩìÂºïÁî®‰∏∫0ÁöÑÊó∂ÂÄôÔºåÊâç‰ºöÂà†Èô§Êï∞ÊçÆÔºåÂΩìÊï∞ÊçÆÂ≠òÂú®Âú®ÁºìÂ≠ò‰∏≠ÁöÑÊó∂ÂÄôÔºåÂºïÁî®ÈªòËÆ§‰∏∫1Ôºå‰∏∫0ÂàôË°®Á§∫‰∏çÁºìÂ≠ò‰∏îÊ≤°ÊúâÂ§ñÈÉ®ÂºïÁî®</li><li>ÂØπ‰∫éÈáçÂ§çÁöÑkeyÔºå‰ºöÁõ¥Êé•ÊõøÊç¢</li><li>ÂÆπÈáè‰∏çË∂≥ÁöÑÊó∂ÂÄô„ÄÇÊõøÊç¢lru_‰∏≠ÁöÑÊï∞ÊçÆÔºå<code>in_use_</code>‰∏≠ÁöÑÊï∞ÊçÆ‰∏çÊìç‰Ωú</li><li>ÈìæË°®Âú®appendÁöÑÊó∂ÂÄôÔºåÊÄªÊòØÊ∑ªÂä†Âú®ÈìæË°®Â§¥ËäÇÁÇπ</li></ul></li><li><p>LRUHandle<br>ÂèåÂêëÈìæË°®ÔºåÂú®hashË°®‰∏≠‰ºö‰øùÂ≠òÊï∞ÊçÆÔºåÂú®LRU‰∏≠‰ºöÁª¥Êä§‰ΩøÁî®ÊÉÖÂÜµÔºå</p><ul><li>removeÔºåÁõ¥Êé•ËÆæÁΩÆÈìæÊé•ÔºåË∑≥ËøáÂΩìÂâçËäÇÁÇπ</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> LRUCache<span style=color:#f92672>::</span>LRU_Remove(LRUHandle<span style=color:#f92672>*</span> e) {
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>next<span style=color:#f92672>-&gt;</span>prev <span style=color:#f92672>=</span> e<span style=color:#f92672>-&gt;</span>prev;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>prev<span style=color:#f92672>-&gt;</span>next <span style=color:#f92672>=</span> e<span style=color:#f92672>-&gt;</span>next;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>LRU_AppendÔºåinsertÊìç‰ΩúÔºåÊääËäÇÁÇπappendÂú®ÈìæË°®‰πãÂâç</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> LRUCache<span style=color:#f92672>::</span>LRU_Append(LRUHandle<span style=color:#f92672>*</span> list, LRUHandle<span style=color:#f92672>*</span> e) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Make &#34;e&#34; newest entry by inserting just before *list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  e<span style=color:#f92672>-&gt;</span>next <span style=color:#f92672>=</span> list;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>prev <span style=color:#f92672>=</span> list<span style=color:#f92672>-&gt;</span>prev;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>prev<span style=color:#f92672>-&gt;</span>next <span style=color:#f92672>=</span> e;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>next<span style=color:#f92672>-&gt;</span>prev <span style=color:#f92672>=</span> e;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>HandleTable
LRUHandleÁöÑ‰∫åÁª¥Êï∞ÁªÑÔºå‰ΩøÁî®ËøûÂú∞ÂùÄÊ≥ïÊù•Â§ÑÁêÜÂÜ≤Á™ÅÔºåÂü∫Á°ÄÂÆπÈáè‰∏∫4ÔºårehashÊåâ2Êâ©ÂÖÖÁ©∫Èó¥</p></li></ul><p>ÁºìÂ≠òÊúâ‰∏§ÁßçÔºå‰∏ÄÁßçÊòØÁî®Êù•ÁºìÂ≠òÁöÑÊâìÂºÄÁöÑSST tableÁöÑcacheÔºå‰∏ÄÁßçÊòØÁî®Êù•ÁºìÂ≠ò‰ΩøÁî®ÁöÑblockÁöÑcache</p><h2 id=sst>SST</h2><p><img src=/posts/readbooks/images/image.png alt=Ê†ºÂºèÂúñ>
ÂÖ∑È´îÊ†ºÂºèÂ¶ÇÂúñÔºåÊñá‰ª∂ÊúÄÂêéÊòØfooterÔºå‰øùÂ≠òmataÂíåindexÁöÑÂ§ßÂ∞èÂíåÂÅèÁßªÔºå</p><ul><li><p>footer (<code>Footer::EncodeTo</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  int64 <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> mata
</span></span><span style=display:flex><span>  int64 <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> index
</span></span><span style=display:flex><span>  padding
</span></span><span style=display:flex><span>  magicnum
</span></span></code></pre></div></li><li><p>BlockBuilder<br>Á£ÅÁõòËØªÂÜôÊåâÁÖß‰∏ÄÂÆöÂ§ßÂ∞èËØªÂèñÊØîËæÉÊúâÊïàÁéáÔºåleveldbÊåâÁÖß4KÂ§ßÂ∞èÁªÑÁªáÊñá‰ª∂Ôºå4K‰∏∫‰∏Ä‰∏™blockÔºåblockÊåâÁÖß‰∏Ä‰∏™‰∏Ä‰∏™ÁöÑÊù°ÁõÆÁºñÁ†ÅÊï∞ÊçÆÔºåÊ†ºÂºè‰∏∫<code>slen|uslen|vlen|uskey|v</code>ÔºåsÊåáÁöÑÊòØshareÔºåÂ¶Ç‰∏ãÁöÑ‰æãÂ≠ê</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    string key1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abcd&#34;</span>, v1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vv1vv&#34;</span>;
</span></span><span style=display:flex><span>    string key2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abce&#34;</span>, v2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vv2vv&#34;</span>;
</span></span><span style=display:flex><span>    string key3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abxf&#34;</span>, v3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vv3vv&#34;</span>;
</span></span><span style=display:flex><span>    encode <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span> abcd vv1vv <span style=color:#f92672>|</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>5</span> e vv2vv <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> xf vv3vv}
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>Á¨¨‰∏Ä‰∏™ËÆ∞ÂΩï‰∏çÁºñÁ†ÅÔºåÁ¨¨‰∫å‰∏™ÂíåÁ¨¨‰∏Ä‰∏™ÂØπÊØîÔºåÁºñÁ†ÅÂ≠òÂèñÔºåkeyÊäΩÂèñÁõ∏ÂêåÁöÑÂâçÁºÄÔºåËÆ∞ÂΩïÈïøÂ∫¶Ôºå‰πãÂêéÁöÑÊï∞ÊçÆÈÉΩÊåâÂâç‰∏Ä‰∏™Êï∞ÊçÆÁºñÁ†ÅÔºåÂ¶ÇÊûúÊï∞ÊçÆÂ§™Â§öÔºåÂèØËÉΩÂêéÈù¢ÁöÑkeyÂíå‰πãÂâçÁöÑkeyÂ∑ÆË∑ùÊØîËæÉÂ§ßÔºåÊü•ÊâæÁöÑÊó∂ÂÄôÂè™ËÉΩÂÖ®ÈÉ®Ëß£Á†ÅÁÑ∂ÂêéÂØªÊâækeyÔºåÊâÄ‰ª•ËÆæËÆ°ÂèØ‰ª•ÊéßÂà∂ÊØèÈöîÂõ∫ÂÆöÊï∞ÈáèÁöÑkeyÂ≠ò‰∏Ä‰∏™ÂÆåÊï¥ÁöÑkeyÔºåÁß∞‰∏∫ÈáçÂêØÁÇπÔºåÊåâÈáçÂêØÁÇπÂàíÂàÜ‰∏∫‰∏çÂêåÁöÑgroupÔºåÊ≠§Êó∂‰∏îËÆ∞ÂΩïkeyÁöÑÂÅèÁßªÔºåÊ≠§Êó∂Êü•ÊâæÁöÑÊó∂ÂÄôÂèØ‰ª•ÊåâÁÖßÂÅèÁßªÂèñkeyÁÑ∂Âêé‰ΩøÁî®‰∫åÂàÜÊü•ÊâæÁ≠âÊñπÂºèÂø´ÈÄüÊü•ÂØª„ÄÇÂú®ÊåÅ‰πÖÂåñÁöÑÊó∂ÂÄôÔºåblockÊú´Â∞æËÆ∞ÂΩïgroupÁöÑÂ§ßÂ∞èÔºåÂÜç‰ΩøÁî®‰∏Ä‰∏™bitËÆ∞ÂΩïÂéãÁº©Ê†ºÂºèÔºåÂÜç‰ΩøÁî®4‰∏™bitËÆ∞ÂΩïcrc„ÄÇËøôÂ∞±ÊòØblockÁöÑÂü∫Êú¨Ê†ºÂºè
Èô§‰∫Üfooter‰ΩøÁî®ÂçïÁã¨ÁöÑÁºñÁ†ÅÊ†ºÂºè‰πãÂ§ñ„ÄÇÂÖ∂‰ΩôÁöÑmataÔºåindexÔºådataÈÉΩ‰ΩøÁî®blockÁöÑÊ†ºÂºèÁºñÁ†ÅÊï∞ÊçÆÔºå
block ÊòØ‰∏Ä‰∏™ËØªÂÜôÂçï‰ΩçÔºåÊâÄ‰ª•Â¶ÇÊûú‰ΩøÁî®Âú∫ÊôØÂ§ßÈáèÊâπÈáèËØªÂÜôÔºåÂàôÂèØ‰ª•ÈÄÇÂΩìÂ¢ûÂä†block sizeÔºåÂ¶ÇÊûúÂçïÁÇπËØªÂÜôÊØîËæÉÂ§öÔºåÂàôÂèØ‰ª•ÂáèÂ∞ëblock sizeÔºå ËøôË¶ÅÂπ≥Ë°°</p><ul><li>ÂÜôÂÖ•ÊµÅÁ®ã</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>TableBuilder<span style=color:#f92672>::</span>Add
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (r<span style=color:#f92672>-&gt;</span>pending_index_entry)   <span style=color:#75715e>//  Êñ∞ÁöÑblockËÆæÁΩÆindex
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    index_block.Add
</span></span><span style=display:flex><span>  filter_block<span style=color:#f92672>-&gt;</span>AddKey          <span style=color:#75715e>//  ËÆæÁΩÆfilter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  data_block.Add                <span style=color:#75715e>// Ê∑ªÂä†Êï∞ÊçÆÂà∞data_blockÔºåÂ¶ÇÊûúÂ§ßÂ∞èËææÂà∞ÈôêÂà∂Ôºåflush
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (estimated_block_size <span style=color:#f92672>&gt;=</span> r<span style=color:#f92672>-&gt;</span>options.block_size)
</span></span><span style=display:flex><span>    TableBuilder<span style=color:#f92672>::</span>Flush()
</span></span><span style=display:flex><span>      TableBuilder<span style=color:#f92672>::</span>WriteBlock    <span style=color:#75715e>// ÂÜôblock 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        BlockBuilder<span style=color:#f92672>::</span>Finish      <span style=color:#75715e>// ÊâìÂåÖÊï∞ÊçÆÔºåÁºñÁ†Ågroup offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        compression               <span style=color:#75715e>//  ÂéãÁº©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TableBuilder<span style=color:#f92672>::</span>WriteRawBlock <span style=color:#75715e>//  ÂÜôÂéãÁº©‰πãÂêéÁöÑÊï∞ÊçÆÔºåËÆæÁΩÆÁºñÁ†ÅÊ†ºÂºèÂíåcrc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    r<span style=color:#f92672>-&gt;</span>pending_index_entry <span style=color:#f92672>=</span> true;  <span style=color:#75715e>//  ËÆæÁΩÆÊ†áËÆ∞‰∏∫trueÔºåËÆ∞ÂΩïindex
</span></span></span></code></pre></div><ul><li><p>ËØªÂèñÊµÅÁ®ã<br>ËÆÄÂèñÁöÑÊôÇÂÄôÈÄÜÂêëÊìç‰ΩúÔºåÊ†°Áõ£crc</p></li><li><p>index
indexÁöÑ‰∏ÄÂÄãÊ¢ùÁõÆÂ∞çÊáâÁöÑÊòØ‰∏ÄÂÄãdatablock‰∏≠ÁöÑÊúÄÂ§ßÁöÑkey‰ª•ÂèäblockÁöÑÂÅèÁßªÂíåÂ§ßÂ∞èÔºåkey‰ΩøÁî®FindShortestSeparatorË®àÁÆóÂæóÂá∫ÔºåÁ¢∫‰øù‰ªñË®àÁÆóÁöÑkeyÊòØÁï∂Ââç‰øùÂ≠òÁöÑdatablock‰∏≠ÁöÑÊúÄÂ§ßÂÄºÂä†1ÔºåÁõÆÁöÑÊòØ‰æøÊñºÊü•Êâæ</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  start: abcdef
</span></span><span style=display:flex><span>  limit: abcdgh
</span></span><span style=display:flex><span>  FindShortestSeparator<span style=color:#f92672>--&gt;</span> start <span style=color:#f92672>=</span> abcdf  <span style=color:#75715e>// ÂÖ¨ÂÖ±ÂâçÁ∂¥Âä†1
</span></span></span></code></pre></div></li></ul><hr><ul><li>immemtableÁöÑÂØ´ÂÖ•</li></ul><blockquote><p><a href=https://hardcore.feishu.cn/docs/doccn4w8clvork96K3dqQnJRh9g# target=_blank>https://hardcore.feishu.cn/docs/doccn4w8clvork96K3dqQnJRh9g#</a>
<a href=https://my.oschina.net/fileoptions/blog/903206 target=_blank>https://my.oschina.net/fileoptions/blog/903206</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span>WriteLevel0Table
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    mutex_.Unlock();    <span style=color:#75715e>// ‰∏çÂä†ÈéñÊòØÂõ†Áà≤immemtable‰∏çÂèØËÆäÔºåÊâÄ‰ª•Ê≤íÊúâÂπ∂ÁôºÂïèÈ°å
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    s <span style=color:#f92672>=</span> BuildTable(dbname_, env_, options_, table_cache_, iter, <span style=color:#f92672>&amp;</span>meta);
</span></span><span style=display:flex><span>    BuildTable :{
</span></span><span style=display:flex><span>      <span style=color:#75715e>// get file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// add values
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      builder<span style=color:#f92672>-&gt;</span>Add(key, iter<span style=color:#f92672>-&gt;</span>value());
</span></span><span style=display:flex><span>      s <span style=color:#f92672>=</span> builder<span style=color:#f92672>-&gt;</span>Finish();
</span></span><span style=display:flex><span>      Finish: {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// metaindex
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// footer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>      file<span style=color:#f92672>-&gt;</span>sync();
</span></span><span style=display:flex><span>      file<span style=color:#f92672>-&gt;</span>close();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    mutex_.Lock();
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>ÂÖ∑È´îÁöÑÁ¥∞ÁØÄÂèØ‰ª•ÂèÉËÄÉ‰ª£Á¢ºÁöÑÊñáÊ™îÔºå</p><h2 id=Ëø≠‰ª£Âô®>Ëø≠‰ª£Âô®</h2><p>Ë®™ÂïèÁâπÂÆöÊï∏ÊìöÁµêÊßãÁöÑÊäΩË±°Ôºå‰ΩøÊï∏ÊìöÁöÑË®™ÂïèÂíåÂ≠òÂÑ≤ÂàÜÈõ¢ÔºåÂèØ‰ª•ÂèÉËÄÉSTLÁöÑÂØ¶ÁèæÔºålevelDB‰∏≠Â∞ç‰∏çÂêåÁöÑÁµÑ‰ª∂ÂØ¶Áèæ‰∏çÂêåÁöÑËø≠‰ª£Âô®</p><ul><li>MemTableIterator</li><li>LevelFileNumIterator</li><li>Block::Iter</li></ul><h2 id=version>version</h2><blockquote><p><a href=https://leveldb-handbook.readthedocs.io/zh/latest/version.html target=_blank>https://leveldb-handbook.readthedocs.io/zh/latest/version.html</a></p></blockquote><p>Êú¨Ë¥®‰∏äÊòØ‰ΩøÁî®ÁâàÊú¨Âè∑ÁªÑÊàêkeyÔºåÁî®Êù•Êü•ËØ¢Êï∞ÊçÆÔºå‰πãÂâçÊï∞ÊçÆÂ≠òÊîæÁöÑÊó∂ÂÄôÔºåÊòØÊúâËÆ∞ÂΩïseqÁöÑÔºåversionÊòØ‰∏ì‰∏∫ËøôÁßçË°å‰∏∫ËÆæËÆ°ÁöÑÁ≥ªÁªüÔºå<br>ÈúÄË¶ÅÁÆ°ÁêÜÁ£ÅÁõòÊñá‰ª∂ÁöÑÁâàÊú¨Ôºå‰∏çÂêåÁöÑÁâàÊú¨‰ΩøÁî®‰∏çÂêåÁöÑSequenceÔºåkey‰∏≠Âê´ÊúâLastSequence‰ø°ÊÅØÔºåÊâÄ‰ª•Êú¨Ë¥®‰∏äËøòÊòØkeyÁöÑÊü•ËØ¢</p><ul><li>get<br>ÈúÄË¶ÅËØªÂèñÁ£ÅÁõò‰∏≠ÁöÑÊñá‰ª∂Ôºåversion‰∏≠‰øùÂ≠òFileMetaDataÔºåÊâÄ‰ª•ÂèØ‰ª•Âø´ÈÄüÁöÑÂÆö‰ΩçÊï∞ÊçÆÁöÑsstÔºåÁÑ∂ÂêéÁõ¥Êé•ËØªÂèñsstÔºåÂØπ‰∫éL0ÔºåÁî±‰∫éÂ≠òÂú®ÈáçÂ§çkeyÔºåÊâÄ‰ª•
ÈúÄË¶ÅËøõË°åkeyÁöÑÊØîËæÉÔºåËØªÂèñÂ§ö‰∏™Êñá‰ª∂</li></ul><h2 id=compact>compact</h2><p>ÂÆöÊúüÁöÑÊï∞ÊçÆÁöÑÊï¥ÁêÜÂêàÂπ∂Êìç‰Ωú</p><hr><ul><li>minor compaction<br>immemtableÊåÅ‰πÖÂåñ‰∏∫SSTÔºåÂèØ‰ª•ÊâãÂä®‰ΩøÁî®TEST_CompactMemTableËß¶ÂèëÔºå‰∏ªË¶ÅÊñπÂºèÊòØËÆæÁΩÆ<code>DBImpl::Write</code>ÁöÑWriteBatchÂèÇÊï∞‰∏∫nullÔºåÊ≠§Êó∂Âú®<code>MakeRoomForWrite</code>‰∏≠Ôºå‰ºöÊ†πÊçÆÂèÇÊï∞ÂØºËá¥ÈÄâÊã©compactÁöÑÂàÜÊîØÔºå‰ºöËøõË°åCompactMemTableÊìç‰ΩúÔºåÊ≠§Êó∂‰πãÂâçÁöÑÊï∞ÊçÆ‰ºöÂõ∫ÂåñÂà∞Êñá‰ª∂‰∏≠„ÄÇ‰πüÂèØ‰ª•Ëá™Âä®Ëß¶ÂèëÔºåÂΩìmemtable Êª°‰∫Ü‰πãÂêéÔºå‰ºöËøõË°åÁõ∏ÂêåÁöÑÊìç‰Ωú„ÄÇ<ul><li>TIPS: Ê≠§Êó∂version‰∏≠‰ºö‰øùÂ≠òSSTÁöÑÁõ∏ÂÖ≥‰ø°ÊÅØÔºåÂåÖÊã¨beginkeyÂíåendkeyÔºå‰ª•ÂèäÁâàÊú¨‰ø°ÊÅØ</li><li>Êñá‰ª∂‰∏ç‰∏ÄÂÆöÊòØlevel0ÔºåÂØπ‰∫éÂ§ßÊñá‰ª∂ÔºåÈ¢ÑÊµãlevel0ÂèØËÉΩÂæàÂø´Âà∞ËææÈôêÂà∂ÔºåÂèØ‰ª•Âú®‰∏ÄÂÆöÊù°‰ª∂‰∏ãÁõ¥Êé•ÊääÊñá‰ª∂ÊîæÂú®ËæÉÈ´òÂ±Ç„ÄÇ</li></ul></li></ul><hr><ul><li>Major Compaction<br>sst‰πãÈó¥Âêë‰∏ãÂêàÂπ∂ÔºåÂÖ∂‰ºöÊääÁõ∏ÂêåkeyÁöÑ‰∏çÂêåÁâàÊú¨ÁöÑÊï∞ÊçÆÂêàÂπ∂ÔºåÂèØ‰ª•ÊâãÂä®‰ΩøÁî®TEST_CompactRangeËß¶ÂèëÔºåÊ≠§Êó∂ÂèØ‰ª•ÈÄâÊã©ÈúÄË¶ÅcompactÁöÑlevelÂíåstart keyÂíåendkeyÔºå‰ªñ‰ºöÊääÊñá‰ª∂Âêë‰∏ãÂ±ÇÂêàÂπ∂ÔºåËøôÈáåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØ<ul><li>level0‰ºöÊúâÈáçÂè†ÁöÑkeyÔºåcompactÁöÑÊó∂ÂÄôÈúÄË¶ÅÈÄâÊã©beginkey endkey‰ª•Âèä‰ªñ‰∏≠Èó¥Ë¶ÜÁõñÁöÑÊñá‰ª∂ËøõË°åcompactÊìç‰ΩúÔºåÂê¶Âàô‰ºöÊÆãÁïô‰∏ãold keyÔºå</li><li>sst‰∏ç‰∏ÄÂÆöÊòØÂêë‰∏ãÊé®‰∏ÄÂ±ÇÔºåÂèØ‰ª•ÈÄâÊã©ÊÉ≥Ë¶ÅÂêàÂπ∂ÁöÑÂ±ÇÊï∞ÔºåÂØπ‰∫élevel 0Ôºå‰ΩøÁî®Êñá‰ª∂‰∏™Êï∞ËÆ°ÁÆóscoreÔºåÂØπ‰∫éÂÖ∂‰ªñÂ±ÇÔºå‰ΩøÁî®Êñá‰ª∂Â§ßÂ∞èËÆ°ÁÆó</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> level <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; level <span style=color:#f92672>&lt;</span> config<span style=color:#f92672>::</span>kNumLevels <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; level<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>double</span> score;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (level <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We treat level-0 specially by bounding the number of files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// instead of number of bytes for two reasons:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// (1) With larger write-buffer sizes, it is nice not to do too
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// many level-0 compactions.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// (2) The files in level-0 are merged on every read and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// therefore we wish to avoid too many files when the individual
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// file size is small (perhaps because of a small write-buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// setting, or very high compression ratios, or lots of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// overwrites/deletions).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    score <span style=color:#f92672>=</span> v<span style=color:#f92672>-&gt;</span>files_[level].size() <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>double</span><span style=color:#f92672>&gt;</span>(config<span style=color:#f92672>::</span>kL0_CompactionTrigger);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Compute the ratio of current size to size limit.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint64_t</span> level_bytes <span style=color:#f92672>=</span> TotalFileSize(v<span style=color:#f92672>-&gt;</span>files_[level]);
</span></span><span style=display:flex><span>      score <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>double</span><span style=color:#f92672>&gt;</span>(level_bytes) <span style=color:#f92672>/</span> MaxBytesForLevel(options_, level);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (score <span style=color:#f92672>&gt;</span> best_score) {
</span></span><span style=display:flex><span>      best_level <span style=color:#f92672>=</span> level;
</span></span><span style=display:flex><span>      best_score <span style=color:#f92672>=</span> score;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li>sstËÆ∞ÂΩï‰∏Ä‰∏™Êü•ËØ¢Ê¨°Êï∞ÔºåÂΩì‰∏Ä‰∏™Êñá‰ª∂Ë¢´Êü•ËØ¢Â§öÊ¨°‰∏îÊòØÊó†ÊïàÊü•ËØ¢ÁöÑÊó∂ÂÄôÁöÑÔºåÂΩìËææÂà∞‰∏ÄÂÆöÊ¨°Êï∞Â∞±‰ºöËß¶ÂèëcompcatÊìç‰ΩúÔºåÁêÜÁî±ÊòØ‰ªñÂèØËÉΩÂíåÂÖ∂‰ªñÊñá‰ª∂ÊúâÂ§™Â§öÁöÑÈáçÂ§çÁöÑkeyÔºåÈúÄË¶ÅË¢´Ê∏ÖÁêÜ‰ª•Âπ≥Ë°°ioÊìç‰ΩúÔºåËøôÈáåÁöÑ‰æùÊçÆÊòØÁöÑ‰∏ÄÊ¨°È¢ùÂ§ñÁöÑcompactÊìç‰ΩúÁöÑcostÂíåÂ§öÊ¨°ÁöÑÊó†ÊïàseekÁöÑÂùáË°°„ÄÇ</li><li></li></ul>‰ªñÁöÑÂ§ßËá¥ÈÄªËæëÊòØÂΩìÂâç‰ΩøÁî®ÁöÑÁ∫øÁ®ãËÆæÁΩÆmanual_compaction_‰ø°ÊÅØÔºåÁÑ∂ÂêéË∞ÉÁî®compactÁ∫øÁ®ã‰ΩøÁî®manual_compaction_ÊâßË°åcompactÊìç‰Ωú<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>compact {
</span></span><span style=display:flex><span>  BackgroundCompaction {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (imm_ <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>      CompactMemTable();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Compaction<span style=color:#f92672>*</span> c;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (is_manual) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ÊâßË°åmanual compactÔºå‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºåËé∑ÂæóCompaction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      c <span style=color:#f92672>=</span> versions_<span style=color:#f92672>-&gt;</span>CompactRange(m<span style=color:#f92672>-&gt;</span>level, m<span style=color:#f92672>-&gt;</span>begin, m<span style=color:#f92672>-&gt;</span>end);
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (c <span style=color:#f92672>==</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ‰∏çÂÅöÂ§ÑÁêÜÔºå‰∏çÈúÄË¶Åcompact
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (<span style=color:#f92672>!</span>is_manual <span style=color:#f92672>&amp;&amp;</span> c<span style=color:#f92672>-&gt;</span>IsTrivialMove()) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ‰ªÖ‰ªÖÂè™ÈúÄË¶ÅÁßªÂä®Êñá‰ª∂Ôºå‰æãÂ¶ÇÊúÄÂºÄÂßãÁöÑÊó∂ÂÄô‰∏ãÂ±ÇÊ≤°ÊúâÈúÄË¶ÅÂêàÂπ∂ÁöÑÊñá‰ª∂ÔºåÁõ¥Êé•ÁßªÂä®Êñá‰ª∂Ôºå‰øÆÊîπÂÖÉÊï∞ÊçÆÂç≥ÂèØ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ÊâßË°åcompact
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      CompactionState<span style=color:#f92672>*</span> compact <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompactionState(c);
</span></span><span style=display:flex><span>      status <span style=color:#f92672>=</span> DoCompactionWork(compact); 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//  Â§ö‰∏™Êñá‰ª∂ÁöÑÂêàÂπ∂Êìç‰ΩúÔºå‰ºöÂ§ÑÁêÜËøáÊúüÊàñËÄÖÈúÄË¶ÅÂà†Èô§ÁöÑÊï∞ÊçÆ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  DoCompactionWork {
</span></span><span style=display:flex><span>    Iterator<span style=color:#f92672>*</span> input <span style=color:#f92672>=</span> versions_<span style=color:#f92672>-&gt;</span>MakeInputIterator(compact<span style=color:#f92672>-&gt;</span>compaction);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (input<span style=color:#f92672>-&gt;</span>Valid() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>shutting_down_.load(std<span style=color:#f92672>::</span>memory_order_acquire)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (has_imm_.load(std<span style=color:#f92672>::</span>memory_order_relaxed)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//  Â¶ÇÊûúÊúâminor compactÔºåÂàô‰ºòÂÖàÂ§ÑÁêÜ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Âà§Êñ≠ÈáçÂè†ÔºåÈáçÂè†Â§™Â§öÂΩ±ÂìçÊü•ËØ¢ÔºåÁõ¥Êé•ÁªàÊ≠¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> compact<span style=color:#f92672>-&gt;</span>compaction<span style=color:#f92672>-&gt;</span>ShouldStopBefore(key)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#960050;background-color:#1e0010>Ôºõ</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Â§ÑÁêÜkey
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Â¶ÇÊûúÊòØdelete
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//  ÊàñËÄÖÊòØsequenceÂ∞è‰∫éÂΩìÂâç‰ΩøÁî®‰∏≠ÁöÑsequence 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//  ÊàñËÄÖÊõ¥È´òÂ±ÇÊ≤°ÊúâËøô‰∏™key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        drop <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>drop)
</span></span><span style=display:flex><span>        compact<span style=color:#f92672>-&gt;</span>builder<span style=color:#f92672>-&gt;</span>Add(key, input<span style=color:#f92672>-&gt;</span>value());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><p>Áî±‰∫écompactÁöÑÊó∂ÂÄôÔºå‰ºöÂç†Áî®‰∏ÄÂÆöÁöÑÁ≥ªÁªüËµÑÊ∫êÔºåÊâÄ‰ª•Â¶ÇÊûúÂèëÁîücompactionÁöÑÊó∂ÂÄô</p><ul><li>Â¶ÇÊûúÊòØminor compactÔºåÂàôÂáèÁºìÂÜôÊìç‰ΩúÔºåÈáäÊîæ‰∏ÄÂÆöÁöÑÁ≥ªÁªüËµÑÊ∫ê</li><li>Â¶ÇÊûúÊòØMajor CompactionÔºåÂàôÊöÇÂÅúÊìç‰Ωú„ÄÇÁ≠âÂæÖcompact‰ªªÂä°ÂÆåÊàê</li></ul></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><a role=button class="btn btn-outline h-12" href=/posts/course/6.824/coursenote/ title=Coursenote><ion-icon name=chevron-back></ion-icon><div class="inline-flex flex-col items-start"><span class="text-base-content/60 text-xs font-normal">Previous page</span>
<span class="max-w-48 truncate">Coursenote</span></div></a><a role=button class="btn btn-outline h-12" href=/posts/readbooks/volcanooptimizer/ title=VolcanoOptimizer><div class="inline-flex flex-col items-end"><span class="text-base-content/60 text-xs font-normal">Next page</span>
<span class="max-w-48 truncate">VolcanoOptimizer</span></div><ion-icon name=chevron-forward></ion-icon></a></div></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end lg:self-start"><nav id=TableOfContents><ul><li><a href=#ÁºñËØë>ÁºñËØë</a></li><li><a href=#slice>slice</a></li><li><a href=#status>status</a></li><li><a href=#Êï∞ÂÄºÁºñÁ†Å>Êï∞ÂÄºÁºñÁ†Å</a></li><li><a href=#arena>Arena</a></li><li><a href=#skiplist>SkipList</a></li><li><a href=#memtable>MemTable</a></li><li><a href=#dbimpl>DBImpl</a></li><li><a href=#writebatch>WriteBatch</a></li><li><a href=#posixenv>PosixEnv</a></li><li><a href=#walÊó•Âøó>WALÊó•Âøó</a></li><li><a href=#lrucache>LRUCache</a></li><li><a href=#sst>SST</a></li><li><a href=#Ëø≠‰ª£Âô®>Ëø≠‰ª£Âô®</a></li><li><a href=#version>version</a></li><li><a href=#compact>compact</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>¬© 2016 - 2025 Askyx's Blog</p><p class=text-sm>üå±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>Hi, my name is Yue Yang.</p><p>This is my blog.</p><h2 id=„Éæœâo>„Éæ(‚Ä¢œâ‚Ä¢`)o</h2><p>ÊØîËæÉËÉÜÂ∞èÔºåÂá∫Èó®ÈÉΩÂæóË¥¥Â¢ôËµ∞</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>¬© 2016 - 2025 Askyx's Blog</p><p class=text-sm>üå±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"en"}).toFormat("yyyyÂπ¥MMÊúàddÊó•")})}</script><script src=/js/toc.min.js></script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
      })
    </script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>