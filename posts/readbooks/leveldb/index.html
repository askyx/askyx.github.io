<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>LevelDBæºç é˜…è¯» | Askyx's Blog</title><link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>ğŸŒ±</text></svg>"></link>
<link rel=canonical href=https://askyx.github.io/posts/readbooks/leveldb/><meta name=author content="Askyx"><meta name=description content="leveldb æºç æ€»ç»“åˆ†æ"><meta name=keywords content="æºç é˜…è¯»,LevelDB,å­˜å‚¨å¼•æ“"><meta name=generator content="Hugo 0.148.1"><meta property="og:url" content="https://askyx.github.io/posts/readbooks/leveldb/"><meta property="og:site_name" content="Askyx's Blog"><meta property="og:title" content="LevelDBæºç é˜…è¯»"><meta property="og:description" content="leveldb æºç æ€»ç»“åˆ†æ"><meta property="og:locale" content="zh_Hans"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-15T21:59:53+08:00"><meta property="article:modified_time" content="2025-07-18T17:05:11+08:00"><meta property="article:tag" content="æºç é˜…è¯»"><meta property="article:tag" content="LevelDB"><meta property="article:tag" content="å­˜å‚¨å¼•æ“"><meta property="og:image" content="https://askyx.github.io/img/global-background.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://askyx.github.io/img/global-background.jpg"><meta name=twitter:title content="LevelDBæºç é˜…è¯»"><meta name=twitter:description content="leveldb æºç æ€»ç»“åˆ†æ"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><link rel=stylesheet href=/css/custom.css><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title="Flip it!"><div class="h-10 rounded-full"><img src=/img/personal/avatar.jpg alt="Askyx's Blog"></div></div><div><a href=https://askyx.github.io/ class="text-lg font-semibold cursor-pointer">Askyx's Blog</a><div class="text-base-content/60 text-sm">life is short, use Python</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=About><ion-icon name=information-circle></ion-icon>About</div></li><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=Search><ion-icon name=search></ion-icon>Search</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=https://github.com/askyx target=_blank title=GitHub><ion-icon name=logo-github></ion-icon>GitHub</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=About>About</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=Search><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=https://github.com/askyx target=_blank title=GitHub><ion-icon class=group-hover:text-primary-content name=logo-github></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="LevelDBæºç é˜…è¯»"><meta itemprop=description content="leveldb æºç æ€»ç»“åˆ†æ"><meta itemprop=datePublished content="2022-05-15T21:59:53+08:00"><meta itemprop=dateModified content="2025-07-18T17:05:11+08:00"><meta itemprop=wordCount content="7998"><meta itemprop=image content="https://askyx.github.io/img/global-background.jpg"><meta itemprop=keywords content="æºç é˜…è¯»,LevelDB,å­˜å‚¨å¼•æ“"><header><h1 itemprop=headline>LevelDBæºç é˜…è¯»</h1><p class=text-sm><span data-format=luxon>2022-05-15T21:59:53+08:00</span>
| <span>16 minute read</span>
| <span>Updated at
<span data-format=luxon>2025-07-18T17:05:11+08:00</span></span></p></header><section id=dream-single-post-content itemprop=articleBody><hr><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>LevelDB:    version <span style=color:#ae81ff>1.23</span>
</span></span><span style=display:flex><span>Date:       Thu Oct <span style=color:#ae81ff>20</span> <span style=color:#ae81ff>15</span><span style=color:#f92672>:</span><span style=color:#ae81ff>32</span><span style=color:#f92672>:</span><span style=color:#ae81ff>47</span> <span style=color:#ae81ff>2022</span>
</span></span><span style=display:flex><span>CPU:        <span style=color:#ae81ff>16</span> <span style=color:#f92672>*</span> AMD Ryzen <span style=color:#ae81ff>9</span> <span style=color:#ae81ff>5900</span>HS with Radeon Graphics
</span></span><span style=display:flex><span>CPUCache:   <span style=color:#ae81ff>512</span> KB
</span></span><span style=display:flex><span>Keys:       <span style=color:#ae81ff>16</span> bytes each
</span></span><span style=display:flex><span>Values:     <span style=color:#ae81ff>100</span> bytes each (<span style=color:#ae81ff>50</span> bytes after compression)
</span></span><span style=display:flex><span>Entries:    <span style=color:#ae81ff>1000000</span>
</span></span><span style=display:flex><span>RawSize:    <span style=color:#ae81ff>110.6</span> MB (estimated)
</span></span><span style=display:flex><span>FileSize:   <span style=color:#ae81ff>62.9</span> MB (estimated)
</span></span><span style=display:flex><span><span style=color:#f92672>------------------------------------------------</span>
</span></span><span style=display:flex><span>fillseq      :       <span style=color:#ae81ff>1.394</span> micros<span style=color:#f92672>/</span>op;   <span style=color:#ae81ff>79.3</span> MB<span style=color:#f92672>/</span>s     
</span></span><span style=display:flex><span>fillsync     :    <span style=color:#ae81ff>1208.178</span> micros<span style=color:#f92672>/</span>op;    <span style=color:#ae81ff>0.1</span> MB<span style=color:#f92672>/</span>s (<span style=color:#ae81ff>1000</span> ops)
</span></span><span style=display:flex><span>fillrandom   :       <span style=color:#ae81ff>1.948</span> micros<span style=color:#f92672>/</span>op;   <span style=color:#ae81ff>56.8</span> MB<span style=color:#f92672>/</span>s     
</span></span><span style=display:flex><span>overwrite    :       <span style=color:#ae81ff>2.448</span> micros<span style=color:#f92672>/</span>op;   <span style=color:#ae81ff>45.2</span> MB<span style=color:#f92672>/</span>s     
</span></span><span style=display:flex><span>readrandom   :       <span style=color:#ae81ff>3.251</span> micros<span style=color:#f92672>/</span>op; (<span style=color:#ae81ff>864322</span> of <span style=color:#ae81ff>1000000</span> found)
</span></span><span style=display:flex><span>readrandom   :       <span style=color:#ae81ff>2.947</span> micros<span style=color:#f92672>/</span>op; (<span style=color:#ae81ff>864083</span> of <span style=color:#ae81ff>1000000</span> found)
</span></span><span style=display:flex><span>readseq      :       <span style=color:#ae81ff>0.126</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>878.1</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>readreverse  :       <span style=color:#ae81ff>0.216</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>511.4</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>compact      :  <span style=color:#ae81ff>473557.000</span> micros<span style=color:#f92672>/</span>op;
</span></span><span style=display:flex><span>readrandom   :       <span style=color:#ae81ff>2.174</span> micros<span style=color:#f92672>/</span>op; (<span style=color:#ae81ff>864105</span> of <span style=color:#ae81ff>1000000</span> found)
</span></span><span style=display:flex><span>readseq      :       <span style=color:#ae81ff>0.111</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>997.1</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>readreverse  :       <span style=color:#ae81ff>0.185</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>598.0</span> MB<span style=color:#f92672>/</span>s    
</span></span><span style=display:flex><span>fill100K     :     <span style=color:#ae81ff>530.603</span> micros<span style=color:#f92672>/</span>op;  <span style=color:#ae81ff>179.8</span> MB<span style=color:#f92672>/</span>s (<span style=color:#ae81ff>1000</span> ops)
</span></span><span style=display:flex><span>crc32c       :       <span style=color:#ae81ff>0.904</span> micros<span style=color:#f92672>/</span>op; <span style=color:#ae81ff>4322.1</span> MB<span style=color:#f92672>/</span>s (<span style=color:#ae81ff>4</span>K per op)
</span></span><span style=display:flex><span>snappycomp   :       <span style=color:#ae81ff>2.353</span> micros<span style=color:#f92672>/</span>op; <span style=color:#ae81ff>1659.9</span> MB<span style=color:#f92672>/</span>s (output: <span style=color:#ae81ff>55.1</span><span style=color:#f92672>%</span>)
</span></span><span style=display:flex><span>snappyuncomp :       <span style=color:#ae81ff>0.390</span> micros<span style=color:#f92672>/</span>op; <span style=color:#ae81ff>10026.4</span> MB<span style=color:#f92672>/</span>s 
</span></span></code></pre></div><hr><pre><code>read: d019e3605f222ebc5a3a2484a2cb29db537551dd
</code></pre><p>å°ä¸”å®Œæ•´çš„å·¥ä¸šå­˜å‚¨å®ç°ï¼Œå…¶ä¸­æœ‰è®¸å¤šç»†èŠ‚æ˜¯å¯ä»¥å€Ÿé‰´çš„ã€‚è¿™é‡Œæ²¡æœ‰å®Œæ•´çš„æ·±å…¥æ¯ä¸€è¡Œä»£ç ï¼Œåç»­ä¼šæ—¶ä¸æ—¶çš„æ…¢æ…¢è¡¥å……</p><ul><li>2022-05-17 åˆæ­¥é˜…è¯»ä»£ç ï¼Œäº†è§£ç»„ä»¶åŠå¤§è‡´æ‰§è¡Œé€»è¾‘</li><li>2022-10-20 é‡è¯»éƒ¨åˆ†ä»£ç ï¼Œæ„Ÿè§‰è‡ªå·±è²Œä¼¼æœ‰äº†äº›è®¸é•¿è¿›</li></ul><h2 id=ç¼–è¯‘>ç¼–è¯‘</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>git clone --recurse-submodules https://github.com/google/leveldb.git
</span></span><span style=display:flex><span>cd leveldb
</span></span></code></pre></div><p><code>VSCode</code>å®‰è£…<code>cmake</code>æ’ä»¶ä¹‹åï¼Œæ‰“å¼€é¡¹ç›®ï¼Œcmakeæ’ä»¶è‡ªåŠ¨é…ç½®ï¼Œæ­¤æ—¶ä½¿ç”¨<code>shift+p</code>è®¾ç½®<code>cmake: set build target</code>ä¹‹åï¼Œå†ä½¿ç”¨<code>shift+p</code>é€‰æ‹©<code>cmake: build</code>å³å¯ç¼–è¯‘ç›®æ ‡æ¨¡å—ï¼Œd019e3605f222ebc5a3a2484a2cb29db537551ddä¸­æµ‹è¯•æ–‡ä»¶è¿›è¡Œäº†è°ƒæ•´ï¼Œå…¨éƒ¨åˆå¹¶åˆ°<code>leveldb_tests</code>ä¸­ï¼Œè°ƒè¯•æ—¶æŒ‰ç…§æƒ³è¦äº†è§£çš„æ¨¡å—ï¼Œè‡ªå·±æ³¨é‡Šå…¶ä»–æµ‹è¯•æ–‡ä»¶ï¼Œé‡æ–°ç¼–è¯‘å³å¯ã€‚æ­¤æ—¶å¯ä»¥åœ¨æ–‡ä»¶ä¸­æ–­ç‚¹è°ƒè¯•ï¼Œæˆ–è€…ä½¿ç”¨gdbè°ƒè¯•</p><h2 id=slice>slice</h2><p>å­—ç¬¦ä¸²çš„æµ…æ‹·è´å®ç°ï¼Œä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆå’ŒæŒ‡é’ˆé•¿åº¦å®ç°ï¼Œç±»ä¼¼c++åæ¥å®ç°çš„string_viewï¼Œå¦‚æœä½¿ç”¨stringï¼Œåˆ™åœ¨ä¼ é€’æ•°æ®çš„æ—¶å€™ä¼šè¿›è¡Œæ‹·è´æ“ä½œï¼Œæœ‰æ€§èƒ½æŸå¤±ã€‚å¦ä¸€ä¸ªç›®çš„æ˜¯ä¸ºäº†è‡ªä¸»å¯æ§ï¼Œç¡®ä¿æ•°æ®åœ¨ä¼ è¾“çš„è¿‡ç¨‹ä¸­ä¸ä¼šé€ æˆå¤ªå¤šçš„æ•°æ®å‰¯æœ¬ã€‚æ‰€ä»¥æ‹·è´æ„é€ å‡½æ•°ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„ç³»ç»Ÿå‡½æ•°ï¼Œä½¿ç”¨æµ…æ‹·è´</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Slice(<span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span><span style=display:flex><span>Slice<span style=color:#f92672>&amp;</span> <span style=color:#66d9ef>operator</span><span style=color:#f92672>=</span>(<span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span>) <span style=color:#f92672>=</span> <span style=color:#66d9ef>default</span>;
</span></span></code></pre></div><h2 id=status>status</h2><p>è‡ªå®šä¹‰ä¿¡æ¯æ¨¡å—ï¼ŒæŠŠçŠ¶æ€ç å’ŒçŠ¶æ€ä¿¡æ¯è¿›è¡Œå‹ç¼©ï¼Œå‹ç¼©æ ¼å¼å¦‚ä¸‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Status<span style=color:#f92672>::</span>Status(Code code, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> msg, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> msg2) {
</span></span><span style=display:flex><span>  assert(code <span style=color:#f92672>!=</span> kOk);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> len1 <span style=color:#f92672>=</span> <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint32_t</span><span style=color:#f92672>&gt;</span>(msg.size());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> len2 <span style=color:#f92672>=</span> <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint32_t</span><span style=color:#f92672>&gt;</span>(msg2.size());
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint32_t</span> size <span style=color:#f92672>=</span> len1 <span style=color:#f92672>+</span> (len2 <span style=color:#f92672>?</span> (<span style=color:#ae81ff>2</span> <span style=color:#f92672>+</span> len2) <span style=color:#f92672>:</span> <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> result <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#66d9ef>char</span>[size <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>];
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>memcpy(result, <span style=color:#f92672>&amp;</span>size, <span style=color:#66d9ef>sizeof</span>(size));
</span></span><span style=display:flex><span>  result[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>=</span> <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>char</span><span style=color:#f92672>&gt;</span>(code);
</span></span><span style=display:flex><span>  std<span style=color:#f92672>::</span>memcpy(result <span style=color:#f92672>+</span> <span style=color:#ae81ff>5</span>, msg.data(), len1);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (len2) {
</span></span><span style=display:flex><span>    result[<span style=color:#ae81ff>5</span> <span style=color:#f92672>+</span> len1] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;:&#39;</span>;
</span></span><span style=display:flex><span>    result[<span style=color:#ae81ff>6</span> <span style=color:#f92672>+</span> len1] <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39; &#39;</span>;
</span></span><span style=display:flex><span>    std<span style=color:#f92672>::</span>memcpy(result <span style=color:#f92672>+</span> <span style=color:#ae81ff>7</span> <span style=color:#f92672>+</span> len1, msg2.data(), len2);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  state_ <span style=color:#f92672>=</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><blockquote><p>TIPS: å¯¹äºæ•°å­—ï¼Œä¹‹é™…æ‹·è´åœ°å€å¯ä»¥ç›´æ¥åºåˆ—åŒ–ï¼Œä¸éœ€è¦ä½¿ç”¨ to_stringï¼Œå–æ•°çš„æ—¶å€™ç›´æ¥å–å­—èŠ‚ç ï¼Œç„¶åstatic_castå°±å¯ä»¥äº†</p></blockquote><h2 id=æ•°å€¼ç¼–ç >æ•°å€¼ç¼–ç </h2><p>leveldbä¸­å‡ ä¹æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šå’Œæ•°æ®æ ¼å¼çš„ç¼–ç æˆ–å¤šæˆ–å°‘çš„æœ‰è”ç³»ï¼Œé¦–å…ˆæ•°æ®çš„å­˜å‚¨ä¸èƒ½ç›´æ¥ç®€å•çš„to_stringç„¶åå­˜å‚¨å­—ç¬¦ä¸²ï¼Œå…¶æ¬¡å¯¹äºæ•´å½¢çš„å˜é•¿ç¼–ç ï¼Œä»–ä¼šæŠŠæ•°æ®çš„äºŒè¿›åˆ¶ç¼–ç æŒ‰7æ‹†åˆ†ï¼Œåœ¨æ¯ä¸ªå­—èŠ‚çš„ç¬¬ä¸€ä½ä½¿ç”¨1è¡¨ç¤ºæ˜¯å¦ä¸ºæ•°æ®çš„ç»“å°¾ï¼Œä¾‹å¦‚<code>int(1)</code>ç¼–ç ä¸º<code>00000001</code>ï¼Œ<code>11 10101010</code>ä¼šç¼–ç ä¸º<code>10101010 00000111</code>ï¼Œå¯¹åº”å‹ç¼©å’Œè§£å‹ä»£ç å¦‚ä¸‹ï¼Œå˜é•¿ç¼–ç æ˜¯ä¸€ç§ç¼–ç¨‹æŠ€å·§ï¼Œintç±»å‹æ˜¯4å­—èŠ‚ï¼Œlongæ˜¯8å­—èŠ‚ã€‚å½“å­˜å‚¨çš„æ•°æ®å°çš„æ—¶å€™ã€‚å¯ä»¥èŠ‚çº¦ç©ºé—´ã€‚å¹¶ä¸”æˆ‘ä»¬æœ‰ç†ç”±ç›¸ä¿¡ï¼Œç¨‹åºä¸­å¤§éƒ¨åˆ†åœºæ™¯ä½¿ç”¨çš„æ˜¯å°æ•°å­—ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> <span style=color:#a6e22e>EncodeVarint32</span>(<span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> dst, <span style=color:#66d9ef>uint32_t</span> v) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Operate on characters as unsigneds
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*</span> ptr <span style=color:#f92672>=</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*&gt;</span>(dst);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>int</span> B <span style=color:#f92672>=</span> <span style=color:#ae81ff>128</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>7</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>14</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>|</span> B;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>7</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>21</span>)) {
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>|</span> B;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> (v <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>7</span>) <span style=color:#f92672>|</span> B;
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>(ptr<span style=color:#f92672>++</span>) <span style=color:#f92672>=</span> v <span style=color:#f92672>&gt;&gt;</span> <span style=color:#ae81ff>14</span>;
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (v <span style=color:#f92672>&lt;</span> (<span style=color:#ae81ff>1</span> <span style=color:#f92672>&lt;&lt;</span> <span style=color:#ae81ff>28</span>)) {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> GetVarint32PtrFallback(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> p, <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> limit,
</span></span><span style=display:flex><span>                                   <span style=color:#66d9ef>uint32_t</span><span style=color:#f92672>*</span> value) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>uint32_t</span> result <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>uint32_t</span> shift <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; shift <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>28</span> <span style=color:#f92672>&amp;&amp;</span> p <span style=color:#f92672>&lt;</span> limit; shift <span style=color:#f92672>+=</span> <span style=color:#ae81ff>7</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint32_t</span> byte <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>(<span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint8_t</span><span style=color:#f92672>*&gt;</span>(p));
</span></span><span style=display:flex><span>    p<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (byte <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>128</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// More bytes are present
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      result <span style=color:#f92672>|=</span> ((byte <span style=color:#f92672>&amp;</span> <span style=color:#ae81ff>127</span>) <span style=color:#f92672>&lt;&lt;</span> shift);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      result <span style=color:#f92672>|=</span> (byte <span style=color:#f92672>&lt;&lt;</span> shift);
</span></span><span style=display:flex><span>      <span style=color:#f92672>*</span>value <span style=color:#f92672>=</span> result;
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>reinterpret_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*&gt;</span>(p);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nullptr</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>é™¤äº†å˜é•¿ä¹‹å¤–ï¼Œè¿˜æœ‰å®šé•¿ç¼–ç ï¼Œä»¥åŠå¯¹åº”çš„32ä½ï¼Œ64ä½çš„å®ç°ç­‰ï¼Œåœ¨å®é™…çš„æ•°æ®å¤„ç†ä¸­ï¼Œä¼šæœ‰è®°å½•æ•°æ®é•¿åº¦ç­‰æ“ä½œï¼Œå°±ä¼šä½¿ç”¨ç¼–ç æ“ä½œï¼ŒæŠŠæ•°å€¼ç¼–ç åˆ°æ•°æ®ä¸­ã€‚å®šé•¿ç¼–ç æ˜¯ç›´æ¥å­˜å‚¨å­—èŠ‚åºã€‚</p><h2 id=arena>Arena</h2><p>è‡ªå®šä¹‰å†…å­˜æ± ï¼Œè®¾è®¡æ€è·¯æ˜¯ç”³è¯·å†…å­˜å’Œåˆ†é…å†…å­˜éš”ç¦»ï¼Œç”³è¯·å†…å­˜çš„æ—¶å€™å¤šç”³è¯·ï¼Œåˆ†é…å†…å­˜çš„æ—¶å€™ä»å·²ç”³è¯·çš„å†…å­˜ä¸­åˆ†é…ï¼Œä½¿ç”¨vectorç»´æŠ¤å†…å­˜ç©ºé—´ï¼ŒLevelDBä¸­åœ¨memtableä¸­ä½¿ç”¨ï¼Œç†è®ºä¸Šå¯ä»¥ç”¨åœ¨ä»»ä½•æƒ³ä½¿ç”¨çš„ç»„ä»¶ä¸­ï¼Œä½†æ˜¯å®é™…ä¸Šæ•°æ®å˜åŠ¨æœ€å¤šçš„åœ°æ–¹æ˜¯memtableï¼Œæ‰€ä»¥æš‚æ—¶åªå‘ç°åªæœ‰è¿™é‡Œä½¿ç”¨ã€‚</p><ul><li>å¯¹äºå¤§ç©ºé—´(å¤§äºkBlockSize / 4çš„ç©ºé—´ï¼Œå¤§äºkBlockSize = 4096)ï¼Œåˆ™ç›´æ¥ç”³è¯·ï¼Œç‹¬å ä¸€ä¸ªblockï¼Œä¸å—blockå¤§å°çš„é™åˆ¶ï¼Œä¸”ä¸æ”¹å˜ä¹‹å‰è®°å½•çš„blockçš„æŒ‡é’ˆçŠ¶æ€</li><li>å¯¹äºå°ç©ºé—´<ul><li>ç¬¬ä¸€æ¬¡ä¼šç”³è¯·å¤§å°ä¸º4kçš„ç©ºé—´ï¼Œç„¶åè®°å½•å½“å‰ç©ºé—´çš„æŒ‡é’ˆåŠç©ºé—´ä½¿ç”¨æƒ…å†µï¼Œç„¶åä»ç©ºé—´ä¸Šåˆ†é…å†…å­˜ï¼Œä¸”ç©ºé—´pushåˆ°vectorä¸­</li><li>ä¹‹åçš„ç©ºé—´ç”³è¯·å¦‚æœåœ¨å½“å‰blockä¸Šå¯ä»¥ç»§ç»­åˆ†é…ï¼Œåˆ™åœ¨blockä¸Šç›´æ¥åˆ†é…</li><li>å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™é‡æ–°åˆ†é…ï¼Œä¹‹å‰æ®‹ç•™çš„ç©ºé—´ç›´æ¥ä¸¢å¼ƒï¼Œä¸”ä¸è®¡å…¥ä½¿ç”¨ç©ºé—´ç»Ÿè®¡</li></ul></li><li>å¯¹äºç©ºé—´çš„ç»Ÿè®¡æƒ…å†µï¼Œä½¿ç”¨åŸå­å˜é‡<code>std::atomic&lt;size_t> memory_usage_;</code>è®°å½•ï¼Œå› ä¸ºArenaåœ¨skiplistä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯èƒ½æœ‰å¹¶å‘çš„æƒ…å†µ</li></ul><blockquote><p>TIPS: åŸå­ç±»å‹çš„ç»†èŠ‚éœ€è¦è°ƒç ”</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span> pool <span style=color:#f92672>=</span> area<span style=color:#f92672>-&gt;</span>Allocate(size);               <span style=color:#75715e>// ä¸å¯¹é½çš„ç”³è¯·
</span></span></span><span style=display:flex><span><span style=color:#75715e>// char * pool = area-&gt;AllocateAligned(size);     // ç”³è¯·å¯¹é½çš„ç©ºé—´
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>auto</span> mem <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> (pool) <span style=color:#66d9ef>char</span>(size);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Allocate(size) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (size <span style=color:#f92672>&lt;</span> alloc_bytes_remaining_) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span> result <span style=color:#f92672>=</span> alloc_ptr_;
</span></span><span style=display:flex><span>    alloc_ptr_ <span style=color:#f92672>+=</span> bytes;
</span></span><span style=display:flex><span>    alloc_bytes_remaining_ <span style=color:#f92672>-=</span> bytes;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> result;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>AllocateFallback</span>(size);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=skiplist>SkipList</h2><p>æ¥è‡ªè®ºæ–‡<a href=https://15721.courses.cs.cmu.edu/spring2018/papers/08-oltpindexes1/pugh-skiplists-cacm1990. target=_blank>Skip lists: a probabilistic alternative to balanced trees</a>
ï¼Œå…¶ä¸­ä»‹ç»äº†è·³è¡¨çš„å®ç°å’Œå…¶ä»–ä¸åŒç»“æ„ä¹‹é—´çš„å¯¹æ¯”æƒ…å†µï¼Œ</p><blockquote><p>éœ€è¦é‡ä¿®æ¦‚ç‡è®º</p></blockquote><p>è·³è¡¨ä½¿ç”¨ä½¿ç”¨æ¦‚ç‡å‡è¡¡çš„æŠ€æœ¯ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½å¯ä»¥å®ç°<code>O(log n)</code>çš„æ—¶é—´å¤æ‚åº¦ï¼Œå¯ä»¥å‚è€ƒä¸Šé¢çš„æ–‡ç« ï¼Œè¿™é‡Œæ€»ç»“å‡ ä¸ªç‚¹</p><ol><li>è·³è¡¨å¯ä»¥ç®€å•çš„ç†è§£ä¸ºé“¾è¡¨çš„+indexçš„å®ç°ï¼Œindexçš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿçš„æŸ¥æ‰¾æ•°æ®</li><li>è·³è¡¨åœ¨å¢åŠ èŠ‚ç‚¹çš„æ—¶å€™ï¼Œä½¿ç”¨æ¦‚ç‡ä¸º0.25æ¥ç¡®å®šä½¿å¾—å¦å¢åŠ ä¸‹ä¸€å±‚ï¼Œåœ¨è¿™ä¸ªæ¦‚ç‡ä¸‹ï¼Œç©ºé—´éœ€è¦èŠ±è´¹çš„ä»£ä»·ä¸º<code>(cost(node) * 1.33)</code></li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>unsigned</span> <span style=color:#66d9ef>int</span> kBranching <span style=color:#f92672>=</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>int</span> height <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> (height <span style=color:#f92672>&lt;</span> kMaxHeight <span style=color:#f92672>&amp;&amp;</span> rnd_.OneIn(kBranching)) {
</span></span><span style=display:flex><span>    height<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ol start=3><li>æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥æŠ½è±¡çš„ç†è§£ä¸ºäºŒåˆ†æŸ¥æ‰¾çš„<code>O(log n)</code></li><li>è·³è¡¨çš„æ“ä½œçš„æ—¶é—´å¤æ‚åº¦å’Œçº¢é»‘æ ‘å‡ ä¹å·®ä¸å¤šï¼Œä½†æ˜¯æœ‰ä¸€ç‚¹åŠŸèƒ½æ˜¯çº¢é»‘æ ‘æ— æ³•å®ç°çš„ï¼Œå³<code>range search</code>ï¼Œçº¢é»‘æ ‘ç”±äºç»“æ„ç‰¹æ€§ï¼Œæ— æ³•è¿›è¡Œç±»ä¼¼çš„æ“ä½œï¼Œè·³è¡¨å¯ä»¥å®šä½nodeä¹‹åï¼Œå¯ä»¥æ ¹æ®nodeé—´çš„é“¾æ¥å®ç°é¡ºåºéå†</li><li>insertçš„æ—¶å€™å…ˆæŸ¥æ‰¾ä½ç½®ï¼Œç„¶åæŒ‰æ¦‚ç‡è®¡ç®—å±‚é«˜ï¼Œå†è¿›è¡Œæ’å…¥
<img src=/posts/readbooks/images/skiplist.png alt=skiplist></li><li>å®¹æ˜“å®ç°å¹¶å‘æ“ä½œï¼Œå¹¶å‘çš„æ—¶å€™åªéœ€è¦å¯¹æå°‘çš„èŠ‚ç‚¹åŠ é”å³å¯ï¼Œä½†æ˜¯çº¢é»‘æ ‘ç”±äºéœ€è¦å˜å½¢æ—‹è½¬éœ€è¦å¯¹æ•´æ£µæ ‘åŠ é”ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯å¤§éƒ¨åˆ†å­˜å‚¨ä½¿ç”¨skiplistçš„ä½œä¸ºmemtableçš„ç†ç”±ä¹‹ä¸€<br>1. <a href=https://www.bookstack.cn/read/Cpp_Concurrency_In_Action/README.md target=_blank>c++å¹¶å‘ç¼–ç¨‹</a><br>2. ä¸‰ç§å¹¶å‘<ol><li>max_heights_ ä½¿ç”¨memory_order_relaxedï¼Œskipliståªå…è®¸ä¸€å†™å¤šè¯»ï¼Œmax_height_åªæœ‰å†™æ‰ä¼šæ”¹å˜</li><li>insertè®¾ç½®æ–°èŠ‚ç‚¹çš„nextï¼Œä½¿ç”¨NoBarrier_Nextå’ŒNoBarrier_SetNextæ“ä½œï¼Œæ­¤æ—¶å¯¹nodeä½¿ç”¨memory_order_relaxedæ“ä½œï¼Œæ­¤æ—¶å…¶ä»–çº¿ç¨‹æ— æ³•çœ‹è§æ–°èŠ‚ç‚¹</li><li>insertè®¾ç½®æ–°èŠ‚ç‚¹çš„forwardï¼Œæ­¤æ—¶ä½¿ç”¨SetNextçš„memory_order_releaseï¼Œæ­¤æ—¶æ‰€æœ‰çº¿ç¨‹å¯ä»¥çœ‹è§æ–°èŠ‚ç‚¹<br>ä½†æ˜¯ç”±äºskiplist åˆ†å±‚ï¼Œæ‰€ä»¥æ­¤æ—¶åªèƒ½çœ‹è§å½“å‰æ’å…¥çš„è¿™ä¸€å±‚ï¼Œè€ŒæŸ¥è¯¢æ˜¯éœ€è¦ä»é¡¶å±‚å¾€ä¸‹æŸ¥çš„ï¼Œæ‰€ä»¥insertéœ€è¦ä»åº•å±‚å¼€å§‹ï¼Œå¦åˆ™å¯èƒ½å‡ºç°ä¸Šå±‚æŸ¥è¯¢èŠ‚ç‚¹å­˜åœ¨ï¼Œä½†æ˜¯ä¸‹å±‚ä¸å­˜åœ¨</li></ol></li><li>leveldbä¸­ï¼Œskiplistæ²¡æœ‰deleteæ“ä½œï¼Œå¦‚æœéœ€è¦å®ç°ï¼Œåˆ™éœ€è¦å®ç°ç±»ä¼¼insertä¸­çš„éƒ¨åˆ†æ“ä½œï¼ŒæŸ¥æ‰¾åˆ°preï¼Œåœ¨è®¾ç½®èŠ‚ç‚¹å³å¯ã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>template</span> <span style=color:#f92672>&lt;</span><span style=color:#66d9ef>typename</span> Key, <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Comparator</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> SkipList<span style=color:#f92672>&lt;</span>Key, Comparator<span style=color:#f92672>&gt;::</span>Insert(<span style=color:#66d9ef>const</span> Key<span style=color:#f92672>&amp;</span> key) {
</span></span><span style=display:flex><span>  Node<span style=color:#f92672>*</span> prev[kMaxHeight];
</span></span><span style=display:flex><span>  <span style=color:#75715e>// è®¾ç½®preï¼Œä»é¡¶å±‚å¼€å§‹æŸ¥æ‰¾ï¼Œè®°å½•çš„æ˜¯æ¯ä¸€å±‚çš„å½“å‰èŠ‚ç‚¹çš„preèŠ‚ç‚¹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  Node<span style=color:#f92672>*</span> x <span style=color:#f92672>=</span> FindGreaterOrEqual(key, prev);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  assert(x <span style=color:#f92672>==</span> <span style=color:#66d9ef>nullptr</span> <span style=color:#f92672>||</span> <span style=color:#f92672>!</span>Equal(key, x<span style=color:#f92672>-&gt;</span>key));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//   éšå³é«˜åº¦
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>int</span> height <span style=color:#f92672>=</span> RandomHeight();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (height <span style=color:#f92672>&gt;</span> GetMaxHeight()) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// å¦‚æœé«˜åº¦æ¯”ä¹‹å‰çš„é«˜ï¼Œåˆ™æŠŠprevä¹‹å‰é«˜åº¦èŠ‚ç‚¹åˆ°heightä¹‹é—´çš„nodeè®¾ç½®ä¸ºhead_
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> GetMaxHeight(); i <span style=color:#f92672>&lt;</span> height; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>      prev[i] <span style=color:#f92672>=</span> head_;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    max_height_.store(height, std<span style=color:#f92672>::</span>memory_order_relaxed);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  x <span style=color:#f92672>=</span> NewNode(key, height);
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ä½¿ç”¨heightè®¾ç½®å½“å‰èŠ‚ç‚¹å’Œpreä»¥åŠnexté˜¶æ®µä¹‹é—´çš„é“¾æ¥
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; i <span style=color:#f92672>&lt;</span> height; i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    x<span style=color:#f92672>-&gt;</span>NoBarrier_SetNext(i, prev[i]<span style=color:#f92672>-&gt;</span>NoBarrier_Next(i));
</span></span><span style=display:flex><span>    prev[i]<span style=color:#f92672>-&gt;</span>SetNext(i, x);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol start=8><li><code>std::atomic&lt;Node*> next_[1];</code>ï¼Œä¸èƒ½æ˜¯<code>next_[0]</code>ï¼Œå› ä¸º0çš„æ—¶å€™sizeofä¸è®¡ç®—è¿™ä½ï¼Œå¤§å°ä¸å¯¹ï¼Œä¸èƒ½æ˜¯äºŒçº§æŒ‡é’ˆï¼Œå› ä¸ºæ­¤æ—¶nextåœ¨åç»­çš„ä½¿ç”¨ä¸­ï¼Œä¸Šå±‚next_æ˜¯nullptrï¼Œæ— æ³•ç›´æ¥æ“ä½œï¼Œåªæœ‰ä½¿ç”¨æ•°ç»„æå‰å ä½ï¼Œæ‰å¯ä»¥è®¾ç½®nodeï¼Œè‡ªå·±æ‰‹å†™çš„æ—¶å€™éœ€è¦æ³¨æ„ã€‚ä¹Ÿå¯ä»¥å†insertçš„æ—¶å€™æ³¨æ„äºheadçš„ç›¸å¯¹å…³ç³»ã€‚</li></ol><h2 id=memtable>MemTable</h2><p>SkipListçš„å°è£…ï¼Œé•¿æœŸå¤„äºå†…å­˜ä¸­ï¼Œæ´»åŠ¨çš„tableåªæœ‰ä¸€ä¸ªï¼Œæ»¡çš„ä¹‹åå†»ç»“è½ç›˜ã€‚åŸºç¡€æ“ä½œä¸ºaddå’Œgetï¼Œä½¿ç”¨MemTableIteratorè®¿é—®memtableã€‚<br>MemTableIteratoræ˜¯SkipListçš„è¿­ä»£å™¨çš„å°è£…ã€‚æŒæœ‰ä¸€ä¸ªè·³è¡¨å’Œnodeï¼Œä½¿ç”¨SeekToFirstå’ŒSeekToLastå®šä½nodeä¹‹åï¼Œå¼€å§‹ä½¿ç”¨</p><ol><li>addç¼–ç æ•°æ®å’Œç±»å‹ä»¥åŠé•¿åº¦å’Œkeyç­‰ï¼Œæ‹¼æ¥ä¸ºä¸€ä¸ªbufferï¼Œç„¶åinsertåˆ°skiplistä¸­</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#75715e>// Format of an entry is concatenation of:
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  key_size     : varint32 of internal_key.size()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  key bytes    : char[internal_key.size()]
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  tag          : uint64((sequence &lt;&lt; 8) | type)
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  value_size   : varint32 of value.size()
</span></span></span><span style=display:flex><span><span style=color:#75715e>//  value bytes  : char[value.size()]
</span></span></span></code></pre></div><ol start=2><li>ä½¿ç”¨è¿­ä»£å™¨seekåˆ°nodeï¼Œç„¶åè·å¾—æ•°æ®ï¼Œè§£ç ï¼Œåˆ¤æ–­æ•°æ®ç±»å‹</li></ol><h2 id=dbimpl>DBImpl</h2><p>DBçš„å…·ä½“å®ç°ï¼Œå¯¹å¤–æ¥å£ä½¿ç”¨DBå¯¹è±¡ï¼Œä½†æ˜¯å†…éƒ¨å®é™…è°ƒç”¨çš„è¿˜æ˜¯DBImplå®ä¾‹</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>Status DBImpl<span style=color:#f92672>::</span>Put(<span style=color:#66d9ef>const</span> WriteOptions<span style=color:#f92672>&amp;</span> o, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> key, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> val) {
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> DB<span style=color:#f92672>::</span>Put(o, key, val);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Status DBImpl<span style=color:#f92672>::</span>Delete(<span style=color:#66d9ef>const</span> WriteOptions<span style=color:#f92672>&amp;</span> options, <span style=color:#66d9ef>const</span> Slice<span style=color:#f92672>&amp;</span> key) {
</span></span><span style=display:flex><span><span style=color:#66d9ef>return</span> DB<span style=color:#f92672>::</span>Delete(options, key);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ol><li>æ–°å»º</li><li>æ¢å¤</li><li>å†™<br>1. ä½¿ç”¨WriteBatchæ‰“åŒ…ä¸€æ‰¹å†™å…¥æ•°æ®
2. é™åˆ¶ä¸€å†™å¤šè¯»ï¼ŒWriteBatchä¼šæ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œç­‰å¾…å†™å…¥æ¶ˆè€—
3. å†™å…¥ä¼šæœ‰å¤šç§ä¸­é—´çŠ¶å†µ<ol><li>å½“å‰æ­£åœ¨L0çš„compactï¼Œæ­¤æ—¶å¦‚æœä¸æ˜¯å¼ºåˆ¶å¼‚æ­¥å†™ï¼Œåˆ™éœ€è¦ç­‰å¾…1sè®©å‡ºèµ„æºï¼Œç­‰å¾…compactå®Œæˆï¼Œä½†æ˜¯æœ€å¤šåªèƒ½ç­‰å¾…ä¸€æ¬¡</li><li>memç©ºé—´ä¸è¶³ï¼Œéœ€è¦è¿›è¡Œ compactï¼Œ ç­‰å¾…</li><li>L0 SSTè¶…è¿‡é™åˆ¶ï¼Œç­‰å¾…compact</li></ol><blockquote><p>è¿™é‡Œå‡ æ¡åº”è¯¥æ˜¯å†™å…¥çš„æœ€å¤§çš„æ€§èƒ½ç“¶é¢ˆï¼ŒRocksDBä¸­åº”è¯¥æœ‰è§£å†³çš„æ–¹æ¡ˆï¼Œåç»­å¯ä»¥çœ‹çœ‹ä»–çš„å†™å…¥æµç¨‹</p></blockquote></li><li>è¯»<br>1. ä¸‰å±‚è¯»å–ã€‚å­˜åœ¨è¯»æ”¾å¤§çš„é—®é¢˜<br>2. å…ˆéƒ½memtable
3. å†éƒ½inmem
4. è¯»å–L0å±‚
5. è¯»å–å…¶ä»–å±‚
6. è¯»å–æ–‡ä»¶ä¸Šçš„æ•°æ®çš„æ—¶å€™ä½¿ç”¨<code>Version::Get</code>ï¼Œå†…éƒ¨å…ˆä»L0å¼€å§‹ï¼Œç„¶ååœ¨ä¾æ¬¡å‘ä¸‹è¯»å–ï¼Œèƒ½è¿›è¡Œkeyçš„æ¯”å¯¹çš„ä¾æ®æ˜¯versionä¸­ä¿å­˜æ–‡ä»¶çš„FileMetaData</li><li>compact</li><li>lockæœºåˆ¶</li></ol><h2 id=writebatch>WriteBatch</h2><p><img src=/posts/readbooks/images/xx.webp alt></p><p>å†™æ“ä½œçš„ä¸»è¦æ“ä½œå¯¹è±¡ï¼Œä¸»è¦æ­¥éª¤æ˜¯æŠŠæ“ä½œçš„æ•°æ®æ‰“åŒ…ä¸ºä¸€ä¸ªbufferï¼Œç„¶åä½¿ç”¨<code>WriteBatch::Iterate</code>æ“ä½œhandlerå®ç°insertæ“ä½œï¼Œhanleæ˜¯ä¸€ä¸ªå®ç°putå’Œdeleteçš„æ¥å£ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯æŠŠæ•°æ®å’Œæ“ä½œåˆ†ç¦»äº†ï¼Œè¿™é‡Œæœ‰å‡ ç‚¹ç»†èŠ‚</p><ol><li>WriteBatchçš„æ•°æ®æ ¼å¼ä¸º <code>seq|countkey|{type|key|val}</code>ï¼Œbatchæ·»åŠ ä¸€ä¸ªæ•°æ®çš„æ—¶å€™ï¼Œé™¤äº†æ­£å¸¸æ·»åŠ æ•°æ®ï¼Œè¿˜ä¼šcount++ï¼Œç”¨äºåœ¨<code>WriteBatch::Iterate</code>çš„æ—¶å€™æ£€æµ‹å½“å‰æ‰¹æ¬¡æ•°æ®æ•°é‡æ˜¯å¦æ­£ç¡®</li><li>ä¸€ä¸ªbatchçš„æ•°æ®åªæœ‰ä¸€ä¸ªsequenceï¼Œbatchå†™å®Œä¹‹åï¼Œæ•°å€¼åŠ ä¸€ï¼Œ</li><li>æœ‰æ¨™è¨˜æ§åˆ¶æ˜¯å¦ä½¿ç”¨ä½¿ç”¨åŒæ­¥å¯«ã€‚é»˜èªç‚ºåŒæ­¥å¯«ï¼Œç•°æ­¥å¯«å…¥çš„é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¯èƒ½å°è‡´ç³»çµ±å´©æ½°çš„æ™‚å€™ä¸Ÿæ•¸æ“šï¼Œæ‰€ä»¥çˆ²äº†åˆ†æ”¤å¤§é‡æ•¸æ“šçš„åŒæ­¥å¯«çš„costï¼Œé€™è£è¨­è¨ˆWriteBatchä¾†æ‰“åŒ…æ•¸æ“šï¼Œé€²è¡Œä¸€æ¬¡åŒæ­¥å¯«æ“ä½œï¼Œå› çˆ²æ˜¯é †åºå¯«å…¥ç£ç›¤ï¼Œæ‰€ä»¥å¯«å…¥é€Ÿåº¦å¯ä»¥æ¥å—</li><li>å†™å…¥æ“ä½œå…·æœ‰åŸå­æ€§ï¼Œåœ¨å†™æ•°æ®çš„æ—¶å€™ä¼šå…ˆå†™æ—¥å¿—ç„¶åå†å†™æ•°æ®ï¼Œå½“å†™æ—¥å¿—ä¹‹å‰æˆ–è€…å†™æ—¥å¿—è¿‡ç¨‹ä¸­å®•æœºï¼Œä¸‹æ¬¡é‡å¯æ—¶æ¢å¤æ•°æ®åº“çš„æ—¶å€™ç›´æ¥ä¸¢å¼ƒå¼‚å¸¸æ—¥å¿—ã€‚æˆ–è€…å†™å®Œæ—¥å¿—ä¹‹åå®•æœºï¼Œç³»ç»Ÿåœ¨ä¸‹æ¬¡å¯åŠ¨ä¹‹åéƒ½æ˜¯ç¡®ä¿æ•°æ®çš„åŸå­æ€§ï¼Œ</li></ol><h2 id=posixenv>PosixEnv</h2><p>posixç¯å¢ƒèµ„æºçš„å®ç°ï¼Œç»§æ‰¿è‡ªenvï¼Œç›®çš„æ˜¯ä¾¿äºå®ç°ä¸åŒå¹³å°ä¸‹çš„ä»£ç ï¼Œ</p><ul><li>çº¿ç¨‹æ± ï¼Œä¸€ä¸ªç®€å•çš„ä¾‹å­ <a href=https://github.com/progschj/ThreadPool target=_blank>https://github.com/progschj/ThreadPool</a></li><li>æ—¥å¿—</li><li>æ–‡ä»¶</li></ul><h2 id=walæ—¥å¿—>WALæ—¥å¿—</h2><blockquote><p><a href=https://leveldb-handbook.readthedocs.io/zh/latest/journal.html target=_blank>https://leveldb-handbook.readthedocs.io/zh/latest/journal.html</a></p></blockquote><p>æ—¥å¿—åœ¨å†™æ•°æ®ä¹‹å‰è®°å½•ï¼Œå†™å®Œä¹‹åç«‹åˆ»flushï¼Œä¹‹åæ‰æ˜¯çœŸæ­£çš„å†™æ•°æ®åˆ°memtableï¼Œæ—¥å¿—æ–‡ä»¶ä¼šä¸€ç›´ä¿å­˜ï¼Œç›´åˆ°æ•°æ®è½ç›˜æ‰åˆ é™¤ï¼Œå³memtableå˜ä¸ºimmemtableä¸”compact(æ•°æ®è½ç›˜)ä¹‹åæ‰åˆ é™¤ï¼Œå¦‚æœæœŸé—´ç³»ç»Ÿå¼‚å¸¸ï¼Œåˆ™æ—¥å¿—æ–‡ä»¶ä¿å­˜ï¼Œåˆ°ä¸‹æ¬¡é‡å¯ä¹‹åå›å¤ä¹‹åæ‰åˆ é™¤ï¼Œ</p><p>(log::Writer)<br>å†™æ•°æ®ä¹‹å‰éœ€è¦é¢„å†™æ—¥å¿—ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ï¼Œåœ¨æ“ä½œæ•°æ®å¼‚å¸¸çš„æ—¶å€™å¯ä»¥ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®ï¼ŒæŒ‰blockåˆ’åˆ†ï¼Œä¸€ä¸ªblockå¤§å°ä¸º32kï¼Œä¸€ä¸ªblockæœ‰å››ç§çŠ¶æ€</p><ol><li>kFullType<br>ä¸€ä¸ªblockå¯ä»¥å­˜å®Œæ•°æ®</li><li>kFirstType<br>ä¸€ä¸ªblockå­˜ä¸ä¸‹æ•°æ®ï¼Œæ ‡è®°ä¸ºç¬¬ä¸€ä¸ªblock</li><li>kLastType<br>æœ€åä¸€ä¸ªblock</li><li>kMiddleType<br>ä¸­é—´çš„block</li></ol><p>æ¯ä¸€ä¸ªblockä¸­çš„æ•°æ®çš„ç»„ç»‡æ ¼å¼ä¸º<code>crc|len(2)|type(1)|values</code>ï¼Œå…¶ä¸­valuesçš„æ•°æ®æ¥è‡ªäºå‰é¢çš„WriteBatchæ‰“åŒ…çš„æ•°æ®ï¼Œæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œæ²¡æœ‰åšå¤ªå¤šçš„å¤„ç†ï¼Œä¸»è¦çš„è°ƒç”¨æ–¹æ³•ä¸º</p><ul><li>DBImpl::Write</li><li>DBImpl::NewDB</li><li>VersionSet::LogAndApply</li><li>VersionSet::WriteSnapshot</li></ul><p>(log::Reader)<br>walå¯¹åº”çš„è¯»å–æ“ä½œ</p><h2 id=lrucache>LRUCache</h2><blockquote><p><a href=https://leveldb-handbook.readthedocs.io/zh/latest/cache.html target=_blank>https://leveldb-handbook.readthedocs.io/zh/latest/cache.html</a></p></blockquote><p>ç¼“å­˜æ¨¡å—ï¼Œæµ‹è¯•æ–‡ä»¶ä¸º<code>cache_test.cc</code>ã€‚</p><ul><li><p>ShardedLRUCache<br>LRUHandleçš„åŒ…è£…ï¼Œä¸»è¦åŸå› æ˜¯LRUHandleçš„æ¥å£éƒ½åŠ é”ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ShardedLRUCacheåŒ…è£…ä¸€ä¸‹ï¼Œä½¿ç”¨16ä¸ªLRUHandleæ¥ç®¡ç†ç¼“å­˜ï¼Œä»¥æé«˜å¹¶å‘æ—¶å€™çš„æ“ä½œæ•ˆç‡ã€‚<code>uint32_t Shard(uint32_t hash) { return hash >> (32 - kNumShardBits); }</code>ä¼šä½¿ç”¨å‰4ä¸ªbitè®¡ç®—ä½ç½®ï¼Œå¾—åˆ°å¯¹åº”çš„LRUHandleå¯¹è±¡ï¼Œä¹‹åçš„æ“ä½œä½¿ç”¨æ­¤å¯¹è±¡å¤„ç†ï¼Œç›¸å½“äºLRUHandleçš„hashè¡¨ã€‚</p></li><li><p>LRUCache</p><blockquote><p><a href=https://leetcode.cn/problems/lru-cache/ target=_blank>https://leetcode.cn/problems/lru-cache/</a></p></blockquote><p>LRUçš„å®ç°ï¼Œä½¿ç”¨HandleTableä½œä¸ºhashè¡¨ä¿å­˜çš„æ•°æ®ã€‚LRUHandleä¸ºé“¾è¡¨ä¿å­˜æ•°æ®ï¼Œä¸»è¦ç»†èŠ‚ä¸º</p><ul><li>ä½¿ç”¨hashè¡¨ä¿å­˜æ•°æ®</li><li>ä½¿ç”¨ä¸€ä¸ªLRUHandleç»´æŠ¤ä½¿ç”¨æƒ…å†µï¼Œæ•°æ®åœ¨ç¼“å­˜ä¸­çš„æ—¶å€™ï¼Œè¦ä¹ˆåªæ˜¯åœ¨ç¼“å­˜ä¸­ï¼Œä¿å­˜åœ¨lru_é“¾è¡¨ä¸­ï¼Œæˆ–è€…æ˜¯ä½¿ç”¨ä¸­çš„æ•°æ®ï¼Œä¿å­˜åœ¨<code>in_use_</code>ä¸­</li><li>ä½¿ç”¨å¼•ç”¨æ ‡è®°æ•°æ®çš„ä½¿ç”¨ï¼Œåªæœ‰å½“å¼•ç”¨ä¸º0çš„æ—¶å€™ï¼Œæ‰ä¼šåˆ é™¤æ•°æ®ï¼Œå½“æ•°æ®å­˜åœ¨åœ¨ç¼“å­˜ä¸­çš„æ—¶å€™ï¼Œå¼•ç”¨é»˜è®¤ä¸º1ï¼Œä¸º0åˆ™è¡¨ç¤ºä¸ç¼“å­˜ä¸”æ²¡æœ‰å¤–éƒ¨å¼•ç”¨</li><li>å¯¹äºé‡å¤çš„keyï¼Œä¼šç›´æ¥æ›¿æ¢</li><li>å®¹é‡ä¸è¶³çš„æ—¶å€™ã€‚æ›¿æ¢lru_ä¸­çš„æ•°æ®ï¼Œ<code>in_use_</code>ä¸­çš„æ•°æ®ä¸æ“ä½œ</li><li>é“¾è¡¨åœ¨appendçš„æ—¶å€™ï¼Œæ€»æ˜¯æ·»åŠ åœ¨é“¾è¡¨å¤´èŠ‚ç‚¹</li></ul></li><li><p>LRUHandle<br>åŒå‘é“¾è¡¨ï¼Œåœ¨hashè¡¨ä¸­ä¼šä¿å­˜æ•°æ®ï¼Œåœ¨LRUä¸­ä¼šç»´æŠ¤ä½¿ç”¨æƒ…å†µï¼Œ</p><ul><li>removeï¼Œç›´æ¥è®¾ç½®é“¾æ¥ï¼Œè·³è¿‡å½“å‰èŠ‚ç‚¹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> LRUCache<span style=color:#f92672>::</span>LRU_Remove(LRUHandle<span style=color:#f92672>*</span> e) {
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>next<span style=color:#f92672>-&gt;</span>prev <span style=color:#f92672>=</span> e<span style=color:#f92672>-&gt;</span>prev;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>prev<span style=color:#f92672>-&gt;</span>next <span style=color:#f92672>=</span> e<span style=color:#f92672>-&gt;</span>next;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>LRU_Appendï¼Œinsertæ“ä½œï¼ŒæŠŠèŠ‚ç‚¹appendåœ¨é“¾è¡¨ä¹‹å‰</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span><span style=color:#66d9ef>void</span> LRUCache<span style=color:#f92672>::</span>LRU_Append(LRUHandle<span style=color:#f92672>*</span> list, LRUHandle<span style=color:#f92672>*</span> e) {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Make &#34;e&#34; newest entry by inserting just before *list
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  e<span style=color:#f92672>-&gt;</span>next <span style=color:#f92672>=</span> list;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>prev <span style=color:#f92672>=</span> list<span style=color:#f92672>-&gt;</span>prev;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>prev<span style=color:#f92672>-&gt;</span>next <span style=color:#f92672>=</span> e;
</span></span><span style=display:flex><span>  e<span style=color:#f92672>-&gt;</span>next<span style=color:#f92672>-&gt;</span>prev <span style=color:#f92672>=</span> e;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li><li><p>HandleTable
LRUHandleçš„äºŒç»´æ•°ç»„ï¼Œä½¿ç”¨è¿åœ°å€æ³•æ¥å¤„ç†å†²çªï¼ŒåŸºç¡€å®¹é‡ä¸º4ï¼ŒrehashæŒ‰2æ‰©å……ç©ºé—´</p></li></ul><p>ç¼“å­˜æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ç”¨æ¥ç¼“å­˜çš„æ‰“å¼€çš„SST tableçš„cacheï¼Œä¸€ç§æ˜¯ç”¨æ¥ç¼“å­˜ä½¿ç”¨çš„blockçš„cache</p><h2 id=sst>SST</h2><p><img src=/posts/readbooks/images/image.png alt=æ ¼å¼åœ–>
å…·é«”æ ¼å¼å¦‚åœ–ï¼Œæ–‡ä»¶æœ€åæ˜¯footerï¼Œä¿å­˜mataå’Œindexçš„å¤§å°å’Œåç§»ï¼Œ</p><ul><li><p>footer (<code>Footer::EncodeTo</code>)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  int64 <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> mata
</span></span><span style=display:flex><span>  int64 <span style=color:#f92672>*</span> <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> index
</span></span><span style=display:flex><span>  padding
</span></span><span style=display:flex><span>  magicnum
</span></span></code></pre></div></li><li><p>BlockBuilder<br>ç£ç›˜è¯»å†™æŒ‰ç…§ä¸€å®šå¤§å°è¯»å–æ¯”è¾ƒæœ‰æ•ˆç‡ï¼ŒleveldbæŒ‰ç…§4Kå¤§å°ç»„ç»‡æ–‡ä»¶ï¼Œ4Kä¸ºä¸€ä¸ªblockï¼ŒblockæŒ‰ç…§ä¸€ä¸ªä¸€ä¸ªçš„æ¡ç›®ç¼–ç æ•°æ®ï¼Œæ ¼å¼ä¸º<code>slen|uslen|vlen|uskey|v</code>ï¼ŒsæŒ‡çš„æ˜¯shareï¼Œå¦‚ä¸‹çš„ä¾‹å­</p></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    string key1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abcd&#34;</span>, v1 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vv1vv&#34;</span>;
</span></span><span style=display:flex><span>    string key2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abce&#34;</span>, v2 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vv2vv&#34;</span>;
</span></span><span style=display:flex><span>    string key3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abxf&#34;</span>, v3 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vv3vv&#34;</span>;
</span></span><span style=display:flex><span>    encode <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span> <span style=color:#ae81ff>4</span> <span style=color:#ae81ff>5</span> abcd vv1vv <span style=color:#f92672>|</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>5</span> e vv2vv <span style=color:#f92672>|</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>5</span> xf vv3vv}
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>ç¬¬ä¸€ä¸ªè®°å½•ä¸ç¼–ç ï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸€ä¸ªå¯¹æ¯”ï¼Œç¼–ç å­˜å–ï¼ŒkeyæŠ½å–ç›¸åŒçš„å‰ç¼€ï¼Œè®°å½•é•¿åº¦ï¼Œä¹‹åçš„æ•°æ®éƒ½æŒ‰å‰ä¸€ä¸ªæ•°æ®ç¼–ç ï¼Œå¦‚æœæ•°æ®å¤ªå¤šï¼Œå¯èƒ½åé¢çš„keyå’Œä¹‹å‰çš„keyå·®è·æ¯”è¾ƒå¤§ï¼ŒæŸ¥æ‰¾çš„æ—¶å€™åªèƒ½å…¨éƒ¨è§£ç ç„¶åå¯»æ‰¾keyï¼Œæ‰€ä»¥è®¾è®¡å¯ä»¥æ§åˆ¶æ¯éš”å›ºå®šæ•°é‡çš„keyå­˜ä¸€ä¸ªå®Œæ•´çš„keyï¼Œç§°ä¸ºé‡å¯ç‚¹ï¼ŒæŒ‰é‡å¯ç‚¹åˆ’åˆ†ä¸ºä¸åŒçš„groupï¼Œæ­¤æ—¶ä¸”è®°å½•keyçš„åç§»ï¼Œæ­¤æ—¶æŸ¥æ‰¾çš„æ—¶å€™å¯ä»¥æŒ‰ç…§åç§»å–keyç„¶åä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ç­‰æ–¹å¼å¿«é€ŸæŸ¥å¯»ã€‚åœ¨æŒä¹…åŒ–çš„æ—¶å€™ï¼Œblockæœ«å°¾è®°å½•groupçš„å¤§å°ï¼Œå†ä½¿ç”¨ä¸€ä¸ªbitè®°å½•å‹ç¼©æ ¼å¼ï¼Œå†ä½¿ç”¨4ä¸ªbitè®°å½•crcã€‚è¿™å°±æ˜¯blockçš„åŸºæœ¬æ ¼å¼
é™¤äº†footerä½¿ç”¨å•ç‹¬çš„ç¼–ç æ ¼å¼ä¹‹å¤–ã€‚å…¶ä½™çš„mataï¼Œindexï¼Œdataéƒ½ä½¿ç”¨blockçš„æ ¼å¼ç¼–ç æ•°æ®ï¼Œ
block æ˜¯ä¸€ä¸ªè¯»å†™å•ä½ï¼Œæ‰€ä»¥å¦‚æœä½¿ç”¨åœºæ™¯å¤§é‡æ‰¹é‡è¯»å†™ï¼Œåˆ™å¯ä»¥é€‚å½“å¢åŠ block sizeï¼Œå¦‚æœå•ç‚¹è¯»å†™æ¯”è¾ƒå¤šï¼Œåˆ™å¯ä»¥å‡å°‘block sizeï¼Œ è¿™è¦å¹³è¡¡</p><ul><li>å†™å…¥æµç¨‹</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>TableBuilder<span style=color:#f92672>::</span>Add
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (r<span style=color:#f92672>-&gt;</span>pending_index_entry)   <span style=color:#75715e>//  æ–°çš„blockè®¾ç½®index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    index_block.Add
</span></span><span style=display:flex><span>  filter_block<span style=color:#f92672>-&gt;</span>AddKey          <span style=color:#75715e>//  è®¾ç½®filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  data_block.Add                <span style=color:#75715e>// æ·»åŠ æ•°æ®åˆ°data_blockï¼Œå¦‚æœå¤§å°è¾¾åˆ°é™åˆ¶ï¼Œflush
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#66d9ef>if</span> (estimated_block_size <span style=color:#f92672>&gt;=</span> r<span style=color:#f92672>-&gt;</span>options.block_size)
</span></span><span style=display:flex><span>    TableBuilder<span style=color:#f92672>::</span>Flush()
</span></span><span style=display:flex><span>      TableBuilder<span style=color:#f92672>::</span>WriteBlock    <span style=color:#75715e>// å†™block 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        BlockBuilder<span style=color:#f92672>::</span>Finish      <span style=color:#75715e>// æ‰“åŒ…æ•°æ®ï¼Œç¼–ç group offset
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        compression               <span style=color:#75715e>//  å‹ç¼©
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        TableBuilder<span style=color:#f92672>::</span>WriteRawBlock <span style=color:#75715e>//  å†™å‹ç¼©ä¹‹åçš„æ•°æ®ï¼Œè®¾ç½®ç¼–ç æ ¼å¼å’Œcrc
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    r<span style=color:#f92672>-&gt;</span>pending_index_entry <span style=color:#f92672>=</span> true;  <span style=color:#75715e>//  è®¾ç½®æ ‡è®°ä¸ºtrueï¼Œè®°å½•index
</span></span></span></code></pre></div><ul><li><p>è¯»å–æµç¨‹<br>è®€å–çš„æ™‚å€™é€†å‘æ“ä½œï¼Œæ ¡ç›£crc</p></li><li><p>index
indexçš„ä¸€å€‹æ¢ç›®å°æ‡‰çš„æ˜¯ä¸€å€‹datablockä¸­çš„æœ€å¤§çš„keyä»¥åŠblockçš„åç§»å’Œå¤§å°ï¼Œkeyä½¿ç”¨FindShortestSeparatorè¨ˆç®—å¾—å‡ºï¼Œç¢ºä¿ä»–è¨ˆç®—çš„keyæ˜¯ç•¶å‰ä¿å­˜çš„datablockä¸­çš„æœ€å¤§å€¼åŠ 1ï¼Œç›®çš„æ˜¯ä¾¿æ–¼æŸ¥æ‰¾</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  start: abcdef
</span></span><span style=display:flex><span>  limit: abcdgh
</span></span><span style=display:flex><span>  FindShortestSeparator<span style=color:#f92672>--&gt;</span> start <span style=color:#f92672>=</span> abcdf  <span style=color:#75715e>// å…¬å…±å‰ç¶´åŠ 1
</span></span></span></code></pre></div></li></ul><hr><ul><li>immemtableçš„å¯«å…¥</li></ul><blockquote><p><a href=https://hardcore.feishu.cn/docs/doccn4w8clvork96K3dqQnJRh9g# target=_blank>https://hardcore.feishu.cn/docs/doccn4w8clvork96K3dqQnJRh9g#</a>
<a href=https://my.oschina.net/fileoptions/blog/903206 target=_blank>https://my.oschina.net/fileoptions/blog/903206</a></p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>
</span></span><span style=display:flex><span>WriteLevel0Table
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    mutex_.Unlock();    <span style=color:#75715e>// ä¸åŠ é–æ˜¯å› çˆ²immemtableä¸å¯è®Šï¼Œæ‰€ä»¥æ²’æœ‰å¹¶ç™¼å•é¡Œ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    s <span style=color:#f92672>=</span> BuildTable(dbname_, env_, options_, table_cache_, iter, <span style=color:#f92672>&amp;</span>meta);
</span></span><span style=display:flex><span>    BuildTable :{
</span></span><span style=display:flex><span>      <span style=color:#75715e>// get file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#75715e>// add values
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      builder<span style=color:#f92672>-&gt;</span>Add(key, iter<span style=color:#f92672>-&gt;</span>value());
</span></span><span style=display:flex><span>      s <span style=color:#f92672>=</span> builder<span style=color:#f92672>-&gt;</span>Finish();
</span></span><span style=display:flex><span>      Finish: {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// filter
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// metaindex
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// index
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>// footer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>      file<span style=color:#f92672>-&gt;</span>sync();
</span></span><span style=display:flex><span>      file<span style=color:#f92672>-&gt;</span>close();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    mutex_.Lock();
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><p>å…·é«”çš„ç´°ç¯€å¯ä»¥åƒè€ƒä»£ç¢¼çš„æ–‡æª”ï¼Œ</p><h2 id=è¿­ä»£å™¨>è¿­ä»£å™¨</h2><p>è¨ªå•ç‰¹å®šæ•¸æ“šçµæ§‹çš„æŠ½è±¡ï¼Œä½¿æ•¸æ“šçš„è¨ªå•å’Œå­˜å„²åˆ†é›¢ï¼Œå¯ä»¥åƒè€ƒSTLçš„å¯¦ç¾ï¼ŒlevelDBä¸­å°ä¸åŒçš„çµ„ä»¶å¯¦ç¾ä¸åŒçš„è¿­ä»£å™¨</p><ul><li>MemTableIterator</li><li>LevelFileNumIterator</li><li>Block::Iter</li></ul><h2 id=version>version</h2><blockquote><p><a href=https://leveldb-handbook.readthedocs.io/zh/latest/version.html target=_blank>https://leveldb-handbook.readthedocs.io/zh/latest/version.html</a></p></blockquote><p>æœ¬è´¨ä¸Šæ˜¯ä½¿ç”¨ç‰ˆæœ¬å·ç»„æˆkeyï¼Œç”¨æ¥æŸ¥è¯¢æ•°æ®ï¼Œä¹‹å‰æ•°æ®å­˜æ”¾çš„æ—¶å€™ï¼Œæ˜¯æœ‰è®°å½•seqçš„ï¼Œversionæ˜¯ä¸“ä¸ºè¿™ç§è¡Œä¸ºè®¾è®¡çš„ç³»ç»Ÿï¼Œ<br>éœ€è¦ç®¡ç†ç£ç›˜æ–‡ä»¶çš„ç‰ˆæœ¬ï¼Œä¸åŒçš„ç‰ˆæœ¬ä½¿ç”¨ä¸åŒçš„Sequenceï¼Œkeyä¸­å«æœ‰LastSequenceä¿¡æ¯ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šè¿˜æ˜¯keyçš„æŸ¥è¯¢</p><ul><li>get<br>éœ€è¦è¯»å–ç£ç›˜ä¸­çš„æ–‡ä»¶ï¼Œversionä¸­ä¿å­˜FileMetaDataï¼Œæ‰€ä»¥å¯ä»¥å¿«é€Ÿçš„å®šä½æ•°æ®çš„sstï¼Œç„¶åç›´æ¥è¯»å–sstï¼Œå¯¹äºL0ï¼Œç”±äºå­˜åœ¨é‡å¤keyï¼Œæ‰€ä»¥
éœ€è¦è¿›è¡Œkeyçš„æ¯”è¾ƒï¼Œè¯»å–å¤šä¸ªæ–‡ä»¶</li></ul><h2 id=compact>compact</h2><p>å®šæœŸçš„æ•°æ®çš„æ•´ç†åˆå¹¶æ“ä½œ</p><hr><ul><li>minor compaction<br>immemtableæŒä¹…åŒ–ä¸ºSSTï¼Œå¯ä»¥æ‰‹åŠ¨ä½¿ç”¨TEST_CompactMemTableè§¦å‘ï¼Œä¸»è¦æ–¹å¼æ˜¯è®¾ç½®<code>DBImpl::Write</code>çš„WriteBatchå‚æ•°ä¸ºnullï¼Œæ­¤æ—¶åœ¨<code>MakeRoomForWrite</code>ä¸­ï¼Œä¼šæ ¹æ®å‚æ•°å¯¼è‡´é€‰æ‹©compactçš„åˆ†æ”¯ï¼Œä¼šè¿›è¡ŒCompactMemTableæ“ä½œï¼Œæ­¤æ—¶ä¹‹å‰çš„æ•°æ®ä¼šå›ºåŒ–åˆ°æ–‡ä»¶ä¸­ã€‚ä¹Ÿå¯ä»¥è‡ªåŠ¨è§¦å‘ï¼Œå½“memtable æ»¡äº†ä¹‹åï¼Œä¼šè¿›è¡Œç›¸åŒçš„æ“ä½œã€‚<ul><li>TIPS: æ­¤æ—¶versionä¸­ä¼šä¿å­˜SSTçš„ç›¸å…³ä¿¡æ¯ï¼ŒåŒ…æ‹¬beginkeyå’Œendkeyï¼Œä»¥åŠç‰ˆæœ¬ä¿¡æ¯</li><li>æ–‡ä»¶ä¸ä¸€å®šæ˜¯level0ï¼Œå¯¹äºå¤§æ–‡ä»¶ï¼Œé¢„æµ‹level0å¯èƒ½å¾ˆå¿«åˆ°è¾¾é™åˆ¶ï¼Œå¯ä»¥åœ¨ä¸€å®šæ¡ä»¶ä¸‹ç›´æ¥æŠŠæ–‡ä»¶æ”¾åœ¨è¾ƒé«˜å±‚ã€‚</li></ul></li></ul><hr><ul><li>Major Compaction<br>sstä¹‹é—´å‘ä¸‹åˆå¹¶ï¼Œå…¶ä¼šæŠŠç›¸åŒkeyçš„ä¸åŒç‰ˆæœ¬çš„æ•°æ®åˆå¹¶ï¼Œå¯ä»¥æ‰‹åŠ¨ä½¿ç”¨TEST_CompactRangeè§¦å‘ï¼Œæ­¤æ—¶å¯ä»¥é€‰æ‹©éœ€è¦compactçš„levelå’Œstart keyå’Œendkeyï¼Œä»–ä¼šæŠŠæ–‡ä»¶å‘ä¸‹å±‚åˆå¹¶ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<ul><li>level0ä¼šæœ‰é‡å çš„keyï¼Œcompactçš„æ—¶å€™éœ€è¦é€‰æ‹©beginkey endkeyä»¥åŠä»–ä¸­é—´è¦†ç›–çš„æ–‡ä»¶è¿›è¡Œcompactæ“ä½œï¼Œå¦åˆ™ä¼šæ®‹ç•™ä¸‹old keyï¼Œ</li><li>sstä¸ä¸€å®šæ˜¯å‘ä¸‹æ¨ä¸€å±‚ï¼Œå¯ä»¥é€‰æ‹©æƒ³è¦åˆå¹¶çš„å±‚æ•°ï¼Œå¯¹äºlevel 0ï¼Œä½¿ç”¨æ–‡ä»¶ä¸ªæ•°è®¡ç®—scoreï¼Œå¯¹äºå…¶ä»–å±‚ï¼Œä½¿ç”¨æ–‡ä»¶å¤§å°è®¡ç®—</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>int</span> level <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; level <span style=color:#f92672>&lt;</span> config<span style=color:#f92672>::</span>kNumLevels <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>; level<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>double</span> score;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (level <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// We treat level-0 specially by bounding the number of files
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// instead of number of bytes for two reasons:
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// (1) With larger write-buffer sizes, it is nice not to do too
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// many level-0 compactions.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// (2) The files in level-0 are merged on every read and
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// therefore we wish to avoid too many files when the individual
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// file size is small (perhaps because of a small write-buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// setting, or very high compression ratios, or lots of
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// overwrites/deletions).
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    score <span style=color:#f92672>=</span> v<span style=color:#f92672>-&gt;</span>files_[level].size() <span style=color:#f92672>/</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>double</span><span style=color:#f92672>&gt;</span>(config<span style=color:#f92672>::</span>kL0_CompactionTrigger);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Compute the ratio of current size to size limit.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#66d9ef>uint64_t</span> level_bytes <span style=color:#f92672>=</span> TotalFileSize(v<span style=color:#f92672>-&gt;</span>files_[level]);
</span></span><span style=display:flex><span>      score <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>static_cast</span><span style=color:#f92672>&lt;</span><span style=color:#66d9ef>double</span><span style=color:#f92672>&gt;</span>(level_bytes) <span style=color:#f92672>/</span> MaxBytesForLevel(options_, level);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (score <span style=color:#f92672>&gt;</span> best_score) {
</span></span><span style=display:flex><span>      best_level <span style=color:#f92672>=</span> level;
</span></span><span style=display:flex><span>      best_score <span style=color:#f92672>=</span> score;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span></code></pre></div><ul><li>sstè®°å½•ä¸€ä¸ªæŸ¥è¯¢æ¬¡æ•°ï¼Œå½“ä¸€ä¸ªæ–‡ä»¶è¢«æŸ¥è¯¢å¤šæ¬¡ä¸”æ˜¯æ— æ•ˆæŸ¥è¯¢çš„æ—¶å€™çš„ï¼Œå½“è¾¾åˆ°ä¸€å®šæ¬¡æ•°å°±ä¼šè§¦å‘compcatæ“ä½œï¼Œç†ç”±æ˜¯ä»–å¯èƒ½å’Œå…¶ä»–æ–‡ä»¶æœ‰å¤ªå¤šçš„é‡å¤çš„keyï¼Œéœ€è¦è¢«æ¸…ç†ä»¥å¹³è¡¡ioæ“ä½œï¼Œè¿™é‡Œçš„ä¾æ®æ˜¯çš„ä¸€æ¬¡é¢å¤–çš„compactæ“ä½œçš„costå’Œå¤šæ¬¡çš„æ— æ•ˆseekçš„å‡è¡¡ã€‚</li><li></li></ul>ä»–çš„å¤§è‡´é€»è¾‘æ˜¯å½“å‰ä½¿ç”¨çš„çº¿ç¨‹è®¾ç½®manual_compaction_ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨compactçº¿ç¨‹ä½¿ç”¨manual_compaction_æ‰§è¡Œcompactæ“ä½œ<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>compact {
</span></span><span style=display:flex><span>  BackgroundCompaction {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (imm_ <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>      CompactMemTable();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    Compaction<span style=color:#f92672>*</span> c;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (is_manual) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æ‰§è¡Œmanual compactï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œè·å¾—Compaction
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      c <span style=color:#f92672>=</span> versions_<span style=color:#f92672>-&gt;</span>CompactRange(m<span style=color:#f92672>-&gt;</span>level, m<span style=color:#f92672>-&gt;</span>begin, m<span style=color:#f92672>-&gt;</span>end);
</span></span><span style=display:flex><span>    } 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (c <span style=color:#f92672>==</span> <span style=color:#66d9ef>nullptr</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ä¸åšå¤„ç†ï¼Œä¸éœ€è¦compact
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    }<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (<span style=color:#f92672>!</span>is_manual <span style=color:#f92672>&amp;&amp;</span> c<span style=color:#f92672>-&gt;</span>IsTrivialMove()) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// ä»…ä»…åªéœ€è¦ç§»åŠ¨æ–‡ä»¶ï¼Œä¾‹å¦‚æœ€å¼€å§‹çš„æ—¶å€™ä¸‹å±‚æ²¡æœ‰éœ€è¦åˆå¹¶çš„æ–‡ä»¶ï¼Œç›´æ¥ç§»åŠ¨æ–‡ä»¶ï¼Œä¿®æ”¹å…ƒæ•°æ®å³å¯
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// æ‰§è¡Œcompact
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      CompactionState<span style=color:#f92672>*</span> compact <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompactionState(c);
</span></span><span style=display:flex><span>      status <span style=color:#f92672>=</span> DoCompactionWork(compact); 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>//  å¤šä¸ªæ–‡ä»¶çš„åˆå¹¶æ“ä½œï¼Œä¼šå¤„ç†è¿‡æœŸæˆ–è€…éœ€è¦åˆ é™¤çš„æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  DoCompactionWork {
</span></span><span style=display:flex><span>    Iterator<span style=color:#f92672>*</span> input <span style=color:#f92672>=</span> versions_<span style=color:#f92672>-&gt;</span>MakeInputIterator(compact<span style=color:#f92672>-&gt;</span>compaction);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (input<span style=color:#f92672>-&gt;</span>Valid() <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>shutting_down_.load(std<span style=color:#f92672>::</span>memory_order_acquire)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (has_imm_.load(std<span style=color:#f92672>::</span>memory_order_relaxed)) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>//  å¦‚æœæœ‰minor compactï¼Œåˆ™ä¼˜å…ˆå¤„ç†
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// åˆ¤æ–­é‡å ï¼Œé‡å å¤ªå¤šå½±å“æŸ¥è¯¢ï¼Œç›´æ¥ç»ˆæ­¢
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> compact<span style=color:#f92672>-&gt;</span>compaction<span style=color:#f92672>-&gt;</span>ShouldStopBefore(key)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span><span style=color:#960050;background-color:#1e0010>ï¼›</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// å¤„ç†key
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// å¦‚æœæ˜¯delete
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//  æˆ–è€…æ˜¯sequenceå°äºå½“å‰ä½¿ç”¨ä¸­çš„sequence 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#75715e>//  æˆ–è€…æ›´é«˜å±‚æ²¡æœ‰è¿™ä¸ªkey
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        drop <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>drop)
</span></span><span style=display:flex><span>        compact<span style=color:#f92672>-&gt;</span>builder<span style=color:#f92672>-&gt;</span>Add(key, input<span style=color:#f92672>-&gt;</span>value());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></li></ul><p>ç”±äºcompactçš„æ—¶å€™ï¼Œä¼šå ç”¨ä¸€å®šçš„ç³»ç»Ÿèµ„æºï¼Œæ‰€ä»¥å¦‚æœå‘ç”Ÿcompactionçš„æ—¶å€™</p><ul><li>å¦‚æœæ˜¯minor compactï¼Œåˆ™å‡ç¼“å†™æ“ä½œï¼Œé‡Šæ”¾ä¸€å®šçš„ç³»ç»Ÿèµ„æº</li><li>å¦‚æœæ˜¯Major Compactionï¼Œåˆ™æš‚åœæ“ä½œã€‚ç­‰å¾…compactä»»åŠ¡å®Œæˆ</li></ul></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><a role=button class="btn btn-outline h-12" href=/posts/course/6.824/coursenote/ title=Coursenote><ion-icon name=chevron-back></ion-icon><div class="inline-flex flex-col items-start"><span class="text-base-content/60 text-xs font-normal">Previous page</span>
<span class="max-w-48 truncate">Coursenote</span></div></a><a role=button class="btn btn-outline h-12" href=/posts/readbooks/volcanooptimizer/ title=VolcanoOptimizer><div class="inline-flex flex-col items-end"><span class="text-base-content/60 text-xs font-normal">Next page</span>
<span class="max-w-48 truncate">VolcanoOptimizer</span></div><ion-icon name=chevron-forward></ion-icon></a></div></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end lg:self-start"><nav id=TableOfContents><ul><li><a href=#ç¼–è¯‘>ç¼–è¯‘</a></li><li><a href=#slice>slice</a></li><li><a href=#status>status</a></li><li><a href=#æ•°å€¼ç¼–ç >æ•°å€¼ç¼–ç </a></li><li><a href=#arena>Arena</a></li><li><a href=#skiplist>SkipList</a></li><li><a href=#memtable>MemTable</a></li><li><a href=#dbimpl>DBImpl</a></li><li><a href=#writebatch>WriteBatch</a></li><li><a href=#posixenv>PosixEnv</a></li><li><a href=#walæ—¥å¿—>WALæ—¥å¿—</a></li><li><a href=#lrucache>LRUCache</a></li><li><a href=#sst>SST</a></li><li><a href=#è¿­ä»£å™¨>è¿­ä»£å™¨</a></li><li><a href=#version>version</a></li><li><a href=#compact>compact</a></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2016 - 2025 Askyx's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>Hi, my name is Yue Yang.</p><p>This is my blog.</p><h2 id=ãƒ¾Ï‰o>ãƒ¾(â€¢Ï‰â€¢`)o</h2><p>æ¯”è¾ƒèƒ†å°ï¼Œå‡ºé—¨éƒ½å¾—è´´å¢™èµ°</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>Â© 2016 - 2025 Askyx's Blog</p><p class=text-sm>ğŸŒ±
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"en"}).toFormat("yyyyå¹´MMæœˆddæ—¥")})}</script><script src=/js/toc.min.js></script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
      })
    </script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>