<!doctype html><html lang=zh-Hans x-data :class=$store.darkMode.class() :data-theme=$store.darkMode.theme()><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Postgres_xc 源码编译及环境搭建 | Askyx's Blog</title>
<link rel=icon href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>🌱</text></svg>"></link>
<link rel=canonical href=https://askyx.github.io/trash/postgres_xc_build/><meta name=author content="Askyx"><meta name=description content="My personal blog"><meta name=generator content="Hugo 0.121.0"><meta property="og:title" content="Postgres_xc 源码编译及环境搭建"><meta property="og:description" content="Postgres_xc 源码编译，集群环境搭建"><meta property="og:type" content="article"><meta property="og:url" content="https://askyx.github.io/trash/postgres_xc_build/"><meta property="og:image" content="https://askyx.github.io/img/global-background.jpg"><meta property="article:section" content="trash"><meta property="article:published_time" content="2022-07-27T16:44:08+08:00"><meta property="article:modified_time" content="2025-07-14T16:49:40+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://askyx.github.io/img/global-background.jpg"><meta name=twitter:title content="Postgres_xc 源码编译及环境搭建"><meta name=twitter:description content="Postgres_xc 源码编译，集群环境搭建"><link rel=stylesheet href=/css/output.min.css><style>pre{padding:1em;overflow:auto}</style><link rel=stylesheet href=/css/custom.css><script defer src=https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js integrity="sha256-PtHu0lJIiSHfZeNj1nFd6wTX+Squ255SGZ/fc8seCtM=" crossorigin=anonymous></script></head><body x-data="{
    flip: false,
  }"><div id=dream-global-bg></div><nav x-data="{ isSticky: false }" x-init="window.addEventListener('scroll', () => { isSticky = window.scrollY > 30 })" class="sticky top-0 z-30 mt-4 lg:mt-8 py-4" :class="{ 'bg-base-100 shadow-lg dark:border-b dark:border-base-content/30': isSticky }"><div class="container flex justify-between px-4"><section class="flex items-center gap-4"><div class="avatar cursor-pointer hover:avatar-online" @click="flip = !flip" title="Flip it!"><div class="h-10 rounded-full"><img src=/img/personal/avatar.jpg alt="Askyx's Blog"></div></div><div><a href=https://askyx.github.io/ class="text-lg font-semibold cursor-pointer">Askyx's Blog</a><div class="text-base-content/60 text-sm">life is short, use Python</div></div></section><div class="dropdown dropdown-end sm:hidden"><div tabindex=0 role=button class="btn btn-ghost btn-square" aria-label="Select an option"><ion-icon name=menu class=text-2xl></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-md"><li><div role=link tabindex=0 class="inline-flex items-center p-2 cursor-pointer" @click="flip = !flip" title=About><ion-icon name=information-circle></ion-icon>About</div></li><li><a class="group inline-flex items-center p-2 cursor-pointer" href=/search title=Search><ion-icon name=search></ion-icon>Search</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=https://github.com/askyx target=_blank title=GitHub><ion-icon name=logo-github></ion-icon>GitHub</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li></ul></div><section class="hidden sm:flex sm:items-center sm:gap-2 md:gap-4"><div role=link tabindex=0 class="text-sm font-semibold cursor-pointer hover:underline" @click="flip = !flip" title=About>About</div><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=/search title=Search><ion-icon class=group-hover:text-primary-content name=search></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href=https://github.com/askyx target=_blank title=GitHub><ion-icon class=group-hover:text-primary-content name=logo-github></ion-icon></a><div class="dropdown dropdown-end dropdown-hover"><div tabindex=0 role=button class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" aria-label="Select an option"><ion-icon class="group-hover:text-primary-content text-xl" name=menu></ion-icon></div><ul tabindex=0 class="dropdown-content menu w-36 bg-base-100 rounded-box z-1 shadow-xl"><li><a class="inline-flex items-center p-2 cursor-pointer" href=/posts title=Archives><ion-icon name=archive></ion-icon>Archives</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/tags title="All Tags"><ion-icon name=pricetags></ion-icon>All Tags</a></li><li><a class="inline-flex items-center p-2 cursor-pointer" href=/index.xml title=RSS><ion-icon name=logo-rss></ion-icon>RSS</a></li></ul></div></section></div></nav><div class=flip-container :class="{ 'flip-it': flip }"><div class=flipper><div class=front><div class=container><div class="lg:grid lg:grid-cols-4 gap-4 mt-4 px-4"><div class="hidden lg:block"></div><div class=lg:col-span-2><article class="mx-auto prose prose-quoteless dark:prose-invert" id=dream-single-post-main itemscope itemtype=http://schema.org/Article><meta itemprop=name content="Postgres_xc 源码编译及环境搭建"><meta itemprop=description content="Postgres_xc 源码编译，集群环境搭建"><meta itemprop=datePublished content="2022-07-27T16:44:08+08:00"><meta itemprop=dateModified content="2025-07-14T16:49:40+08:00"><meta itemprop=wordCount content="4082"><meta itemprop=image content="https://askyx.github.io/img/global-background.jpg"><meta itemprop=keywords content><header><h1 itemprop=headline>Postgres_xc 源码编译及环境搭建</h1><p class=text-sm><span data-format=luxon>2022-07-27T16:44:08+08:00</span>
| <span>9 minute read</span>
| <span>Updated at
<span data-format=luxon>2025-07-14T16:49:40+08:00</span></span></p><div class="flex justify-between"><div class="flex items-center"><span>@</span>
<span itemprop=author itemscope itemtype=https://schema.org/Person><span itemprop=name>Askyx</span></span></div><div class="flex items-center gap-2"><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://x.com/intent/post?text=Postgres_xc%20%e6%ba%90%e7%a0%81%e7%bc%96%e8%af%91%e5%8f%8a%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba&amp;url=https://askyx.github.io/trash/postgres_xc_build/" target=_blank rel="noopener noreferrer" title="Share on X"><ion-icon class=group-hover:text-primary-content name=logo-x></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://facebook.com/sharer/sharer.php?u=https://askyx.github.io/trash/postgres_xc_build/" target=_blank rel="noopener noreferrer" title="Share on Facebook"><ion-icon class=group-hover:text-primary-content name=logo-facebook></ion-icon></a><a class="group inline-flex items-center p-2 rounded-full cursor-pointer hover:bg-primary" href="https://wa.me/?text=Postgres_xc%20%e6%ba%90%e7%a0%81%e7%bc%96%e8%af%91%e5%8f%8a%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba%20https://askyx.github.io/trash/postgres_xc_build/" target=_blank rel="noopener noreferrer" title="Share on WhatsApp"><ion-icon class=group-hover:text-primary-content name=logo-whatsapp></ion-icon></a></div></div></header><section id=dream-single-post-content itemprop=articleBody><h2 id=源码编译>源码编译</h2><p>下载<a href="https://master.dl.sourceforge.net/project/postgres-xc/Version_1.2/pgxc-v1.2.1.tar.gz?viasf=1" target=_blank>源码</a>
，解压，这里尝试使用<code>-g</code>编译源码，目的是为了可以调试源码</p><p>编译中有flex的一个问题，提示版本不正确，且即使使用<code>export</code>指定<code>FLEX</code>，编译的时候还是会用yylex的一个重定义的错误，从postgres主线上找到解决的patch，这里网上没有太多有用的资料，所以有尝试的建议先直接编译，如果遇到相同的问题再使用下面的解决方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c++ data-lang=c++><span style=display:flex><span>gcc <span style=color:#f92672>-</span>DPGXC  <span style=color:#f92672>-</span>Wall <span style=color:#f92672>-</span>Wmissing<span style=color:#f92672>-</span>prototypes <span style=color:#f92672>-</span>Wpointer<span style=color:#f92672>-</span>arith <span style=color:#f92672>-</span>Wdeclaration<span style=color:#f92672>-</span>after<span style=color:#f92672>-</span>statement <span style=color:#f92672>-</span>Werror<span style=color:#f92672>=</span>vla <span style=color:#f92672>-</span>Wendif<span style=color:#f92672>-</span>labels <span style=color:#f92672>-</span>Wmissing<span style=color:#f92672>-</span>format<span style=color:#f92672>-</span>attribute <span style=color:#f92672>-</span>Wimplicit<span style=color:#f92672>-</span>fallthrough<span style=color:#f92672>=</span><span style=color:#ae81ff>3</span> <span style=color:#f92672>-</span>Wcast<span style=color:#f92672>-</span>function<span style=color:#f92672>-</span>type <span style=color:#f92672>-</span>Wformat<span style=color:#f92672>-</span>security <span style=color:#f92672>-</span>fno<span style=color:#f92672>-</span>strict<span style=color:#f92672>-</span>aliasing <span style=color:#f92672>-</span>fwrapv <span style=color:#f92672>-</span>fexcess<span style=color:#f92672>-</span>precision<span style=color:#f92672>=</span>standard <span style=color:#f92672>-</span>Wno<span style=color:#f92672>-</span>format<span style=color:#f92672>-</span>truncation <span style=color:#f92672>-</span>Wno<span style=color:#f92672>-</span>stringop<span style=color:#f92672>-</span>truncation <span style=color:#f92672>-</span>g <span style=color:#f92672>-</span>I. <span style=color:#f92672>-</span>I. <span style=color:#f92672>-</span>I..<span style=color:#f92672>/</span>..<span style=color:#f92672>/</span>..<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>include  <span style=color:#f92672>-</span>D_GNU_SOURCE   <span style=color:#f92672>-</span>c <span style=color:#f92672>-</span>o gram.o gram.c
</span></span><span style=display:flex><span>gram.y: In function <span style=color:#960050;background-color:#1e0010>‘</span>base_yyparse<span style=color:#960050;background-color:#1e0010>’</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>gram.y:<span style=color:#ae81ff>9025</span><span style=color:#f92672>:</span><span style=color:#ae81ff>11</span><span style=color:#f92672>:</span> warning: implicit declaration of function <span style=color:#960050;background-color:#1e0010>‘</span>superuser<span style=color:#960050;background-color:#1e0010>’</span> [<span style=color:#f92672>-</span>Wimplicit<span style=color:#f92672>-</span>function<span style=color:#f92672>-</span>declaration]
</span></span><span style=display:flex><span> <span style=color:#ae81ff>9025</span> <span style=color:#f92672>|</span>      <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>superuser())
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>           <span style=color:#f92672>^~~~~~~~~</span>
</span></span><span style=display:flex><span>scan.c: At top level:
</span></span><span style=display:flex><span>gram.c:<span style=color:#ae81ff>68</span><span style=color:#f92672>:</span><span style=color:#ae81ff>25</span><span style=color:#f92672>:</span> error: conflicting types <span style=color:#66d9ef>for</span> <span style=color:#960050;background-color:#1e0010>‘</span>base_yylex<span style=color:#960050;background-color:#1e0010>’</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>68</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>#</span>define yylex           base_yylex
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>                         <span style=color:#f92672>^~~~~~~~~~</span>
</span></span><span style=display:flex><span>scan.c:<span style=color:#ae81ff>9108</span><span style=color:#f92672>:</span><span style=color:#ae81ff>12</span><span style=color:#f92672>:</span> note: in expansion of macro <span style=color:#960050;background-color:#1e0010>‘</span>yylex<span style=color:#960050;background-color:#1e0010>’</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>9108</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>int</span> yylex \
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>            <span style=color:#f92672>^~~~~</span>
</span></span><span style=display:flex><span>In file included from gram.y:<span style=color:#ae81ff>60</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>..<span style=color:#f92672>/</span>..<span style=color:#f92672>/</span>..<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>include<span style=color:#f92672>/</span>parser<span style=color:#f92672>/</span>gramparse.h:<span style=color:#ae81ff>66</span><span style=color:#f92672>:</span><span style=color:#ae81ff>12</span><span style=color:#f92672>:</span> note: previous declaration of <span style=color:#960050;background-color:#1e0010>‘</span>base_yylex<span style=color:#960050;background-color:#1e0010>’</span> was here
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>66</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>int</span> base_yylex(YYSTYPE <span style=color:#f92672>*</span>lvalp, YYLTYPE <span style=color:#f92672>*</span>llocp,
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>            <span style=color:#f92672>^~~~~~~~~~</span>
</span></span><span style=display:flex><span>gram.c:<span style=color:#ae81ff>68</span><span style=color:#f92672>:</span><span style=color:#ae81ff>25</span><span style=color:#f92672>:</span> error: conflicting types <span style=color:#66d9ef>for</span> <span style=color:#960050;background-color:#1e0010>‘</span>base_yylex<span style=color:#960050;background-color:#1e0010>’</span>
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>68</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>#</span>define yylex           base_yylex
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>                         <span style=color:#f92672>^~~~~~~~~~</span>
</span></span><span style=display:flex><span>scan.c:<span style=color:#ae81ff>9111</span><span style=color:#f92672>:</span><span style=color:#ae81ff>21</span><span style=color:#f92672>:</span> note: in expansion of macro <span style=color:#960050;background-color:#1e0010>‘</span>yylex<span style=color:#960050;background-color:#1e0010>’</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>9111</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>#</span>define YY_DECL <span style=color:#66d9ef>int</span> yylex \
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>                     <span style=color:#f92672>^~~~~</span>
</span></span><span style=display:flex><span>scan.c:<span style=color:#ae81ff>9132</span><span style=color:#f92672>:</span><span style=color:#ae81ff>1</span><span style=color:#f92672>:</span> note: in expansion of macro <span style=color:#960050;background-color:#1e0010>‘</span>YY_DECL<span style=color:#960050;background-color:#1e0010>’</span>
</span></span><span style=display:flex><span> <span style=color:#ae81ff>9132</span> <span style=color:#f92672>|</span> YY_DECL
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span> <span style=color:#f92672>^~~~~~~</span>
</span></span><span style=display:flex><span>In file included from gram.y:<span style=color:#ae81ff>60</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>..<span style=color:#f92672>/</span>..<span style=color:#f92672>/</span>..<span style=color:#f92672>/</span>src<span style=color:#f92672>/</span>include<span style=color:#f92672>/</span>parser<span style=color:#f92672>/</span>gramparse.h:<span style=color:#ae81ff>66</span><span style=color:#f92672>:</span><span style=color:#ae81ff>12</span><span style=color:#f92672>:</span> note: previous declaration of <span style=color:#960050;background-color:#1e0010>‘</span>base_yylex<span style=color:#960050;background-color:#1e0010>’</span> was here
</span></span><span style=display:flex><span>   <span style=color:#ae81ff>66</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>int</span> base_yylex(YYSTYPE <span style=color:#f92672>*</span>lvalp, YYLTYPE <span style=color:#f92672>*</span>llocp,
</span></span><span style=display:flex><span>      <span style=color:#f92672>|</span>            <span style=color:#f92672>^~~~~~~~~~</span>
</span></span></code></pre></div><p>使用下面的patch可以解决问题，其中configure我还修改了编译选项，如果只是想搭建集群，可以把他修改回来</p><pre tabindex=0><code class=language-git data-lang=git>diff --git a/configure b/configure
index 64fccd7..4199c1d 100755
--- a/configure
+++ b/configure
@@ -3702,13 +3702,13 @@ if test &#34;$ac_test_CFLAGS&#34; = set; then
   CFLAGS=$ac_save_CFLAGS
 elif test $ac_cv_prog_cc_g = yes; then
   if test &#34;$GCC&#34; = yes; then
-    CFLAGS=&#34;-g -O2&#34;
+    CFLAGS=&#34;-g&#34;
   else
     CFLAGS=&#34;-g&#34;
   fi
 else
   if test &#34;$GCC&#34; = yes; then
-    CFLAGS=&#34;-O2&#34;
+    CFLAGS=&#34;-g&#34;
   else
     CFLAGS=
   fi
@@ -3945,8 +3945,8 @@ unset CFLAGS
 # If the user specifies something in the environment, that is used.
 # else:  If the template file set something, that is used.
 # else:  If coverage was enabled, don&#39;t set anything.
-# else:  If the compiler is GCC, then we use -O2.
-# else:  If the compiler is something else, then we use -O, unless debugging.
+# else:  If the compiler is GCC, then we use -g.
+# else:  If the compiler is something else, then we use -g, unless debugging.
 
 if test &#34;$ac_env_CFLAGS_set&#34; = set; then
   CFLAGS=$ac_env_CFLAGS_value
@@ -3955,11 +3955,11 @@ elif test &#34;${CFLAGS+set}&#34; = set; then
 elif test &#34;$enable_coverage&#34; = yes; then
   : # no optimization by default
 elif test &#34;$GCC&#34; = yes; then
-  CFLAGS=&#34;-O2&#34;
+  CFLAGS=&#34;-g&#34;
 else
-  # if the user selected debug mode, don&#39;t use -O
+  # if the user selected debug mode, don&#39;t use -g
   if test &#34;$enable_debug&#34; != yes; then
-    CFLAGS=&#34;-O&#34;
+    CFLAGS=&#34;-g&#34;
   fi
 fi
 
@@ -7335,7 +7335,7 @@ else
         echo &#39;%%&#39;  &gt; conftest.l
         if $pgac_candidate -t conftest.l 2&gt;/dev/null | grep FLEX_SCANNER &gt;/dev/null 2&gt;&amp;1; then
           pgac_flex_version=`$pgac_candidate --version 2&gt;/dev/null`
-          if echo &#34;$pgac_flex_version&#34; | sed &#39;s/[.a-z]/ /g&#39; | $AWK &#39;{ if ($1 = 2 &amp;&amp; $2 = 5 &amp;&amp; $3 &gt;= 31) exit 0; else exit 1;}&#39;
+          if echo &#34;$pgac_flex_version&#34; | sed &#39;s/[.a-z]/ /g&#39; | $AWK &#39;{ if ($1 == 2 &amp;&amp; ($2 &gt; 5 || ($2 == 5 &amp;&amp; $3 &gt;= 31))) exit 0; else exit 1;}&#39;
           then
             pgac_cv_path_flex=$pgac_candidate
             break 2
@@ -7433,7 +7433,7 @@ if test &#34;$PERL&#34;; then
   { $as_echo &#34;$as_me:$LINENO: using perl $pgac_perl_version&#34; &gt;&amp;5
 $as_echo &#34;$as_me: using perl $pgac_perl_version&#34; &gt;&amp;6;}
   if echo &#34;$pgac_perl_version&#34; | sed &#39;s/[.a-z_]/ /g&#39; | \
-    $AWK &#39;{ if ($1 = 5 &amp;&amp; $2 &gt;= 8) exit 1; else exit 0;}&#39;
+    $AWK &#39;{ if ($1 == 5 &amp;&amp; $2 &gt;= 8) exit 1; else exit 0;}&#39;
   then
     { $as_echo &#34;$as_me:$LINENO: WARNING:
 *** The installed version of Perl, $PERL, is too old to use with PostgreSQL.
diff --git a/contrib/pgxc_ctl/variables.c b/contrib/pgxc_ctl/variables.c
index 1bfaf79..74ceecf 100644
--- a/contrib/pgxc_ctl/variables.c
+++ b/contrib/pgxc_ctl/variables.c
@@ -17,6 +17,7 @@
 
 pgxc_ctl_var *var_head = NULL;
 pgxc_ctl_var *var_tail = NULL;
+pgxc_var_hash var_hash[NUM_HASH_BUCKET];
 
 static void clear_var(pgxc_ctl_var *var);
 /*
@@ -35,7 +35,7 @@ typedef struct pgxc_var_hash {
 } pgxc_var_hash;
 
 
-pgxc_var_hash var_hash[NUM_HASH_BUCKET];
+
 
 void init_var_hash(void);
 void add_var_hash(pgxc_ctl_var *var);
diff --git a/src/backend/parser/Makefile b/src/backend/parser/Makefile
index 0395bd5..9cc8946 100644
--- a/src/backend/parser/Makefile
+++ b/src/backend/parser/Makefile
@@ -12,7 +12,7 @@ include $(top_builddir)/src/Makefile.global
 
 override CPPFLAGS := -I. -I$(srcdir) $(CPPFLAGS)
 
-OBJS= analyze.o gram.o keywords.o kwlookup.o parser.o \
+OBJS= analyze.o gram.o scan.o keywords.o kwlookup.o parser.o \
       parse_agg.o parse_clause.o parse_coerce.o parse_collate.o parse_cte.o \
       parse_expr.o parse_func.o parse_node.o parse_oper.o parse_param.o \
       parse_relation.o parse_target.o parse_type.o parse_utilcmd.o scansup.o
@@ -20,12 +20,9 @@ OBJS= analyze.o gram.o keywords.o kwlookup.o parser.o \
 include $(top_srcdir)/src/backend/common.mk
 
 
-# scan is compiled as part of gram
-gram.o: scan.c
-
 # Latest flex causes warnings in this file.
 ifeq ($(GCC),yes)
-gram.o: CFLAGS += -Wno-error
+scan.o: CFLAGS += -Wno-error
 endif
 
 
@@ -47,7 +44,7 @@ scan.c: FLEX_NO_BACKUP=yes
 
 
 # Force these dependencies to be known even without dependency info built:
-gram.o keywords.o parser.o: gram.h
+gram.o scan.o keywords.o parser.o: gram.h
 
 
 # gram.c, gram.h, and scan.c are in the distribution tarball, so they
diff --git a/src/backend/parser/gram.y b/src/backend/parser/gram.y
index 173c078..cce9386 100644
--- a/src/backend/parser/gram.y
+++ b/src/backend/parser/gram.y
@@ -14254,13 +14254,3 @@ parser_init(base_yy_extra_type *yyext)
 {
 	yyext-&gt;parsetree = NIL;		/* in case grammar forgets to set it */
 }
-
-/*
- * Must undefine this stuff before including scan.c, since it has different
- * definitions for these macros.
- */
-#undef yyerror
-#undef yylval
-#undef yylloc
-
-#include &#34;scan.c&#34;
diff --git a/src/backend/parser/scan.l b/src/backend/parser/scan.l
index 92f38a2..911a0ed 100644
--- a/src/backend/parser/scan.l
+++ b/src/backend/parser/scan.l
@@ -1,4 +1,4 @@
-%{
+%top{
 /*-------------------------------------------------------------------------
  *
  * scan.l
@@ -6,7 +6,7 @@
  *
  * NOTE NOTE NOTE:
  *
- * The rules in this file must be kept in sync with psql&#39;s lexer!!!
+ * The rules in this file must be kept in sync with psql&#39;s psqlscan.l!
  *
  * The rules are designed so that the scanner never has to backtrack,
  * in the sense that there is always a rule that can match the input
@@ -34,12 +34,13 @@
 #include &lt;ctype.h&gt;
 #include &lt;unistd.h&gt;
 
+#include &#34;parser/gramparse.h&#34;
 #include &#34;parser/parser.h&#34;				/* only needed for GUC variables */
-#include &#34;parser/scanner.h&#34;
 #include &#34;parser/scansup.h&#34;
 #include &#34;mb/pg_wchar.h&#34;
+}
 
-
+%{
 /* Avoid exit() on fatal scanner errors (a bit ugly -- see yy_fatal_error) */
 #undef fprintf
 #define fprintf(file, fmt, msg)  fprintf_to_ereport(fmt, msg)
diff --git a/src/gtm/proxy/proxy_main.c b/src/gtm/proxy/proxy_main.c
index 3224525..52d186f 100644
--- a/src/gtm/proxy/proxy_main.c
+++ b/src/gtm/proxy/proxy_main.c
@@ -69,7 +69,7 @@ int			GTMProxyPortNumber;
 int			GTMProxyWorkerThreads;
 char		*GTMProxyDataDir;
 char		*GTMProxyConfigFileName;
-char		*GTMConfigFileName;
+extern char		*GTMConfigFileName;
 
 char		*GTMServerHost;
 int			GTMServerPortNumber;
diff --git a/src/interfaces/ecpg/preproc/Makefile b/src/interfaces/ecpg/preproc/Makefile
index 715be28..8651f30 100644
--- a/src/interfaces/ecpg/preproc/Makefile
+++ b/src/interfaces/ecpg/preproc/Makefile
@@ -26,7 +26,7 @@ override CPPFLAGS := -I../include -I$(top_srcdir)/src/interfaces/ecpg/include \
 
 override CFLAGS += $(PTHREAD_CFLAGS) -DECPG_COMPILE
 
-OBJS=	preproc.o type.o ecpg.o output.o parser.o \
+OBJS=	preproc.o pgc.o type.o ecpg.o output.o parser.o \
 	keywords.o c_keywords.o ecpg_keywords.o kwlookup.o ../ecpglib/typename.o descriptor.o variable.o \
 	$(WIN32RES)
 
@@ -44,9 +44,6 @@ ecpg: $(OBJS) | submake-libpgport
 ../ecpglib/typename.o: ../ecpglib/typename.c
 	$(MAKE) -C $(dir $@) $(notdir $@)
 
-# pgc is compiled as part of preproc
-preproc.o: pgc.c
-
 preproc.h: preproc.c ;
 preproc.c: BISONFLAGS += -d
 
@@ -54,7 +51,7 @@ preproc.y: ../../../backend/parser/gram.y parse.pl ecpg.addons ecpg.header ecpg.
 	$(PERL) $(srcdir)/parse.pl $(srcdir) &lt; $&lt; &gt; $@
 	$(PERL) $(srcdir)/check_rules.pl $(srcdir) $&lt;
 
-ecpg_keywords.o c_keywords.o keywords.o preproc.o parser.o: preproc.h
+ecpg_keywords.o c_keywords.o keywords.o preproc.o pgc.o parser.o: preproc.h
 
 kwlookup.c: % : $(top_srcdir)/src/backend/parser/%
 	rm -f $@ &amp;&amp; $(LN_S) $&lt; .
diff --git a/src/interfaces/ecpg/preproc/ecpg.trailer b/src/interfaces/ecpg/preproc/ecpg.trailer
index 70dc690..fb8e03a 100644
--- a/src/interfaces/ecpg/preproc/ecpg.trailer
+++ b/src/interfaces/ecpg/preproc/ecpg.trailer
@@ -1912,11 +1912,3 @@ void parser_init(void)
 {
  /* This function is empty. It only exists for compatibility with the backend parser right now. */
 }
-
-/*
- * Must undefine base_yylex before including pgc.c, since we want it
- * to create the function base_yylex not filtered_base_yylex.
- */
-#undef base_yylex
-
-#include &#34;pgc.c&#34;
diff --git a/src/interfaces/ecpg/preproc/pgc.l b/src/interfaces/ecpg/preproc/pgc.l
index 5abb74f..2e363c2 100644
--- a/src/interfaces/ecpg/preproc/pgc.l
+++ b/src/interfaces/ecpg/preproc/pgc.l
@@ -1,4 +1,4 @@
-%{
+%top{
 /*-------------------------------------------------------------------------
  *
  * pgc.l
@@ -23,7 +23,19 @@
 #include &lt;limits.h&gt;
 
 #include &#34;extern.h&#34;
+#include &#34;preproc.h&#34;
+
+/*
+ * Change symbol names as expected by preproc.l.  It&#39;d be better to do this
+ * with %option prefix=&#34;base_yy&#34;, but that affects some other names that
+ * various files expect *not* to be prefixed with &#34;base_&#34;.  Cleaning it up
+ * is not worth the trouble right now.
+ */
+#define yylex           base_yylex
+#define yylval          base_yylval
+}
 
+%{
 extern YYSTYPE yylval;
 
 static int		xcdepth = 0;	/* depth of nesting in slash-star comments */
</code></pre><ul><li>使用正常的编译postgres的方法编译源码即可，具体可以参考我其他文章</li></ul><hr><h2 id=配置集群>配置集群</h2><ul><li>GTM * 1</li><li>COOR * 2</li><li>DNODE * 2</li></ul><blockquote><p>我这里尝试在单机上搭建集群环境，理论上修改port是可以成功的，但是我可能某一步没有正确配置，所以失败了，但是我这里的资料都是我主要从官网扒下来的，失败了也是想不通😂</p></blockquote><p>主要过程为和配置如下，这是后期整理的资料，因该有用，起码命令有用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># 配置.bashrc</span>
</span></span><span style=display:flex><span>export PGHOME<span style=color:#f92672>=</span>/home/postgres/postgres-home/build/postgres-xc/build
</span></span><span style=display:flex><span>export PGPORT<span style=color:#f92672>=</span><span style=color:#ae81ff>4431</span>
</span></span><span style=display:flex><span>export PGDATA<span style=color:#f92672>=</span>$PGHOME/../data
</span></span><span style=display:flex><span>export LANG<span style=color:#f92672>=</span>en_US.utf8
</span></span><span style=display:flex><span>export LD_LIBRARY_PATH<span style=color:#f92672>=</span>$PGHOME/lib:$LD_LIBRARY_PATH
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span>$PGHOME/bin:$PATH:.
</span></span><span style=display:flex><span>export MANPATH<span style=color:#f92672>=</span>$PGHOME/share/man:$MANPATH
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./initgtm -Z gtm -D $PGHOME/../data1/gtm/data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./initdb -D $PGHOME/../data1/coor_1/data --nodename coor_1
</span></span><span style=display:flex><span>./initdb -D $PGHOME/../data1/coor_2/data --nodename coor_2
</span></span><span style=display:flex><span>./initdb -D $PGHOME/../data1/db_1/data --nodename db_1
</span></span><span style=display:flex><span>./initdb -D $PGHOME/../data1/db_2/data --nodename db_2
</span></span><span style=display:flex><span>./initdb -D $PGHOME/../data1/db_3/data --nodename db_3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#port = 5432/port = 24076/g&#34;</span> coor_1/data/postgresql.conf 
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#pooler_port = 6667/pooler_port = 6667/g&#34;</span> coor_1/data/postgresql.conf 
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#port = 5432/port = 24077/g&#34;</span> coor_2/data/postgresql.conf 
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#pooler_port = 6667/pooler_port = 6668/g&#34;</span> coor_2/data/postgresql.conf 
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#port = 5432/port = 24071/g&#34;</span> db_1/data/postgresql.conf 
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#port = 5432/port = 24072/g&#34;</span> db_2/data/postgresql.conf 
</span></span><span style=display:flex><span>sed -i <span style=color:#e6db74>&#34;s/#port = 5432/port = 24073/g&#34;</span> db_3/data/postgresql.conf 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>编辑data/co1/postgresql.conf： 
</span></span><span style=display:flex><span>  gtm_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6666</span>            //为默认值
</span></span><span style=display:flex><span>  pgxc_node_name <span style=color:#f92672>=</span> co1        //pgxc_node_name不能重复
</span></span><span style=display:flex><span>编辑data/co2/postgresql.conf： 
</span></span><span style=display:flex><span>  gtm_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6666</span>
</span></span><span style=display:flex><span>  pgxc_node_name <span style=color:#f92672>=</span> co2
</span></span><span style=display:flex><span>编辑data/dn1/postgresql.conf： 
</span></span><span style=display:flex><span>  gtm_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6666</span>
</span></span><span style=display:flex><span>  pgxc_node_name <span style=color:#f92672>=</span> dn1          
</span></span><span style=display:flex><span>编辑data/dn2/postgresql.conf： 
</span></span><span style=display:flex><span>  gtm_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6666</span>
</span></span><span style=display:flex><span>  pgxc_node_name <span style=color:#f92672>=</span> dn2
</span></span><span style=display:flex><span>编辑data/dn2/postgresql.conf： 
</span></span><span style=display:flex><span>  gtm_port <span style=color:#f92672>=</span> <span style=color:#ae81ff>6666</span>
</span></span><span style=display:flex><span>  pgxc_node_name <span style=color:#f92672>=</span> dn3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>mkdir gtm/data/log
</span></span><span style=display:flex><span>mkdir coor_1/data/log
</span></span><span style=display:flex><span>mkdir coor_2/data/log
</span></span><span style=display:flex><span>mkdir db_1/data/log
</span></span><span style=display:flex><span>mkdir db_2/data/log
</span></span><span style=display:flex><span>mkdir db_3/data/log
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#./bin/gtm_ctl start -S gtm -D data/gtm -l data/gtm/gtm.log  //启动gtm（由于切换为相对路径后找不到对应的文件夹，所以创建日志会失败）</span>
</span></span><span style=display:flex><span>./gtm_ctl start -Z gtm -D $PGHOME/../data1/gtm/data -l /home/wen/postgres-home/build/postgres-xc/data1/gtm/data/log/gtm.log 
</span></span><span style=display:flex><span>./pg_ctl start -Z datanode -D $PGHOME/../data1/db_1/data -l /home/wen/postgres-home/build/postgres-xc/data1/db_1/data/log/postgresql.log  -o <span style=color:#e6db74>&#34;-p 24071&#34;</span>
</span></span><span style=display:flex><span>./pg_ctl start -Z datanode -D $PGHOME/../data1/db_2/data -l /home/wen/postgres-home/build/postgres-xc/data1/db_2/data/log/postgresql.log  -o <span style=color:#e6db74>&#34;-p 24072&#34;</span>
</span></span><span style=display:flex><span>./pg_ctl start -Z datanode -D $PGHOME/../data1/db_3/data -l /home/wen/postgres-home/build/postgres-xc/data1/db_3/data/log/postgresql.log  -o <span style=color:#e6db74>&#34;-p 24073&#34;</span>
</span></span><span style=display:flex><span>./pg_ctl start -Z coordinator -D $PGHOME/../data1/coor_2/data -l /home/wen/postgres-home/build/postgres-xc/data1/coor_2/data/log/postgresql.log  -o <span style=color:#e6db74>&#34;-p 24077&#34;</span>
</span></span><span style=display:flex><span>./pg_ctl start -Z coordinator -D $PGHOME/../data1/coor_1/data -l /home/wen/postgres-home/build/postgres-xc/data1/coor_1/data/log/postgresql.log  -o <span style=color:#e6db74>&#34;-p 24076&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./psql -p <span style=color:#ae81ff>24076</span> 
</span></span><span style=display:flex><span> CREATE NODE db_1 WITH <span style=color:#f92672>(</span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;datanode&#39;</span>, PORT <span style=color:#f92672>=</span> 24071<span style=color:#f92672>)</span>; 
</span></span><span style=display:flex><span> CREATE NODE db_2 WITH <span style=color:#f92672>(</span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;datanode&#39;</span>, PORT <span style=color:#f92672>=</span> 24072<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span> CREATE NODE db_3 WITH <span style=color:#f92672>(</span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;datanode&#39;</span>, PORT <span style=color:#f92672>=</span> 24073<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span> CREATE NODE coor_1 WITH <span style=color:#f92672>(</span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;coordinator&#39;</span>, PORT <span style=color:#f92672>=</span> 24076<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span> CREATE NODE coor_2 WITH <span style=color:#f92672>(</span>HOST <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;localhost&#39;</span>, type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;coordinator&#39;</span>, PORT <span style=color:#f92672>=</span> 24077<span style=color:#f92672>)</span>;
</span></span><span style=display:flex><span> SELECT pgxc_pool_reload<span style=color:#f92672>()</span>;
</span></span><span style=display:flex><span> <span style=color:#66d9ef>select</span> * from pgxc_node;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./pg_ctl stop -D $PGHOME/../data1/coor_1/data -m immediate
</span></span><span style=display:flex><span>./pg_ctl stop -D $PGHOME/../data1/coor_2/data -m immediate
</span></span><span style=display:flex><span>./pg_ctl stop -D $PGHOME/../data1/db_1/data -m immediate
</span></span><span style=display:flex><span>./pg_ctl stop -D $PGHOME/../data1/db_2/data -m immediate
</span></span><span style=display:flex><span>./pg_ctl stop -D $PGHOME/../data1/db_3/data -m immediate
</span></span><span style=display:flex><span>./gtm_ctl stop -Z gtm -D  $PGHOME/../data1/gtm/data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ rm -f data/gtm/register.node  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./bin/gtm_ctl start -Z gtm -D data/gtm -p ./bin -l data/gtm/gtm.log 
</span></span><span style=display:flex><span>$ ./bin/pg_ctl start -l data/dn1/postgresql.log -Z datanode -D data/dn1 -o <span style=color:#e6db74>&#34;-p 24071&#34;</span>
</span></span><span style=display:flex><span>$ ./bin/pg_ctl start -l data/dn2/postgresql.log -Z datanode -D data/dn2 -o <span style=color:#e6db74>&#34;-p 24072&#34;</span>
</span></span><span style=display:flex><span>$ ./bin/pg_ctl start -l data/dn3/postgresql.log -Z datanode -D data/dn3 -o <span style=color:#e6db74>&#34;-p 24073&#34;</span>
</span></span><span style=display:flex><span>$ ./bin/pg_ctl start -l data/co1/postgresql.log -Z coordinator -D data/co1 -o <span style=color:#e6db74>&#34;-p 24076&#34;</span>
</span></span><span style=display:flex><span>$ ./bin/pg_ctl start -l data/co2/postgresql.log -Z coordinator -D data/co2 -o <span style=color:#e6db74>&#34;-p 24077&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ ./bin/pg_ctl stop -D data/co1 -m immediate
</span></span><span style=display:flex><span>$ ./bin/pg_ctl stop -D data/co2 -m immediate
</span></span><span style=display:flex><span>$ ./bin/pg_ctl stop -D data/dn1 -m immediate
</span></span><span style=display:flex><span>$ ./bin/pg_ctl stop -D data/dn2 -m immediate
</span></span><span style=display:flex><span>$ ./bin/pg_ctl stop -D data/dn3 -m immediate
</span></span><span style=display:flex><span>$ ./bin/gtm_ctl stop -Z gtm -D data/gtm 
</span></span><span style=display:flex><span>$ rm -f data/gtm/register.node 
</span></span><span style=display:flex><span>$ rm -rf data
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export XCHOME<span style=color:#f92672>=</span>/home/wen/postgres/build/postgres-xc/build
</span></span><span style=display:flex><span>export PATH<span style=color:#f92672>=</span>$XCHOME/bin:$PATH
</span></span><span style=display:flex><span>export LD_LIBRARY_PATH<span style=color:#f92672>=</span>$XCHOME/lib:$LD_LIBRARY_PATH
</span></span><span style=display:flex><span>export XCDATABASE<span style=color:#f92672>=</span>postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export XCDATA<span style=color:#f92672>=</span>/home/wen/postgres/build/postgres-xc/data
</span></span><span style=display:flex><span>alias cdd<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cd </span>$XCDATA<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># alias pcn1=&#34;psql -d postgres -p 65022&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># alias pcn2=&#34;psql -d postgres -p 65023&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># alias pdn1=&#34;psql -d postgres -p 65013&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># alias pdn2=&#34;psql -d postgres -p 65014&#34;</span>
</span></span><span style=display:flex><span><span style=color:#75715e># alias pgtm=&#34;psql -d postgres -p 65011&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>alias mk<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;cd /home/wen/postgres/build/postgres-xc/make &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>/home/wen/postgres/postgres-xc/configure --prefix=</span>$XCHOME<span style=color:#e6db74> \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-segsize=4 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-wal-blocksize=64 \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--enable-grammar-oracle \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-perl \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-python \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-pam \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-ldap \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-libxml \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--with-libxslt \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--enable-thread-safety \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--disable-cassert \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>--enable-depend CFLAGS=&#39;-g&#39; &amp;&amp; \
</span></span></span><span style=display:flex><span><span style=color:#e6db74>make &amp;&amp; make install
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><h2 id=重新分布数据以及节点操作>重新分布数据以及节点操作</h2><p>PXC 可以修改表的重分布属性，即将表的数据在不同的节点中进行重新分布。有下面几种方法</p><ol><li><p>默认的重分布方法，首先，通过 copy to 命令把所有的数据保存到 coordinator上，然后使用truncate把各个数据节点上的数据清空。最后使用 copy from 机制把数据重新分布到底层的各个数据节点上。最后根据情况可能会执行 reindex。</p></li><li><p>replicated表到replicated表： 这通常是在 replicated表中增加或删除底层数据节点时使用。</p></li></ol><ul><li>删除一个副本，直接在这个数据节点上 执行 truncate 即可。</li><li>增加一个副本，通过 copy to 命令把任意节点上的数据保存到 coordinator上，然后使用 copy from 机制把数据复制到新增的节点上即可。最后根据情况可能会执行 reindex。</li></ul><ol start=3><li><p>把replicated表转为distribute表：
如果转换后 distribute表的节点分布列表与分布前不同或有新节点增加，则使用默认方法，即第一种；
如果转换后distribute表分布的节点和转换前相同或减少了，则不需要跨节点重新分布数据，只需要删除底层节点表中那些不需要保留的数据即可。最后根据情况可能会执行 reindex。</p></li><li><p>把distribute表转换成 replicated表： 使用默认的重分布方法，即第一种。</p></li></ol><p>Postgres-XC 通过扩展 <code>ALTER TABLE</code> 命令提供了让表数据重新分布的功能，主要增加了以下子句</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>DISTRIBUTE <span style=color:#66d9ef>BY</span> <span style=color:#960050;background-color:#1e0010>{</span> REPLICATION <span style=color:#f92672>|</span> ROUNDROBIN <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span> HASH <span style=color:#f92672>|</span> MODULO  ( <span style=color:#66d9ef>column_name</span>) <span style=color:#960050;background-color:#1e0010>}</span> <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>TO</span> <span style=color:#960050;background-color:#1e0010>{</span> <span style=color:#66d9ef>GROUP</span>  groupname <span style=color:#f92672>|</span> NODE  <span style=color:#960050;background-color:#1e0010>（</span>nodename [ , ....]<span style=color:#960050;background-color:#1e0010>）}</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ADD</span> NODE <span style=color:#960050;background-color:#1e0010>（</span>nodename [, ... ]<span style=color:#960050;background-color:#1e0010>）</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>DELETE</span> NODE (nodename [, ... ] <span style=color:#960050;background-color:#1e0010>）</span>
</span></span></code></pre></div><h3 id=增加coordinators节点>增加Coordinators节点</h3><ol><li>初始化一个新的 coordinator节点</li><li>配置对应的 postgresql.conf 文件</li><li>连接到任意已有的 coordinator节点，锁住集群，为备份做准备，执行锁住命令 但不要退出,否则备份出来的数据会不一致</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  postgres<span style=color:#f92672>=#</span> <span style=color:#66d9ef>select</span> pgxc_lock_for_backup();
</span></span><span style=display:flex><span>  INFO:  please <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>close</span> this <span style=color:#66d9ef>session</span> <span style=color:#66d9ef>until</span> you <span style=color:#66d9ef>are</span> done adding the <span style=color:#66d9ef>new</span> node
</span></span></code></pre></div><p>做完这个操作后，整个集群不要执行DDL语句，这样数据库的元数据就不会发生变化，就能保证备份的一致性了。</p><ol start=4><li>再连接已有的任意一个 coordinator节点，执行备份</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  pg_dumpall <span style=color:#f92672>-</span>p <span style=color:#ae81ff>5432</span> <span style=color:#f92672>-</span>s <span style=color:#75715e>--include-nodes --dump-nodes --file=meta.sql
</span></span></span></code></pre></div><ol start=5><li>把新的 coordinator节点启动到 restoremode 模式下<code>pg_ctl start -Z restoremode -D /opt/pgxc/coordinator/</code></li></ol><ul><li>将备份文件拷贝到新节点
<code>psql -d postgres -p 5432 -f /tmp/meta.sql</code></li><li>然后将新的 coordinator停止
<code>pg_ctl stop -D /opt/pgxc/coordinator</code></li></ul><ol start=6><li>启动新coordinator
<code>pg_ctl start -Z coordinator -D /opt/pgxc/coordinator</code></li><li>在每台 coordinator上执行 create node 命令增加新节点,最后调用函数 <code>pgxc_pool_reload()</code> 刷新缓存在连接池中的节点信息</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#66d9ef>create</span> node cdtor5 <span style=color:#66d9ef>with</span> (<span style=color:#66d9ef>host</span><span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;vlnx107001.firstshare.cn&#39;</span>,<span style=color:#66d9ef>type</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;coordinator&#39;</span>,port<span style=color:#f92672>=</span><span style=color:#ae81ff>5432</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> pgxc_pool_reload();
</span></span></code></pre></div><ol start=8><li>退出第3 步的session，释放集群锁。</li></ol><h3 id=移除coordinators-节点>移除Coordinators 节点</h3><ol><li>将要移除的节点停掉</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  pg_ctl stop <span style=color:#f92672>-</span>Z coordinator <span style=color:#f92672>-</span>D <span style=color:#f92672>/</span>opt<span style=color:#f92672>/</span>pgxc<span style=color:#f92672>/</span>coordinators <span style=color:#f92672>-</span>m faster
</span></span></code></pre></div><ol start=2><li>连接到任意 coordinator， 执行 drop node命令</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#66d9ef>drop</span> node cdtor3;
</span></span></code></pre></div><ol start=3><li>刷新缓存</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  <span style=color:#66d9ef>select</span>  pgxc_pool_reload();
</span></span></code></pre></div><h3 id=增加-datanode节点>增加 Datanode节点</h3><ol><li>初始化新的 datanode 并修改对应的postgresql.conf文件</li><li>连接到任意已有的 coordinator节点，锁住集群，为备份做准备，执行锁住命令 但不要退出,否则备份出来的数据会不一致</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  postgres<span style=color:#f92672>=#</span> <span style=color:#66d9ef>select</span> pgxc_lock_for_backup();
</span></span><span style=display:flex><span>  INFO:  please <span style=color:#66d9ef>do</span> <span style=color:#66d9ef>not</span> <span style=color:#66d9ef>close</span> this <span style=color:#66d9ef>session</span> <span style=color:#66d9ef>until</span> you <span style=color:#66d9ef>are</span> done adding the <span style=color:#66d9ef>new</span> node
</span></span></code></pre></div><p>做完这个操作后，整个集群不要执行DDL语句，这样数据库的元数据就不会发生变化，就能保证备份的一致性了。</p><ol start=3><li>连接到任意 datanode节点，执行元数据的备份</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>  pg_dumpall <span style=color:#f92672>-</span>p <span style=color:#ae81ff>5432</span> <span style=color:#f92672>-</span>s <span style=color:#75715e>--file=datanode_meta.sql
</span></span></span></code></pre></div><ol start=4><li>把新的datanode启动到 restoremode，和coordinator类似</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    pg_ctl <span style=color:#66d9ef>start</span> <span style=color:#f92672>-</span>Z restoremode <span style=color:#f92672>-</span>D <span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>pgsql<span style=color:#f92672>/</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>6</span><span style=color:#f92672>/</span>dnode <span style=color:#f92672>-</span>p <span style=color:#ae81ff>5439</span>
</span></span><span style=display:flex><span>    psql <span style=color:#f92672>-</span>d postgres <span style=color:#f92672>-</span>f datanode_meta.<span style=color:#66d9ef>sql</span> <span style=color:#f92672>-</span> p <span style=color:#ae81ff>5439</span>
</span></span><span style=display:flex><span>    pg_ctl stop <span style=color:#f92672>-</span>D <span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>pgsql<span style=color:#f92672>/</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>6</span><span style=color:#f92672>/</span>dnode <span style=color:#f92672>-</span>p <span style=color:#ae81ff>5439</span> <span style=color:#f92672>-</span>m fast
</span></span></code></pre></div><ol start=5><li>启动新的datanode节点到正常状态下
<code>pg_ctl start -Z datanode -D /var/lib/pgsql/9.6/dnode</code></li><li>在每台 coordinator 执行 create node 增加新节点，然后调用 pgxc_pool_reload()</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#66d9ef>create</span> node dnode4 <span style=color:#66d9ef>with</span>(<span style=color:#66d9ef>host</span><span style=color:#f92672>=</span><span style=color:#e6db74>&#39;hostname&#39;</span>,<span style=color:#66d9ef>type</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&#39;datanode&#39;</span>,port<span style=color:#f92672>=</span> <span style=color:#ae81ff>5439</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>select</span> pgxc_pool_reload();
</span></span></code></pre></div><ol start=7><li>退出第2步</li><li>可以执行 alter table 命令，把旧表的数据重新分布到新节点上。如果不执行这步，则旧表的数据只存在于原先的节点中。</li></ol><p>移除 Datanode节点</p><ol><li>要移除一个datanode，首先要把这个datanode上的数据重新分布到其他节点上</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>    <span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl_name1 <span style=color:#66d9ef>delete</span> node (dnode4);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl_name2 <span style=color:#66d9ef>delete</span> node (dnode4);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>alter</span> <span style=color:#66d9ef>table</span> tbl_name3 <span style=color:#66d9ef>delete</span> node (dnode4);
</span></span><span style=display:flex><span>    .....
</span></span></code></pre></div><p>检查是否有表把数据放在这个节点上</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> pgxc_class <span style=color:#66d9ef>c</span>,pgxc_node n <span style=color:#66d9ef>where</span> n.node_name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;dnode4&#39;</span> <span style=color:#66d9ef>and</span> n.oid<span style=color:#f92672>=</span><span style=color:#66d9ef>any</span>(<span style=color:#66d9ef>c</span>.nodeoids);
</span></span></code></pre></div><ol start=2><li>停掉该节点</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>pg_ctl stop <span style=color:#f92672>-</span>Z datanode <span style=color:#f92672>-</span>D <span style=color:#f92672>/</span>var<span style=color:#f92672>/</span>lib<span style=color:#f92672>/</span>pgsql<span style=color:#f92672>/</span><span style=color:#ae81ff>9</span>.<span style=color:#ae81ff>6</span><span style=color:#f92672>/</span>dnode <span style=color:#f92672>-</span>m fast;
</span></span></code></pre></div><ol start=3><li>连接到所有 coordinator节点 删除给节点</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>drop</span> node  dnode4;
</span></span></code></pre></div><ol start=4><li>刷新缓存</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>select</span> pgxc_pool_reload();
</span></span></code></pre></div></section><div class=divider></div><div class="flex flex-col md:flex-row justify-between gap-4 py-4"><div></div><a role=button class="btn btn-outline h-12" href=/trash/docs/ title=Docs><div class="inline-flex flex-col items-end"><span class="text-base-content/60 text-xs font-normal">Next page</span>
<span class="max-w-48 truncate">Docs</span></div><ion-icon name=chevron-forward></ion-icon></a></div><div class=divider></div><section class=space-y-4><template x-if="['localhost', '127.0.0.1'].indexOf(window.location.hostname) == -1"><article><script src=https://utteranc.es/client.js repo=https://askyx.github.io/ issue-term=og:title theme=github-light crossorigin=anonymous async></script></article></template></section></article></div><div x-data=tocHighlighter() @scroll.window=debouncedScroll class="hidden lg:flex lg:flex-col lg:items-end lg:self-start"><nav id=TableOfContents><ul><li><a href=#源码编译>源码编译</a></li><li><a href=#配置集群>配置集群</a></li><li><a href=#重新分布数据以及节点操作>重新分布数据以及节点操作</a><ul><li><a href=#增加coordinators节点>增加Coordinators节点</a></li><li><a href=#移除coordinators-节点>移除Coordinators 节点</a></li><li><a href=#增加-datanode节点>增加 Datanode节点</a></li></ul></li></ul></nav></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2016 - 2025 Askyx's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div><div class=back><div class=container><div class="dream-grid dream-grid-about"><div class="w-full md:w-1/2 lg:w-1/3 xl:w-1/4 p-4 dream-column"><article class="card bg-base-100 hover:bg-base-content/10 shadow-xl dark:border dark:border-base-content/30"><div class=card-body><div class=card-title>About Me</div><div class="prose dark:prose-invert"><p>Hi, my name is Yue Yang.</p><p>This is my blog.</p><h2 id=ヾωo>ヾ(•ω•`)o</h2><p>比较胆小，出门都得贴墙走</p></div></div></article></div></div><footer class="flex justify-between items-center gap-2 px-4 py-12"><div><p>© 2016 - 2025 Askyx's Blog</p><p class=text-sm>🌱
<span class=text-base-content/60>Powered by <a class=hover:underline href=https://gohugo.io/ target=_blank>Hugo</a> with theme
<a class=hover:underline href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</span></p></div><div x-data="{ icons: [
    { name: 'sunny', status: 'n' },
    { name: 'moon', status: 'y' },
    { name: 'desktop', status: 'auto' }
  ] }" class="flex items-center gap-2 h-[32px] px-2 bg-base-100 border border-base-content/30 rounded-full"><template x-for="icon in icons"><div role=button tabindex=0 :aria-label="'Select ' + icon.name + ' mode'" class="group inline-flex justify-center items-center p-1 rounded-full cursor-pointer hover:bg-primary" :class="$store.darkMode.icon() === icon.name && 'bg-primary'" @click=$store.darkMode.toggle(icon.status)><ion-icon :name="`${icon.name}-outline`" class=group-hover:text-primary-content :class="$store.darkMode.icon() === icon.name && 'text-primary-content'"></ion-icon></div></template></div></footer></div></div></div></div><script>window.lightTheme="emerald",window.darkTheme="forest"</script><script src=https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin=anonymous></script><script src=/js/grid.min.js></script><script src=/js/main.min.js></script><script src=https://cdn.jsdelivr.net/npm/luxon@1.26.0 integrity="sha256-4sbTzmCCW9LGrIh5OsN8V5Pfdad1F1MwhLAOyXKnsE0=" crossorigin=anonymous></script><script>format();function format(){document.querySelectorAll('span[data-format="luxon"]').forEach(e=>{const t=e.textContent;e.textContent=luxon.DateTime.fromISO(t,{locale:"en"}).toFormat("yyyy年MM月dd日")})}</script><script src=/js/toc.min.js></script><script type=module>
      import mediumZoom from 'https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/+esm';
      mediumZoom('#dream-single-post-content img', {
        background: 'oklch(var(--b1))',
        margin: 24,
      })
    </script><script type=module src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.esm.js integrity="sha256-/IFmi82bIhdYWctu0UddSlJqpnzWm7Vh2C4CM32wF/k=" crossorigin=anonymous></script><script nomodule src=https://cdn.jsdelivr.net/npm/ionicons@7.4.0/dist/ionicons/ionicons.js integrity="sha256-mr7eJMX3VC3F7G32mk4oWp1C6a2tlMYxUdptfT7uKI8=" crossorigin=anonymous></script></body></html>